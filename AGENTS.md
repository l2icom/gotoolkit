# GoToolkit – Notes Agent

Référence rapide pour les contributrices/contributeurs/copilotes.

- **Structure.** Modules HTML statiques dans `public/`; `src/connect/index.tsx` bundle le pont Excalidraw en `public/js/connect.bundle.js`; workers Cloudflare dans `workers/` (proxy OpenAI, partage, feedback). Tout hors `src/connect` est HTML/JS/CSS écrit à la main.
- **Navigation.** `public/index.html` pointe vers `canvas.html`, `grid.html`, `draw.html`, `timeline.html`, `voice.html` avec le cache-buster `?v=2025.12.24.2`. Chaque page est ouvrable directement. Les pages fixent `window.GO_TOOLKIT_SHARE_API_URL` (launcher → `https://gotoolkit.workers.dev`, modules → `https://share.gotoolkit.workers.dev/`).
- **Modules.** Canvas (`slides`) : exports PPTX/PNG/JSON + templates `public/js/prompt.js`. Grid (`grids`) : AG Grid multi-page, export CSV/JSON, modal de templates + critères (`public/js/template-criteria.js`), testé par Playwright. Draw (`diagrams`) : hôte Excalidraw via `GoToolkitExcalidraw` (conversion Mermaid). Timeline (`timelines`) : vis-timeline avec export XLSX/PNG/JSON. Voice (`voices`) : enregistrement + STT, transcript/sujets/participants par page ; partage via la collection `voices`.
- **Globals/contrats.** Seuls les scripts `public/js` touchent `window` : `GoToolkitIAConfig`, `GoToolkitAIBackend`, `GoToolkitIAClient.chatCompletion`, `GoToolkitIA.chatCompletion`, `GoToolkitOpenAI`, `GoToolkitWebLLM`, `GoToolkitExcalidraw`, `goToolkitDocStore`, `goToolkitCapsuleDrafts`, `goToolkitShareHistory`, `goToolkitShareWorker`. À garder stables.
- **IA/backends.** `public/js/ia-config.js` stocke OpenAI/Ollama/WebLLM/config en `localStorage` et expose les endpoints (direct + `https://openai.gotoolkit.workers.dev`). `public/js/ia-client.js` normalise les chunks SSE/NDJSON (`normalizeChunk`), streame (`consumeStream/consumeNdjsonStream`) et route via `GoToolkitAIBackend.getBackend`. WebLLM vit dans `public/js/webllm-worker.js` + `public/js/webllm-sw.js`.
- **Partage.** `public/js/share-worker-client.js` construit les URLs à partir de `GO_TOOLKIT_SHARE_API_URL(S)` (inclut `https://share.gotoolkit.workers.dev`). Le worker `workers/share-proxy` écrit en Firestore et limite via KV `RATE_LIMIT`; collections autorisées : `slides`, `timelines`, `diagrams`, `grids`, `voices`. Historique local : `public/js/share-history.js`. Capsules/brouillons : `public/js/idb-doc-store.js` + `public/js/capsule-drafts.js` (IndexedDB avec fallback `localStorage`).
- **Pont Excalidraw.** `src/connect/index.tsx` rend Excalidraw, force un thème clair, réutilise l’état courant pour appliquer une scène, normalise les éléments Mermaid (épaisseur/arrondi). Exposé via `window.GoToolkitExcalidraw` pour Draw.
- **Build/test.** `npm install` → `npm run build` (esbuild de `src/connect/index.tsx` vers `public/js/connect.bundle.js`). `npm start` sert `public/` sur le port 5000. `npm run test:playwright` lance `tests/grid-mock.spec.ts` sur `public/grid.html`.
- **Cache/version.** Mettre à jour `?v=2025.12.24.2` partout (liens launcher, includes `prompt.js`, navigation interne) quand les assets changent.
- **Workers.** `workers/openai-proxy` attend `OPENAI_API_KEY` + KV `RATE_LIMIT` ; gère CORS, taille, quotas IP. `workers/share-proxy` requiert `FIREBASE_SERVICE_ACCOUNT` JSON, `FIREBASE_PROJECT_ID` optionnel, `SHARE_ALLOWED_ORIGINS`, KV `RATE_LIMIT`. `workers/feedback-proxy` partage ces secrets/KV. Code compatible runtime Cloudflare uniquement.
- **Debug.** Inspecter `window.GoToolkit*` dans la console pour le backend IA, l’API Excalidraw, l’état du worker de partage ou les brouillons. L’état local est surtout sous `localStorage` (`go-toolkit-*`) et IndexedDB (`capsule-drafts`/`share-history`).
