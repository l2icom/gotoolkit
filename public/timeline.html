<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>PI Planning ‚Äì Proto OpenAI + vis-timeline</title>

    <!-- Vis Timeline -->
    <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css"
        type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --surface-soft: #f7f7f7;
            --border: #e5e7eb;
            --border-strong: #d1d5db;

            --primary: #2563eb;
            --primary-soft: rgba(37, 99, 235, 0.08);
            --primary-strong: #1d4ed8;

            --text: #111827;
            --muted: #8b8173;

            --feature: #2563eb;
            --enabler: #059669;
            --bug: #e11d48;
            --milestone: #f97316;

            --radius-lg: 16px;
            --radius-md: 999px;
            --radius-sm: 8px;

            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
            --app-font: "Inter", system-ui;
            --global-font-size: 14px;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            padding: 16px;
            background: #f7f7f7;
            color: var(--text);
            font-family: var(--app-font, "Inter");
        }

        .vis-item .vis-item-content {
            white-space: normal !important;
            word-break: break-word;
        }

        .app {
            max-width: 1180px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
            align-items: stretch;
            min-height: calc(100vh - 32px);
            height: calc(100vh - 32px);
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0;
            border-radius: 0;
            background: #f7f7f7;
            border: none;
            box-shadow: none;
        }

        .tabs {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
        }

        .tab {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .tab-actions {
            margin-left: auto;
            display: flex;
            gap: 4px;
        }

        .tab-btn-add,
        .tab-btn-delete {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #fff;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        h1 {
            margin: 0 0 4px;
            font-size: 19px;
        }

        .subtitle {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
        }

        /* Panneau gauche : OpenAI + JSON */
        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }

        textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 11px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        select,
        .input-small {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            padding: 4px 8px;
            font-size: 11px;
            background: var(--surface-soft);
        }

        select:focus,
        .input-small:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            background: var(--primary);
            color: #fff;
            transition:
                background 120ms ease,
                box-shadow 120ms ease,
                transform 80ms ease;
        }

        .btn-ghost {
            background: var(--surface-soft);
            color: var(--text);
            border-color: var(--border);
        }

        .btn:hover {
            background: var(--primary-strong);
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.32);
        }

        .btn-ghost:hover {
            background: #e5edff;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .btn[disabled] {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
        }

        .hint code {
            font-size: 10px;
            background: var(--surface-soft);
            border-radius: 6px;
            padding: 2px 4px;
        }

        /* Timeline + toolbar */
        .timeline-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1 1 auto;
            min-height: 0;
            height: 100%;
            width: auto;
            max-width: 100%;
            font-size: var(--global-font-size, 14px);
            aspect-ratio: var(--timeline-aspect-ratio, 16 / 9);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .header-buttons .btn {
            background: #ffffff;
            border-color: rgba(15, 23, 42, 0.08);
            color: #0f172a;
            padding: 0 16px;
            min-height: 36px;
            border-radius: 999px;
            font-size: 14px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: #fff;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 20px rgba(15, 23, 42, 0.2);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            min-width: 200px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-panel label {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-panel select,
        .menu-panel button {
            width: 100%;
        }

        .menu-panel button {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
        }

        .ratio-grid {
            display: flex;
            gap: 4px;
        }

        .ratio-grid button {
            flex: 1;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.25);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .menu-panel label {
            font-size: 11px;
            color: #475569;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-panel select,
        .menu-panel button {
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 6px 8px;
            font-size: 12px;
            background: var(--surface-soft);
            cursor: pointer;
            font-family: inherit;
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 4px;
        }

        .ratio-grid button {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .context-menu .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            min-width: 220px;
            position: relative;
            left: -10px;
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: flex;
            gap: 6px;
        }

        .ratio-grid button {
            flex: 1;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.25);
            padding: 12px;
            display: none;
            width: 220px;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .context-menu label {
            font-size: 12px;
            color: #475569;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .context-menu select {
            border-radius: 8px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            padding: 6px 8px;
            font-size: 12px;
            background: #f8fafc;
            font-family: inherit;
        }

        .context-menu .ratio-options {
            display: flex;
            gap: 6px;
        }

        .context-menu .ratio-options button {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #f3f4f6;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .header-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 800px;
            width: 100%;
        }

        .header-actions .header-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header-actions textarea {
            max-height: 30px;
            font-size: 14px;
        }

        .header-actions button {
            align-self: flex-start;
        }

        .menu-trigger {
            position: relative;
            display: inline-flex;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid rgba(15, 23, 42, 0.1);
            border-radius: 16px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.2);
            display: none;
            min-width: 220px;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .context-menu label,
        .context-menu button {
            font-size: 13px;
            color: var(--text);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 60;
        }

        .modal-overlay.open {
            display: flex;
        }

        .filter-modal {
            background: var(--surface);
            border-radius: 18px;
            padding: 16px 18px 20px;
            width: min(480px, 100%);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .filter-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .filter-modal h3 {
            margin: 0;
            font-size: 15px;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            color: var(--muted);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
        }

        .btn-group {
            display: inline-flex;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            overflow: hidden;
        }

        .type-filter {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin: 12px 0 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
        }

        .type-filter span {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 11px;
        }

        .type-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .type-filter-chip {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: background 120ms ease, color 120ms ease, border-color 120ms ease;
            background: transparent;
        }

        .type-filter-chip:hover {
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.2);
        }

        .btn-small {
            border: none;
            background: transparent;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 120ms ease, color 120ms ease;
        }

        .btn-small:hover {
            background: var(--primary-soft);
        }

        .btn-small-active {
            background: var(--primary-soft);
            color: var(--primary-strong);
        }

        #timeline {
            background: var(--surface-soft);
            border-radius: 12px;
            border: 1px solid var(--border);
            height: 100%;
            padding: 6px;
        }

        /* vis.js styling */
        .vis-labelset .vis-label {
            font-size: var(--global-font-size);
            color: var(--muted);
        }

        .vis-labelset .vis-label:nth-child(1) .vis-inner {
            font-weight: 600;
            color: #b45309;
        }

        .vis-item {
            border-radius: var(--radius-sm);
            border-width: 1px;
            font-size: var(--global-font-size);
            line-height: 1.2;
            padding-inline: 6px;
            cursor: pointer;
            background: #e5e7eb;
            border-color: #d1d5db;
            color: var(--text);
            transition:
                box-shadow 120ms ease,
                transform 80ms ease,
                background 120ms ease,
                border-color 120ms ease,
                color 120ms ease;
            white-space: normal;
            word-break: break-word;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        .vis-item.vis-range.type-training.vis-editable {
            padding-inline: 4px;
            padding-top: 2px;
            padding-bottom: 2px;
        }

        .vis-item.vis-range.type-training.vis-editable .vis-item-content {
            padding: 2px;
        }

        .vis-item:hover {
            background: #dbeafe;
            border-color: var(--primary);
        }

        .vis-item.vis-selected {
            background: rgba(37, 99, 235, 0.14);
            border-color: var(--primary-strong);
            color: #111827;
        }

        .vis-item.milestone-class {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        .type-feature {
            background: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.8);
            color: #1d4ed8;
        }

        .type-enabler {
            background: rgba(5, 150, 105, 0.1);
            border-color: rgba(5, 150, 105, 0.8);
            color: #047857;
        }

        .type-bug {
            background: rgba(225, 29, 72, 0.1);
            border-color: rgba(225, 29, 72, 0.85);
            color: #b91c1c;
        }

        .type-milestone {
            background: transparent;
            border: none;
            padding: 0;
            overflow: visible;
            min-width: 0;
        }

        .type-milestone .ms-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 2px 6px 2px 4px;
            border-radius: 999px;
            background: transparent;
            color: #9a3412;
            border: 1px solid rgba(249, 115, 22, 0.4);
        }

        .type-milestone .diamond {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            background: #fed7aa;
            border: 1px solid var(--milestone);
            transform: rotate(45deg);
            flex-shrink: 0;
        }

        .vis-time-axis .vis-text {
            font-size: 10px;
            color: var(--muted);
        }

        .vis-panel.vis-center,
        .vis-panel.vis-left {
            border-color: var(--border);
        }

        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="app-header">
            <div class="tabs-actions">
                <div id="viewTabs" class="tabs"></div>

                <div class="tab-actions">
                    <button class="tab-btn-add" id="addViewBtn" type="button" aria-label="Ajouter une vue">‚ûï</button>
                    <button class="tab-btn-delete" id="deleteViewBtn" type="button"
                        aria-label="Supprimer la vue active">üóëÔ∏è</button>
                </div>
                <div class="app-actions">
                    <button class="btn" id="openIaModal" aria-label="Ouvrir l'IA">‚ú®</button>
                    <div class="menu-trigger">
                        <button class="btn" id="optionsBtn" aria-label="Options d'affichage">üñåÔ∏è</button>
                        <div class="context-menu" id="optionsMenu">
                            <div class="menu-panel">
                                <label>
                                    Police
                                    <select id="fontSelect">
                                        <option value="Inter">Inter</option>
                                        <option value="Nunito">Nunito</option>
                                        <option value="Source Sans Pro">Source Sans Pro</option>
                                        <option value="Roboto">Roboto</option>
                                    </select>
                                </label>
                                <label>
                                    Taille (px)
                                    <select id="fontSizeInput">
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                    </select>
                                </label>
                                <label>
                                    Fond
                                    <select id="backgroundSelector">
                                        <option value="#f7f7f7">Gris clair</option>
                                        <option value="#ffffff">Blanc</option>
                                        <option value="transparent">Transparent</option>
                                        <option value="#f3f7ff">Bleu clair</option>
                                        <option value="#0f172a">Sombre</option>
                                    </select>
                                </label>
                                <div class="ratio-wrapper">
                                    <div class="ratio-label">Ratio</div>
                                    <div class="ratio-grid" id="ratioGrid">
                                        <button type="button" data-ratio="4:3">4:3</button>
                                        <button type="button" data-ratio="16:9">16:9</button>
                                        <button type="button" data-ratio="3:2">3:2</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- TIMELINE + TOOLBAR -->
        <div class="timeline-card">
            <div class="timeline-header">
                <div class="header-text">
                    <h1>Outil de planning ¬∑ OpenAI ready</h1>
                </div>
                <div class="header-buttons">

                </div>
            </div>

            <div class="toolbar">
                <div class="btn-group">
                    <button class="btn-small" id="btn-today">Aujourd'hui</button>
                </div>

                <div class="btn-group">
                    <button class="btn-small" id="btn-zoom-in">+</button>
                    <button class="btn-small" id="btn-fit">Auto</button>

                    <button class="btn-small" id="btn-zoom-out">‚àí</button>
                </div>

                <div class="btn-group">
                    <button class="btn-small" id="btn-scale-day">Jour</button>

                    <button class="btn-small btn-small-active" id="btn-scale-week">Semaine</button>
                    <button class="btn-small" id="btn-scale-month">Mois</button>
                </div>

                <button class="btn-small" id="btn-delete-selected">
                    üóëÔ∏è
                </button>
            </div>

            <div id="timeline"></div>
        </div>

        <div class="modal-overlay" id="iaModalOverlay" role="dialog" aria-modal="true" aria-labelledby="iaModalTitle">
            <div class="filter-modal">
                <div class="modal-header">
                    <h3 id="iaModalTitle">Assistant IA</h3>
                    <button class="modal-close" id="iaModalClose" type="button" aria-label="Fermer l'IA">√ó</button>
                </div>
                <div class="header-actions">
                    <div class="header-row">
                        <label for="mode">Mode d'action</label>
                        <select id="mode">
                            <option value="create">üÜï Cr√©er un planning √† partir du prompt</option>
                            <option value="modify">‚úèÔ∏è Modifier le planning actuel avec le prompt</option>
                        </select>
                    </div>
                    <div class="header-row">
                        <label for="prompt">Prompt envoy√© √† OpenAI</label>
                        <textarea id="prompt" rows="4"
                            placeholder="Exemple : Cr√©e un planning PI de 10 semaines..."></textarea>
                    </div>
                    <button class="btn" id="btn-call">
                        <span>‚ú® Envoyer</span>
                    </button>
                </div>
            </div>
        </div>

        <input type="file" id="importJsonInput" accept="application/json" style="display:none">
        <script>
            // ============================================================
            // 1. Schema JSON ¬∑ planning-v1 (doc d√©veloppeur)
            // ============================================================
            /*
                OpenAI doit renvoyer un objet de forme :
    
                {
                  "timeline": {          // optionnel
                    "start": "2025-01-01",
                    "end":   "2025-03-31"
                  },
                  "groups": [
                    { "id": "milestones", "label": "Jalons PI" },
                    { "id": "team-alpha", "label": "Team Alpha ‚Äì Core Engine" },
                    ...
                  ],
                  "items": [
                    // jalon ponctuel
                    {
                      "id": "ms-1",
                      "groupId": "milestones",
                      "label": "System Demo 1",
                      "kind": "milestone",
                      "date": "2025-01-15"
                    },
                    // t√¢che avec d√©but / fin
                    {
                      "id": "it-1",
                      "groupId": "team-alpha",
                      "label": "Feature X",
                      "kind": "feature",   // "feature" | "enabler" | "bug" | "other"
                      "start": "2025-01-05",
                      "end": "2025-02-02"
                    }
                  ]
                }
    
                ‚Üí Ce fichier se charge de mapper ce JSON vers vis-timeline,
                  et permet aussi de r√©exporter le planning dans ce format.
            */

            // ============================================================
            // 2. Setup vis-timeline (groups + items)
            // ============================================================
            var DataSet = vis.DataSet;
            var Timeline = vis.Timeline;

            var container = document.getElementById("timeline");

            var groups = new DataSet();
            var items = new DataSet();
            items.on("add", persistCurrentPlanning);
            items.on("update", persistCurrentPlanning);
            items.on("remove", persistCurrentPlanning);
            groups.on("add", persistCurrentPlanning);
            groups.on("update", persistCurrentPlanning);
            groups.on("remove", persistCurrentPlanning);

            var now = new Date();
            var oneDay = 24 * 60 * 60 * 1000;
            var oneWeek = 7 * oneDay;
            var snapMode = "week";
            var typeDefinitions = {};
            var typeFilterState = {};
            var typeFilterChips = document.getElementById("typeFilterChips");
            var timeline = null;
            var OPENAI_PROXY_URL = "https://openai.tranxq.workers.dev/v1/chat/completions";
            var OPENAI_MODEL = "gpt-5-nano";
            var OPENAI_TEMPERATURE = 1;
            var LOCAL_STORAGE_KEY = "timeline-planning-state";
            var typeStyleElement = document.createElement("style");
            typeStyleElement.id = "timeline-type-styles";
            document.head.appendChild(typeStyleElement);
            var persistenceLocked = false;

            function sanitizeTypeId(raw) {
                var id = (raw || "").toLowerCase().trim();
                if (!id) return "feature";
                return id.replace(/[^a-z0-9_-]/g, "-");
            }

            function rebuildTypeStyles() {
                var rules = Object.keys(typeDefinitions).map(function (key) {
                    var def = typeDefinitions[key];
                    return [
                        ".vis-item.type-" + def.id + " {",
                        "  background: " + def.background + ";",
                        "  border-color: " + def.border + ";",
                        "  color: " + def.color + ";",
                        "}"
                    ].join("\n");
                });
                typeStyleElement.textContent = rules.join("\n");
            }

            function ensureTypeDefinition(def) {
                var base = def || {};
                var id = sanitizeTypeId(base.id || base.name || base.kind);
                var colors = def && def.colors ? def.colors : {};
                typeDefinitions[id] = {
                    id: id,
                    label: base.label || base.name || id,
                    background: colors.background || base.background || "rgba(229, 231, 235, 0.9)",
                    border: colors.border || base.border || "rgba(156, 163, 175, 0.9)",
                    color: colors.text || base.color || "#111827"
                };
                if (!Object.prototype.hasOwnProperty.call(typeFilterState, id)) {
                    typeFilterState[id] = true;
                }
                rebuildTypeStyles();
                return id;
            }

            function applyTypeDefinitions(defs) {
                if (!Array.isArray(defs)) return;
                defs.forEach(function (def) {
                    ensureTypeDefinition({
                        id: def.id,
                        label: def.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    });
                });
            }

            function persistPlanningState(planning) {
                if (!planning) return;
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(planning));
                } catch (err) {
                    console.warn("Impossible de sauvegarder le planning", err);
                }
            }

            function loadPersistedPlanning() {
                try {
                    var raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (err) {
                    console.warn("Impossible de lire le planning sauvegard√©", err);
                    return null;
                }
            }

            function persistCurrentPlanning() {
                if (persistenceLocked) return;
                persistPlanningState(exportPlanningToJson());
            }

            function getActiveTypeIds() {
                return Object.keys(typeFilterState).filter(function (key) {
                    return !!typeFilterState[key];
                });
            }

            function refreshTypeFilterUI() {
                if (!typeFilterChips) return;
                typeFilterChips.innerHTML = "";
                Object.keys(typeDefinitions).forEach(function (key) {
                    var def = typeDefinitions[key];
                    if (!def) return;
                    var isActive = !!typeFilterState[key];
                    var chip = document.createElement("button");
                    chip.type = "button";
                    chip.className = "type-filter-chip" + (isActive ? " active" : "");
                    chip.textContent = def.label;
                    chip.dataset.typeId = key;
                    chip.setAttribute("aria-pressed", isActive ? "true" : "false");
                    chip.style.borderColor = def.border;
                    chip.style.background = isActive ? def.background : "transparent";
                    chip.style.color = isActive ? def.color : "var(--muted)";
                    chip.addEventListener("click", function () {
                        typeFilterState[key] = !typeFilterState[key];
                        refreshTypeFilterUI();
                        updateTimelineFilter();
                    });
                    typeFilterChips.appendChild(chip);
                });
            }

            function updateTimelineFilter() {
                var activeTypes = getActiveTypeIds();
                var allowAll = activeTypes.length === 0;
                items.get().forEach(function (item) {
                    var kind = sanitizeTypeId(item.kind || item.type || "");
                    if (!kind) return;
                    var shouldBeVisible = allowAll || activeTypes.indexOf(kind) >= 0;
                    var isHidden = !!item.hidden;
                    if (isHidden === !shouldBeVisible) return;
                    items.update({ id: item.id, hidden: !shouldBeVisible });
                });
            }

            var options = {
                stack: true,
                orientation: "top",
                groupHeightMode: "auto",
                editable: {
                    add: true,
                    updateTime: true,
                    updateGroup: true,
                    remove: false
                },
                selectable: true,
                multiselect: false,
                margin: { item: 8, axis: 10 },
                snap: function (date) {
                    var d = new Date(date);
                    if (snapMode === "day") {
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    if (snapMode === "month") {
                        d.setDate(1);
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    var day = d.getDay();
                    var diff = (day + 6) % 7;
                    d.setDate(d.getDate() - diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                },
                template: function (item) {
                    if (item.kind === "milestone") {
                        var text = (item.content || "").trim() || "Jalon";
                        return (
                            '<div class="ms-pill">' +
                            '<span class="diamond"></span>' +
                            "<span>" + text + "</span>" +
                            "</div>"
                        );
                    }
                    return item.content || "";
                },
                timeAxis: {
                    scale: "week",
                    step: 1
                }
            };

            timeline = new Timeline(container, items, groups, options);

            var iaModalOverlay = document.getElementById("iaModalOverlay");
            var iaModalButton = document.getElementById("openIaModal");
            var iaModalClose = document.getElementById("iaModalClose");

            function openIaModal() {
                if (iaModalOverlay) iaModalOverlay.classList.add("open");
            }

            function closeIaModal() {
                if (iaModalOverlay) iaModalOverlay.classList.remove("open");
            }

            if (iaModalButton) {
                iaModalButton.addEventListener("click", openIaModal);
            }
            if (iaModalClose) {
                iaModalClose.addEventListener("click", closeIaModal);
            }
            if (iaModalOverlay) {
                iaModalOverlay.addEventListener("click", function (event) {
                    if (event.target === iaModalOverlay) {
                        closeIaModal();
                    }
                });
            }

            var CREATE_SYSTEM_TEMPLATE =
                "Tu es un assistant qui va g√©n√©rer un planning √† partir des instructions suivantes {{(contenu du id=\"prompt\") }}\\n\\n" +
                "R√©ponds toujours avec un JSON qui contient :\\n" +
                "- `types` : un tableau d‚Äôobjets `{ id, label, background, border, color }` pour d√©crire des types d'actions diff√©rentes. Ajouter un type sp√©cifique aux milestones.\\n" +
                "- `timeline` : `{ start, end }` au format ISO (YYYY-MM-DD).\\n" +
                "- `groups` : chaque groupe d'actions avec { id, label }.\\n" +
                "- `items` : chaque item { id, groupId, label, kind, start?, end?, date? }. Les jalons sont des `kind: \"milestone\"`.\\n" +
                "- Donne des couleurs diff√©rentes par type.\\n" +
                "- Sors uniquement le JSON, sans explication ni texte additionnel.";

            var MODIFY_SYSTEM_TEMPLATE =
                "Tu es un assistant qui modifie √† partir du contexte suivant {{(contenu du id=\"prompt\") }}\\n\\n" +
                "le planning de d√©part suivant en conservant les ids existants : {{(contenu au format JSON du planning existant)}}\\n\\n" +
                "R√©ponds toujours avec un JSON qui contient :\\n" +
                "- `types` : un tableau d‚Äôobjets `{ id, label, background, border, color }` pour d√©crire des types d'actions diff√©rentes.\\n" +
                "- `timeline` : `{ start, end }` au format ISO (YYYY-MM-DD).\\n" +
                "- `groups` : chaque groupe d'actions avec { id, label }.\\n" +
                "- `items` : chaque item { id, groupId, label, kind, start?, end?, date? }.\\n" +
                "- Les items ponctuels sont des `kind: \"milestone\"` et `groupId: \"milestones\"`.\\n" +
                "- Sors seulement le JSON.";

            var optionsBtn = document.getElementById("optionsBtn");
            var optionsMenu = document.getElementById("optionsMenu");
            var fontSelect = document.getElementById("fontSelect");
            var fontSizeInput = document.getElementById("fontSizeInput");
            var backgroundSelector = document.getElementById("backgroundSelector");
            var ratioGrid = document.getElementById("ratioGrid");
            var timelineCard = document.querySelector(".timeline-card");
            var fontChoices = [
                "Inter",
                "Nunito",
                "Source Sans Pro",
                "Roboto"
            ];
            var fontSizeChoices = [9, 10, 11, 12, 13, 14, 15, 16];

            function renderFontOptions() {
                if (!fontSelect) return;
                fontSelect.innerHTML = "";
                fontChoices.forEach(function (choice) {
                    var option = document.createElement("option");
                    option.value = choice;
                    option.textContent = choice + " ¬∑ Aa Bb";
                    option.style.fontFamily = choice;
                    fontSelect.appendChild(option);
                });
            }

            function renderFontSizeOptions() {
                if (!fontSizeInput) return;
                fontSizeInput.innerHTML = "";
                fontSizeChoices.forEach(function (size) {
                    var option = document.createElement("option");
                    option.value = size;
                    option.textContent = size + " px";
                    option.style.fontSize = size + "px";
                    fontSizeInput.appendChild(option);
                });
            }

            function closeContextMenus() {
                if (optionsMenu) optionsMenu.classList.remove("open");
            }

            if (optionsBtn && optionsMenu) {
                optionsBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    syncFontControls();
                    optionsMenu.classList.toggle("open");
                });
            }

            document.addEventListener("click", function (event) {
                if (optionsMenu && !optionsMenu.contains(event.target) && optionsBtn !== event.target) {
                    optionsMenu.classList.remove("open");
                }
            });

            function applyFont(font) {
                document.documentElement.style.setProperty("--app-font", font);
            }

            function updateFontSize(size) {
                var normalized = parseInt(size, 10);
                if (isNaN(normalized)) {
                    normalized = 14;
                }
                var value = normalized + "px";
                document.documentElement.style.setProperty("--global-font-size", value);
                document.body.style.fontSize = value;
                if (timelineCard) timelineCard.style.fontSize = value;
                if (container) container.style.fontSize = value;
            }

            function syncFontControls() {
                var computed = getComputedStyle(document.documentElement);
                if (fontSelect) {
                    var rawFont = (computed.getPropertyValue("--app-font") || "").split(",")[0].trim();
                    rawFont = rawFont.replace(/^["']|["']$/g, "");
                    if (rawFont) {
                        fontSelect.value = rawFont;
                    }
                }
                if (fontSizeInput) {
                    var rawSize = computed.getPropertyValue("--global-font-size").trim();
                    var calculated = parseInt(rawSize, 10);
                    if (isNaN(calculated)) {
                        calculated = parseInt(window.getComputedStyle(document.body).fontSize, 10);
                    }
                    if (!isNaN(calculated)) {
                        fontSizeInput.value = calculated;
                    }
                }
            }

            function applyBackground(value) {
                var bodyValue = "#f7f7f7";
                var cardValue = "";
                if (value === "#f7f7f7") {
                    bodyValue = "#f7f7f7";
                    cardValue = "var(--surface)";
                } else if (value === "transparent") {
                    bodyValue = "#f7f7f7";
                    cardValue = "rgba(255, 255, 255, 0.6)";
                } else if (value === "#ffffff") {
                    bodyValue = "#ffffff";
                    cardValue = "#ffffff";
                } else if (value === "#f3f7ff") {
                    bodyValue = "radial-gradient(circle at top left, #cce1ff, #f3f7ff)";
                    cardValue = "#f3f7ff";
                } else if (value === "#0f172a") {
                    bodyValue = "radial-gradient(circle at top left, #172554, #0f172a)";
                    cardValue = "#0f172a";
                }
                document.body.style.background = bodyValue;
                if (timelineCard) {
                    timelineCard.style.background = cardValue || "var(--surface)";
                }
            }

            function updateTimelineAspect(ratio) {
                if (!timelineCard || !ratio) return;
                var value = ratio.replace(":", " / ");
                timelineCard.dataset.ratio = ratio;
                timelineCard.style.setProperty("--timeline-aspect-ratio", value);
                timelineCard.style.aspectRatio = value;
            }

            function applyRatio(ratio) {
                updateTimelineAspect(ratio);
            }

            renderFontOptions();
            renderFontSizeOptions();

            if (fontSelect) fontSelect.addEventListener("change", function () {
                applyFont(this.value);
            });
            if (fontSizeInput) fontSizeInput.addEventListener("change", function () {
                updateFontSize(this.value);
            });
            if (backgroundSelector) backgroundSelector.addEventListener("change", function () {
                applyBackground(this.value);
            });
            if (ratioGrid) {
                ratioGrid.addEventListener("click", function (event) {
                    var ratio = event.target.dataset.ratio;
                    if (ratio) applyRatio(ratio);
                });
            }

            applyRatio("16:9");

            if (backgroundSelector) {
                applyBackground(backgroundSelector.value);
            }

            syncFontControls();

            var viewTabs = document.getElementById("viewTabs");
            var addViewBtn = document.getElementById("addViewBtn");
            var deleteViewBtn = document.getElementById("deleteViewBtn");
            var views = ["Vue 1"];
            var activeViewIndex = 0;

            function renderViewTabs() {
                if (!viewTabs) return;
                viewTabs.innerHTML = "";
                views.forEach(function (view, index) {
                    var btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "tab" + (index === activeViewIndex ? " active" : "");
                    btn.textContent = view;
                    btn.dataset.index = index;
                    btn.addEventListener("click", function () {
                        activeViewIndex = Number(this.dataset.index);
                        renderViewTabs();
                    });
                    viewTabs.appendChild(btn);
                });
            }

            function addView() {
                views.push("Vue " + (views.length + 1));
                activeViewIndex = views.length - 1;
                renderViewTabs();
            }

            function deleteView() {
                if (views.length <= 1) return;
                views.splice(activeViewIndex, 1);
                activeViewIndex = Math.min(activeViewIndex, views.length - 1);
                renderViewTabs();
            }

            addViewBtn && addViewBtn.addEventListener("click", addView);
            deleteViewBtn && deleteViewBtn.addEventListener("click", deleteView);
            renderViewTabs();
            // ============================================================
            // 3. Inline labeling via prompt (double-clic)
            // ============================================================
            function editItemLabel(itemId) {
                var it = items.get(itemId);
                if (!it) return;
                var current = (it.content || "").trim();
                var label = window.prompt("Saisis un libell√©", current);
                if (label === null) return;
                label = label.trim();
                if (!label) {
                    var keeper = current || itemId;
                    if (confirm("Supprimer ¬´ " + keeper + " ¬ª ?")) {
                        items.remove(itemId);
                    }
                    return;
                }
                items.update({ id: itemId, content: label });
            }

            // Double-clic : √©diter ou cr√©er
            timeline.on("doubleClick", function (props) {
                if (props.item) {
                    editItemLabel(props.item);
                    return;
                }

                if (props.time && props.group) {
                    var start = new Date(props.time);
                    var end = new Date(start.getTime() + oneWeek);
                    var id;
                    var newItem;

                    if (props.group === "milestones") {
                        id = "ms-" + Date.now();
                        newItem = {
                            id: id,
                            group: "milestones",
                            content: "",
                            start: start,
                            type: "point",
                            kind: "milestone",
                            className: "type-milestone milestone-class"
                        };
                    } else {
                        id = "it-" + Date.now();
                        newItem = {
                            id: id,
                            group: props.group,
                            content: "",
                            start: start,
                            end: end,
                            kind: "feature",
                            className: "type-feature"
                        };
                    }

                    items.add(newItem);
                    setTimeout(function () { editItemLabel(id); }, 30);
                }
            });

            // Ajout natif vis ‚Üí on force notre logique + label prompt
            options.onAdd = function (item, callback) {
                callback(null);
                var start = item.start || item.end || new Date();
                var groupId = item.group || "team-alpha";
                var id, newItem;

                if (groupId === "milestones") {
                    id = "ms-" + Date.now();
                    newItem = {
                        id: id,
                        group: "milestones",
                        content: "",
                        start: start,
                        type: "point",
                        kind: "milestone",
                        className: "type-milestone milestone-class"
                    };
                } else {
                    id = "it-" + Date.now();
                    newItem = {
                        id: id,
                        group: groupId,
                        content: "",
                        start: start,
                        end: new Date(start.getTime() + oneWeek),
                        kind: "feature",
                        className: "type-feature"
                    };
                }
                items.add(newItem);
                setTimeout(function () { editItemLabel(id); }, 30);
            };

            timeline.setOptions(options);
            updateTimelineFilter();

            // ============================================================
            // 4. S√©lection et suppression simple
            // ============================================================
            var selectedItemId = null;
            var btnDeleteSelected = document.getElementById("btn-delete-selected");

            timeline.on("select", function (props) {
                selectedItemId = (props.items && props.items.length) ? props.items[0] : null;
            });

            btnDeleteSelected.addEventListener("click", function () {
                if (!selectedItemId) return;
                var it = items.get(selectedItemId);
                var label = (it && it.content) ? it.content : selectedItemId;
                if (confirm("Supprimer ¬´ " + label + " ¬ª ?")) {
                    items.remove(selectedItemId);
                    selectedItemId = null;
                }
            });

            // ============================================================
            // 5. Fonctions JSON <-> vis-timeline
            // ============================================================
            function isoToDate(str) {
                if (!str) return null;
                var d = new Date(str);
                return isNaN(d.getTime()) ? null : d;
            }

            function toDate(iso) {
                var d = isoToDate(iso);
                if (d) return d;
                var fallback = new Date(iso);
                return isNaN(fallback.getTime()) ? new Date() : fallback;
            }

            function daysBetween(start, end) {
                if (!start || !end) return 0;
                return Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
            }

            function dateToIso(d) {
                if (!d) return null;
                return new Date(d).toISOString().slice(0, 10);
            }

            function applyPlanningFromJson(planning) {
                if (!planning) return;

                persistenceLocked = true;
                try {
                    applyTypeDefinitions(planning.types);
                    // groups
                    if (Array.isArray(planning.groups)) {
                        groups.clear();
                        planning.groups.forEach(function (g, idx) {
                            groups.add({
                                id: g.id,
                                content: g.label || g.id || ("Group " + (idx + 1))
                            });
                        });
                    }

                    // items
                    if (Array.isArray(planning.items)) {
                        items.clear();
                        planning.items.forEach(function (it) {
                            var kind = sanitizeTypeId(it.type || it.kind || "feature");
                            var base = {
                                id: it.id || ("it-" + Date.now() + Math.random()),
                                group: it.groupId,
                                content: it.label || "",
                                kind: kind
                            };
                            ensureTypeDefinition({ id: kind });

                            if (base.kind === "milestone") {
                                base.start = isoToDate(it.date || it.start);
                                base.type = "point";
                                base.className = "type-milestone milestone-class";
                            } else {
                                base.start = isoToDate(it.start);
                                base.end = isoToDate(it.end) || new Date(base.start.getTime() + oneWeek);
                                base.className = "type-" + base.kind;
                            }
                            items.add(base);
                        });
                    }

                    // timeline range
                    var rangeStart = planning.timeline && planning.timeline.start
                        ? isoToDate(planning.timeline.start)
                        : null;
                    var rangeEnd = planning.timeline && planning.timeline.end
                        ? isoToDate(planning.timeline.end)
                        : null;

                    if (rangeStart && rangeEnd) {
                        timeline.setWindow(rangeStart, rangeEnd, { animation: false });
                    } else {
                        timeline.fit({ animation: false });
                    }
                    refreshTypeFilterUI();
                    updateTimelineFilter();
                } finally {
                    persistenceLocked = false;
                }
                persistPlanningState(planning);
            }

            function exportPlanningToJson() {
                var g = groups.get();
                var it = items.get();

                var minStart = null;
                var maxEnd = null;

                var outGroups = g.map(function (gr) {
                    return {
                        id: gr.id,
                        label: gr.content
                    };
                });

                var outItems = it.map(function (item) {
                    if (item.kind === "milestone") {
                        if (item.start) {
                            var ds = new Date(item.start);
                            if (!minStart || ds < minStart) minStart = ds;
                            if (!maxEnd || ds > maxEnd) maxEnd = ds;
                        }
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: "milestone",
                            date: dateToIso(item.start)
                        };
                    } else {
                        var ds2 = item.start ? new Date(item.start) : null;
                        var de2 = item.end ? new Date(item.end) : null;
                        if (ds2) {
                            if (!minStart || ds2 < minStart) minStart = ds2;
                        }
                        if (de2) {
                            if (!maxEnd || de2 > maxEnd) maxEnd = de2;
                        } else if (ds2) {
                            if (!maxEnd || ds2 > maxEnd) maxEnd = ds2;
                        }

                        var kind = item.kind || "feature";
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: kind,
                            start: dateToIso(item.start),
                            end: dateToIso(item.end)
                        };
                    }
                });

                var planning = {
                    timeline: {
                        start: dateToIso(minStart) || dateToIso(new Date()),
                        end: dateToIso(maxEnd) || dateToIso(new Date())
                    },
                    groups: outGroups,
                    items: outItems
                };

                return planning;
            }

            function formatColorForType(typeId) {
                var def = typeDefinitions[typeId];
                if (def && def.background) return def.border || def.background;
                return "    ";
            }

            // ============================================================
            // 6. Toolbar timeline
            // ============================================================
            document.getElementById("btn-today").addEventListener("click", function () {
                var range = 4 * oneWeek;
                var center = new Date();
                timeline.setWindow(
                    new Date(center.getTime() - range / 2),
                    new Date(center.getTime() + range / 2),
                    { animation: true }
                );
            });

            document.getElementById("btn-fit").addEventListener("click", function () {
                timeline.fit({ animation: true });
            });

            document.getElementById("btn-zoom-in").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() + interval * 0.25);
                var newEnd = new Date(r.end.getTime() - interval * 0.25);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            document.getElementById("btn-zoom-out").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() - interval * 0.5);
                var newEnd = new Date(r.end.getTime() + interval * 0.5);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            var btnWeek = document.getElementById("btn-scale-week");
            var btnDay = document.getElementById("btn-scale-day");
            var btnMonth = document.getElementById("btn-scale-month");
            var currentScaleMode = "week";

            function setScale(mode) {
                var normalized = (mode === "day" || mode === "month") ? mode : "week";
                currentScaleMode = normalized;
                snapMode = normalized;

                btnWeek.classList.toggle("btn-small-active", normalized === "week");
                btnDay.classList.toggle("btn-small-active", normalized === "day");
                btnMonth.classList.toggle("btn-small-active", normalized === "month");

                var timeAxis = (normalized === "day")
                    ? { scale: "day", step: 1 }
                    : (normalized === "month")
                        ? { scale: "month", step: 1 }
                        : { scale: "week", step: 1 };

                timeline.setOptions({
                    timeAxis: timeAxis,
                    snap: options.snap
                });
            }

            btnWeek.addEventListener("click", function () { setScale("week"); });
            btnDay.addEventListener("click", function () { setScale("day"); });
            btnMonth.addEventListener("click", function () { setScale("month"); });

            function detectScaleFromRange(start, end) {
                if (!start || !end) return null;
                var diff = end.getTime() - start.getTime();
                if (diff <= 0) return null;
                var days = diff / oneDay;
                if (days <= 21) return "day";
                if (days <= 90) return "week";
                return "month";
            }

            timeline.on("rangechanged", function (props) {
                var autoMode = detectScaleFromRange(props.start, props.end);
                if (autoMode && autoMode !== currentScaleMode) {
                    setScale(autoMode);
                }
            });

            // ============================================================
            // 7. Panneau OpenAI
            // ============================================================
            var txtPrompt = document.getElementById("prompt");
            var selectMode = document.getElementById("mode");
            var btnCall = document.getElementById("btn-call");
            var waitingTimerId = null;
            var waitingCounter = 60;
            var iaModalButtonDefaultLabel = iaModalButton
                ? iaModalButton.textContent.trim()
                : "‚ú®";

            function updateIaButtonLabel(isLoading, counter) {
                if (!iaModalButton) return;
                if (isLoading) {
                    var baseLabel = iaModalButtonDefaultLabel ? iaModalButtonDefaultLabel + " " : "";
                    var displayCounter = typeof counter === "number" ? counter : waitingCounter;
                    iaModalButton.textContent = baseLabel + "‚è≥ Attente " + displayCounter + "s";
                } else {
                    iaModalButton.textContent = iaModalButtonDefaultLabel;
                }
            }

            function stopWaitingTimer() {
                if (waitingTimerId) {
                    clearInterval(waitingTimerId);
                    waitingTimerId = null;
                }
                updateIaButtonLabel(false);
            }

            function startWaitingTimer() {
                stopWaitingTimer();
                waitingCounter = 60;
                updateIaButtonLabel(true, waitingCounter);
                waitingTimerId = setInterval(function () {
                    waitingCounter--;
                    if (waitingCounter < 0) {
                        waitingCounter = 60;
                    }
                    updateIaButtonLabel(true, waitingCounter);
                }, 1000);
            }

            function fillPromptTemplate(template, instructions, planningJson) {
                var text = template.replace("{{(contenu du id=\"prompt\") }}", instructions || "");
                if (template.indexOf("{{(contenu au format JSON du planning existant)}}") >= 0) {
                    text = text.replace("{{(contenu au format JSON du planning existant)}}", planningJson || "");
                }
                return text;
            }

            async function callOpenAI(messages) {
                var headers = {
                    "Content-Type": "application/json"
                };
                try {
                    console.log(
                        "OpenAI request content",
                        messages.map(function (m) {
                            return "[" + m.role + "] " + (m.content || "");
                        })
                    );
                    var response = await fetch(OPENAI_PROXY_URL, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            model: OPENAI_MODEL,
                            temperature: OPENAI_TEMPERATURE,
                            messages: messages
                        })
                    });
                    if (!response.ok) {
                        var errBody = await response.text();
                        throw new Error(errBody);
                    }
                    var payload = await response.json();
                    var choice = (payload.choices && payload.choices[0]) || {};
                    var messageText = (choice.message && choice.message.content) || choice.text || "";
                    console.log("OpenAI received text", messageText);
                    return messageText;
                } catch (err) {
                    console.error("Erreur OpenAI", err);
                    alert("Impossible de contacter OpenAI. V√©rifie que le proxy est accessible.");
                    return null;
                }
            }

            btnCall.addEventListener("click", async function () {
                var mode = selectMode.value;
                var promptText = txtPrompt.value.trim();

                if (!promptText) {
                    alert("Ajoute un prompt avant d'appeler OpenAI üôÇ");
                    txtPrompt.focus();
                    return;
                }

                var currentPlanning = null;
                var planningJson = "";
                if (mode === "modify") {
                    currentPlanning = exportPlanningToJson();
                    planningJson = JSON.stringify(currentPlanning, null, 2);
                }

                var systemContent = fillPromptTemplate(
                    mode === "modify" ? MODIFY_SYSTEM_TEMPLATE : CREATE_SYSTEM_TEMPLATE,
                    promptText,
                    planningJson
                );

                var payload = {
                    schema: "planning-v1",
                    mode: mode,
                    prompt: promptText,
                    planning: currentPlanning
                };

                var messages = [
                    { role: "system", content: systemContent },
                    { role: "user", content: JSON.stringify(payload, null, 2) }
                ];

                startWaitingTimer();
                btnCall.disabled = true;
                closeIaModal();
                try {
                    var aiResponse = await callOpenAI(messages);
                    if (!aiResponse) return;
                    var normalized = aiResponse.trim();
                    console.log("OpenAI response body", normalized);
                    var planning;
                    try {
                        planning = JSON.parse(normalized);
                    } catch (err) {
                        console.error("JSON OpenAI invalide", err);
                        alert("R√©ponse OpenAI invalide : JSON attendu.");
                        return;
                    }
                    applyPlanningFromJson(planning);
                } finally {
                    btnCall.disabled = false;
                    stopWaitingTimer();
                }
            });

            // Initial : vue vide ou planning persist√© + focus prompt
            var persistedPlanning = loadPersistedPlanning();
            if (persistedPlanning) {
                applyPlanningFromJson(persistedPlanning);
            } else {
                timeline.setWindow(
                    new Date(now.getTime() - 2 * oneWeek),
                    new Date(now.getTime() + 6 * oneWeek),
                    { animation: false }
                );
            }
            setScale("week");
            txtPrompt.focus();
        </script>
</body>

</html>