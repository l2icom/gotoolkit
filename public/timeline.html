<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Go-Toolkit - Go-Timeline</title>

    <!-- Vis Timeline -->
    <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css"
        type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --surface-soft: #f7f7f7;
            --border: #e5e7eb;
            --border-strong: #d1d5db;
            --timeline-background: #ffffff;

            --primary: #2a7a57;
            --primary-soft: rgba(42, 122, 87, 0.17);
            --primary-strong: #1f4f3d;

            --text: #111827;
            --muted: #8b8173;

            --radius-lg: 16px;
            --radius-md: 999px;
            --radius-sm: 10px;

            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
            --app-font: "Inter", system-ui;
            --global-font-size: 14px;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            padding: 4px;
            background: #f7f7f7;
            color: var(--text);
            font-family: var(--app-font, "Inter");
        }

        .vis-item .vis-item-content {
            white-space: normal !important;
            word-break: break-word;
        }


        .type-milestone .vis-item-content {
            margin-left: 10 px;
        }


        .app {
            max-width: 1180px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
            min-height: calc(100vh - 32px);
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            width: 100%;
            max-width: 1180px;
            margin: 4px 0 auto;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }

        .tabs {
            flex: 1;
            min-width: 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tabs-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        .ia-header-actions {
            width: 100%;
        }

        .tab {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .context-menu.file-menu {
            padding: 0;
            margin: 0;
            transform: translateX(10px);
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .tab-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tab-btn-add,
        .tab-btn-delete {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #fff;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        h1 {
            margin: 0 0 4px;
            font-size: 19px;
        }

        .subtitle {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
        }

        /* Panneau gauche : OpenAI + JSON */
        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }

        textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 11px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
            resize: vertical;
            min-height: 80px;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        select,
        .input-small {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            padding: 4px 8px;
            font-size: 11px;
            background: var(--surface-soft);
        }

        select:focus,
        .input-small:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            background: var(--primary);
            color: #fff;
        }

        .white-btn {
            border-color: rgba(15, 23, 42, 0.2);
            background: #fff;
            color: #0f172a;
            margin-right: 6px;
        }

        .white-btn:hover,
        .white-btn:focus-visible {
            border-color: #2a7a57;
            background: #fff;
            color: #2a7a57;
            box-shadow: none;
        }

        #switchToIndex:hover,
        #switchToIndex:focus-visible {
            color: #0f172a;
            border-color: #2a7a57;
            box-shadow: none;
        }

        .btn-ghost {
            background: var(--surface-soft);
            color: var(--text);
            border-color: var(--border);
        }

        .btn:hover {
            box-shadow: 0 6px 18px rgba(42, 122, 87, 0.32);
        }

        #switchToIndex:hover {
            box-shadow: none;
        }

        .btn-ghost:hover {
            background: #e5edff;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .btn[disabled] {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
        }

        .hint code {
            font-size: 10px;
            background: var(--surface-soft);
            border-radius: 6px;
            padding: 2px 4px;
        }

        /* Timeline + toolbar */
        .timeline-card {
            background: var(--timeline-background);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 0 1 auto;
            min-height: 0;
            height: auto;
            width: 100%;
            max-width: 100%;
            font-size: var(--global-font-size, 14px);
            aspect-ratio: var(--timeline-aspect-ratio, 16 / 9);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .header-buttons .btn {
            background: #ffffff;
            border-color: rgba(15, 23, 42, 0.08);
            color: #0f172a;
            padding: 0 16px;
            min-height: 36px;
            border-radius: 999px;
            font-size: 14px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: #fff;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 12px 20px rgba(15, 23, 42, 0.2);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            min-width: 200px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-panel label {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-panel select,
        .menu-panel button {
            width: 100%;
        }

        .menu-panel button {
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            background: #f8fafc;
            padding: 6px 10px;
            font-size: 13px;
            cursor: pointer;
        }

        .ratio-grid {
            display: flex;
            gap: 4px;
        }

        .ratio-grid button {
            flex: 1;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.25);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .menu-panel label {
            font-size: 11px;
            color: #475569;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-panel select,
        .menu-panel button {
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 6px 8px;
            font-size: 12px;
            background: var(--surface-soft);
            cursor: pointer;
            font-family: inherit;
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 4px;
        }

        .ratio-grid button {
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.2);
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .context-menu .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            min-width: 220px;
            position: relative;
            left: -10px;
        }

        #fileMenu .menu-panel {
            padding: 0;
            gap: 0;
        }

        .info-popup {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }

        .info-popup.open {
            display: flex;
        }

        .info-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .info-card strong {
            font-size: 18px;
        }

        .info-close {
            align-self: flex-end;
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
        }

        .tour-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            display: none;
            z-index: 120;
            pointer-events: auto;
        }

        .tour-overlay.visible {
            display: block;
        }

        .tour-overlay.dimmed {
            background: rgba(15, 15, 15, 0.65);
        }

        .tour-highlight {
            position: absolute;
            border: 2px solid #2a7a57;
            border-radius: 12px;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(15, 15, 15, 0.65);
            transition: all 0.25s ease;
            pointer-events: none;
        }

        .tour-highlight.hidden {
            opacity: 0;
        }

        .tour-panel {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 460px;
            width: calc(100% - 40px);
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
            color: #1f1f1f;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tour-panel h4 {
            margin: 0;
            font-size: 18px;
        }

        .tour-panel p {
            margin: 0;
            line-height: 1.4;
        }

        .tour-step-counter {
            font-size: 11px;
            color: #918b7f;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .tour-step-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tour-panel button {
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }

        .tour-panel button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
        }

        .tour-panel button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tour-skip {
            position: absolute;
            top: 12px;
            right: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .menu-panel-btn {
            border-radius: 0;
            background: transparent;
            text-align: left;
            padding: 8px 12px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease;
        }

        .menu-panel-btn:hover {
            background: rgba(42, 122, 87, 0.08);
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: flex;
            gap: 6px;
        }

        .ratio-grid button {
            flex: 1;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }

        .menu-trigger {
            position: relative;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: #fff;
            border-radius: 12px;
            border: 1px solid rgba(15, 23, 42, 0.1);
            box-shadow: 0 14px 40px rgba(15, 23, 42, 0.25);
            padding: 12px;
            display: none;
            width: 220px;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .context-menu label {
            font-size: 12px;
            color: #475569;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 10px;
        }

        .context-menu select {
            border-radius: 8px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            padding: 6px 8px;
            font-size: 12px;
            background: #f8fafc;
            font-family: inherit;
        }

        .context-menu .ratio-options {
            display: flex;
            gap: 6px;
        }

        .context-menu .ratio-options button {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #f3f4f6;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .header-actions {
            display: flex;
            flex-direction: row;
            gap: 8px;
            max-width: 800px;
            width: 100%;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .ia-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 800px;
            width: 100%;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .header-actions .header-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .header-actions .header-row label,
        .header-actions .header-row textarea,
        .header-actions .header-row select,
        .header-actions .header-row button {
            width: 100%;
        }

        .header-actions textarea {
            max-height: 30px;
            font-size: 14px;
        }

        .header-actions button {
            align-self: flex-end;
            background: #fff;
            border: 1px solid rgba(15, 23, 42, 0.2);
            color: #0f172a;
            box-shadow: none;
        }

        .menu-trigger {
            position: relative;
            display: inline-flex;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid rgba(15, 23, 42, 0.1);
            border-radius: 16px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.2);
            display: none;
            min-width: 220px;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .context-menu label,
        .context-menu button {
            font-size: 13px;
            color: var(--text);
        }

        .toast {
            position: fixed;
            bottom: 18px;
            right: 18px;
            background: rgba(15, 23, 42, 0.92);
            color: #fff;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 13px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.3);
            pointer-events: none;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 90;
        }

        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 60;
        }

        .modal-overlay.open {
            display: flex;
        }

        .filter-modal {
            background: var(--surface);
            border-radius: 18px;
            padding: 16px 18px 20px;
            width: min(480px, 100%);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .filter-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .filter-modal h3 {
            margin: 0;
            font-size: 15px;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            color: var(--muted);
        }

        .color-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
            z-index: 90;
            opacity: 0;
            pointer-events: none;
            transition: opacity 140ms ease;
        }

        .color-modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .color-modal {
            background: var(--surface);
            border-radius: 18px;
            width: min(520px, 100%);
            max-height: min(90vh, 600px);
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 18px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.3);
        }

        .color-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .color-modal h3 {
            margin: 0;
            font-size: 15px;
        }

        .color-modal .modal-close {
            font-size: 20px;
            color: var(--muted);
        }

        .color-modal-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-types {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 320px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .color-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .color-row-label {
            font-size: 13px;
            color: var(--muted);
            flex: 1;
        }

        .color-row-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }



        .color-row-controls input[type="color"] {
            width: 38px;
            height: 38px;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
        }

        .color-row-controls input[type="text"] {
            width: 90px;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 12px;
            text-transform: lowercase;
        }

        .color-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
        }

        .toolbar .item-actions {
            margin-left: auto;
        }

        .btn-group {
            display: inline-flex;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            overflow: hidden;
        }

        .type-filter {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 6px;
            margin: 12px 0 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
        }

        .type-filter span {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 11px;
        }

        .type-filter-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .type-filter-chip {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: background 120ms ease, color 120ms ease, border-color 120ms ease;
            background: transparent;
        }

        .type-filter-chip:hover {
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.2);
        }

        .btn-small {
            border: none;
            background: transparent;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 120ms ease, color 120ms ease;
        }

        .btn-small:hover {
            background: var(--primary-soft);
        }

        .btn-small-active {
            background: var(--primary-soft);
            color: var(--primary-strong);
        }

        .btn-small:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        #timeline {
            background: var(--timeline-background, var(--surface));
            border-radius: 12px;
            border: 1px solid var(--border);
            height: 100%;
            padding: 6px;
        }

        /* vis.js styling */
        .vis-labelset .vis-label {
            font-size: var(--global-font-size);
            color: var(--muted);
        }


        .vis-item {
            border-radius: var(--radius-sm);
            border-width: 1px;
            font-size: var(--global-font-size);
            line-height: 1.2;
            padding-inline: 6px;
            cursor: pointer;
            background: #e5e7eb;
            border-color: #d1d5db;
            color: var(--text);
            transition:
                box-shadow 120ms ease,
                transform 80ms ease,
                background 120ms ease,
                border-color 120ms ease,
                color 120ms ease;
            white-space: normal;
            word-break: break-word;
        }


        .vis-item:hover {
            background: #dbeafe;
            border-color: var(--primary);
        }

        .vis-item.vis-selected {
            border-width: 3px;
            border-style: solid;
            background: rgba(37, 99, 235, 0.14);
            border-color: var(--primary-strong);
            color: #111827;
        }

        .vis-item.milestone-class {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        .type-feature {
            background: rgba(37, 99, 235, 0.1);
            border-color: rgba(37, 99, 235, 0.8);
            color: #1d4ed8;
        }

        .type-enabler {
            background: rgba(5, 150, 105, 0.1);
            border-color: rgba(5, 150, 105, 0.8);
            color: #047857;
        }

        .type-bug {
            background: rgba(225, 29, 72, 0.1);
            border-color: rgba(225, 29, 72, 0.85);
            color: #b91c1c;
        }

        .type-milestone {
            background: transparent;
            border: none;
            padding: 0;
            overflow: visible;
            min-width: 0;
        }

        .type-milestone .ms-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            padding: 2px 6px 2px 4px;
            border-radius: 999px;
            background: transparent;
            color: #9a3412;
            border: 1px solid rgba(249, 115, 22, 0.4);
        }

        .type-milestone .diamond {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            background: #fed7aa;
            border: 1px solid var(--milestone);
            transform: rotate(45deg);
            flex-shrink: 0;
        }

        .vis-item.vis-dot {
            border: none;
            background: transparent;
            padding: 0;
            margin-left: 5px;
        }

        .vis-item.vis-dot::before {
            content: "";
            position: absolute;
            width: 12px;
            height: 12px;
            top: 50%;
            left: 50%;
            transform: translate(calc(-50% + 2.5px), -50%) rotate(45deg);
            border-radius: 0;
            background: var(--milestone-selected-background, rgba(37, 99, 235, 0.14));
            box-shadow: 0 0 0 1px transparent;
        }


        .vis-item.type-milestone.vis-selected,
        .vis-item.milestone-class.vis-selected {
            border-width: 2px;
            background: transparent;
            border-color: var(--milestone-selected-border, rgba(37, 99, 235, 0.8));
            border-style: solid;
        }

        .vis-time-axis .vis-text {
            font-size: 10px;
            color: var(--muted);
        }

        .vis-panel.vis-center,
        .vis-panel.vis-left {
            border-color: var(--border);
        }

        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="app-header">
            <div class="tabs-actions">
                <button class="btn white-btn" id="switchToIndex" aria-label="Go to index">‚áÜ Go-Timeline</button>
                <div class="tabs-wrapper">
                    <div id="viewTabs" class="tabs"></div>
                    <div class="tab-actions">
                        <button class="tab-btn-add" id="addViewBtn" type="button"
                            aria-label="Ajouter une vue">‚ûï</button>
                        <button class="tab-btn-delete" id="deleteViewBtn" type="button"
                            aria-label="Supprimer la vue active">üóëÔ∏è</button>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn" id="openIaModal" aria-label="Ouvrir l'IA">‚ú®</button>
                    <div class="menu-trigger">
                        <button class="btn" id="optionsBtn" aria-label="Options d'affichage">üé®</button>
                        <div class="context-menu" id="optionsMenu">
                            <div class="menu-panel">
                                <label>
                                    Taille (px)
                                    <select id="fontSizeInput">
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                    </select>
                                </label>
                                <label>
                                    Fond
                                    <select id="backgroundSelector">
                                        <option value="#ffffff">Blanc</option>
                                        <option value="transparent">Transparent</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="menu-trigger">
                        <button class="btn" id="fileMenuBtn" aria-label="Fichier">üìÑ</button>
                        <div class="context-menu file-menu" id="fileMenu">
                            <div class="menu-panel" style="transform: translateX(10px);">
                                <button id="importJsonBtn" type="button" class="menu-panel-btn">üìÇ Open</button>
                                <button id="exportJsonBtn" type="button" class="menu-panel-btn">üíæ Save</button>
                                <button id="exportTextBtn" type="button" class="menu-panel-btn">üìã Texte</button>
                                <button id="exportImageBtn" type="button" class="menu-panel-btn">üñºÔ∏è Image</button>
                                <button id="exportExcelBtn" type="button" class="menu-panel-btn">üìä Excel</button>
                                <button id="aboutTimelineBtn" type="button" class="menu-panel-btn">‚ÑπÔ∏è √Ä propos</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- TIMELINE + TOOLBAR -->
        <div class="timeline-card">
            <div class="timeline-header">
                <div class="header-text">
                    <h1>Outil de planning ¬∑ OpenAI ready</h1>
                </div>
                <div class="header-buttons">

                </div>
            </div>

            <div class="toolbar">
                <div class="btn-group">
                    <button class="btn-small" id="btn-today">Aujourd'hui</button>
                </div>

                <div class="btn-group">
                    <button class="btn-small" id="btn-zoom-in">+</button>
                    <button class="btn-small" id="btn-fit">Auto</button>

                    <button class="btn-small" id="btn-zoom-out">‚àí</button>
                </div>

                <div class="btn-group">
                    <button class="btn-small" id="btn-scale-day">Jour</button>

                    <button class="btn-small btn-small-active" id="btn-scale-week">Semaine</button>
                    <button class="btn-small" id="btn-scale-month">Mois</button>
                </div>
                <div class="btn-group item-actions">
                    <button class="btn-small" id="btn-rename-selected" aria-label="Renommer l‚Äô√©l√©ment s√©lectionn√©">
                        ‚úèÔ∏è
                    </button>
                    <button class="btn-small" id="btn-add-milestone" aria-label="Ajouter un jalon">
                        + Rep√®re
                    </button>
                    <button class="btn-small" id="btn-add-item" aria-label="Ajouter un √©l√©ment">
                        + Action
                    </button>

                </div>
                <div class="btn-group">
                    <button class="btn-small" id="openColorPaletteBtn"
                        aria-label="Personnaliser les couleurs">üé®</button>
                </div>
            </div>

            <div id="timeline"></div>
        </div>

        <div class="modal-overlay" id="iaModalOverlay" role="dialog" aria-modal="true" aria-labelledby="iaModalTitle">
            <div class="filter-modal">
                <div class="modal-header">
                    <h3 id="iaModalTitle">Assistant IA</h3>
                    <button class="modal-close" id="iaModalClose" type="button" aria-label="Fermer l'IA">√ó</button>
                </div>
                <div class="ia-actions">
                    <div class="header-row  ia-header-actions">
                        <label for="mode">Mode d'action</label>
                        <select id="mode">
                            <option value="create">üÜï Cr√©er un planning</option>
                            <option value="modify">‚úèÔ∏è Modifier le planning</option>
                        </select>
                    </div>
                    <div class="header-row ia-header-actions">
                        <label for="prompt">Demande</label>
                        <textarea id="prompt" rows="30"
                            placeholder="√âlaborer un planning op√©rationnel pour une demande de maintenance moteur.&#10;&#10;Objectifs :&#10;- P√©riode : janvier‚Äìmars 2025&#10;- Segments : Pr√©paration op√©rationnelle, Inspection technique, Actions correctives&#10;- Natures : diagnostic, intervention, contr√¥le qualit√©, jalon&#10;- G√©n√©rer 6 interventions dat√©es (d√©but/fin) avec logique m√©tier&#10;- Ajouter 2 jalons cl√©s (Feu vert inspection, Cl√¥ture technique)&#10;- Libell√©s courts et professionnels"></textarea>
                    </div>
                    <button class="btn" id="btn-call">
                        <span>‚ú® Envoyer</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="color-modal-overlay" id="colorModalOverlay" role="dialog" aria-modal="true"
            aria-labelledby="colorModalTitle">
            <div class="color-modal">
                <div class="modal-header">
                    <h3 id="colorModalTitle">Palette de couleurs</h3>
                    <button class="modal-close" id="colorModalClose" type="button"
                        aria-label="Fermer la palette">√ó</button>
                </div>
                <div class="color-modal-body">
                    <div class="color-types" id="colorTypeList"></div>
                </div>
                <div class="color-actions">
                    <button class="btn white-btn" type="button" id="randomizeColorsBtn">üåà Random</button>
                    <button class="btn" type="button" id="saveColorPreferencesBtn">Valider</button>
                </div>
            </div>
        </div>

        <div id="timelineInfoPopup" class="info-popup" role="dialog" aria-live="polite">
            <div class="info-card">
                <button class="info-close" type="button" aria-label="Fermer">√ó</button>
                <img src="logo.gif" alt="Logo Go-Toolkit">
                <strong>Go-Toolkit</strong>
                <span>Version 0.11.23</span>
                <span>D√©velopp√© par Quang TRAN.</span>
                <span>Usage r√©serv√© √† Savane Consulting.</span>
                <button id="timelineTourReplayBtn" type="button" class="btn">Tour guid√©</button>
            </div>
        </div>

        <div id="timelineTourOverlay" class="tour-overlay" aria-hidden="true">
            <div class="tour-highlight hidden" aria-hidden="true"></div>
            <div class="tour-panel">
                <span class="tour-step-counter" id="timelineTourStepCounter"></span>
                <h4 id="timelineTourStepTitle"></h4>
                <p id="timelineTourStepDescription"></p>
                <div class="tour-step-footer">
                    <button id="timelineTourPrevBtn" type="button">Pr√©c√©dent</button>
                    <button id="timelineTourNextBtn" type="button" class="primary">Suivant</button>
                    <button id="timelineTourCloseBtn" type="button">Fermer</button>
                </div>
            </div>
            <button id="timelineTourSkipBtn" class="tour-skip" type="button">√ó</button>
        </div>

        <div id="copyToast" class="toast" aria-live="polite" aria-atomic="true"></div>

        <input type="file" id="importJsonInput" accept="application/json" style="display:none">
        <script>
            // ============================================================
            // 1. Schema JSON ¬∑ planning-v1 (doc d√©veloppeur)
            // ============================================================
            /*
                OpenAI doit renvoyer un objet de forme :
    
                {
                  "timeline": {          // optionnel
                    "start": "2025-01-01",
                    "end":   "2025-03-31"
                  },
                  "groups": [
                    { "id": "milestones", "label": "Jalons PI" },
                    { "id": "team-alpha", "label": "Team Alpha ‚Äì Core Engine" },
                    ...
                  ],
                  "items": [
                    // jalon ponctuel
                    {
                      "id": "ms-1",
                      "groupId": "milestones",
                      "label": "System Demo 1",
                      "kind": "milestone",
                      "date": "2025-01-15"
                    },
                    // t√¢che avec d√©but / fin
                    {
                      "id": "it-1",
                      "groupId": "team-alpha",
                      "label": "Feature X",
                      "kind": "feature",   // "feature" | "enabler" | "bug" | "other"
                      "start": "2025-01-05",
                      "end": "2025-02-02"
                    }
                  ]
                }
    
                ‚Üí Ce fichier se charge de mapper ce JSON vers vis-timeline,
                  et permet aussi de r√©exporter le planning dans ce format.
            */

            // ============================================================
            // 2. Setup vis-timeline (groups + items)
            // ============================================================
            var DataSet = vis.DataSet;
            var Timeline = vis.Timeline;

            var container = document.getElementById("timeline");

            var groups = new DataSet();
            var items = new DataSet();
            items.on("add", persistCurrentPlanning);
            items.on("update", persistCurrentPlanning);
            items.on("remove", persistCurrentPlanning);
            groups.on("add", persistCurrentPlanning);
            groups.on("update", persistCurrentPlanning);
            groups.on("remove", persistCurrentPlanning);

            var now = new Date();
            var oneDay = 24 * 60 * 60 * 1000;
            var oneWeek = 7 * oneDay;
            var snapMode = "week";
            var currentScaleMode = "week";
            var typeDefinitions = {};
            var typeFilterState = {};
            var typeFilterChips = document.getElementById("typeFilterChips");
            var timeline = null;
            var OPENAI_PROXY_URL = "https://openai.tranxq.workers.dev/v1/chat/completions";
            var OPENAI_MODEL = "gpt-5-nano";
            var OPENAI_TEMPERATURE = 1;
            var LOCAL_STORAGE_KEY = "timeline-planning-state";
            var typeStyleElement = document.createElement("style");
            typeStyleElement.id = "timeline-type-styles";
            document.head.appendChild(typeStyleElement);
            var persistenceLocked = false;
            var allowedBackgroundValues = ["transparent", "#ffffff"];
            function deepClone(value) {
                if (value === undefined || value === null) return value;
                return JSON.parse(JSON.stringify(value));
            }
            var DEMO_STATE = {
                views: [
                    {
                        name: "Vue 1",
                        title: "Vue 1",
                        planning: {
                            timeline: {
                                start: "2025-11-30",
                                end: "2026-06-15"
                            },
                            groups: [
                                { id: "g1", label: "PM & Stakeholders" },
                                { id: "g2", label: "Architecture & Data" },
                                { id: "g3", label: "Backend" },
                                { id: "g4", label: "Frontend & UX" },
                                { id: "g5", label: "Quality Assurance" },
                                { id: "g6", label: "DevOps & Infra" },
                                { id: "g7", label: "Formation & Support" }
                            ],
                            items: [
                                {
                                    id: "i2",
                                    groupId: "g2",
                                    label: "Architecture Freeze",
                                    kind: "milestone",
                                    date: "2025-12-21"
                                },
                                {
                                    id: "i3",
                                    groupId: "g4",
                                    label: "MVP Scope Freeze",
                                    kind: "milestone",
                                    date: "2026-02-15"
                                },
                                {
                                    id: "i4",
                                    groupId: "g6",
                                    label: "Production Readiness",
                                    kind: "milestone",
                                    date: "2026-05-31"
                                },
                                {
                                    id: "i5",
                                    groupId: "g1",
                                    label: "Review & Next PI",
                                    kind: "milestone",
                                    date: "2026-05-31"
                                },
                                {
                                    id: "i9",
                                    groupId: "g3",
                                    label: "API: Demandes de maintenance endpoints",
                                    kind: "feature",
                                    start: "2025-11-30",
                                    end: "2026-01-19"
                                },
                                {
                                    id: "i10",
                                    groupId: "g3",
                                    label: "Gestion des √©tats de demande",
                                    kind: "task",
                                    start: "2026-01-31",
                                    end: "2026-03-13"
                                },
                                {
                                    id: "i11",
                                    groupId: "g4",
                                    label: "UI: Cr√©ation et suivi des demandes",
                                    kind: "feature",
                                    start: "2025-12-15",
                                    end: "2026-02-28"
                                },
                                {
                                    id: "i12",
                                    groupId: "g4",
                                    label: "Dashboard & filtres",
                                    kind: "task",
                                    start: "2026-01-10",
                                    end: "2026-03-20"
                                },
                                {
                                    id: "i13",
                                    groupId: "g5",
                                    label: "Tests fonctionnels & acceptance criteria",
                                    kind: "documentation",
                                    start: "2026-01-15",
                                    end: "2026-03-15"
                                },
                                {
                                    id: "i14",
                                    groupId: "g5",
                                    label: "Automatisation QA",
                                    kind: "task",
                                    start: "2026-02-20",
                                    end: "2026-04-30"
                                },
                                {
                                    id: "i15",
                                    groupId: "g6",
                                    label: "CI/CD & Environnements",
                                    kind: "integration",
                                    start: "2025-12-15",
                                    end: "2026-04-30"
                                },
                                {
                                    id: "i16",
                                    groupId: "g6",
                                    label: "Monitoring & Observabilit√©",
                                    kind: "task",
                                    start: "2026-03-01",
                                    end: "2026-05-31"
                                },
                                {
                                    id: "i17",
                                    groupId: "g7",
                                    label: "Formation utilisateur",
                                    kind: "documentation",
                                    start: "2026-03-15",
                                    end: "2026-04-30"
                                },
                                {
                                    id: "i18",
                                    groupId: "g7",
                                    label: "Support post-d√©ploiement",
                                    kind: "task",
                                    start: "2026-04-01",
                                    end: "2026-06-15"
                                },
                                {
                                    id: "i20",
                                    groupId: "g3",
                                    label: "Int√©gration s√©curit√© & conformit√© API",
                                    kind: "integration",
                                    start: "2026-01-05",
                                    end: "2026-02-28"
                                }
                            ]
                        }
                    },
                    {
                        name: "Vue 2",
                        title: "Vue 2",
                        planning: {
                            timeline: {
                                start: "2025-11-23",
                                end: "2025-11-23"
                            },
                            groups: [],
                            items: []
                        }
                    }
                ],
                displayPreferences: {
                    font: "Inter",
                    fontSize: 14,
                    background: "#f7f7f7",
                    ratio: "16:9"
                }
            };
            function sanitizeTypeId(raw) {
                var id = (raw || "").toLowerCase().trim();
                if (!id) return "feature";
                return id.replace(/[^a-z0-9_-]/g, "-");
            }

            function hslToHex(h, s, l) {
                var hue = ((h % 360) + 360) % 360;
                var sat = Math.max(0, Math.min(100, s)) / 100;
                var light = Math.max(0, Math.min(100, l)) / 100;
                var c = (1 - Math.abs(2 * light - 1)) * sat;
                var x = c * (1 - Math.abs(((hue / 60) % 2) - 1));
                var m = light - c / 2;
                var r = 0;
                var g = 0;
                var b = 0;
                if (hue < 60) {
                    r = c;
                    g = x;
                } else if (hue < 120) {
                    r = x;
                    g = c;
                } else if (hue < 180) {
                    g = c;
                    b = x;
                } else if (hue < 240) {
                    g = x;
                    b = c;
                } else if (hue < 300) {
                    r = x;
                    b = c;
                } else {
                    r = c;
                    b = x;
                }
                var red = Math.round((r + m) * 255);
                var green = Math.round((g + m) * 255);
                var blue = Math.round((b + m) * 255);
                var toHex = function (value) {
                    var str = value.toString(16);
                    return str.length === 1 ? "0" + str : str;
                };
                return "#" + toHex(red) + toHex(green) + toHex(blue);
            }

            function getRainbowColor() {
                var hue = Math.random() * 360;
                var saturation = 65 + Math.random() * 15;
                var lightness = 76 + Math.random() * 6;
                return hslToHex(hue, saturation, lightness);
            }

            function generateRainbowPalette(count) {
                var palette = [];
                var size = Math.max(1, count || 1);
                var baseHue = Math.random() * 360;
                var step = 360 / size;
                for (var i = 0; i < size; i++) {
                    var hue = (baseHue + i * step) % 360;
                    var saturation = 65 + Math.random() * 15;
                    var lightness = 76 + Math.random() * 6;
                    palette.push(hslToHex(hue, saturation, lightness));
                }
                return palette;
            }

            function normalizeHexColor(value) {
                if (!value || typeof value !== "string") return null;
                var trimmed = value.trim().toLowerCase();
                if (trimmed === "transparent") return "transparent";
                if (trimmed[0] !== "#") trimmed = "#" + trimmed;
                if (/^#([a-f0-9]{6})$/.test(trimmed)) {
                    return trimmed;
                }
                var shortMatch = trimmed.match(/^#([a-f0-9]{3})$/);
                if (shortMatch) {
                    return (
                        "#" +
                        shortMatch[1]
                            .split("")
                            .map(function (char) { return char + char; })
                            .join("")
                    );
                }
                return null;
            }

            function setPreviewColor(preview, color) {
                if (!preview) return;
                if (color === "transparent") {
                    preview.style.backgroundImage =
                        "repeating-linear-gradient(45deg, rgba(15, 23, 42, 0.08) 0 6px, transparent 6px 12px)";
                    preview.style.backgroundColor = "transparent";
                } else {
                    preview.style.backgroundImage = "none";
                    preview.style.backgroundColor = color;
                }
            }

            function rebuildTypeStyles() {
                var rules = Object.keys(typeDefinitions).map(function (key) {
                    var def = typeDefinitions[key];
                    var background = def.background;
                    if (key === "milestone") {
                        background = "transparent";
                    }
                    return [
                        ".vis-item.type-" + def.id + " {",
                        "  background: " + background + ";",
                        "  border-color: " + def.border + ";",
                        "  color: " + def.color + ";",
                        "}"
                    ].join("\n");
                });
                var milestoneDef = typeDefinitions["milestone"];
                if (milestoneDef) {
                    var highlightBackground = milestoneDef.background || "rgba(37, 99, 235, 0.14)";
                    var highlightBorder = milestoneDef.border || "rgba(37, 99, 235, 0.8)";
                    var milestoneRule = [
                        ":root {",
                        "  --milestone-selected-background: " + highlightBackground + ";",
                        "  --milestone-selected-border: " + highlightBorder + ";",
                        "}"
                    ].join("\n");
                    rules.push(milestoneRule);
                }
                typeStyleElement.textContent = rules.join("\n");
            }

            function ensureTypeDefinition(def) {
                var base = def || {};
                var id = sanitizeTypeId(base.id || base.name || base.kind);
                var colors = def && def.colors ? def.colors : {};
                var existing = typeDefinitions[id] || {};
                var background =
                    colors.background || base.background || existing.background || getRainbowColor();
                var border = colors.border || base.border || existing.border || "rgba(156, 163, 175, 0.9)";
                var textColor = colors.text || base.color || existing.color || "#111827";
                var label = base.label || base.name || existing.label || id;
                typeDefinitions[id] = {
                    id: id,
                    label: label,
                    background: background,
                    border: border,
                    color: textColor
                };
                if (!Object.prototype.hasOwnProperty.call(typeFilterState, id)) {
                    typeFilterState[id] = true;
                }
                rebuildTypeStyles();
                return id;
            }

            function applyTypeDefinitions(defs) {
                if (!Array.isArray(defs)) return;
                defs.forEach(function (def) {
                    ensureTypeDefinition({
                        id: def.id,
                        label: def.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    });
                });
            }

            function persistTimelineState() {
                try {
                    var payload = {
                        views: views.map(function (view) {
                            return {
                                name: view.name,
                                title: view.title,
                                planning: view.planning
                            };
                        }),
                        displayPreferences: Object.assign({}, displayPreferences)
                    };
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(payload));
                } catch (err) {
                    console.warn("Impossible de sauvegarder le planning", err);
                }
            }

            function loadPersistedTimelineState() {
                try {
                    var raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (err) {
                    console.warn("Impossible de lire le planning sauvegard√©", err);
                    return null;
                }
            }

            var views = [];
            var activeViewIndex = 0;
            var displayPreferences = {
                font: "Inter",
                fontSize: 14,
                background: "transparent",
                ratio: "16:9"
            };
            var colorModalState = {
                types: {},
                timeline: displayPreferences.background || "#ffffff"
            };
            var persistedState = loadPersistedTimelineState();
            if (persistedState) {
                if (Array.isArray(persistedState.views) && persistedState.views.length) {
                    views = persistedState.views.map(function (view, index) {
                        return {
                            name: view.name || view.title || ("Vue " + (index + 1)),
                            title: view.title || view.name || ("Vue " + (index + 1)),
                            planning: view.planning || null
                        };
                    });
                } else if (persistedState.groups) {
                    var defaultLabel = persistedState.label || persistedState.name || "Vue 1";
                    views = [{
                        name: defaultLabel,
                        title: defaultLabel,
                        planning: persistedState
                    }];
                }
                if (persistedState.displayPreferences) {
                    Object.assign(displayPreferences, persistedState.displayPreferences);
                }
            } else {
                if (Array.isArray(DEMO_STATE.views) && DEMO_STATE.views.length) {
                    views = deepClone(DEMO_STATE.views);
                }
                if (DEMO_STATE.displayPreferences) {
                    var demoPrefs = deepClone(DEMO_STATE.displayPreferences);
                    demoPrefs.background = "#ffffff";
                    Object.assign(displayPreferences, demoPrefs);
                }
            }
            if (!views.length) {
                views = [{ name: "Vue 1", title: "Vue 1", planning: null }];
            }

            function persistCurrentPlanning() {
                if (persistenceLocked) return;
                if (!views[activeViewIndex]) return;
                views[activeViewIndex].planning = exportPlanningToJson();
                persistTimelineState();
            }

            function getActiveTypeIds() {
                return Object.keys(typeFilterState).filter(function (key) {
                    return !!typeFilterState[key];
                });
            }

            function refreshTypeFilterUI() {
                if (!typeFilterChips) return;
                typeFilterChips.innerHTML = "";
                Object.keys(typeDefinitions).forEach(function (key) {
                    var def = typeDefinitions[key];
                    if (!def) return;
                    var isActive = !!typeFilterState[key];
                    var chip = document.createElement("button");
                    chip.type = "button";
                    chip.className = "type-filter-chip" + (isActive ? " active" : "");
                    chip.textContent = def.label;
                    chip.dataset.typeId = key;
                    chip.setAttribute("aria-pressed", isActive ? "true" : "false");
                    chip.style.borderColor = def.border;
                    chip.style.background = isActive ? def.background : "transparent";
                    chip.style.color = isActive ? def.color : "var(--muted)";
                    chip.addEventListener("click", function () {
                        typeFilterState[key] = !typeFilterState[key];
                        refreshTypeFilterUI();
                        updateTimelineFilter();
                    });
                    typeFilterChips.appendChild(chip);
                });
            }

            function updateTimelineFilter() {
                var activeTypes = getActiveTypeIds();
                var allowAll = activeTypes.length === 0;
                items.get().forEach(function (item) {
                    var kind = sanitizeTypeId(item.kind || item.type || "");
                    if (!kind) return;
                    var shouldBeVisible = allowAll || activeTypes.indexOf(kind) >= 0;
                    var isHidden = !!item.hidden;
                    if (isHidden === !shouldBeVisible) return;
                    items.update({ id: item.id, hidden: !shouldBeVisible });
                });
            }

            var options = {
                stack: true,
                orientation: "top",
                groupHeightMode: "auto",
                editable: {
                    add: true,
                    updateTime: true,
                    updateGroup: true,
                    remove: false
                },
                selectable: true,
                multiselect: false,
                margin: { item: 8, axis: 10 },
                snap: function (date) {
                    var d = new Date(date);
                    if (snapMode === "day") {
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    if (snapMode === "month") {
                        d.setDate(1);
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    var day = d.getDay();
                    var diff = (day + 6) % 7;
                    d.setDate(d.getDate() - diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                },
                template: function (item) {
                    if (item.kind === "milestone") {
                        var text = (item.content || "").trim() || "Jalon";
                        return (
                            '<div class="ms-pill">' +
                            '<span class="diamond"></span>' +
                            "<span>" + text + "</span>" +
                            "</div>"
                        );
                    }
                    return item.content || "";
                },
                timeAxis: {
                    scale: "week",
                    step: 1
                }
            };

            timeline = new Timeline(container, items, groups, options);

            var iaModalOverlay = document.getElementById("iaModalOverlay");
            var iaModalButton = document.getElementById("openIaModal");
            var iaModalClose = document.getElementById("iaModalClose");

            function openIaModal() {
                if (iaModalOverlay) iaModalOverlay.classList.add("open");
            }

            function closeIaModal() {
                if (iaModalOverlay) iaModalOverlay.classList.remove("open");
            }

            if (iaModalButton) {
                iaModalButton.addEventListener("click", openIaModal);
            }
            if (iaModalClose) {
                iaModalClose.addEventListener("click", closeIaModal);
            }
            if (iaModalOverlay) {
                iaModalOverlay.addEventListener("click", function (event) {
                    if (event.target === iaModalOverlay) {
                        closeIaModal();
                    }
                });
            }

            var CREATE_SYSTEM_TEMPLATE =
                "Tu es un assistant qui va g√©n√©rer un planning √† partir des instructions suivantes {{(contenu du id=\"prompt\") }}\\n\\n" +
                "R√©ponds toujours avec un JSON qui contient :\\n" +
                "- `types` : un tableau d‚Äôobjets `{ id, label}` pour d√©crire des types d'actions diff√©rentes. Ajouter un type sp√©cifique aux milestones.\\n" +
                "- `timeline` : `{ start, end }` au format ISO (YYYY-MM-DD).\\n" +
                "- `groups` : chaque groupe d'actions avec { id, label }.\\n" +
                "- `items` : chaque item { id, groupId, label, kind, start?, end?, date? }.\\n" +
                "- Les items ponctuels sont des `kind: \"milestone\"`.\\n" +
                "- Sors uniquement le JSON, sans explication ni texte additionnel.";

            var MODIFY_SYSTEM_TEMPLATE =
                "Tu es un assistant qui modifie √† partir du contexte suivant {{(contenu du id=\"prompt\") }}\\n\\n" +
                "le planning de d√©part suivant en conservant les ids existants : {{(contenu au format JSON du planning existant)}}\\n\\n" +
                "R√©ponds toujours avec un JSON qui contient :\\n" +
                "- `types` : un tableau d‚Äôobjets `{ id, label}` pour d√©crire des types d'actions diff√©rentes.\\n" +
                "- `timeline` : `{ start, end }` au format ISO (YYYY-MM-DD).\\n" +
                "- `groups` : chaque groupe d'actions avec { id, label }.\\n" +
                "- `items` : chaque item { id, groupId, label, kind, start?, end?, date? }.\\n" +
                "- Les items ponctuels sont des `kind: \"milestone\"`.\\n" +
                "- Sors seulement le JSON.";

            var optionsBtn = document.getElementById("optionsBtn");
            var optionsMenu = document.getElementById("optionsMenu");
            var fontSizeInput = document.getElementById("fontSizeInput");
            var backgroundSelector = document.getElementById("backgroundSelector");
            var fileMenuBtn = document.getElementById("fileMenuBtn");
            var fileMenu = document.getElementById("fileMenu");
            var importJsonBtn = document.getElementById("importJsonBtn");
            var exportJsonBtn = document.getElementById("exportJsonBtn");
            var exportTextBtn = document.getElementById("exportTextBtn");
            var exportImageBtn = document.getElementById("exportImageBtn");
            var exportExcelBtn = document.getElementById("exportExcelBtn");
            var aboutTimelineBtn = document.getElementById("aboutTimelineBtn");
            var importJsonInput = document.getElementById("importJsonInput");
            var headerTitleElement = document.querySelector(".header-text h1");
            var infoPopup = document.getElementById("timelineInfoPopup");
            var infoCloseBtn = infoPopup ? infoPopup.querySelector(".info-close") : null;
            var copyToast = document.getElementById("copyToast");
            var copyToastTimer = null;
            var timelineCard = document.querySelector(".timeline-card");
            var switchToIndexBtn = document.getElementById("switchToIndex");
            var colorModalOverlay = document.getElementById("colorModalOverlay");
            var colorModalClose = document.getElementById("colorModalClose");
            var openColorPaletteBtn = document.getElementById("openColorPaletteBtn");
            var colorTypeList = document.getElementById("colorTypeList");
            var timelineBackgroundPreview = document.getElementById("timelineBackgroundPreview");
            var timelineBackgroundColorPicker = document.getElementById("timelineBackgroundColorPicker");
            var timelineBackgroundColorHex = document.getElementById("timelineBackgroundColorHex");
            var saveColorPreferencesBtn = document.getElementById("saveColorPreferencesBtn");
            var randomizeColorsBtn = document.getElementById("randomizeColorsBtn");
            var fontSizeChoices = [9, 10, 11, 12, 13, 14, 15, 16];

            function renderFontSizeOptions() {
                if (!fontSizeInput) return;
                fontSizeInput.innerHTML = "";
                fontSizeChoices.forEach(function (size) {
                    var option = document.createElement("option");
                    option.value = size;
                    option.textContent = size + " px";
                    option.style.fontSize = size + "px";
                    fontSizeInput.appendChild(option);
                });
                if (displayPreferences.fontSize) {
                    fontSizeInput.value = displayPreferences.fontSize;
                }
            }

            function closeContextMenus() {
                if (optionsMenu) optionsMenu.classList.remove("open");
                if (fileMenu) fileMenu.classList.remove("open");
            }

            if (optionsBtn && optionsMenu) {
                optionsBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    syncFontControls();
                    optionsMenu.classList.toggle("open");
                });
            }

            if (fileMenuBtn && fileMenu) {
                fileMenuBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    fileMenu.classList.toggle("open");
                });
            }

            document.addEventListener("click", function (event) {
                if (optionsMenu && !optionsMenu.contains(event.target) && optionsBtn !== event.target) {
                    optionsMenu.classList.remove("open");
                }
                if (fileMenu && !fileMenu.contains(event.target) && fileMenuBtn !== event.target) {
                    fileMenu.classList.remove("open");
                }
            });

            function getOrderedTypeIds() {
                return Object.keys(typeDefinitions).sort(function (a, b) {
                    var labelA = (typeDefinitions[a] && typeDefinitions[a].label) || a;
                    var labelB = (typeDefinitions[b] && typeDefinitions[b].label) || b;
                    return labelA.localeCompare(labelB);
                });
            }

            function captureColorPreferencesState() {
                colorModalState.types = {};
                var typeIds = getOrderedTypeIds();
                typeIds.forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    colorModalState.types[typeId] = def.background || getRainbowColor();
                });
                colorModalState.timeline = displayPreferences.background || "#ffffff";
            }

            function syncTimelineBackgroundInputs(value) {
                var normalized = value || "#ffffff";
                colorModalState.timeline = normalized;
                if (timelineBackgroundPreview) {
                    setPreviewColor(timelineBackgroundPreview, normalized);
                }
                if (timelineBackgroundColorPicker) {
                    timelineBackgroundColorPicker.value = normalized === "transparent" ? "#ffffff" : normalized;
                }
                if (timelineBackgroundColorHex) {
                    timelineBackgroundColorHex.value = normalized;
                }
            }

            function updateTypeColorValue(typeId, normalized, preview, picker, hexInput) {
                if (!normalized) return;
                colorModalState.types[typeId] = normalized;
                setPreviewColor(preview, normalized);
                if (picker) {
                    picker.value = normalized === "transparent" ? "#ffffff" : normalized;
                }
                if (hexInput) {
                    hexInput.value = normalized;
                }
            }

            function renderColorModalContent() {
                if (!colorTypeList) return;
                colorTypeList.innerHTML = "";
                var typeIds = getOrderedTypeIds();
                typeIds.forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    var colorValue = colorModalState.types[typeId] || def.background || "#ffffff";
                    colorModalState.types[typeId] = colorValue;
                    var row = document.createElement("div");
                    row.className = "color-row";
                    var label = document.createElement("div");
                    label.className = "color-row-label";
                    label.textContent = def.label || typeId;
                    var controls = document.createElement("div");
                    controls.className = "color-row-controls";
                    var preview = document.createElement("span");
                    preview.className = "color-preview";
                    setPreviewColor(preview, colorValue);
                    var colorPicker = document.createElement("input");
                    colorPicker.type = "color";
                    colorPicker.value = colorValue === "transparent" ? "#ffffff" : colorValue;
                    var hexInput = document.createElement("input");
                    hexInput.type = "text";
                    hexInput.placeholder = "#ffffff";
                    hexInput.value = colorValue;
                    hexInput.addEventListener("input", function () {
                        var normalized = normalizeHexColor(hexInput.value);
                        if (!normalized) return;
                        updateTypeColorValue(typeId, normalized, preview, colorPicker, hexInput);
                    });
                    colorPicker.addEventListener("input", function () {
                        var normalized = normalizeHexColor(colorPicker.value);
                        if (!normalized) return;
                        updateTypeColorValue(typeId, normalized, preview, colorPicker, hexInput);
                    });
                    controls.appendChild(preview);
                    controls.appendChild(colorPicker);
                    controls.appendChild(hexInput);
                    row.appendChild(label);
                    row.appendChild(controls);
                    colorTypeList.appendChild(row);
                });
                syncTimelineBackgroundInputs(colorModalState.timeline);
            }

            function openColorModal() {
                captureColorPreferencesState();
                renderColorModalContent();
                if (colorModalOverlay) {
                    colorModalOverlay.classList.add("open");
                }
            }

            function closeColorModal() {
                if (colorModalOverlay) {
                    colorModalOverlay.classList.remove("open");
                }
            }

            function applyColorModalChanges() {
                Object.keys(colorModalState.types).forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    var background = colorModalState.types[typeId];
                    if (!def || !background) return;
                    def.background = background;
                });
                rebuildTypeStyles();
                refreshTypeFilterUI();
                if (colorModalState.timeline) {
                    applyBackground(colorModalState.timeline);
                }
                persistCurrentPlanning();
                closeColorModal();
            }

            if (openColorPaletteBtn) {
                openColorPaletteBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    openColorModal();
                });
            }
            if (colorModalClose) {
                colorModalClose.addEventListener("click", closeColorModal);
            }
            if (colorModalOverlay) {
                colorModalOverlay.addEventListener("click", function (event) {
                    if (event.target === colorModalOverlay) {
                        closeColorModal();
                    }
                });
            }
            if (randomizeColorsBtn) {
                randomizeColorsBtn.addEventListener("click", function () {
                    var typeIds = getOrderedTypeIds();
                    if (!typeIds.length) return;
                    var palette = generateRainbowPalette(typeIds.length);
                    typeIds.forEach(function (typeId, index) {
                        colorModalState.types[typeId] = palette[index % palette.length];
                    });
                    renderColorModalContent();
                });
            }
            if (saveColorPreferencesBtn) {
                saveColorPreferencesBtn.addEventListener("click", applyColorModalChanges);
            }
            if (timelineBackgroundColorPicker) {
                timelineBackgroundColorPicker.addEventListener("input", function () {
                    var normalized = normalizeHexColor(timelineBackgroundColorPicker.value);
                    if (!normalized) return;
                    syncTimelineBackgroundInputs(normalized);
                });
            }
            if (timelineBackgroundColorHex) {
                timelineBackgroundColorHex.addEventListener("input", function () {
                    var normalized = normalizeHexColor(timelineBackgroundColorHex.value);
                    if (!normalized) return;
                    syncTimelineBackgroundInputs(normalized);
                });
            }

            function downloadJson(filename, payload) {
                var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
                var url = URL.createObjectURL(blob);
                var anchor = document.createElement("a");
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
                setTimeout(function () {
                    URL.revokeObjectURL(url);
                }, 1000);
            }

            function gatherExportState() {
                persistCurrentPlanning();
                return {
                    views: views.map(function (view) {
                        return {
                            name: view.name,
                            title: view.title,
                            planning: view.planning
                        };
                    }),
                    displayPreferences: Object.assign({}, displayPreferences)
                };
            }

            function exportTimelineState() {
                var payload = gatherExportState();
                downloadJson("timeline-views.json", payload);
            }

            async function exportTimelineImage() {
                if (!timelineCard || !exportImageBtn) return;
                closeContextMenus();
                var initialLabel = exportImageBtn.textContent;
                exportImageBtn.disabled = true;
                exportImageBtn.textContent = "‚è≥";
                try {
                    var canvas = await html2canvas(timelineCard, { scale: 2, backgroundColor: null, useCORS: true });
                    var link = document.createElement("a");
                    link.href = canvas.toDataURL("image/png");
                    link.download = "go-timeline-view.png";
                    link.click();
                } catch (err) {
                    console.error("Export image impossible", err);
                    alert("Export image impossible. R√©essaie.");
                } finally {
                    exportImageBtn.textContent = initialLabel;
                    exportImageBtn.disabled = false;
                }
            }

            function buildExcelRows(planning) {
                if (!planning || !Array.isArray(planning.items)) return [];
                var groupMap = {};
                (planning.groups || []).forEach(function (group) {
                    if (group && group.id) {
                        groupMap[group.id] = group.label || "";
                    }
                });
                return planning.items.map(function (item) {
                    return {
                        Ligne: groupMap[item.groupId] || item.groupId || "",
                        Activit√©: item.label || "",
                        Type: item.kind || "",
                        D√©but: item.start || "",
                        Fin: item.end || "",
                        Date: item.date || ""
                    };
                });
            }

            function computeDaySpan(start, end) {
                if (!start || !end) {
                    return null;
                }
                var startDate = new Date(start);
                var endDate = new Date(end);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    return null;
                }
                var msPerDay = 1000 * 60 * 60 * 24;
                var diff = Math.round((endDate - startDate) / msPerDay);
                if (diff < 0) {
                    return null;
                }
                return diff + 1; // include both endpoints
            }

            function exportTimelineExcel() {
                if (!exportExcelBtn) return;
                closeContextMenus();
                exportExcelBtn.disabled = true;
                var initialLabel = exportExcelBtn.textContent;
                exportExcelBtn.textContent = "‚è≥";
                try {
                    persistCurrentPlanning();
                    var currentView = views[activeViewIndex];
                    var planning = (currentView && currentView.planning) || exportPlanningToJson();
                    var rows = buildExcelRows(planning);
                    if (!rows.length) {
                        alert("Aucun √©l√©ment √† exporter.");
                        return;
                    }
                    var worksheet = XLSX.utils.json_to_sheet(rows, {
                        header: ["Ligne", "Activit√©", "Type", "D√©but", "Fin", "Date"]
                    });
                    var workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Planning");
                    XLSX.writeFile(workbook, "go-timeline.xlsx");
                } catch (err) {
                    console.error("Export Excel failed", err);
                    alert("Export Excel impossible. R√©essaie.");
                } finally {
                    exportExcelBtn.textContent = initialLabel;
                    exportExcelBtn.disabled = false;
                }
            }

            function buildTextExport(planning, viewTitle) {
                var lines = [];
                if (viewTitle) {
                    lines.push("Vue : " + viewTitle);
                }
                if (planning && planning.timeline) {
                    var start = planning.timeline.start || "";
                    var end = planning.timeline.end || "";
                    var rangeParts = [];
                    if (start) rangeParts.push(start);
                    if (end) rangeParts.push(end);
                    if (rangeParts.length) {
                        lines.push("P√©riode : " + rangeParts.join(" ‚Üí "));
                    }
                }
                var groupMap = {};
                (planning && Array.isArray(planning.groups) ? planning.groups : []).forEach(function (group) {
                    if (group && group.id) {
                        var label = group.label || group.name || group.id;
                        groupMap[group.id] = label.trim() || group.id;
                    }
                });
                var groupLabels = Object.keys(groupMap).map(function (id) {
                    return groupMap[id];
                }).filter(Boolean);
                if (groupLabels.length) {
                    lines.push("Groupes : " + groupLabels.join(", "));
                }
                var items = planning && Array.isArray(planning.items) ? planning.items : [];
                if (items.length) {
                    lines.push("");
                    lines.push("√âl√©ments :");
                    items.forEach(function (item, index) {
                        if (index) {
                            lines.push("");
                        }
                        var label = item.label || "Sans titre";
                        lines.push(label);
                        if (item.kind === "milestone") {
                            if (item.date) {
                                lines.push("Date: " + item.date);
                            }
                        } else {
                            if (item.start || item.end) {
                                var span = (item.start || "") + (item.start && item.end ? " ‚Üí " : "") + (item.end || "");
                                if (span) {
                                    var days = computeDaySpan(item.start, item.end);
                                    lines.push("Date: " + span + (days ? " (" + days + " jours)" : ""));
                                }
                            }
                        }
                        var groupLabel = groupMap[item.groupId] || item.groupId;
                        if (groupLabel) {
                            lines.push("Groupe: " + groupLabel);
                        }
                        if (item.kind) {
                            lines.push("Type: " + item.kind);
                        }
                    });
                } else {
                    lines.push("");
                    lines.push("Aucun √©l√©ment √† exporter pour l‚Äôinstant.");
                }
                return lines.join("\n");
            }

            function copyTextToClipboard(text) {
                if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                    return navigator.clipboard.writeText(text);
                }
                return new Promise(function (resolve, reject) {
                    var textarea = document.createElement("textarea");
                    textarea.value = text;
                    textarea.setAttribute("readonly", "");
                    textarea.style.position = "absolute";
                    textarea.style.left = "-9999px";
                    document.body.appendChild(textarea);
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    var success = document.execCommand("copy");
                    document.body.removeChild(textarea);
                    if (success) {
                        resolve();
                    } else {
                        reject(new Error("Fallback copy failed"));
                    }
                });
            }

            function showCopyToast(message) {
                if (!copyToast) return;
                copyToast.textContent = message;
                copyToast.classList.add("visible");
                if (copyToastTimer) {
                    clearTimeout(copyToastTimer);
                }
                copyToastTimer = setTimeout(function () {
                    copyToast.classList.remove("visible");
                    copyToastTimer = null;
                }, 2200);
            }

            async function exportTimelineText() {
                if (!exportTextBtn) return;
                closeContextMenus();
                exportTextBtn.disabled = true;
                try {
                    persistCurrentPlanning();
                    var currentView = views[activeViewIndex];
                    var planning = (currentView && currentView.planning) || exportPlanningToJson();
                    var text = buildTextExport(planning, currentView && currentView.title);
                    await copyTextToClipboard(text);
                    showCopyToast("Texte copi√© dans le presse-papier");
                } catch (err) {
                    console.error("Copie texte impossible", err);
                    alert("Impossible de copier le texte. R√©essaie.");
                } finally {
                    exportTextBtn.disabled = false;
                }
            }

            function applyImportedState(state) {
                if (!state) return;
                var importedViews = [];
                if (Array.isArray(state.views) && state.views.length) {
                    importedViews = state.views.map(function (view, index) {
                        var label = view.name || view.title || ("Vue " + (index + 1));
                        return {
                            name: label,
                            title: view.title || view.name || label,
                            planning: view.planning || null
                        };
                    });
                } else if (state.groups) {
                    var label = state.label || state.name || "Vue 1";
                    importedViews = [{ name: label, title: label, planning: state }];
                }
                if (!importedViews.length) {
                    alert("Aucune vue valide √† importer.");
                    return;
                }
                views = importedViews;
                if (state.displayPreferences) {
                    Object.assign(displayPreferences, state.displayPreferences);
                }
                renderFontSizeOptions();
                applyDisplayPreferences();
                syncFontControls();
                renderViewTabs();
                activateView(0, true);
                persistTimelineState();
            }

            function triggerImportJson() {
                if (!importJsonInput) return;
                importJsonInput.value = "";
                importJsonInput.click();
            }

            if (importJsonInput) {
                importJsonInput.addEventListener("change", function (event) {
                    var file = event.target.files && event.target.files[0];
                    if (!file) return;
                    var reader = new FileReader();
                    reader.onload = function () {
                        try {
                            var payload = JSON.parse(reader.result);
                            applyImportedState(payload);
                        } catch (err) {
                            alert("Fichier JSON invalide.");
                        }
                    };
                    reader.readAsText(file);
                    importJsonInput.value = "";
                });
            }

            if (importJsonBtn) {
                importJsonBtn.addEventListener("click", function () {
                    triggerImportJson();
                    closeContextMenus();
                });
            }
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener("click", function () {
                    exportTimelineState();
                    closeContextMenus();
                });
            }
            if (exportImageBtn) {
                exportImageBtn.addEventListener("click", exportTimelineImage);
            }
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener("click", exportTimelineExcel);
            }
            if (exportTextBtn) {
                exportTextBtn.addEventListener("click", exportTimelineText);
            }
            function showTimelineAbout() {
                if (!infoPopup) return;
                infoPopup.classList.add("open");
            }
            function hideTimelineAbout() {
                if (!infoPopup) return;
                infoPopup.classList.remove("open");
            }
            if (aboutTimelineBtn) {
                aboutTimelineBtn.addEventListener("click", function () {
                    showTimelineAbout();
                    closeContextMenus();
                });
            }
            if (infoCloseBtn) {
                infoCloseBtn.addEventListener("click", function () {
                    hideTimelineAbout();
                });
            }
            if (infoPopup) {
                infoPopup.addEventListener("click", function (event) {
                    if (event.target === infoPopup) {
                        hideTimelineAbout();
                    }
                });
            }
            if (switchToIndexBtn) {
                switchToIndexBtn.addEventListener("click", function () {
                    window.location.href = "index.html";
                });
            }

            function applyFont(font) {
                document.documentElement.style.setProperty("--app-font", font);
                document.body.style.fontFamily = font;
                if (timelineCard) {
                    timelineCard.style.fontFamily = font;
                }
                if (container) {
                    container.style.fontFamily = font;
                }
                displayPreferences.font = font;
            }

            function updateFontSize(size) {
                var normalized = parseInt(size, 10);
                if (isNaN(normalized)) {
                    normalized = 14;
                }
                var value = normalized + "px";
                document.documentElement.style.setProperty("--global-font-size", value);
                document.body.style.fontSize = value;
                if (timelineCard) timelineCard.style.fontSize = value;
                if (container) container.style.fontSize = value;
                displayPreferences.fontSize = normalized;
            }

            function syncFontControls() {
                var computed = getComputedStyle(document.documentElement);
                if (fontSizeInput) {
                    var rawSize = computed.getPropertyValue("--global-font-size").trim();
                    var calculated = parseInt(rawSize, 10);
                    if (isNaN(calculated)) {
                        calculated = parseInt(window.getComputedStyle(document.body).fontSize, 10);
                    }
                    if (!isNaN(calculated)) {
                        fontSizeInput.value = calculated;
                    }
                }
            }

            function applyBackground(value) {
                var normalized = (typeof value === "string" ? value.trim() : "") || "#ffffff";
                var bodyValue = normalized === "transparent" ? "#f7f7f7" : normalized;
                var cardValue = normalized === "transparent" ? "rgba(255, 255, 255, 0.6)" : normalized;
                document.body.style.background = bodyValue;
                document.documentElement.style.setProperty("--timeline-background", cardValue);
                if (timelineCard) {
                    timelineCard.style.background = cardValue;
                }
                displayPreferences.background = normalized;
                if (backgroundSelector) {
                    var selectorValue = allowedBackgroundValues.indexOf(normalized) >= 0
                        ? normalized
                        : allowedBackgroundValues[0];
                    backgroundSelector.value = selectorValue;
                }
                if (timelineBackgroundColorHex && normalized) {
                    timelineBackgroundColorHex.value = normalized;
                }
                if (timelineBackgroundColorPicker && normalized) {
                    timelineBackgroundColorPicker.value = normalized === "transparent" ? "#ffffff" : normalized;
                }
                syncTimelineBackgroundInputs(normalized);
            }

            function updateTimelineAspect(ratio) {
                if (!timelineCard || !ratio) return;
                var value = ratio.replace(":", " / ");
                timelineCard.dataset.ratio = ratio;
                timelineCard.style.setProperty("--timeline-aspect-ratio", value);
                timelineCard.style.aspectRatio = value;
            }

            function applyRatio(ratio) {
                displayPreferences.ratio = ratio;
                updateTimelineAspect(ratio);
            }

            function applyDisplayPreferences() {
                if (displayPreferences.font) {
                    applyFont(displayPreferences.font);
                }
                if (fontSizeInput && displayPreferences.fontSize) {
                    fontSizeInput.value = displayPreferences.fontSize;
                    updateFontSize(displayPreferences.fontSize);
                }
                var backgroundValue = displayPreferences.background || "#ffffff";
                applyBackground(backgroundValue);
                if (displayPreferences.ratio) {
                    applyRatio(displayPreferences.ratio);
                }
            }

            renderFontSizeOptions();

            if (fontSizeInput) fontSizeInput.addEventListener("change", function () {
                updateFontSize(this.value);
            });
            applyDisplayPreferences();
            syncFontControls();
            if (backgroundSelector) {
                backgroundSelector.addEventListener("change", function () {
                    applyBackground(this.value);
                });
            }

            var viewTabs = document.getElementById("viewTabs");
            var addViewBtn = document.getElementById("addViewBtn");
            var deleteViewBtn = document.getElementById("deleteViewBtn");

            function ensureViewName(index) {
                var view = views[index];
                if (!view) return "Vue " + (index + 1);
                return view.name || view.title || ("Vue " + (index + 1));
            }

            function refreshHeaderText() {
                if (!headerTitleElement) return;
                var currentView = views[activeViewIndex];
                headerTitleElement.textContent =
                    (currentView && (currentView.title || currentView.name)) || "Outil de planning ¬∑ OpenAI ready";
            }

            function resetTimelineForEmptyView() {
                persistenceLocked = true;
                groups.clear();
                items.clear();
                persistenceLocked = false;
                timeline.setWindow(
                    new Date(now.getTime() - 2 * oneWeek),
                    new Date(now.getTime() + 6 * oneWeek),
                    { animation: false }
                );
                refreshTypeFilterUI();
                updateTimelineFilter();
                persistCurrentPlanning();
            }

            function activateView(index, skipSave) {
                if (index < 0 || index >= views.length) return;
                if (!skipSave) {
                    persistCurrentPlanning();
                }
                activeViewIndex = index;
                var view = views[index];
                if (view && view.planning) {
                    applyPlanningFromJson(view.planning);
                } else {
                    resetTimelineForEmptyView();
                }
                refreshHeaderText();
                renderViewTabs();
            }

            if (headerTitleElement) {
                headerTitleElement.addEventListener("dblclick", function () {
                    var currentLabel = (headerTitleElement.textContent || "").trim();
                    var label = window.prompt("Nom de la vue", currentLabel);
                    if (label === null) return;
                    label = label.trim();
                    if (!label) return;
                    var view = views[activeViewIndex];
                    if (!view) return;
                    view.name = label;
                    view.title = label;
                    refreshHeaderText();
                    persistTimelineState();
                    renderViewTabs();
                });
            }

            function renderViewTabs() {
                if (!viewTabs) return;
                viewTabs.innerHTML = "";
                views.forEach(function (view, index) {
                    var btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "tab" + (index === activeViewIndex ? " active" : "");
                    btn.textContent = ensureViewName(index);
                    btn.dataset.index = index;
                    btn.addEventListener("click", function () {
                        activateView(Number(this.dataset.index));
                    });
                    viewTabs.appendChild(btn);
                });
                if (viewTabs.children.length > 0) {
                    var last = viewTabs.children[viewTabs.children.length - 1];
                    last.scrollIntoView({ behavior: "smooth", inline: "end" });
                }
            }

            function addView() {
                persistCurrentPlanning();
                var label = "Vue " + (views.length + 1);
                views.push({ name: label, title: label, planning: null });
                persistTimelineState();
                activateView(views.length - 1, true);
            }

            function deleteView() {
                if (views.length <= 1) return;
                views.splice(activeViewIndex, 1);
                if (activeViewIndex >= views.length) {
                    activeViewIndex = views.length - 1;
                }
                persistTimelineState();
                activateView(activeViewIndex, true);
            }

            addViewBtn && addViewBtn.addEventListener("click", addView);
            deleteViewBtn && deleteViewBtn.addEventListener("click", deleteView);

            renderViewTabs();
            activateView(activeViewIndex, true);
            // ============================================================
            // 3. Inline labeling via prompt (double-clic)
            // ============================================================
            var renameGuard = false;
            function editItemLabel(itemId) {
                if (renameGuard) return;
                renameGuard = true;
                setTimeout(function () {
                    renameGuard = false;
                }, 300);
                var it = items.get(itemId);
                if (!it) return;
                var current = (it.content || "").trim();
                var label = window.prompt("Saisis un libell√© ou vide pour supprimer", current);
                if (label === null) return;
                label = label.trim();
                if (!label) {
                    items.remove(itemId);
                    return;
                }
                items.update({ id: itemId, content: label });
            }

            function editGroupLabel(groupId) {
                if (!groupId) return;
                var group = groups.get(groupId);
                if (!group) return;
                var current = (group.content || group.label || group.id || "").trim();
                var label = window.prompt("Nom du groupe. Vider pour supprimer", current);
                if (label === null) return;
                label = label.trim();
                if (!label) {
                    if (!confirm("Supprimer ce groupe et tous les √©l√©ments associ√©s ?")) {
                        return;
                    }
                    var relatedItems = items.get({
                        filter: function (item) {
                            return item.group === groupId;
                        }
                    });
                    relatedItems.forEach(function (item) {
                        items.remove(item.id);
                    });
                    groups.remove(groupId);
                    return;
                }
                groups.update({ id: groupId, content: label, label: label });
            }

            // Double-clic : √©diter ou cr√©er
            timeline.on("doubleClick", function (props) {
                if (props.what === "group-label" && props.group) {
                    editGroupLabel(props.group);
                    return;
                }
                if (props.item) {
                    editItemLabel(props.item);
                    return;
                }

                if (props.time && props.group) {
                    var start = new Date(props.time);
                    var end = new Date(start.getTime() + oneWeek);
                    var id;
                    var newItem;

                    if (props.group === "milestones") {
                        id = "ms-" + Date.now();
                        newItem = {
                            id: id,
                            group: "milestones",
                            content: "",
                            start: start,
                            type: "point",
                            kind: "milestone",
                            className: "type-milestone milestone-class"
                        };
                    } else {
                        id = "it-" + Date.now();
                        newItem = {
                            id: id,
                            group: props.group,
                            content: "",
                            start: start,
                            end: end,
                            kind: "feature",
                            className: "type-feature"
                        };
                    }

                    items.add(newItem);
                    setTimeout(function () { editItemLabel(id); }, 30);
                }
            });

            // Ajout natif vis ‚Üí on force notre logique + label prompt
            options.onAdd = function (item, callback) {
                callback(null);
                var start = item.start || item.end || new Date();
                var groupId = item.group || "team-alpha";
                var id, newItem;

                if (groupId === "milestones") {
                    id = "ms-" + Date.now();
                    newItem = {
                        id: id,
                        group: "milestones",
                        content: "",
                        start: start,
                        type: "point",
                        kind: "milestone",
                        className: "type-milestone milestone-class"
                    };
                } else {
                    id = "it-" + Date.now();
                    newItem = {
                        id: id,
                        group: groupId,
                        content: "",
                        start: start,
                        end: new Date(start.getTime() + oneWeek),
                        kind: "feature",
                        className: "type-feature"
                    };
                }
                items.add(newItem);
                setTimeout(function () { editItemLabel(id); }, 30);
            };

            timeline.setOptions(options);
            updateTimelineFilter();

            // ============================================================
            // 4. S√©lection et suppression simple
            // ============================================================
            var selectedItemId = null;
            var btnAddMilestone = document.getElementById("btn-add-milestone");
            var btnRenameSelected = document.getElementById("btn-rename-selected");
            var btnAddItem = document.getElementById("btn-add-item");
            var btnDeleteSelected = document.getElementById("btn-delete-selected");

            function getDefaultGroupId() {
                if (!groups || typeof groups.get !== "function") {
                    return null;
                }
                var currentGroups = groups.get();
                if (currentGroups && currentGroups.length) {
                    return currentGroups[0].id;
                }
                var fallbackId = "team-alpha";
                if (typeof groups.add === "function") {
                    groups.add({
                        id: fallbackId,
                        content: "Team Alpha"
                    });
                }
                return fallbackId;
            }

            function getTimelineCenter() {
                if (!timeline || typeof timeline.getWindow !== "function") {
                    return new Date();
                }
                var windowBounds = timeline.getWindow();
                if (!windowBounds) {
                    return new Date();
                }
                var start = windowBounds.start ? new Date(windowBounds.start) : new Date();
                var end = windowBounds.end ? new Date(windowBounds.end) : new Date(start.getTime() + oneWeek);
                var mid = (start.getTime() + end.getTime()) / 2;
                return new Date(mid);
            }

            function getGroupForNewItem(isMilestone) {
                if (!groups || typeof groups.get !== "function") {
                    return null;
                }
                if (isMilestone) {
                    var milestoneGroup = groups.get("milestones");
                    if (milestoneGroup) {
                        return "milestones";
                    }
                }
                if (selectedItemId) {
                    var selectedItem = items.get(selectedItemId);
                    if (selectedItem && selectedItem.group) {
                        return selectedItem.group;
                    }
                }
                return getDefaultGroupId();
            }

            function computeDefaultEnd(start) {
                if (!start) return new Date();
                var end = new Date(start);
                if (currentScaleMode === "day") {
                    end.setDate(end.getDate() + 10);
                    return end;
                }
                if (currentScaleMode === "month") {
                    end.setMonth(end.getMonth() + 2);
                    return end;
                }
                end.setDate(end.getDate() + 14);
                return end;
            }

            function createTimelineItem(kind) {
                if (!items) return;
                var isMilestone = kind === "milestone";
                var groupId = getGroupForNewItem(isMilestone);
                if (!groupId) return;
                var baseStart = getTimelineCenter();
                var newItemId = (isMilestone ? "ms-" : "it-") + Date.now();
                var newItem = {
                    id: newItemId,
                    group: groupId,
                    content: "",
                    start: baseStart,
                    kind: isMilestone ? "milestone" : "feature",
                    className: isMilestone ? "type-milestone milestone-class" : "type-feature"
                };
                if (isMilestone) {
                    newItem.type = "point";
                } else {
                    newItem.end = computeDefaultEnd(baseStart);
                }
                items.add(newItem);
                if (timeline && typeof timeline.setSelection === "function") {
                    timeline.setSelection(newItemId);
                }
                selectedItemId = newItemId;
                updateSelectionButtons();
                setTimeout(function () {
                    editItemLabel(newItemId);
                }, 30);
            }

            timeline.on("select", function (props) {
                selectedItemId = (props.items && props.items.length) ? props.items[0] : null;
                updateSelectionButtons();
            });

            if (btnAddMilestone) {
                btnAddMilestone.addEventListener("click", function () {
                    createTimelineItem("milestone");
                });
            }
            if (btnRenameSelected) {
                btnRenameSelected.addEventListener("click", function () {
                    if (!selectedItemId) return;
                    editItemLabel(selectedItemId);
                });
            }
            if (btnAddItem) {
                btnAddItem.addEventListener("click", function () {
                    createTimelineItem("feature");
                });
            }

            function updateSelectionButtons() {
                var hasSelection = !!selectedItemId;
                if (btnDeleteSelected) {
                    btnDeleteSelected.disabled = !hasSelection;
                }
                if (btnRenameSelected) {
                    btnRenameSelected.disabled = !hasSelection;
                }
            }

            updateSelectionButtons();

            if (btnDeleteSelected) {
                btnDeleteSelected.addEventListener("click", function () {
                    if (!selectedItemId) return;
                    var it = items.get(selectedItemId);
                    var label = (it && it.content) ? it.content : selectedItemId;
                    if (confirm("Supprimer ¬´ " + label + " ¬ª ?")) {
                        items.remove(selectedItemId);
                        selectedItemId = null;
                        updateSelectionButtons();
                    }
                });
            }

            // ============================================================
            // 5. Fonctions JSON <-> vis-timeline
            // ============================================================
            function isoToDate(str) {
                if (!str) return null;
                var d = new Date(str);
                return isNaN(d.getTime()) ? null : d;
            }

            function toDate(iso) {
                var d = isoToDate(iso);
                if (d) return d;
                var fallback = new Date(iso);
                return isNaN(fallback.getTime()) ? new Date() : fallback;
            }

            function daysBetween(start, end) {
                if (!start || !end) return 0;
                return Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
            }

            function dateToIso(d) {
                if (!d) return null;
                return new Date(d).toISOString().slice(0, 10);
            }

            function applyPlanningFromJson(planning) {
                if (!planning) return;

                persistenceLocked = true;
                try {
                    applyTypeDefinitions(planning.types);
                    // groups
                    if (Array.isArray(planning.groups)) {
                        groups.clear();
                        planning.groups.forEach(function (g, idx) {
                            groups.add({
                                id: g.id,
                                content: g.label || g.id || ("Group " + (idx + 1))
                            });
                        });
                    }

                    // items
                    if (Array.isArray(planning.items)) {
                        items.clear();
                        planning.items.forEach(function (it) {
                            var kind = sanitizeTypeId(it.type || it.kind || "feature");
                            var base = {
                                id: it.id || ("it-" + Date.now() + Math.random()),
                                group: it.groupId,
                                content: it.label || "",
                                kind: kind
                            };
                            ensureTypeDefinition({ id: kind });

                            if (base.kind === "milestone") {
                                base.start = isoToDate(it.date || it.start);
                                base.type = "point";
                                base.className = "type-milestone milestone-class";
                            } else {
                                base.start = isoToDate(it.start);
                                base.end = isoToDate(it.end) || new Date(base.start.getTime() + oneWeek);
                                base.className = "type-" + base.kind;
                            }
                            items.add(base);
                        });
                    }

                    // timeline range
                    var rangeStart = planning.timeline && planning.timeline.start
                        ? isoToDate(planning.timeline.start)
                        : null;
                    var rangeEnd = planning.timeline && planning.timeline.end
                        ? isoToDate(planning.timeline.end)
                        : null;

                    if (rangeStart && rangeEnd) {
                        timeline.setWindow(rangeStart, rangeEnd, { animation: false });
                    } else {
                        timeline.fit({ animation: false });
                    }
                    refreshTypeFilterUI();
                    updateTimelineFilter();
                } finally {
                    persistenceLocked = false;
                }
                persistCurrentPlanning();
            }

            function exportPlanningToJson() {
                var g = groups.get();
                var it = items.get();

                var minStart = null;
                var maxEnd = null;

                var outGroups = g.map(function (gr) {
                    return {
                        id: gr.id,
                        label: gr.content
                    };
                });

                var outItems = it.map(function (item) {
                    if (item.kind === "milestone") {
                        if (item.start) {
                            var ds = new Date(item.start);
                            if (!minStart || ds < minStart) minStart = ds;
                            if (!maxEnd || ds > maxEnd) maxEnd = ds;
                        }
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: "milestone",
                            date: dateToIso(item.start)
                        };
                    } else {
                        var ds2 = item.start ? new Date(item.start) : null;
                        var de2 = item.end ? new Date(item.end) : null;
                        if (ds2) {
                            if (!minStart || ds2 < minStart) minStart = ds2;
                        }
                        if (de2) {
                            if (!maxEnd || de2 > maxEnd) maxEnd = de2;
                        } else if (ds2) {
                            if (!maxEnd || ds2 > maxEnd) maxEnd = ds2;
                        }

                        var kind = item.kind || "feature";
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: kind,
                            start: dateToIso(item.start),
                            end: dateToIso(item.end)
                        };
                    }
                });

                var typeEntries = Object.keys(typeDefinitions).map(function (key) {
                    var def = typeDefinitions[key];
                    if (!def) return null;
                    return {
                        id: def.id,
                        label: def.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    };
                }).filter(Boolean);

                var planning = {
                    timeline: {
                        start: dateToIso(minStart) || dateToIso(new Date()),
                        end: dateToIso(maxEnd) || dateToIso(new Date())
                    },
                    groups: outGroups,
                    items: outItems
                };

                if (typeEntries.length) {
                    planning.types = typeEntries;
                }

                return planning;
            }

            function formatColorForType(typeId) {
                var def = typeDefinitions[typeId];
                if (def && def.background) return def.border || def.background;
                return "    ";
            }

            // ============================================================
            // 6. Toolbar timeline
            // ============================================================
            document.getElementById("btn-today").addEventListener("click", function () {
                var range = 4 * oneWeek;
                var center = new Date();
                timeline.setWindow(
                    new Date(center.getTime() - range / 2),
                    new Date(center.getTime() + range / 2),
                    { animation: true }
                );
            });

            document.getElementById("btn-fit").addEventListener("click", function () {
                timeline.fit({ animation: true });
            });

            document.getElementById("btn-zoom-in").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() + interval * 0.25);
                var newEnd = new Date(r.end.getTime() - interval * 0.25);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            document.getElementById("btn-zoom-out").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() - interval * 0.5);
                var newEnd = new Date(r.end.getTime() + interval * 0.5);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            var btnWeek = document.getElementById("btn-scale-week");
            var btnDay = document.getElementById("btn-scale-day");
            var btnMonth = document.getElementById("btn-scale-month");

            function setScale(mode) {
                var normalized = (mode === "day" || mode === "month") ? mode : "week";
                currentScaleMode = normalized;
                snapMode = normalized;

                btnWeek.classList.toggle("btn-small-active", normalized === "week");
                btnDay.classList.toggle("btn-small-active", normalized === "day");
                btnMonth.classList.toggle("btn-small-active", normalized === "month");

                var timeAxis = (normalized === "day")
                    ? { scale: "day", step: 1 }
                    : (normalized === "month")
                        ? { scale: "month", step: 1 }
                        : { scale: "week", step: 1 };

                timeline.setOptions({
                    timeAxis: timeAxis,
                    snap: options.snap
                });
            }

            btnWeek.addEventListener("click", function () { setScale("week"); });
            btnDay.addEventListener("click", function () { setScale("day"); });
            btnMonth.addEventListener("click", function () { setScale("month"); });

            function detectScaleFromRange(start, end) {
                if (!start || !end) return null;
                var diff = end.getTime() - start.getTime();
                if (diff <= 0) return null;
                var days = diff / oneDay;
                if (days <= 21) return "day";
                if (days <= 90) return "week";
                return "month";
            }

            timeline.on("rangechanged", function (props) {
                var autoMode = detectScaleFromRange(props.start, props.end);
                if (autoMode && autoMode !== currentScaleMode) {
                    setScale(autoMode);
                }
            });

            // ============================================================
            // 7. Panneau OpenAI
            // ============================================================
            var txtPrompt = document.getElementById("prompt");
            var selectMode = document.getElementById("mode");
            var btnCall = document.getElementById("btn-call");
            var waitingTimerId = null;
            var waitingCounter = 60;
            var iaModalButtonDefaultLabel = iaModalButton
                ? iaModalButton.textContent.trim()
                : "‚ú®";

            function updateIaButtonLabel(isLoading, counter) {
                if (!iaModalButton) return;
                if (isLoading) {
                    var baseLabel = iaModalButtonDefaultLabel ? iaModalButtonDefaultLabel + " " : "";
                    var displayCounter = typeof counter === "number" ? counter : waitingCounter;
                    iaModalButton.textContent = baseLabel + "‚è≥ Attente " + displayCounter + "s";
                } else {
                    iaModalButton.textContent = iaModalButtonDefaultLabel;
                }
            }

            function stopWaitingTimer() {
                if (waitingTimerId) {
                    clearInterval(waitingTimerId);
                    waitingTimerId = null;
                }
                updateIaButtonLabel(false);
            }

            function startWaitingTimer() {
                stopWaitingTimer();
                waitingCounter = 60;
                updateIaButtonLabel(true, waitingCounter);
                waitingTimerId = setInterval(function () {
                    waitingCounter--;
                    if (waitingCounter < 0) {
                        waitingCounter = 60;
                    }
                    updateIaButtonLabel(true, waitingCounter);
                }, 1000);
            }

            function fillPromptTemplate(template, instructions, planningJson) {
                var text = template.replace("{{(contenu du id=\"prompt\") }}", instructions || "");
                if (template.indexOf("{{(contenu au format JSON du planning existant)}}") >= 0) {
                    text = text.replace("{{(contenu au format JSON du planning existant)}}", planningJson || "");
                }
                return text;
            }

            async function callOpenAI(messages) {
                var headers = {
                    "Content-Type": "application/json"
                };
                try {
                    console.log(
                        "OpenAI request content",
                        messages.map(function (m) {
                            return "[" + m.role + "] " + (m.content || "");
                        })
                    );
                    var response = await fetch(OPENAI_PROXY_URL, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({
                            model: OPENAI_MODEL,
                            temperature: OPENAI_TEMPERATURE,
                            messages: messages
                        })
                    });
                    if (!response.ok) {
                        var errBody = await response.text();
                        throw new Error(errBody);
                    }
                    var payload = await response.json();
                    var choice = (payload.choices && payload.choices[0]) || {};
                    var messageText = (choice.message && choice.message.content) || choice.text || "";
                    console.log("OpenAI received text", messageText);
                    return messageText;
                } catch (err) {
                    console.error("Erreur OpenAI", err);
                    alert("Impossible de contacter OpenAI. V√©rifie que le proxy est accessible.");
                    return null;
                }
            }

            btnCall.addEventListener("click", async function () {
                var mode = selectMode.value;
                var promptText = txtPrompt.value.trim();

                if (!promptText) {
                    alert("Ajoute un prompt avant d'appeler OpenAI üôÇ");
                    txtPrompt.focus();
                    return;
                }

                var currentPlanning = null;
                var planningJson = "";
                if (mode === "modify") {
                    currentPlanning = exportPlanningToJson();
                    planningJson = JSON.stringify(currentPlanning, null, 2);
                }

                var systemContent = fillPromptTemplate(
                    mode === "modify" ? MODIFY_SYSTEM_TEMPLATE : CREATE_SYSTEM_TEMPLATE,
                    promptText,
                    planningJson
                );

                var payload = {
                    schema: "planning-v1",
                    mode: mode,
                    prompt: promptText,
                    planning: currentPlanning
                };

                var messages = [
                    { role: "system", content: systemContent },
                    { role: "user", content: JSON.stringify(payload, null, 2) }
                ];

                startWaitingTimer();
                btnCall.disabled = true;
                closeIaModal();
                try {
                    var aiResponse = await callOpenAI(messages);
                    if (!aiResponse) return;
                    var normalized = aiResponse.trim();
                    console.log("OpenAI response body", normalized);
                    var planning;
                    try {
                        planning = JSON.parse(normalized);
                    } catch (err) {
                        console.error("JSON OpenAI invalide", err);
                        alert("R√©ponse OpenAI invalide : JSON attendu.");
                        return;
                    }
                    applyPlanningFromJson(planning);
                } finally {
                    btnCall.disabled = false;
                    stopWaitingTimer();
                }
            });

            var timelineTourSteps = [
                {
                    title: "Go-Timeline, ton copilote planning",
                    description: "Go-Timeline aide les consultants √† g√©n√©rer des plannings de projet clairs et rapides pour cadrer leurs prochaines √©tapes.",
                    selectors: [".timeline-header"]
                },
                {
                    title: "D√©marre par la modal IA ‚ú®",
                    description: "Clique sur ‚ú®, d√©cris ta demande dans la fen√™tre IA et patiente pendant que la magie transforme ton besoin en planning.",
                    selectors: ["#openIaModal"]
                },
                {
                    title: "Affiche, zoome, navigue",
                    description: "Le planning appara√Æt, tu peux zoomer, te d√©placer dans le temps et jongler avec les boutons de la barre d‚Äôoutils.",
                    selectors: [
                        ".toolbar .btn-group:nth-of-type(1)",
                        ".toolbar .btn-group:nth-of-type(2)",
                        ".toolbar .btn-group:nth-of-type(3)"
                    ]
                },
                {
                    title: "Modifie librement le contenu",
                    description: "Ajoute, renomme, d√©place, ajuste les dur√©es ou supprime n‚Äôimporte quel √©l√©ment directement dans la timeline.",
                    selectors: [".toolbar .item-actions"]
                },
                {
                    title: "Exporte ta timeline",
                    description: "Le menu üìÑ permet de t√©l√©charger la vue courante en texte, image ou Excel pour la partager rapidement.",
                    selectors: ["#fileMenuBtn"]
                }
            ];
            var timelineTourOverlay = document.getElementById("timelineTourOverlay");
            var timelineTourHighlight = timelineTourOverlay && timelineTourOverlay.querySelector(".tour-highlight");
            var timelineTourPanel = timelineTourOverlay && timelineTourOverlay.querySelector(".tour-panel");
            var timelineTourTitle = document.getElementById("timelineTourStepTitle");
            var timelineTourDescription = document.getElementById("timelineTourStepDescription");
            var timelineTourCounter = document.getElementById("timelineTourStepCounter");
            var timelineTourPrevBtn = document.getElementById("timelineTourPrevBtn");
            var timelineTourNextBtn = document.getElementById("timelineTourNextBtn");
            var timelineTourCloseBtn = document.getElementById("timelineTourCloseBtn");
            var timelineTourSkipBtn = document.getElementById("timelineTourSkipBtn");
            var timelineTourReplayBtn = document.getElementById("timelineTourReplayBtn");
            var timelineTourStorageKey = "goTimelineTourSeen";
            var timelineCurrentTourIndex = 0;

            function getSelectorsFromStep(step) {
                if (!step) return [];
                if (Array.isArray(step.selectors)) return step.selectors;
                if (step.selector) return [step.selector];
                return [];
            }

            function getSelectorsBoundingRect(selectors) {
                if (!selectors || !selectors.length) {
                    return null;
                }
                let unionRect = null;
                selectors.forEach(function (selector) {
                    var target = document.querySelector(selector);
                    if (!target) return;
                    var rect = target.getBoundingClientRect();
                    if (!unionRect) {
                        unionRect = {
                            top: rect.top,
                            left: rect.left,
                            right: rect.right,
                            bottom: rect.bottom
                        };
                    } else {
                        unionRect.top = Math.min(unionRect.top, rect.top);
                        unionRect.left = Math.min(unionRect.left, rect.left);
                        unionRect.right = Math.max(unionRect.right, rect.right);
                        unionRect.bottom = Math.max(unionRect.bottom, rect.bottom);
                    }
                });
                if (!unionRect) return null;
                unionRect.width = unionRect.right - unionRect.left;
                unionRect.height = unionRect.bottom - unionRect.top;
                return unionRect;
            }

            function positionTourPanel(selectors) {
                if (!timelineTourPanel) return;
                var spacing = 14;
                var defaults = {
                    top: "auto",
                    bottom: "28px",
                    left: "50%",
                    right: "auto",
                    transform: "translateX(-50%)"
                };
                Object.assign(timelineTourPanel.style, defaults);
                var rect = getSelectorsBoundingRect(selectors);
                if (!rect) return;
                var panelRect = timelineTourPanel.getBoundingClientRect();
                var top = rect.bottom + spacing;
                if (top + panelRect.height > window.innerHeight - spacing) {
                    top = rect.top - panelRect.height - spacing;
                }
                var left = rect.left + rect.width / 2 - panelRect.width / 2;
                left = Math.max(spacing, Math.min(left, window.innerWidth - panelRect.width - spacing));
                timelineTourPanel.style.top = Math.max(spacing, top) + "px";
                timelineTourPanel.style.left = left + "px";
                timelineTourPanel.style.bottom = "auto";
                timelineTourPanel.style.right = "auto";
                timelineTourPanel.style.transform = "none";
            }

            function updateHighlight(selectors) {
                if (!timelineTourHighlight || !timelineTourOverlay) return;
                var rect = getSelectorsBoundingRect(selectors);
                if (!rect) {
                    timelineTourHighlight.classList.add("hidden");
                    timelineTourOverlay.classList.add("dimmed");
                    return;
                }
                timelineTourOverlay.classList.remove("dimmed");
                timelineTourHighlight.classList.remove("hidden");
                var offset = 10;
                timelineTourHighlight.style.width = rect.width + offset * 2 + "px";
                timelineTourHighlight.style.height = rect.height + offset * 2 + "px";
                timelineTourHighlight.style.left = rect.left - offset + "px";
                timelineTourHighlight.style.top = rect.top - offset + "px";
            }

            function renderTimelineTourStep() {
                if (!timelineTourOverlay || !timelineTourSteps.length) return;
                var step = timelineTourSteps[timelineCurrentTourIndex];
                if (!step) return;
                timelineTourTitle.textContent = step.title;
                timelineTourDescription.textContent = step.description;
                timelineTourCounter.textContent = "√âtape " + (timelineCurrentTourIndex + 1) + " / " + timelineTourSteps.length;
                timelineTourPrevBtn.disabled = timelineCurrentTourIndex === 0;
                timelineTourNextBtn.textContent = timelineCurrentTourIndex === timelineTourSteps.length - 1 ? "Termin√©" : "Suivant";
                var selectors = getSelectorsFromStep(step);
                updateHighlight(selectors);
                positionTourPanel(selectors);
            }

            function openTimelineTour(startIndex) {
                hideTimelineAbout();
                if (!timelineTourOverlay) return;
                timelineCurrentTourIndex = typeof startIndex === "number" ? startIndex : 0;
                timelineTourOverlay.classList.add("visible");
                timelineTourOverlay.setAttribute("aria-hidden", "false");
                renderTimelineTourStep();
            }

            function closeTimelineTour(markSeen) {
                if (markSeen && window.localStorage) {
                    window.localStorage.setItem(timelineTourStorageKey, "1");
                }
                if (!timelineTourOverlay) return;
                timelineTourOverlay.classList.remove("visible");
                timelineTourOverlay.setAttribute("aria-hidden", "true");
                timelineTourOverlay.classList.remove("dimmed");
                if (timelineTourHighlight) {
                    timelineTourHighlight.classList.add("hidden");
                }
            }

            if (timelineTourPrevBtn) {
                timelineTourPrevBtn.addEventListener("click", function () {
                    if (timelineCurrentTourIndex === 0) return;
                    timelineCurrentTourIndex--;
                    renderTimelineTourStep();
                });
            }
            if (timelineTourNextBtn) {
                timelineTourNextBtn.addEventListener("click", function () {
                    if (timelineCurrentTourIndex >= timelineTourSteps.length - 1) {
                        closeTimelineTour(true);
                        return;
                    }
                    timelineCurrentTourIndex++;
                    renderTimelineTourStep();
                });
            }
            if (timelineTourCloseBtn) {
                timelineTourCloseBtn.addEventListener("click", function () {
                    closeTimelineTour(true);
                });
            }
            if (timelineTourSkipBtn) {
                timelineTourSkipBtn.addEventListener("click", function () {
                    closeTimelineTour(true);
                });
            }
            if (timelineTourReplayBtn) {
                timelineTourReplayBtn.addEventListener("click", function () {
                    if (window.localStorage) {
                        window.localStorage.removeItem(timelineTourStorageKey);
                    }
                    openTimelineTour(0);
                });
            }

            window.addEventListener("resize", function () {
                if (!timelineTourOverlay || !timelineTourOverlay.classList.contains("visible")) return;
                renderTimelineTourStep();
            });

            var timelineTourSeen = window.localStorage && window.localStorage.getItem(timelineTourStorageKey);
            if (!timelineTourSeen) {
                setTimeout(function () {
                    openTimelineTour(0);
                }, 200);
            }

            setScale("week");
            txtPrompt.focus();
        </script>
</body>

</html>