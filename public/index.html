<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Go-Toolkit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #f5f2eb;
            --surface: #ffffff;
            --surface-soft: #fdfbf6;
            --border-soft: #dfd5c7;
            --border-strong: #d0c3ad;
            --text: #2f2922;
            --muted: #8b8173;
            --primary: #2a7a57;
            --shadow-soft: 0 18px 40px rgba(47, 41, 34, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, rgba(255, 255, 255, 0.4), transparent 55%), var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 8px 6px 12px;
            font-size: 0.95rem;
        }

        .page {
            width: min(1080px, 100%);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hero,
        .section {
            border-radius: 12px;
            border: 1px solid var(--border-soft);
            background: var(--surface);
            padding: 12px;
            box-shadow: var(--shadow-soft);
        }

        .hero {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            text-align: left;
            background-image: linear-gradient(135deg, rgba(42, 122, 87, 0.06), rgba(255, 255, 255, 0));
            min-height: 50px;
            flex-wrap: wrap;
        }

        .hero-logo-wrapper {
            width: 80px;
            height: 52px;
            border-radius: 14px;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero-logo-wrapper img {
            width: 90px;
        }

        h1 {
            margin: 0;
            font-size: clamp(1.4rem, 2.8vw, 1.9rem);
            letter-spacing: -0.02em;
        }

        .hero p {
            margin: 0;
            max-width: 420px;
            color: var(--muted);
            line-height: 1.3;
            font-size: 0.85rem;
        }

        .section-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 0px;
        }

        .section-label {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--muted);
            margin: 5px
        }

        .ghost-button {
            border: 1px solid var(--border-strong);
            border-radius: 999px;
            background: transparent;
            color: var(--text);
            font-size: 0.8rem;
            padding: 2px 6px;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .ghost-button:hover,
        .ghost-button:focus-visible {
            border-color: var(--primary);
            box-shadow: 0 12px 30px rgba(42, 122, 87, 0.15);
            outline: none;
        }

        .launcher-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-between;
            min-height: 30px;
        }

        .launcher {
            flex: 1 1 180px;
            min-width: 150px;
            text-decoration: none;
            color: var(--text);
            border-radius: 8px;
            padding: 20px 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-soft);
            background: var(--surface-soft);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            min-height: 30px;
            height: 30px;
        }

        .launcher:hover,
        .launcher:focus-visible {
            transform: translateY(-2px);
            box-shadow: 0 20px 34px rgba(42, 122, 87, 0.12);
            outline: none;
        }

        .launcher-emoji {
            font-size: 28px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .launcher-name {
            font-size: 15px;
            font-weight: 600;
        }

        .share-gallery {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .share-card {
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-radius: 8px;
            padding: 6px;
            border: 1px solid var(--border-soft);
            background: var(--surface-soft);
            text-decoration: none;
            color: var(--text);
            min-height: 120px;
            transition: box-shadow 0.2s ease;
        }

        .share-card:hover,
        .share-card:focus-visible {
            box-shadow: 0 18px 28px rgba(47, 41, 34, 0.12);
            outline: none;
        }

        .share-card-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .share-card-desc {
            margin: 0;
            color: var(--muted);
            line-height: 1.3;
            min-height: 2em;
            font-size: 0.85rem;
        }

        .share-card-date {
            margin: 4px 0 0;
            font-size: 0.75rem;
            color: rgba(47, 41, 34, 0.6);
        }

        .share-helper {
            margin: 8px 0 0;
            color: var(--muted);
            font-size: 0.8rem;
        }

        .share-helper[hidden] {
            display: none;
        }

        .share-helper-error {
            color: #b43a3f;
        }

        @media (max-width: 720px) {
            body {
                padding: 8px;
            }

            .hero,
            .section {
                padding: 10px;
            }

            .launcher-grid {
                flex-direction: column;
            }

            .launcher {
                width: 100%;
            }

            .share-gallery {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <header class="hero">
            <div class="hero-logo-wrapper">
                <img src="logo.gif" alt="Logo Go-Toolkit">
            </div>
            <h1>Go-Toolkit</h1>
            <p>La boîte à idées IA des consultants</p>
        </header>

        <section class="section">
            <div class="section-title-row">
                <p class="section-label">Nouveau</p>
            </div>
            <div class="launcher-grid">
                <a class="launcher" href="think.html">
                    <span class="launcher-emoji">◫</span>
                    <span class="launcher-name">Go-Think · Structure tes idées</span>
                </a>
                <a class="launcher" href="plan.html">
                    <span class="launcher-emoji">▷</span>
                    <span class="launcher-name">Go-Plan · Organise tes actions</span>
                </a>
                <a class="launcher" href="draw.html">
                    <span class="launcher-emoji">◇</span>
                    <span class="launcher-name">Go-Draw · Schématise tes pensées</span>
                </a>
            </div>
        </section>

        <section class="section">
            <div class="section-title-row">
                <p class="section-label">Partages</p>
                <button id="refreshShares" class="ghost-button" type="button">↻</button>
            </div>
            <div id="shareGallery" class="share-gallery" aria-live="polite"></div>
            <p id="shareLoading" class="share-helper">Chargement des galeries...</p>
            <p id="shareEmpty" class="share-helper" hidden>Aucun partage enregistré pour cette session.</p>
            <p id="shareError" class="share-helper share-helper-error" hidden></p>
        </section>
    </div>

    <script>
        window.GO_TOOLKIT_SHARE_API_URL =
            window.GO_TOOLKIT_SHARE_API_URL || "https://share.gotoolkit.workers.dev/";
    </script>
    <script src="js/share-worker-client.js"></script>
    <script src="js/share-history.js"></script>
    <script>
        (function () {
            const gallery = document.getElementById("shareGallery");
            const loadingLabel = document.getElementById("shareLoading");
            const emptyLabel = document.getElementById("shareEmpty");
            const errorLabel = document.getElementById("shareError");
            const refreshBtn = document.getElementById("refreshShares");
            const shareHistory = window.goToolkitShareHistory;
            const shareService = window.goToolkitShareWorker;

            const APP_DEFINITIONS = {
                think: { emoji: "◫", name: "Go-Think", page: "think.html", collection: "slides" },
                plan: { emoji: "▷", name: "Go-Plan", page: "plan.html", collection: "timelines" },
                draw: { emoji: "◇", name: "Go-Draw", page: "draw.html", collection: "diagrams" }
            };

            function setState({ loading = false, hasData = false, error = "" }) {
                if (loadingLabel) {
                    loadingLabel.hidden = !loading;
                }
                if (emptyLabel) {
                    emptyLabel.hidden = loading || hasData || Boolean(error);
                }
                if (errorLabel) {
                    errorLabel.hidden = !error;
                    errorLabel.textContent = error || "";
                }
            }

            function formatFriendlyDate(isoString) {
                if (!isoString) return "Mis à jour";
                try {
                    const value = new Date(isoString).getTime();
                    if (Number.isNaN(value)) return "Mis à jour";
                    const deltaSeconds = Math.max(0, Math.floor((Date.now() - value) / 1000));
                    if (deltaSeconds < 60) return "À l'instant";
                    const deltaMinutes = Math.floor(deltaSeconds / 60);
                    if (deltaMinutes < 60) return `Il y a ${deltaMinutes} min`;
                    const deltaHours = Math.floor(deltaMinutes / 60);
                    if (deltaHours < 24) return `Il y a ${deltaHours} h`;
                    const deltaDays = Math.floor(deltaHours / 24);
                    if (deltaDays < 30) return `Il y a ${deltaDays} j`;
                    const formatter = new Intl.DateTimeFormat("fr-FR", {
                        day: "2-digit",
                        month: "short",
                        hour: "2-digit",
                        minute: "2-digit"
                    });
                    return formatter.format(new Date(value));
                } catch (err) {
                    return "Mis à jour";
                }
            }

            function normalizeLines(value) {
                if (!value) return [];
                return value
                    .split(/\r?\n/)
                    .map(line => line.trim())
                    .filter(Boolean)
                    .slice(0, 2);
            }

            function extractPreview(app, payload) {
                if (app === "think") {
                    const firstSlide = payload?.slides?.[0];
                    const tabName = firstSlide?.title || "Sans titre";
                    const context = payload?.settings?.globalContext || payload?.settings?.context || "";
                    return { tabName, lines: normalizeLines(context) };
                }
                if (app === "plan") {
                    const firstView = payload?.views?.[0];
                    const tabName = firstView?.title || firstView?.name || "Planning";
                    const brief = payload?.brief || "";
                    return { tabName, lines: normalizeLines(brief) };
                }
                if (app === "draw") {
                    const firstPage = payload?.pages?.[0];
                    const tabName = firstPage?.label || "Page 1";
                    const context = firstPage?.input || "";
                    return { tabName, lines: normalizeLines(context) };
                }
                return { tabName: "Sans titre", lines: [] };
            }

            function getStoredRecords() {
                if (!shareHistory) {
                    return [];
                }
                const records = shareHistory.getRecords() || {};
                return Object.entries(records).filter(([app, record]) => APP_DEFINITIONS[app] && record?.token);
            }

            function buildShareUrl(definition, token) {
                const url = new URL(definition.page, window.location.origin);
                url.searchParams.set("share", token);
                return url.toString();
            }

            async function buildShareCard(app, record) {
                const definition = APP_DEFINITIONS[app];
                if (!definition || !shareService?.isReady) {
                    return null;
                }
                let result;
                try {
                    result = await shareService.fetchSharePayload(definition.collection, record.token);
                } catch (err) {
                    console.error(`Impossible de récupérer le partage ${app}`, err);
                    return null;
                }
                if (!result || !result.payload) {
                    shareHistory?.removeRecord?.(app);
                    return null;
                }
                const preview = extractPreview(app, result.payload);
                const updatedAt = record.updatedAt || result.meta?.updatedAt || new Date().toISOString();
                const formattedDate = formatFriendlyDate(updatedAt);
                const card = document.createElement("a");
                card.className = "share-card";
                card.href = buildShareUrl(definition, record.token);
                card.target = "_blank";
                card.rel = "noopener noreferrer";
                card.setAttribute("data-app", app);
                card.innerHTML = `
                    <p class="share-card-title">${definition.emoji} ${preview.tabName}</p>
                    <p class="share-card-desc">${preview.lines.join(" · ") || "Complète le contexte pour l'afficher ici."}</p>
                    <p class="share-card-date">${formattedDate}</p>
                `;
                return card;
            }

            async function refreshGallery() {
                if (!shareHistory) {
                    setState({ loading: false, hasData: false, error: "Historique des partages indisponible." });
                    return;
                }
                if (!shareService?.isReady) {
                    setState({ loading: false, hasData: false, error: "Service de partage indisponible." });
                    return;
                }
                setState({ loading: true, hasData: false, error: "" });
                gallery.innerHTML = "";
                const entries = getStoredRecords();
                if (!entries.length) {
                    setState({ loading: false, hasData: false, error: "" });
                    return;
                }
                const cards = await Promise.all(entries.map(([app, record]) => buildShareCard(app, record)));
                const validCards = cards.filter(Boolean);
                if (!validCards.length) {
                    setState({ loading: false, hasData: false, error: "" });
                    return;
                }
                validCards.forEach(card => gallery.appendChild(card));
                setState({ loading: false, hasData: true, error: "" });
            }

            refreshBtn?.addEventListener("click", () => {
                refreshGallery();
            });

            refreshGallery();
        })();
    </script>
</body>

</html>