<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Go-Roadmap ‚Äì Tabs 3 colonnes</title>
    <style>
        * {
            box-sizing: border-box;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 30;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 14px;
            padding: 18px;
            max-width: 480px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: var(--muted);
        }

        .modal label {
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .modal textarea,
        .modal input[type="text"],
        .modal input[type="password"] {
            border-radius: 8px;
            border: 1px solid #d0c3ad;
            padding: 8px;
            font-size: 13px;
            font-family: inherit;
        }

        .modal-panel textarea {
            min-height: 90px;
            height: 90px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-footer button {
            border-radius: 8px;
            padding: 6px 12px;
            border: 1px solid #dcd0c1;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .modal-footer button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
        }


        :root {
            --bg: #f5f2eb;
            --card-bg: #ffffff;
            --border-soft: #dfd5c7;
            --text-main: #2f2922;
            --muted: #8b8173;
            --now-color: #e3f4ea;
            --next-color: #fff6de;
            --later-color: #e3f1ff;
            --radius-large: 16px;
            --radius: 10px;
            --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.05);
            --slide-aspect-ratio: 16 / 9;
        }

        html,
        body {
            min-height: 100vh;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f7f7f7;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .app {
            max-width: 1320px;
            margin: 0 auto;
            padding: 4px 4px 4px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: calc(100vh - 24px);
            width: 100%;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        .global-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .global-actions button {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .global-actions button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
            box-shadow: var(--shadow-soft);
        }

        #tabs {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tab-btn {
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
            padding: 4px 10px;
            cursor: pointer;
            color: var(--muted);
            font-size: 12px;
        }

        .tab-btn.active {
            background: #2a7a57;
            color: #fff;
            border-color: #2a7a57;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        }

        .tab-btn-add,
        .tab-btn-delete {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 4px 12px;
            cursor: pointer;
            font-size: 12px;
            color: var(--muted);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .tab-btn-delete {
            border-color: #d86f6f;
            color: #c04040;
        }

        .slides-container {
            position: relative;
            flex: 1;
            min-height: calc(100vh - 200px);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .slide-wrapper {
            margin-top: 4px;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .slide {
            background: var(--slide-bg, transparent);
            border-radius: var(--radius-large);
            padding: 8px 8px 8px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: calc(100vh - 45px);
            max-height: calc(100vh - 45px);
            aspect-ratio: var(--slide-aspect-ratio, 16 / 9);
            width: auto;
        }

        .slide,
        .slide-body,
        .column-body {
            color: var(--slide-text-color, var(--text-main));
        }

        .slide.hidden {
            display: none;
        }

        .slide-header {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 4px;
        }

        .slide-title-row,
        .slide-subtitle-row {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }

        .slide-title-row input,
        .slide-subtitle-row input {
            flex: 1;
        }

        .slide-title-input {
            border: none;
            background: transparent;
            font-size: 20px;
            font-weight: 650;
            padding: 0;
            margin: 0;
            color: var(--slide-text-color, var(--text-main));
            line-height: 1.2;
        }

        .slide-subtitle-input {
            border: none;
            background: transparent;
            font-size: 13px;
            color: var(--slide-text-color, var(--muted));
            padding: 0;
            margin: 0;
            line-height: 1.2;
        }

        .slide-header input:focus-visible {
            outline: none;
            box-shadow: inset 0 -2px 0 #d0c3ad;
        }

        .slide-header-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slide-body {
            display: flex;
            gap: 18px;
            align-items: stretch;
            flex: 1;
            position: relative;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 14px;
            flex: 1;
        }

        .column {
            border-radius: 4px;
            background: var(--slide-bg, transparent);
            border: 1px solid #ebe0d1;
            display: flex;
            flex-direction: column;
            min-height: 420px;
            --stage-color: #f0ede7;
            transition: box-shadow 0.2s ease;
        }

        .column.palette-active {
            box-shadow: none;
            border-color: #ebe0d1;
        }

        :root {
            --global-background: #ffffff;
        }

        .column-header {
            background: var(--slide-bg, transparent);
            border-bottom: 1px solid rgba(0, 0, 0, 0.02);
            border-radius: 4px 4px 0 0;
            padding: 4px 4px 4px;
            min-height: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            overflow: visible;
        }

        .column-header-main {
            display: flex;
            width: 100%;
        }

        .stage-pill {
            font-size: calc(var(--slide-font-size, 16px) + 3px);
            font-weight: 700;
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
            letter-spacing: 0.08em;
            padding: 8px 10px;
            border-radius: 0px;
            border: 0;
            background: var(--slide-bg, transparent);
            cursor: text;
            width: 100%;
            text-align: left;
        }

        .stage-pill:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 122, 87, 0.5);
        }



        .column-body {
            padding: 10px 12px 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 12px;
            background: var(--slide-bg, transparent);
            border-radius: 0 0 4px 4px;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .section-label {
            font-size: calc(var(--slide-label-size, 12px) + 3px);
            font-weight: 700;
            color: var(--slide-text-color, var(--muted));
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 22px;
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
        }

        .section-text-row {
            position: relative;
        }

        .textarea-wrapper {
            position: relative;
            width: 100%;
        }

        .textarea-wrapper textarea {
            padding-top: 26px;
        }

        .field-ai-btn.inside {
            position: absolute;
            bottom: 6px;
            right: 6px;
            border-radius: 999px;
            border: 1px solid #dcd0c1;
            background: rgba(255, 255, 255, 0.9);
            font-size: 11px;
            padding: 2px 6px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .section-label-row,
        .section-text-row {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }

        .field-ai-btn {
            border: none;
            background: transparent;
            font-size: 16px;
            color: #918b7f;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .textarea-wrapper:hover .field-ai-btn,
        .textarea-wrapper textarea:focus-visible+.field-ai-btn,
        .field-ai-btn:focus-visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .field-ai-btn:hover {
            color: #2a7a57;
        }

        .section textarea {
            width: 100%;
            border-radius: 4px;
            font-size: var(--slide-font-size, 16px);
            padding: 6px 8px;
            line-height: 1.4;
            min-height: 140px;
            resize: vertical;
            border: none;
            background: var(--slide-bg, transparent);
            color: var(--slide-text-color, #2f2922);
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
            overflow: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .column-focused textarea {
            border: 1px solid #cfcfcf;
        }

        .section textarea::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .section textarea:focus-visible {
            outline: 1px solid rgba(42, 122, 87, 0.8);
            box-shadow: none;
            scrollbar-width: thin;
        }

        .section textarea.textarea-overflow {
            border: 2px solid #f7c63a;
            box-shadow: 0 0 0 1px rgba(247, 198, 58, 0.35);
        }

        .section textarea:focus-visible::-webkit-scrollbar {
            width: 8px;
        }

        .section textarea::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .section textarea::-webkit-resizer,
        .section textarea::-moz-resizer {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .section textarea:focus-visible::-webkit-resizer,
        .section textarea:focus-visible::-moz-resizer {
            opacity: 1;
        }

        .column-color-grid,
        .slide-bg-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 6px;
        }

        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0d7c8;
        }

        .section-heading {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .column-palettes {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .palette-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .palette-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: flex;
            gap: 6px;
        }

        .ratio-option {
            flex: 1;
            border-radius: 8px;
            border: 1px solid #e0d7c1;
            background: #fff;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .ratio-option.active {
            border-color: #2a7a57;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .font-size-control button {
            border-radius: 999px;
            border: 1px solid #dcd0c1;
            background: #f7f5f1;
            width: 28px;
            height: 28px;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .font-size-control input {
            flex: 1;
            text-align: center;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #cfc6b8;
            cursor: pointer;
            padding: 0;
            background: #fff;
        }

        .color-swatch.transparent {
            background-image: repeating-conic-gradient(#cfc6b8 0% 25%, #fff 0% 50%);
            background-size: 6px 6px;
        }

        .color-swatch:focus-visible {
            outline: 2px solid #2a7a57;
            outline-offset: 2px;
        }

        .text-style-option {
            border-radius: 10px;
            border: 1px solid #e0d7c8;
            padding: 8px;
            background: #fff;
            text-align: left;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 64px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .text-style-option.active {
            border-color: #2a7a57;
        }

        /* √©tats d‚Äô√©dition : bordures seulement au survol / focus */
        .editable {
            border: 1px solid transparent;
            background: transparent;
            transition: border-color 0.12s ease, background-color 0.12s ease, box-shadow 0.12s ease;
        }

        .editable:hover {
            border-color: #d0c3ad;
            background: #fffdf8;
        }

        .editable:focus-visible {
            outline: none;
            border-color: #c0a97f;
            background: #ffffff;
            box-shadow: 0 0 0 1px rgba(192, 169, 127, 0.35);
        }

        /* textareas utilisent editable + fond l√©ger */
        .section textarea.editable {
            background: var(--slide-bg, transparent);
        }

        body.exporting .editable {
            border: none;
            box-shadow: none;
            background: var(--slide-bg, transparent);
        }

        body.exporting .section textarea {
            border: none;
        }

        .ratio-wrapper {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .ratio-grid {
            display: flex;
            gap: 6px;
        }

        .ratio-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .ratio-option {
            flex: 1;
            border-radius: 8px;
            border: 1px solid #e0d7c8;
            background: #fff;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .ratio-option.active {
            border-color: #2a7a57;
        }

        @media print {
            body {
                background: #ffffff;
            }

            .app-header {
                display: none;
            }

            .slide {
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="app-header">
            <div class="tabs-actions">
                <div id="tabs"></div>
                <button class="tab-btn-add" id="addTabBtn" type="button">+ page</button>
                <button class="tab-btn-delete" id="deleteTabBtn" type="button">üóëÔ∏è</button>
            </div>
            <div class="global-actions">
                <button id="textStyleBtn" type="button" aria-label="Options d'affichage">üñåÔ∏è</button>
                <button id="contextBtn" type="button" aria-label="AI Assistant">‚ú®</button>
                <button id="importJsonBtn" type="button">‚¨ÜÔ∏è</button>
                <button id="exportJsonBtn" type="button">‚¨áÔ∏è</button>
                <button id="exportPptxBtn" type="button">üìä PPTX</button>
                <button id="exportPngBtn" type="button" aria-label="Exporter la page">üñºÔ∏è</button>
            </div>
        </div>

        <div class="slides-container">
            <div id="slides" class="slide-wrapper"></div>
        </div>
    </div>

    <div class="modal-overlay" id="contextModal">
        <div class="modal">
            <div class="modal-header">
                <h3>IA & contexte</h3>
                <button class="modal-close" data-close="contextModal">√ó</button>
            </div>
            <div class="modal-panel" data-panel="context">
                <label>
                    D√©cris ton contexte et ta vision de produit
                    <textarea id="contextField" rows="4" placeholder="Contexte..."></textarea>
                </label>
            </div>
            <div class="modal-panel hide" data-panel="settings">
                <label>
                    OpenAI API key
                    <input type="password" id="apiKeyInput" autocomplete="off" placeholder="sk-...">
                </label>
                <label>
                    Prompt objectif (3‚Äì5 expressions courtes)
                    <textarea id="objectivePrompt" rows="2"></textarea>
                </label>
                <label>
                    Prompt moyens (3‚Äì5 expressions courtes)
                    <textarea id="meansPrompt" rows="2"></textarea>
                </label>
                <label>
                    Prompt indicateurs (3‚Äì5 expressions courtes)
                    <textarea id="indicatorsPrompt" rows="2"></textarea>
                </label>
                <button id="resetPromptsBtn" type="button">R√©initialiser les prompts</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>R√©glages</h3>
                <button class="modal-close" data-close="settingsModal">√ó</button>
            </div>
            <div class="modal-panel" data-panel="settings">
                <label>
                    Police
                    <select id="fontSelect"></select>
                </label>
                <label>
                    Taille (px)
                    <select id="fontSizeInput">
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                        <option value="13">13</option>
                        <option value="14">14</option>
                        <option value="15">15</option>
                        <option value="16">16</option>
                    </select>
                </label>
                <label>
                    Fond global
                    <select id="backgroundSelector">
                        <option value="#ffffff">Blanc</option>
                        <option value="transparent">Transparent</option>
                    </select>
                </label>
                <div class="ratio-wrapper">
                    <div class="ratio-label">Aspect ratio</div>
                    <div class="ratio-grid" id="ratioGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.js"></script>
    <script>
        const stageColors = {
            NOW: getComputedStyle(document.documentElement).getPropertyValue("--now-color").trim(),
            NEXT: getComputedStyle(document.documentElement).getPropertyValue("--next-color").trim(),
            LATER: getComputedStyle(document.documentElement).getPropertyValue("--later-color").trim()
        };
        document.documentElement.style.setProperty("--global-background", "#ffffff");

        const textStyles = [
            { name: "Inter", font: "Inter, system-ui, sans-serif", size: 14 },
            { name: "Space Grotesk", font: "'Space Grotesk', 'Inter', sans-serif", size: 14 },
            { name: "Sora", font: "'Sora', 'Segoe UI', sans-serif", size: 15 },
            { name: "Poppins", font: "'Poppins', 'Segoe UI', sans-serif", size: 14 },
            { name: "Manrope", font: "'Manrope', 'Segoe UI', sans-serif", size: 14 },
            { name: "IBM Plex Sans", font: "'IBM Plex Sans', 'Segoe UI', sans-serif", size: 14 },
            { name: "Rounded", font: "'Segoe UI', 'Fredoka One', sans-serif", size: 14 },
            { name: "Serif", font: "Georgia, 'Times New Roman', serif", size: 16 },
            { name: "Mono", font: "'JetBrains Mono', 'Menlo', monospace", size: 13 }
        ];

        const ratioOptions = [
            { name: "16:9", css: "16 / 9", pptx: { width: 10, height: 5.625 } },
            { name: "4:3", css: "4 / 3", pptx: { width: 10, height: 7.5 } },
            { name: "A4", css: "297 / 210", pptx: { width: 11.69, height: 8.27 } }
        ];

        const sectionDefinitions = [
            {
                key: "objective",
                icon: "üéØ",
                label: "Objectif / Impacts business",
                examples:
                    "D√©crire ce que l‚Äôutilisateur ou l‚Äôentreprise gagne quand l‚Äôobjectif est atteint. Formule courte + b√©n√©fice m√©tier. Exemples : \n‚Ä¢ Am√©liorer la fiabilit√© des donn√©es pour r√©duire les erreurs de saisie de 20% \n‚Ä¢ Acc√©l√©rer l‚Äôacc√®s aux indicateurs pour faciliter la d√©cision \n‚Ä¢ Simplifier le parcours utilisateur pour diminuer le temps d‚Äôaction de 30%"
            },
            {
                key: "means",
                icon: "üöÄ",
                label: "Moyens / Solutions / Livrables",
                examples:
                    "Lister ce que l‚Äô√©quipe va produire pour atteindre l‚Äôobjectif : actions, fonctionnalit√©s, ateliers, prototypes. Exemples : \n‚Ä¢ D√©velopper un module de validation automatique \n‚Ä¢ Produire un tableau de bord Power BI \n‚Ä¢ Revoir l‚ÄôUX (wireframes + tests utilisateurs) \n‚Ä¢ Mettre en place une API d‚Äôimport automatis√©"
            },
            {
                key: "indicators",
                icon: "üìà",
                label: "Indicateurs business",
                examples:
                    "D√©crire comment mesurer la r√©ussite : chiffres, qualit√©, d√©lais, adoption. Exemples : \n‚Ä¢ K1 : 95% de donn√©es compl√®tes et conformes \n‚Ä¢ K2 : Temps moyen d‚Äôusage < 40s \n‚Ä¢ K3 : 70% d‚Äôutilisateurs actifs hebdo \n‚Ä¢ K4 : -30% de tickets support"
            }
        ];

        const defaultSectionLabels = sectionDefinitions.reduce((acc, section) => {
            acc[section.key] = `${section.icon} ${section.label}`;
            return acc;
        }, {});

        const defaultStagePillLabels = {
            NOW: "üü¢ NOW - Chantier 1",
            NEXT: "üü° NEXT - Chantier 2",
            LATER: "üîµ LATER - Chantier 3"
        };

        const slidesContainer = document.getElementById("slides");
        const tabsContainer = document.getElementById("tabs");
        const addTabBtn = document.getElementById("addTabBtn");
        const deleteTabBtn = document.getElementById("deleteTabBtn");
        const exportBtn = document.getElementById("exportPngBtn");
        const exportPptxBtn = document.getElementById("exportPptxBtn");
        const textStyleBtn = document.getElementById("textStyleBtn");
        const importJsonBtn = document.getElementById("importJsonBtn");
        const exportJsonBtn = document.getElementById("exportJsonBtn");
        const contextBtn = document.getElementById("contextBtn");

        const apiKeyInput = document.getElementById("apiKeyInput");
        const objectivePromptInput = document.getElementById("objectivePrompt");
        const meansPromptInput = document.getElementById("meansPrompt");
        const indicatorsPromptInput = document.getElementById("indicatorsPrompt");
        const contextModal = document.getElementById("contextModal");
        const contextField = document.getElementById("contextField");
        const contextModalTabs = contextModal.querySelectorAll(".modal-tab");
        const contextModalPanels = contextModal.querySelectorAll(".modal-panel");
        const settingsModal = document.getElementById("settingsModal");
        const fontSelect = document.getElementById("fontSelect");
        const fontSizeInput = document.getElementById("fontSizeInput");
        const ratioGrid = document.getElementById("ratioGrid");
        const backgroundSelector = document.getElementById("backgroundSelector");
        const modalPrimary = document.getElementById("modalPrimary");
        const resetPromptsBtn = document.getElementById("resetPromptsBtn");

        const STORAGE_KEY = "go-roadmap-state";
        const defaultObjectivePrompt = `En tant que consultant product owner exp√©riment√© de 20 ans, sur la base du contexte {{contextField}} et du contenu {{fieldValue}}, reformule sur forme d'une liste de 2 √† 3 objectifs clairs et impactants (2 lignes max pour chaque) sans introduction pr√©alable`;
        const defaultMeansPrompt = `En tant que consultant product owner exp√©riment√© de 20 ans, sur la base du contexte {{contextField}} et du contenu {{fieldValue}}, reformule sous forme d'une liste de 3 √† 5 solutions / livrables / moyens concrets et actionnables (2 lignes max pour chaque) sans introduction pr√©alable`;
        const defaultIndicatorsPrompt = `En tant que consultant product owner exp√©riment√© de 20 ans, sur la base du contexte {{contextField}} et du contenu {{fieldValue}}, reformule sous forme d'une liste de 3 √† 5 indicateurs cl√©s (KPI/OKR) concrets et mesurables (2 lignes max pour chaque) sans introduction pr√©alable`;

        let persistTimer = null;

        function schedulePersist() {
            clearTimeout(persistTimer);
            persistTimer = setTimeout(persistState, 500);
        }

        function persistState() {
            const payload = {
                slides: collectSlideData(),
                settings: {
                    ratioIndex: currentRatioIndex,
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize,
                    apiKey: apiKeyInput.value,
                    objectivePrompt: objectivePromptInput.value,
                    meansPrompt: meansPromptInput.value,
                    indicatorsPrompt: indicatorsPromptInput.value,
                    context: contextField.value
                }
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (err) {
                console.error("Impossible de sauvegarder l'√©tat :", err);
            }
        }

        function loadSavedState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                return false;
            }
            try {
                const parsed = JSON.parse(stored);
                objectivePromptInput.value = parsed.settings?.objectivePrompt || defaultObjectivePrompt;
                meansPromptInput.value = parsed.settings?.meansPrompt || defaultMeansPrompt;
                indicatorsPromptInput.value = parsed.settings?.indicatorsPrompt || defaultIndicatorsPrompt;
                apiKeyInput.value = parsed.settings?.apiKey || "";
                contextField.value = parsed.settings?.context || "";
                currentTextStyleIndex = parseStyleIndex(parsed.settings?.textStyleIndex);
                currentFontSize = normalizeFontSize(parsed.settings?.fontSize ?? currentFontSize);
                currentRatioIndex = Math.max(0, Math.min(ratioOptions.length - 1, parsed.settings?.ratioIndex ?? 0));
                if (Array.isArray(parsed.slides) && parsed.slides.length) {
                    importSlidesFromData(parsed.slides, parsed.settings ?? { ratioIndex: currentRatioIndex });
                    return true;
                }
                return false;
            } catch (err) {
                console.error("Impossible de charger l'√©tat :", err);
                objectivePromptInput.value = defaultObjectivePrompt;
                meansPromptInput.value = defaultMeansPrompt;
                indicatorsPromptInput.value = defaultIndicatorsPrompt;
                return false;
            }
        }

        const importInput = document.createElement("input");
        importInput.type = "file";
        importInput.accept = "application/json";
        importInput.style.display = "none";
        document.body.appendChild(importInput);

        let slideCount = 0;
        let activeIndex = 0;
        let activePaletteColumn = null;
        let currentTextStyleIndex = 0;
        let currentFontSize = 12;
        let currentRatioIndex = 0;

        const defaultTitle = "GO-Roadmap";
        const defaultSubtitle = "Produit / √©quipe / scope";
        const ratioButtons = [];

        function parseStyleIndex(value) {
            const parsed = parseInt(value, 10);
            return Number.isNaN(parsed) ? currentTextStyleIndex : parsed;
        }

        function selectColumnForPalette(column) {
            if (!column) {
                activePaletteColumn = null;
                document.querySelectorAll(".column.palette-active").forEach(el => el.classList.remove("palette-active"));
                return;
            }
            document.querySelectorAll(".column.palette-active").forEach(el => el.classList.remove("palette-active"));
            activePaletteColumn = column;
            column.classList.add("palette-active");
        }

        function updateSectionLabelsInSlide(sectionKey, sourceLabel) {
            const slide = sourceLabel.closest(".slide");
            if (!slide) return;
            const rawText = sourceLabel.textContent.trim();
            const normalized = rawText || defaultSectionLabels[sectionKey];
            slide.querySelectorAll(`.section-label[data-section="${sectionKey}"]`).forEach(label => {
                label.textContent = normalized;
            });
        }

        function bindSectionLabel(label) {
            const sectionKey = label.dataset.section;
            label.addEventListener("blur", () => {
                if (!label.textContent.trim()) {
                    label.textContent = defaultSectionLabels[sectionKey];
                }
                updateSectionLabelsInSlide(sectionKey, label);
            });
        }

        function bindTextareaPlaceholder(textarea) {
            const example = textarea.dataset.placeholder || "";
            textarea.addEventListener("focus", () => {
                if (!textarea.value) {
                    textarea.placeholder = example;
                }
            });
            textarea.addEventListener("blur", () => {
                textarea.placeholder = "";
            });
        }

        function showColumnPlaceholders(column) {
            column.querySelectorAll("textarea").forEach(textarea => {
                if (!textarea.value) {
                    textarea.placeholder = textarea.dataset.placeholder || "";
                }
            });
        }

        function clearColumnPlaceholders(column) {
            column.querySelectorAll("textarea").forEach(textarea => {
                if (!textarea.value) {
                    textarea.placeholder = "";
                }
            });
        }

        function normalizeBullets(textarea) {
            const lines = textarea.value.split("\n");
            const normalized = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return "";
                return trimmed.startsWith("‚Ä¢") ? trimmed : `‚Ä¢ ${trimmed}`;
            });
            textarea.value = normalized.join("\n");
        }

        function updateTextareaOverflowState(textarea) {
            if (!textarea) return;
            textarea.classList.toggle("textarea-overflow", textarea.scrollHeight > textarea.clientHeight);
        }

        function monitorTextareaOverflow(textarea) {
            updateTextareaOverflowState(textarea);
            textarea.addEventListener("input", () => updateTextareaOverflowState(textarea));
            textarea.addEventListener("keydown", event => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const insert = "\n‚Ä¢ ";
                    textarea.setRangeText(insert, start, end, "end");
                    const newPos = start + insert.length;
                    textarea.setSelectionRange(newPos, newPos);
                    updateTextareaOverflowState(textarea);
                }
            });
            textarea.addEventListener("blur", () => {
                normalizeBullets(textarea);
            });
        }


        function getActiveSlideElement() {
            return slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
        }

        function applyColumnStageColor(stage, color) {
            const column = getActiveSlideElement()?.querySelector(`.column[data-stage="${stage}"]`);
            if (!column) return;
            column.style.setProperty("--stage-color", color);
            schedulePersist();
        }

        function applyBackgroundToActiveSlide(color) {
            const slide = getActiveSlideElement();
            if (!slide) return;
            applyBackgroundToSlide(slide, color);
            syncBackgroundSelector();
            document.documentElement.style.setProperty("--global-background", color);
        }

        function syncBackgroundSelector() {
            if (!backgroundSelector) return;
            const slide = getActiveSlideElement();
            if (!slide) return;
            const value = slide.dataset.bgColor || "#ffffff";
            backgroundSelector.value = value === "transparent" ? "transparent" : "#ffffff";
        }

        function normalizeFontSize(value) {
            const parsed = Number(value);
            if (Number.isNaN(parsed)) {
                return currentFontSize;
            }
            return Math.max(8, Math.min(72, parsed));
        }

        function syncFontControls() {
            if (fontSelect) {
                fontSelect.value = currentTextStyleIndex;
            }
            if (fontSizeInput) {
                fontSizeInput.value = currentFontSize;
            }
        }

        function handleFontSizeChange(value) {
            const normalized = normalizeFontSize(value);
            if (normalized === currentFontSize && Number(value) === normalized) {
                return;
            }
            currentFontSize = normalized;
            if (fontSizeInput) {
                fontSizeInput.value = normalized;
            }
            const activeSlide = getActiveSlideElement();
            if (activeSlide) {
                applyTextStyleToSlide(activeSlide, currentTextStyleIndex, currentFontSize);
            }
        }

        function initSettingsModal() {
            fontSelect.innerHTML = "";
            textStyles.forEach((style, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = style.name;
                option.style.fontFamily = style.font;
                option.style.fontSize = `${style.size}px`;
                fontSelect.appendChild(option);
            });

            ratioGrid.innerHTML = "";
            ratioButtons.length = 0;
            ratioOptions.forEach((ratio, index) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "ratio-option";
                btn.dataset.index = index;
                btn.textContent = ratio.name;
                btn.addEventListener("click", () => {
                    applyRatio(index);
                });
                ratioButtons.push(btn);
                ratioGrid.appendChild(btn);
            });

            fontSelect.addEventListener("change", () => {
                currentTextStyleIndex = parseInt(fontSelect.value, 10);
                const activeSlide = getActiveSlideElement();
                if (activeSlide) {
                    applyTextStyleToSlide(activeSlide, currentTextStyleIndex, currentFontSize);
                }
            });
            fontSizeInput.addEventListener("change", () => handleFontSizeChange(fontSizeInput.value));
            Array.from(fontSizeInput.options).forEach(opt => {
                opt.style.fontSize = `${opt.value}px`;
            });
            backgroundSelector.addEventListener("change", () => {
                applyBackgroundToActiveSlide(backgroundSelector.value);
            });

            syncFontControls();
            syncBackgroundSelector();
            updateRatioButtons();
        }

        function openSettingsModal() {
            syncFontControls();
            syncBackgroundSelector();
            openModal(settingsModal);
        }

        function closeSettingsModal() {
            closeModal(settingsModal);
        }

        initSettingsModal();

        function updateRatioButtons() {
            ratioButtons.forEach((button, index) => {
                button.classList.toggle("active", index === currentRatioIndex);
            });
        }

        function parseHexColor(value) {
            const hex = value.replace(/^#/, "");
            if (hex.length !== 6) return null;
            return {
                r: parseInt(hex.slice(0, 2), 16),
                g: parseInt(hex.slice(2, 4), 16),
                b: parseInt(hex.slice(4, 6), 16)
            };
        }

        function getBrightnessFromColor(value) {
            const parsed = parseHexColor(value);
            if (!parsed) return 1;
            return (parsed.r * 299 + parsed.g * 587 + parsed.b * 114) / 1000 / 255;
        }

        function getTextColorForBackground(value) {
            if (!value || value === "transparent") {
                return "#2f2922";
            }
            if (value.startsWith("linear-gradient")) {
                const match = value.match(/#([0-9a-fA-F]{6})/);
                if (match) {
                    value = `#${match[1]}`;
                }
            }
            const brightness = getBrightnessFromColor(value);
            return brightness < 0.6 ? "#ffffff" : "#2f2922";
        }

        function setSlideTextColor(slide, color) {
            const textColor = getTextColorForBackground(color);
            slide.style.setProperty("--slide-text-color", textColor);
        }

        function applyBackgroundToSlide(slide, color) {
            const normalized = color || "transparent";
            slide.dataset.bgColor = normalized;
            slide.style.setProperty("--slide-bg", normalized);
            setSlideTextColor(slide, normalized);
            schedulePersist();
        }

        function applyTextStyleToSlide(slide, styleIndex, size = currentFontSize) {
            const style = textStyles[styleIndex] || textStyles[0];
            const fontSize = typeof size === "number" ? size : currentFontSize;
            slide.dataset.textStyleIndex = styleIndex;
            slide.dataset.fontSize = fontSize;
            slide.style.setProperty("--slide-font-family", style.font);
            slide.style.setProperty("--slide-font-size", `${fontSize}px`);
            const labelSize = Math.max(fontSize - 2, 12);
            slide.style.setProperty("--slide-label-size", `${labelSize}px`);
            schedulePersist();
        }

        function applyRatio(index) {
            const ratio = ratioOptions[index] || ratioOptions[0];
            currentRatioIndex = index;
            document.documentElement.style.setProperty("--slide-aspect-ratio", ratio.css);
            updateRatioButtons();
            schedulePersist();
        }

        function collectSlideData() {
            const slides = Array.from(slidesContainer.querySelectorAll(".slide"));
            return slides.map(slide => {
                const columns = Array.from(slide.querySelectorAll(".column")).map(column => {
                    const columnTitle = column.querySelector(".stage-pill")?.textContent.trim() || "";
                    const stagePill = column.querySelector(".stage-pill");
                    const stageLabel = stagePill ? stagePill.textContent.trim() : "";
                    const stageColor = column.style.getPropertyValue("--stage-color").trim();
                    const columnData = {
                        stage: column.dataset.stage,
                        stageLabel,
                        stageColor,
                        title: columnTitle,
                        sections: {}
                    };
                    sectionDefinitions.forEach(section => {
                        const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                        const textarea = column.querySelector(`textarea[data-section="${section.key}"]`);
                        columnData.sections[section.key] = {
                            label: label ? label.textContent.trim() : defaultSectionLabels[section.key],
                            text: textarea ? textarea.value : ""
                        };
                    });
                    return columnData;
                });
                const titleEl = slide.querySelector(".slide-title-input");
                const fontSizeValue = parseInt(slide.dataset.fontSize, 10);
                return {
                    title: titleEl ? titleEl.value : defaultTitle,
                    bgColor: slide.dataset.bgColor || "transparent",
                    textStyleIndex: parseStyleIndex(slide.dataset.textStyleIndex),
                    fontSize: Number.isNaN(fontSizeValue) ? currentFontSize : fontSizeValue,
                    columns
                };
            });
        }

        function createColumn(colIndex, stage = "NOW", seed = {}) {
            const column = document.createElement("div");
            column.className = "column";
            column.dataset.stage = seed.stage || stage;
            const humanIndex = colIndex + 1;
            const defaultTitleText =
                stage === "NOW" ? "Now" :
                    stage === "NEXT" ? "Next" :
                        stage === "LATER" ? "Later" :
                            `Colonne ${humanIndex}`;
            const fallbackStage = seed.stageLabel || defaultStagePillLabels[column.dataset.stage] || column.dataset.stage;
            const stageColor = seed.stageColor || "#ffffff";
            column.style.setProperty("--stage-color", stageColor);

            const sectionsHtml = sectionDefinitions.map(section => `
        <div class="section">
          <div class="section-label-row">
            <span class="section-label" data-section="${section.key}" contenteditable="true">${section.icon} ${section.label}</span>
          </div>
          <div class="section-text-row">
            <div class="textarea-wrapper">
              <textarea class="editable" data-section="${section.key}" data-placeholder="${(section.examples || "").replace(/"/g, '&quot;')}"></textarea>
              <button class="field-ai-btn inside" type="button" data-field="section-text" data-section="${section.key}" title="G√©n√©rer le contenu" aria-label="G√©n√©rer le contenu">‚ú®</button>
            </div>
          </div>
        </div>
      `).join("");

            column.innerHTML = `
      <div class="column-header">
        <div class="column-header-main">
          <span class="stage-pill" contenteditable="true">${fallbackStage}</span>
        </div>
      </div>
      <div class="column-body">
        ${sectionsHtml}
      </div>
    `;

            const pill = column.querySelector(".stage-pill");
            pill.addEventListener("focus", () => {
                selectColumnForPalette(column);
                const selection = window.getSelection();
                if (selection) {
                    const range = document.createRange();
                    range.selectNodeContents(pill);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
            pill.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    pill.blur();
                }
            });
            pill.addEventListener("blur", () => {
                if (!pill.textContent.trim()) {
                    pill.textContent = fallbackStage;
                }
            });

            column.querySelectorAll(".section-label").forEach(bindSectionLabel);

            sectionDefinitions.forEach(section => {
                const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                const textarea = column.querySelector(`textarea[data-section="${section.key}"]`);
                const sectionSeed = seed.sections && seed.sections[section.key];
                if (sectionSeed) {
                    label.textContent = sectionSeed.label || defaultSectionLabels[section.key];
                    textarea.value = sectionSeed.text || "";
                }
                monitorTextareaOverflow(textarea);
            });

            column.addEventListener("focusin", () => {
                column.classList.add("column-focused");
                showColumnPlaceholders(column);
            });
            column.addEventListener("focusout", () => {
                column.classList.remove("column-focused");
                setTimeout(() => {
                    if (!column.contains(document.activeElement)) {
                        clearColumnPlaceholders(column);
                    }
                }, 0);
            });

            column.querySelectorAll("textarea").forEach(bindTextareaPlaceholder);

            column.addEventListener("click", () => {
                selectColumnForPalette(column);
            });

            return column;
        }

        function createSlide(index, seed = {}) {
            const slide = document.createElement("div");
            slide.className = "slide";
            slide.dataset.index = index;
            const titleValue = (seed.title || defaultTitle).replace(/"/g, '&quot;');
            const subtitleValue = (seed.subtitle || defaultSubtitle).replace(/"/g, '&quot;');
            slide.innerHTML = `
  <div class="slide-header">
    <div class="slide-title-row">
      <input class="slide-title-input editable" type="text" value="${titleValue}">
    </div>
  </div>
  <div class="slide-body">
    <div class="columns"></div>
  </div>
`;
            const columnsContainer = slide.querySelector(".columns");
            ["NOW", "NEXT", "LATER"].forEach((stage, columnIndex) => {
                const columnSeed = seed.columns && seed.columns[columnIndex];
                columnsContainer.appendChild(createColumn(columnIndex, stage, columnSeed));
            });

            columnsContainer.addEventListener("click", event => {
                const targetColumn = event.target.closest(".column");
                if (targetColumn) {
                    selectColumnForPalette(targetColumn);
                }
            });
            const bgColor = seed.bgColor || "#ffffff";
            applyBackgroundToSlide(slide, bgColor);
            const styleIndex = typeof seed.textStyleIndex === "number" ? seed.textStyleIndex : currentTextStyleIndex;
            const fontSize = typeof seed.fontSize === "number" ? seed.fontSize : currentFontSize;
            applyTextStyleToSlide(slide, styleIndex, fontSize);
            return slide;
        }

        function createTabButton(index) {
            const btn = document.createElement("button");
            btn.className = "tab-btn";
            btn.dataset.index = index;
            const slide = slidesContainer.querySelector(`.slide[data-index="${index}"]`);
            const label = slide?.dataset.tabLabel || "Page " + (index + 1);
            btn.textContent = label;
            btn.addEventListener("click", () => setActiveTab(index));
            btn.addEventListener("dblclick", () => {
                const newName = prompt("Renommer l'onglet", btn.textContent);
                if (!newName) return;
                btn.textContent = newName;
                if (slide) {
                    slide.dataset.tabLabel = newName;
                }
            });
            tabsContainer.appendChild(btn);
        }

        function refreshTabs() {
            tabsContainer.innerHTML = "";
            const slides = slidesContainer.querySelectorAll(".slide");
            slides.forEach((slide, idx) => {
                slide.dataset.index = idx;
                createTabButton(idx);
            });
            slideCount = slides.length;
            updateDeleteButtonState();
        }

        function setActiveTab(index) {
            closeSettingsModal();
            activeIndex = index;
            const slides = slidesContainer.querySelectorAll(".slide");
            const tabBtns = tabsContainer.querySelectorAll(".tab-btn");
            slides.forEach(s => {
                s.classList.toggle("hidden", s.dataset.index != index);
            });
            tabBtns.forEach(b => {
                b.classList.toggle("active", b.dataset.index == index);
            });
            const activeSlide = slidesContainer.querySelector(`.slide[data-index="${index}"]`);
            const firstColumn = activeSlide ? activeSlide.querySelector(".column") : null;
            if (firstColumn) {
                selectColumnForPalette(firstColumn);
            }
            if (activeSlide) {
                currentTextStyleIndex = parseStyleIndex(activeSlide.dataset.textStyleIndex);
                currentFontSize = normalizeFontSize(activeSlide.dataset.fontSize ?? currentFontSize);
                syncFontControls();
                syncBackgroundSelector();
            }
        }

        function buildColumnSeeds(slide) {
            if (!slide) {
                return [];
            }
            return Array.from(slide.querySelectorAll(".column")).map(column => {
                const stagePill = column.querySelector(".stage-pill");
                const stageLabel = stagePill ? stagePill.textContent.trim() : column.dataset.stage || "";
                const stageColor = column.style.getPropertyValue("--stage-color").trim() || "#ffffff";
                const sections = {};
                sectionDefinitions.forEach(section => {
                    const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                    sections[section.key] = {
                        label: label ? (label.textContent.trim() || defaultSectionLabels[section.key]) : defaultSectionLabels[section.key]
                    };
                });
                return { stageLabel, stageColor, sections };
            });
        }

        function getDefaultFromCurrentSlide() {
            const slide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (!slide) {
                return null;
            }
            const titleEl = slide.querySelector(".slide-title-input");
            const subtitleEl = slide.querySelector(".slide-subtitle-input");
            const bgColor = slide.dataset.bgColor || "#ffffff";
            const textStyleIndex = parseStyleIndex(slide.dataset.textStyleIndex);
            const fontSize = normalizeFontSize(slide.dataset.fontSize ?? currentFontSize);
            const columns = buildColumnSeeds(slide);
            return {
                title: titleEl?.value || defaultTitle,
                subtitle: subtitleEl?.value || defaultSubtitle,
                bgColor,
                textStyleIndex,
                fontSize,
                columns
            };
        }

        function getDefaultFromLastSlide() {
            if (slideCount === 0) {
                return {
                    title: defaultTitle,
                    subtitle: defaultSubtitle,
                    bgColor: "transparent",
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize
                };
            }
            const previousSlide = slidesContainer.querySelector(`.slide[data-index="${slideCount - 1}"]`);
            if (!previousSlide) {
                return {
                    title: defaultTitle,
                    subtitle: defaultSubtitle,
                    bgColor: "transparent",
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize
                };
            }
            const prevTitleEl = previousSlide.querySelector(".slide-title-input");
            const prevSubtitleEl = previousSlide.querySelector(".slide-subtitle-input");
            return {
                title: prevTitleEl ? prevTitleEl.value : defaultTitle,
                subtitle: prevSubtitleEl ? prevSubtitleEl.value : defaultSubtitle,
                bgColor: previousSlide.dataset.bgColor || "transparent",
                textStyleIndex: parseStyleIndex(previousSlide.dataset.textStyleIndex),
                fontSize: normalizeFontSize(previousSlide.dataset.fontSize ?? currentFontSize),
                columns: buildColumnSeeds(previousSlide)
            };
        }

        function addTab() {
            const idx = slideCount;
            const seed = getDefaultFromCurrentSlide() || getDefaultFromLastSlide();
            const slide = createSlide(idx, seed);
            slidesContainer.appendChild(slide);
            createTabButton(idx);
            slideCount++;
            updateDeleteButtonState();
            setActiveTab(idx);
            schedulePersist();
        }


        function updateDeleteButtonState() {
            deleteTabBtn.disabled = slideCount <= 1;
        }

        addTabBtn.addEventListener("click", addTab);


        deleteTabBtn.addEventListener("click", () => {
            if (slideCount <= 1) {
                return;
            }
            const currentSlide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (currentSlide) {
                currentSlide.remove();
            }
            refreshTabs();
            if (activeIndex >= slideCount) {
                activeIndex = slideCount - 1;
            }
            setActiveTab(activeIndex);
            schedulePersist();
        });

        textStyleBtn.addEventListener("click", event => {
            event.stopPropagation();
            openSettingsModal();
        });

        if (resetPromptsBtn) {
            resetPromptsBtn.addEventListener("click", () => {
                objectivePromptInput.value = defaultObjectivePrompt;
                meansPromptInput.value = defaultMeansPrompt;
                indicatorsPromptInput.value = defaultIndicatorsPrompt;
                schedulePersist();
            });
        }

        importJsonBtn.addEventListener("click", () => {
            importInput.value = "";
            importInput.click();
        });

        importInput.addEventListener("change", event => {
            const files = event.target.files;
            const file = files && files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    const payload = Array.isArray(parsed) ? { slides: parsed, settings: {} } : parsed;
                    importSlidesFromData(payload.slides ?? payload, payload.settings ?? {});
                } catch (err) {
                    alert("Import JSON invalide.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        });

        exportJsonBtn.addEventListener("click", () => {
            const data = collectSlideData();
            const payload = {
                slides: data,
                settings: {
                    ratioIndex: currentRatioIndex,
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize
                }
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "go-roadmap.json";
            link.click();
            URL.revokeObjectURL(link.href);
        });

        function importSlidesFromData(slidesData, settings) {
            const slideList = Array.isArray(slidesData) ? slidesData : [];
            slidesContainer.innerHTML = "";
            slideCount = 0;
            activeIndex = 0;
            if (typeof settings.ratioIndex === "number") {
                applyRatio(settings.ratioIndex);
            }
            if (typeof settings.textStyleIndex === "number") {
                currentTextStyleIndex = settings.textStyleIndex;
            }
            if (typeof settings.fontSize === "number") {
                currentFontSize = normalizeFontSize(settings.fontSize);
            }
            slideList.forEach((slideData, index) => {
                const slide = createSlide(index, {
                    ...slideData,
                    textStyleIndex: typeof slideData.textStyleIndex === "number" ? slideData.textStyleIndex : currentTextStyleIndex,
                    fontSize: typeof slideData.fontSize === "number" ? slideData.fontSize : currentFontSize
                });
                slidesContainer.appendChild(slide);
                slideCount++;
            });
            refreshTabs();
            setActiveTab(0);
            schedulePersist();
        }

        function withExportMode(action) {
            return (async () => {
                closeSettingsModal();
                document.body.classList.add("exporting");
                try {
                    return await action();
                } finally {
                    document.body.classList.remove("exporting");
                }
            })();
        }

        function prepareSlideForExport(slide) {
            const wrapper = document.createElement("div");
            wrapper.style.position = "fixed";
            wrapper.style.top = "-9999px";
            wrapper.style.left = "-9999px";
            wrapper.style.opacity = "0";
            wrapper.style.pointerEvents = "none";
            wrapper.style.zIndex = "-1";
            const clone = slide.cloneNode(true);
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);
            clone.querySelectorAll("textarea").forEach(textarea => {
                const computed = window.getComputedStyle(textarea);
                const replacement = document.createElement("div");
                replacement.textContent = textarea.value || textarea.placeholder || "";
                replacement.style.cssText = computed.cssText;
                replacement.style.whiteSpace = "pre-wrap";
                replacement.style.wordBreak = "break-word";
                replacement.style.overflow = "visible";
                replacement.style.width = computed.width;
                replacement.style.minHeight = computed.height;
                replacement.style.boxSizing = "border-box";
                textarea.replaceWith(replacement);
            });
            clone.querySelectorAll(".column-title").forEach(input => {
                const computed = window.getComputedStyle(input);
                const replacement = document.createElement("div");
                replacement.textContent = input.value || "";
                replacement.style.cssText = computed.cssText;
                replacement.style.whiteSpace = "nowrap";
                replacement.style.overflow = "visible";
                replacement.style.width = computed.width;
                replacement.style.height = computed.height;
                replacement.style.fontSize = `calc(${computed.fontSize} + 5px)`;
                replacement.style.position = "relative";
                replacement.style.top = "10px";
                replacement.style.boxSizing = "border-box";
                input.replaceWith(replacement);
            });
            return { wrapper, clone };
        }

        exportBtn.addEventListener("click", async () => {
            const slide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (!slide) return;
            const oldText = exportBtn.textContent;
            exportBtn.textContent = "‚è≥";
            exportBtn.disabled = true;
            try {
                await withExportMode(async () => {
                    const { wrapper, clone } = prepareSlideForExport(slide);
                    try {
                        const canvas = await html2canvas(clone, { scale: 2, backgroundColor: null, useCORS: true });
                        const link = document.createElement("a");
                        link.download = `go-roadmap-page-${activeIndex + 1}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    } finally {
                        wrapper.remove();
                    }
                });
            } catch (err) {
                alert("Export impossible. Tu peux utiliser l'impression PDF en secours.");
                console.error(err);
            } finally {
                exportBtn.textContent = oldText;
                exportBtn.disabled = false;
            }
        });

        function buildTableDataForSlide(slideData) {
            const columns = slideData.columns || [];
            if (!columns.length) {
                return [];
            }
            const formatSection = (section) =>
                (section?.text || "")
                    .split(/\n+/)
                    .map(line => line.trim())
                    .filter(Boolean)
                    .map((line, idx) => `${idx + 1}. ${line}`)
                    .join("\n");
            const headerRow = columns.map(column => ({
                text: `${column.stageLabel || column.stage || ""} ‚Äî ${column.title || ""}`.trim(),
                options: { bold: true, fontSize: 10 }
            }));
            const sectionKeys = ["objective", "means", "indicators"];
            const rows = sectionKeys.map(key =>
                columns.map(column => ({
                    text: formatSection(column.sections[key]),
                    options: { fontSize: 10 }
                }))
            );
            return [headerRow, ...rows];
        }

        async function exportPptxFromSlides() {
            const ratio = ratioOptions[currentRatioIndex] || ratioOptions[0];
            const data = collectSlideData();
            if (!data.length) return;
            const pptx = new PptxGenJS();
            const layoutName = `CUSTOM_${ratio.name.replace(/[^a-zA-Z0-9]/g, "_")}`;
            pptx.defineLayout({ name: layoutName, width: ratio.pptx.width, height: ratio.pptx.height });
            pptx.layout = layoutName;
            for (const slideData of data) {
                const pptSlide = pptx.addSlide();
                const table = buildTableDataForSlide(slideData);
                pptSlide.addTable(table, {
                    x: 0.4,
                    y: 0.4,
                    w: ratio.pptx.width - 0.8,
                    border: { type: "none" },
                    fontSize: 10,
                    rowH: 0.4,
                    valign: "top",
                    color: "363636"
                });
                pptSlide.addText(`${slideData.title} ‚Äî ${slideData.subtitle}`, {
                    x: 0.4,
                    y: 0.1,
                    w: ratio.pptx.width - 0.8,
                    fontSize: 12,
                    bold: true
                });
            }
            await pptx.writeFile({ fileName: "go-roadmap.pptx" });
        }

        exportPptxBtn.addEventListener("click", async () => {
            exportPptxBtn.disabled = true;
            try {
                await withExportMode(async () => {
                    await exportPptxFromSlides();
                });
            } catch (err) {
                alert("Export PPTX impossible. Tu peux r√©essayer.");
                console.error(err);
            } finally {
                exportPptxBtn.disabled = false;
            }
        });

        function fillTemplate(template, data) {
            return template.replace(/\{\{(\w+)\}\}/g, (_, key) => data[key] ?? "");
        }

        const fieldPromptTemplates = {
            objective: () => objectivePromptInput.value.trim() || defaultObjectivePrompt,
            means: () => meansPromptInput.value.trim() || defaultMeansPrompt,
            indicators: () => indicatorsPromptInput.value.trim() || defaultIndicatorsPrompt
        };

        function buildFieldPrompt(section, contextData) {
            const template = fieldPromptTemplates[section]();
            return fillTemplate(template, contextData);
        }

        async function callOpenAI(messages) {
            const apiKey = apiKeyInput.value.trim();
            try {
                const useProxy = !apiKey;
                if (useProxy) {
                    console.warn("Appel OpenAI via le proxy tranxq.workers.dev");
                } else {
                    console.warn("Appel OpenAI officiel");
                }
                const endpoint = apiKey
                    ? "https://api.openai.com/v1/chat/completions"
                    : "https://openai.tranxq.workers.dev/v1/chat/completions";
                console.log(
                    "send request",
                    messages.map(message => ({
                        role: message.role,
                        content: message.content
                    }))
                );
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(apiKey ? { Authorization: `Bearer ${apiKey}` } : {})
                    },
                    body: JSON.stringify({
                        model: "gpt-5-nano",
                        messages,
                        temperature: 1,
                        max_tokens: 800
                    })
                });
                if (!response.ok) {
                    const body = await response.text();
                    throw new Error(body);
                }
                const payload = await response.json();
                console.debug("OpenAI response payload", payload);
                return payload.choices?.[0]?.message?.content || "";
            } catch (err) {
                console.error("Erreur OpenAI", err);
                alert("Impossible de contacter OpenAI. V√©rifie ta cl√© et ta connexion.");
                return null;
            }
        }

        let activeModalTab = "context";

        function switchModalTab(tabName) {
            activeModalTab = tabName;
            contextModalTabs.forEach(tab => {
                tab.classList.toggle("active", tab.dataset.tab === tabName);
            });
            contextModalPanels.forEach(panel => {
                panel.classList.toggle("hide", panel.dataset.panel !== tabName);
            });
        }

        contextModalTabs.forEach(tab => {
            tab.addEventListener("click", () => {
                switchModalTab(tab.dataset.tab);
            });
        });

        function handleSettingsSave() {
            schedulePersist();
            closeModal(contextModal);
        }
        ;

        async function handleFieldAi(button) {
            const section = button.dataset.section;
            const textarea = button.closest(".section-text-row")?.querySelector("textarea");
            if (!textarea) return;
            const column = button.closest(".column");
            const objectivesValue = column.querySelector("textarea[data-section=\"objective\"]")?.value.trim() || "";
            const meansValue = column.querySelector("textarea[data-section=\"means\"]")?.value.trim() || "";
            const indicatorsValue = column.querySelector("textarea[data-section=\"indicators\"]")?.value.trim() || "";
            const promptContext = {
                contextField: contextField.value.trim(),
                fieldValue: textarea.value.trim(),
                objectifs: objectivesValue,
                moyens: meansValue,
                indicateurs: indicatorsValue
            };
            const message = buildFieldPrompt(section, promptContext);
            const messages = [
                { role: "system", content: "Tu es un assistant produit." },
                { role: "user", content: message }
            ];
            button.textContent = "‚è≥";
            button.disabled = true;
            try {
                const aiText = await callOpenAI(messages);
                if (!aiText) return;
                textarea.value = aiText.trim();
                updateTextareaOverflowState(textarea);
                schedulePersist();
            } finally {
                button.textContent = "‚ú®";
                button.disabled = false;
            }
        }

        document.addEventListener("click", event => {
            const btn = event.target.closest(".field-ai-btn");
            if (btn) {
                event.stopPropagation();
                handleFieldAi(btn);
                return;
            }
            if (!event.target.closest("#textStyleBtn") && !settingsModal.contains(event.target)) {
                closeSettingsModal();
            }
        });

        window.addEventListener("beforeunload", persistState);

        function openModal(modal) {
            modal?.classList.add("open");
        }

        function closeModal(modal) {
            modal?.classList.remove("open");
        }

        document.querySelectorAll(".modal-close").forEach(btn => {
            btn.addEventListener("click", () => {
                const targetId = btn.dataset.close;
                if (targetId) {
                    closeModal(document.getElementById(targetId));
                }
            });
        });

        contextBtn.addEventListener("click", () => {
            switchModalTab("context");
            openModal(contextModal);
        });
        contextModal.addEventListener("click", event => {
            if (event.target === contextModal) {
                closeModal(contextModal);
            }
        });
        settingsModal.addEventListener("click", event => {
            if (event.target === settingsModal) {
                closeSettingsModal();
            }
        });

        switchModalTab("context");
        const hadSavedSlides = loadSavedState();
        if (!hadSavedSlides) {
            addTab();
        }
        applyRatio(currentRatioIndex);
    </script>

</body>

</html>
