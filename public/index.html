<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Go-Toolkit</title>
    <style>
        * {
            box-sizing: border-box;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 30;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 14px;
            padding: 18px;
            max-width: 940px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-trigger {
            position: relative;
            display: inline-flex;
            align-items: stretch;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 0;
            min-width: 150px;
            max-width: 320px;
            display: none;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 0;
        }

        .menu-header {
            font-size: 14px;
            font-weight: 700;
        }

        .context-menu label {
            margin: 0;
            font-size: 13px;
            padding: 12px;
        }

        .context-menu select {
            width: 100%;
            border: 1px solid #dcd0c1;
            border-radius: 6px;
            padding: 6px 8px;
            font-size: 13px;
            background: #fff;
        }

        .context-menu button {
            border-radius: 0;
            background: transparent;
            text-align: left;
            padding: 0;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
        }

        .menu-panel-btn {
            border-radius: 0;
            border: 1px solid #fff;
            background: transparent;
            text-align: left;
            padding: 8px 12px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .menu-panel-btn:hover {
            background: rgba(42, 122, 87, 0.08);
            border-radius: 0px;
        }

        .context-menu button:hover {
            background: rgba(42, 122, 87, 0.08);
        }


        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 18px;
            cursor: pointer;
            color: var(--muted);
        }

        .modal label {
            font-size: 13px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .modal textarea,
        .modal input[type="text"],
        .modal input[type="password"] {
            border-radius: 8px;
            border: 1px solid #d0c3ad;
            padding: 8px;
            font-size: 13px;
            font-family: inherit;
        }

        .modal-panel textarea {
            min-height: 80px;
            height: 80px;
        }

        .prompt-template-select {
            border-radius: 8px;
            border: 1px solid #d0c3ad;
            background: #fff;
            padding: 6px 10px;
            font-size: 13px;
            font-family: inherit;
        }

        #promptFields {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .prompt-row label {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .prompt-label-text {
            font-size: 13px;
            font-weight: 600;
        }

        .prompt-input {
            min-height: 80px;
            border-radius: 8px;
            border: 1px solid #d0c3ad;
            padding: 8px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .modal-footer button {
            border-radius: 8px;
            padding: 6px 12px;
            border: 1px solid #dcd0c1;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .modal-footer button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
        }

        .ia-mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            padding-top: 12px;
        }

        .ia-mode-toggle button {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .ia-mode-label {
            width: 100%;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .ia-mode-toggle button.active {
            background: #2a7a57;
            color: #fff;
            border-color: #2a7a57;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        #promptCustomizationArea.hidden {
            display: none;
        }


        :root {
            --bg: #f5f2eb;
            --card-bg: #ffffff;
            --border-soft: #dfd5c7;
            --text-main: #2f2922;
            --muted: #8b8173;
            --now-color: #e3f4ea;
            --next-color: #fff6de;
            --later-color: #e3f1ff;
            --radius-large: 16px;
            --radius: 10px;
            --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.05);
            --slide-aspect-ratio: 16 / 9;
        }

        html,
        body {
            min-height: 100vh;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #f7f7f7;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .app {
            max-width: 1320px;
            margin: 0 auto;
            padding: 4px 4px 4px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: calc(100vh - 24px);
            width: 100%;
            position: relative;
            background: transparent;
        }

        .app::after {
            content: "";
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 120px;
            height: 120px;
            background: url("logo.gif") no-repeat center/contain;
            opacity: 0.25;
            pointer-events: none;
            z-index: -1;
        }

        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        .global-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .global-actions button,
        .reset-prompts-btn {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .global-actions button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
            box-shadow: var(--shadow-soft);
        }

        .info-button {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .info-popup {
            position: absolute;
            top: 56px;
            right: 12px;
            width: 280px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            z-index: 60;
        }

        .info-popup.open {
            display: flex;
        }

        .info-popup img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            align-self: center;
        }

        .info-popup a {
            color: #2a7a57;
            text-decoration: none;
            font-weight: 600;
        }

        .info-popup button {
            border-radius: 8px;
            border: none;
            background: #2a7a57;
            color: #fff;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        .tour-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            display: none;
            z-index: 120;
            pointer-events: auto;
        }

        .tour-overlay.dimmed {
            background: rgba(15, 15, 15, 0.65);
        }

        .tour-overlay.visible {
            display: block;
        }

        .tour-highlight {
            position: absolute;
            border: 2px solid #2a7a57;
            border-radius: 12px;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(15, 15, 15, 0.65);
            transition: all 0.25s ease;
            pointer-events: none;
        }

        .tour-highlight.hidden {
            opacity: 0;
        }

        .tour-panel {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 460px;
            width: calc(100% - 40px);
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
            color: #1f1f1f;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tour-panel h4 {
            margin: 0;
            font-size: 18px;
        }

        .tour-panel p {
            margin: 0;
            line-height: 1.4;
        }

        .tour-step-counter {
            font-size: 11px;
            color: #918b7f;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .tour-step-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tour-panel button {
            border-radius: 8px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }

        .tour-panel button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
        }

        .tour-panel button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tour-skip {
            position: absolute;
            top: 12px;
            right: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .template-select {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-main);
            appearance: none;
        }

        .template-select:focus-visible {
            outline: none;
            border-color: #2a7a57;
            box-shadow: 0 0 0 2px rgba(42, 122, 87, 0.4);
        }

        #tabs {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tab-btn {
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
            padding: 4px 10px;
            cursor: pointer;
            color: var(--muted);
            font-size: 12px;
        }

        .tab-btn.active {
            background: #2a7a57;
            color: #fff;
            border-color: #2a7a57;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
        }

        .tab-btn-add,
        .tab-btn-delete {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 4px 12px;
            cursor: pointer;
            font-size: 12px;
            color: var(--muted);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }



        .slides-container {
            position: relative;
            flex: 1;
            min-height: calc(100vh - 200px);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .slide-wrapper {
            margin-top: 4px;
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .slide {
            background: var(--slide-bg, transparent);
            border-radius: var(--radius-large);
            padding: 8px 8px 8px;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            gap: 8px;
            height: calc(100vh - 45px);
            max-height: calc(100vh - 45px);
            aspect-ratio: var(--slide-aspect-ratio, 16 / 9);
            width: auto;
        }

        .slide,
        .slide-body,
        .column-body {
            color: var(--slide-text-color, var(--text-main));
        }

        .slide.hidden {
            display: none;
        }

        .slide-header {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 4px;
        }

        .slide-title-row,
        .slide-subtitle-row {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }

        .slide-title-row input,
        .slide-subtitle-row input {
            flex: 1;
        }

        .slide-title-input {
            border: none;
            background: transparent;
            font-size: 20px;
            font-weight: 650;
            padding: 0;
            margin: 0;
            color: var(--slide-text-color, var(--text-main));
            line-height: 1.2;
        }

        .slide-subtitle-input {
            border: none;
            background: transparent;
            font-size: 13px;
            color: var(--slide-text-color, var(--muted));
            padding: 0;
            margin: 0;
            line-height: 1.2;
        }

        .slide-header input:focus-visible {
            outline: none;
            box-shadow: inset 0 -2px 0 #d0c3ad;
        }

        .slide-header-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slide-body {
            display: flex;
            gap: 18px;
            align-items: stretch;
            flex: 1;
            position: relative;
        }

        .columns {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 14px;
            flex: 1;
        }

        .column {
            border-radius: 4px;
            background: var(--slide-bg, transparent);
            border: 1px solid #ebe0d1;
            display: flex;
            flex-direction: column;
            min-height: 420px;
            --stage-color: #f0ede7;
            transition: box-shadow 0.2s ease;
        }

        .column.palette-active {
            box-shadow: none;
            border-color: #ebe0d1;
        }

        :root {
            --global-background: transparent;
        }

        .column-header {
            background: var(--slide-bg, transparent);
            border-bottom: 1px solid rgba(0, 0, 0, 0.02);
            border-radius: 4px 4px 0 0;
            padding: 4px 4px 4px;
            min-height: 20px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 11px;
            overflow: visible;
        }

        .column-header-main {
            display: flex;
            width: 100%;
        }

        .column-title {
            font-size: calc(var(--slide-font-size, 16px) + 3px);
            font-weight: 700;
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
            letter-spacing: 0.08em;
            padding: 8px 10px;
            border-radius: 0px;
            border: 0;
            background: var(--slide-bg, transparent);
            cursor: text;
            width: 100%;
            text-align: left;
        }

        .column-title:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(42, 122, 87, 0.5);
        }



        .column-body {
            padding: 10px 12px 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            font-size: 12px;
            background: var(--slide-bg, transparent);
            border-radius: 0 0 4px 4px;
        }

        .section {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .section-label {
            font-size: calc(var(--slide-label-size, 12px) + 3px);
            font-weight: 700;
            color: var(--slide-text-color, var(--muted));
            display: flex;
            align-items: center;
            gap: 4px;
            min-height: 22px;
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
        }

        .section-text-row {
            position: relative;
        }

        .textarea-wrapper {
            position: relative;
            width: 100%;
        }

        .textarea-wrapper textarea {
            padding-top: 26px;
        }

        .field-ai-btn.inside {
            position: absolute;
            bottom: 6px;
            right: 6px;
            border-radius: 999px;
            border: 1px solid #dcd0c1;
            background: rgba(255, 255, 255, 0.9);
            font-size: 11px;
            padding: 2px 6px;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .section-label-row,
        .section-text-row {
            display: flex;
            align-items: center;
            gap: 6px;
            justify-content: space-between;
        }

        .field-ai-btn {
            border: none;
            background: transparent;
            font-size: 16px;
            color: #918b7f;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .textarea-wrapper:hover .field-ai-btn,
        .textarea-wrapper textarea:focus-visible+.field-ai-btn,
        .field-ai-btn:focus-visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .field-ai-btn:hover {
            color: #2a7a57;
        }

        .section textarea {
            width: 100%;
            border-radius: 4px;
            font-size: var(--slide-font-size, 16px);
            padding: 6px 8px;
            line-height: 1.4;
            min-height: 140px;
            resize: vertical;
            border: none;
            background: var(--slide-bg, transparent);
            color: var(--slide-text-color, #2f2922);
            font-family: var(--slide-font-family, "Segoe UI", sans-serif);
            overflow: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .column-focused textarea {
            border: 1px solid #cfcfcf;
        }

        .section textarea::-webkit-scrollbar {
            width: 0;
            height: 0;
        }

        .section textarea:focus-visible {
            outline: 1px solid rgba(42, 122, 87, 0.8);
            box-shadow: none;
            scrollbar-width: thin;
        }

        .section textarea.textarea-overflow {
            border: 2px solid #f7c63a;
            box-shadow: 0 0 0 1px rgba(247, 198, 58, 0.35);
        }

        .section textarea:focus-visible::-webkit-scrollbar {
            width: 8px;
        }

        .section textarea::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .section textarea::-webkit-resizer,
        .section textarea::-moz-resizer {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .section textarea:focus-visible::-webkit-resizer,
        .section textarea:focus-visible::-moz-resizer {
            opacity: 1;
        }

        .column-color-grid,
        .slide-bg-grid {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 6px;
        }

        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e0d7c8;
        }

        .section-heading {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .column-palettes {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .palette-block {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .palette-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-main);
        }

        .ratio-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px;
        }

        .ratio-grid {
            display: flex;
            gap: 6px;
        }

        .ratio-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .ratio-option {
            flex: 1;
            border-radius: 8px;
            border: 1px solid #e0d7c1;
            background: #fff;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .ratio-option.active {
            border-color: #2a7a57;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .font-size-control button {
            border-radius: 999px;
            border: 1px solid #dcd0c1;
            background: #f7f5f1;
            width: 28px;
            height: 28px;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .font-size-control input {
            flex: 1;
            text-align: center;
        }

        .color-swatch {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid #cfc6b8;
            cursor: pointer;
            padding: 0;
            background: #fff;
        }

        .color-swatch.transparent {
            background-image: repeating-conic-gradient(#cfc6b8 0% 25%, #fff 0% 50%);
            background-size: 6px 6px;
        }

        .color-swatch:focus-visible {
            outline: 2px solid #2a7a57;
            outline-offset: 2px;
        }

        .text-style-option {
            border-radius: 10px;
            border: 1px solid #e0d7c8;
            padding: 8px;
            background: #fff;
            text-align: left;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-height: 64px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .text-style-option.active {
            border-color: #2a7a57;
        }

        /* √©tats d‚Äô√©dition : bordures seulement au survol / focus */
        .editable {
            border: 1px solid transparent;
            background: transparent;
            transition: border-color 0.12s ease, background-color 0.12s ease, box-shadow 0.12s ease;
        }

        .editable:hover {
            border-color: #d0c3ad;
            background: #fffdf8;
        }

        .editable:focus-visible {
            outline: none;
            border-color: #c0a97f;
            background: #ffffff;
            box-shadow: 0 0 0 1px rgba(192, 169, 127, 0.35);
        }

        /* textareas utilisent editable + fond l√©ger */
        .section textarea.editable {
            background: var(--slide-bg, transparent);
        }

        body.exporting .editable {
            border: none;
            box-shadow: none;
            background: var(--slide-bg, transparent);
        }

        body.exporting .section textarea {
            border: none;
        }

        @media print {
            body {
                background: #ffffff;
            }

            .app-header {
                display: none;
            }

            .slide {
                box-shadow: none;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="app-header">
            <div class="tabs-actions">
                <select id="templateSelect" class="template-select" aria-label="S√©lecteur de template"></select>

                <div id="tabs"></div>
                <button class="tab-btn-add" id="addTabBtn" type="button">‚ûï</button>
                <button class="tab-btn-delete" id="deleteTabBtn" type="button">üóëÔ∏è</button>
            </div>
            <div class="global-actions">
                <button id="contextBtn" type="button" aria-label="AI Assistant">‚ú®</button>

                <div class="menu-trigger" id="settingsMenuTrigger">
                    <button id="textStyleBtn" type="button" aria-label="Options d'affichage">üñåÔ∏è</button>
                    <div class="context-menu" id="settingsMenu">
                        <div class="menu-panel">
                            <label>
                                Police
                                <select id="fontSelect"></select>
                            </label>
                            <label>
                                Taille (px)
                                <select id="fontSizeInput">
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                    <option value="13">13</option>
                                    <option value="14">14</option>
                                    <option value="15">15</option>
                                    <option value="16">16</option>
                                </select>
                            </label>
                            <label>
                                Fond global
                                <select id="backgroundSelector">
                                    <option value="transparent">Transparent</option>
                                    <option value="#ffffff">Blanc</option>
                                </select>
                            </label>
                            <div class="ratio-wrapper">
                                <div class="ratio-label">Aspect ratio</div>
                                <div class="ratio-grid" id="ratioGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="menu-trigger" id="fileMenuTrigger">
                    <button id="fileMenuBtn" type="button" aria-label="Fichier">üìÑ</button>
                    <div class="context-menu" id="fileMenu">
                        <div class="menu-panel">
                            <button id="importJsonBtn" type="button" class="menu-panel-btn">üìÇ Ouvrir</button>
                            <button id="exportJsonBtn" type="button" class="menu-panel-btn">üíæ Enregsitrer</button>
                            <button id="exportPptxBtn" type="button" class="menu-panel-btn">üìä Powerpoint</button>
                            <button id="exportPngBtn" type="button" class="menu-panel-btn">üñºÔ∏è Image</button>
                        </div>
                    </div>
                </div>
                <button id="infoButton" type="button" class="info-button" aria-label="Plus d'informations">‚ÑπÔ∏è</button>
            </div>
        </div>

        <div id="infoPopup" class="info-popup" role="dialog" aria-live="polite">
            <img src="logo.gif" alt="Logo Go-Toolkit">
            <strong>Go-Toolkit</strong>
            <span>Version 0.11.22</span>
            <span>D√©velopp√© par Quang TRAN.</span>
            <span>Usage r√©serv√© √† Savane Consulting.</span>
            <button id="tourReplayBtn" type="button">Tour guid√©</button>
        </div>

        <div class="slides-container">
            <div id="slides" class="slide-wrapper"></div>
        </div>

        <div id="tourOverlay" class="tour-overlay" aria-hidden="true">
            <div class="tour-highlight hidden" aria-hidden="true"></div>
            <div class="tour-panel">
                <span class="tour-step-counter" id="tourStepCounter"></span>
                <h4 id="tourStepTitle"></h4>
                <p id="tourStepDescription"></p>
                <div class="tour-step-footer">
                    <button id="tourPrevBtn" type="button">Pr√©c√©dent</button>
                    <button id="tourNextBtn" type="button" class="primary">Suivant</button>
                    <button id="tourCloseBtn" type="button">Fermer</button>
                </div>
            </div>
            <button id="tourSkipBtn" class="tour-skip" type="button">√ó</button>
        </div>
    </div>

    <div class="modal-overlay" id="contextModal">
        <div class="modal">
            <div class="modal-header">
                <h3>IA & contexte</h3>
                <button class="modal-close" data-close="contextModal">√ó</button>
            </div>
            <div class="modal-panel" data-panel="context">

                <label>
                    D√©cris ton contexte et ta vision du produit
                    <textarea id="contextField" rows="4" placeholder="Contexte..."></textarea>
                </label>
            </div>
            <div class="modal-panel hide" data-panel="settings">
                <label>
                    <a href="https://platform.openai.com/settings/organization/api-keys" target="_blank"
                        rel="noreferrer">OpenAI API key</a>
                    <input type="password" id="apiKeyInput" autocomplete="off" placeholder="sk-...">
                </label>
                <div class="ia-mode-toggle" id="iaModeToggle">
                    <div class="ia-mode-label">IA Mode</div>
                    <button type="button" data-ia-mode="express">‚ö° Express</button>
                    <button type="button" data-ia-mode="apprenti">üí° Apprenti</button>
                    <button type="button" data-ia-mode="experimental">üß™ Exp√©rimental</button>
                </div>
                <div id="promptCustomizationArea">
                    <label>
                        Mod√®le de prompts
                        <select id="promptTemplateSelect" class="prompt-template-select"></select>
                    </label>
                    <div id="promptFields">
                        <div class="prompt-row" data-section="first-section">
                            <label>
                                <span class="prompt-label-text">Prompt - Section</span>
                                <textarea class="prompt-input" data-section="first-section" rows="2"></textarea>
                            </label>
                        </div>
                        <div class="prompt-row" data-section="second-section">
                            <label>
                                <span class="prompt-label-text">Prompt - Section</span>
                                <textarea class="prompt-input" data-section="second-section" rows="2"></textarea>
                            </label>
                        </div>
                        <div class="prompt-row" data-section="third-section">
                            <label>
                                <span class="prompt-label-text">Prompt - Section</span>
                                <textarea class="prompt-input" data-section="third-section" rows="2"></textarea>
                            </label>
                        </div>
                    </div>
                    <button id="resetPromptsBtn" type="button" class="reset-prompts-btn">R√©initialiser</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.9.0/dist/pptxgen.bundle.js"></script>
    <script>
        const stageColors = {
            "first-col": getComputedStyle(document.documentElement).getPropertyValue("--now-color").trim(),
            "second-col": getComputedStyle(document.documentElement).getPropertyValue("--next-color").trim(),
            "third-col": getComputedStyle(document.documentElement).getPropertyValue("--later-color").trim()
        };
        document.documentElement.style.setProperty("--global-background", "transparent");

        const textStyles = [
            { name: "Inter", font: "Inter, system-ui, sans-serif", size: 14 },
            { name: "Arial", font: "Arial, Helvetica, sans-serif", size: 14 },
            { name: "Tahoma", font: "Tahoma, Geneva, sans-serif", size: 14 },
            { name: "Trebuchet MS", font: "'Trebuchet MS', Helvetica, sans-serif", size: 14 },
            { name: "Georgia", font: "Georgia, 'Times New Roman', serif", size: 16 },
            { name: "Times New Roman", font: "'Times New Roman', Times, serif", size: 16 },
            { name: "Lucida Console", font: "'Lucida Console', Monaco, monospace", size: 13 },
            { name: "Rounded", font: "'Segoe UI', 'Fredoka One', sans-serif", size: 14 },
            { name: "Serif", font: "Georgia, 'Times New Roman', serif", size: 16 },
            { name: "Mono", font: "'JetBrains Mono', 'Menlo', monospace", size: 13 }
        ];

        const ratioOptions = [
            { name: "16:9", css: "16 / 9", pptx: { width: 10, height: 5.625 } },
            { name: "4:3", css: "4 / 3", pptx: { width: 10, height: 7.5 } },
            { name: "A4", css: "297 / 210", pptx: { width: 11.69, height: 8.27 } }
        ];

        const sectionKeys = ["first-section", "second-section", "third-section"];

        const templates = [
            {
                id: "go-roadmap",
                emoji: "üß≠",
                name: "GO-Roadmap",
                defaultTitle: "GO-Roadmap",
                columns: [
                    { stage: "first-col", label: "Now" },
                    { stage: "second-col", label: "Next" },
                    { stage: "third-col", label: "Later" }
                ],
                sections: [
                    {
                        key: "first-section",
                        icon: "üß≠",
                        label: "Objectifs",
                        examples:
                            "D√©crire ce que l‚Äôutilisateur ou l‚Äôentreprise gagne quand l‚Äôobjectif est atteint. Exemples : \n‚Ä¢ R√©duire les erreurs de saisie de 20% \n‚Ä¢ Acc√©l√©rer l‚Äôacc√®s aux indicateurs pour faciliter la d√©cision \n‚Ä¢ Simplifier le parcours utilisateur pour diminuer le temps d‚Äôaction de 30%"
                    },
                    {
                        key: "second-section",
                        icon: "üöÄ",
                        label: "Moyens",
                        examples:
                            "Lister les actions, fonctionnalit√©s ou livrables concrets. Exemples : \n‚Ä¢ D√©velopper un module de validation automatique \n‚Ä¢ Produire un tableau de bord Power BI \n‚Ä¢ Revoir l‚ÄôUX (wireframes + tests utilisateurs) \n‚Ä¢ Mettre en place une API d‚Äôimport automatis√©"
                    },
                    {
                        key: "third-section",
                        icon: "üî¢",
                        label: "Indicateurs",
                        examples:
                            "D√©crire comment mesurer la r√©ussite : chiffres, adoption, d√©lais. Exemples : \n‚Ä¢ K1 : 95% de donn√©es compl√®tes et conformes \n‚Ä¢ K2 : Temps moyen d‚Äôusage < 40s \n‚Ä¢ K3 : 70% d‚Äôutilisateurs actifs hebdo \n‚Ä¢ K4 : -30% de tickets support"
                    }
                ]
            },
            {
                id: "go-design",
                emoji: "‚≠ê",
                name: "GO-Design",
                defaultTitle: "Go-Design",
                columns: [
                    { stage: "first-col", label: "Saisie de donn√©es" },
                    { stage: "second-col", label: "Consultation de donn√©es" },
                    { stage: "third-col", label: "Analyse de donn√©es" }
                ],
                sections: [
                    {
                        key: "first-section",
                        icon: "üë•",
                        label: "Personas",
                        examples:
                            "D√©crire les profils utilisateurs prioritaires, leurs motivations et frustrations. Exemples : \n‚Ä¢ Responsable data qui manque d‚Äôindicateurs fiables \n‚Ä¢ Analyste qui perd du temps √† consolider \n‚Ä¢ Support qui re√ßoit des tickets de saisie"
                    },
                    {
                        key: "second-section",
                        icon: "‚ù§Ô∏è",
                        label: "Besoins",
                        examples:
                            "Lister les besoins m√©tier ou utilisateur prioritaires. Exemples : \n‚Ä¢ Saisir une donn√©e en moins de 15s \n‚Ä¢ Visualiser les tendances en un coup d‚Äô≈ìil \n‚Ä¢ Exporter automatiquement pour reporting"
                    },
                    {
                        key: "third-section",
                        icon: "‚≠ê",
                        label: "Opportunit√©s",
                        examples:
                            "Identifier les opportunit√©s de design, de diff√©renciation ou d‚Äôimpact. Exemples : \n‚Ä¢ Automatiser la validation pour r√©duire les erreurs \n‚Ä¢ Proposer des parcours contextualis√©s \n‚Ä¢ R√©concilier les sources pour enrichir l‚Äôanalyse"
                    }
                ]
            },
            {
                id: "go-solve",
                emoji: "üå±",
                name: "GO-Solve",
                defaultTitle: "Go-Solve",
                columns: [
                    { stage: "first-col", label: "UI" },
                    { stage: "second-col", label: "Data" },
                    { stage: "third-col", label: "API" }
                ],
                sections: [
                    {
                        key: "first-section",
                        icon: "üåßÔ∏è",
                        label: "Probl√®mes",
                        examples:
                            "Lister les probl√®mes, frictions ou irritants observ√©s. Exemples : \n‚Ä¢ Les utilisateurs abandonnent la saisie \n‚Ä¢ Les donn√©es sont incoh√©rentes \n‚Ä¢ L‚ÄôAPI manque d‚Äôobservabilit√©"
                    },
                    {
                        key: "second-section",
                        icon: "üçÇ",
                        label: "Causes",
                        examples:
                            "Identifier les causes profondes ou hypoth√®ses. Exemples : \n‚Ä¢ UI trop charg√©e \n‚Ä¢ Sch√©ma data non align√© \n‚Ä¢ API non document√©e"
                    },
                    {
                        key: "third-section",
                        icon: "üå±",
                        label: "Solutions",
                        examples:
                            "Proposer des solutions rapides ou exp√©rimentations. Exemples : \n‚Ä¢ Prototyper un wizard de saisie \n‚Ä¢ Ajouter des contr√¥les qualit√© data \n‚Ä¢ Cr√©er des endpoints document√©s et versionn√©s"
                    }
                ]
            }
        ];

        const defaultPromptTemplate = `Tu es un consultant product owner exp√©riment√©, sur la base du contexte {{contextField}} et dans le cadre de {{columnTitle}}, reformuler {{fieldValue}} sous forme de 2 √† 3 {{sectionTitle}} d'un point de vue business et utilisateur (un ‚Ä¢ de < 18 mots pour chaque) sans introduction pr√©alable ni √©moji`;
        const apprentPromptTemplate = `Tu es un coach product owner exp√©riment√©, sur la base du contexte {{contextField}} et dans le cadre de {{columnTitle}}, reprendre ({{fieldValue}}) en ignorant les √©l√©ments entre "[ ]" sous forme de 2 √† 3 √©l√©ments synth√©tiques (un ‚Ä¢ de < 18 mots pour chaque) sans toucher au sens, puis en dessous, proposer 2 √† 3 questions d'approfondissement pour l'aider √† formuler des {{sectionTitle}} synth√©tiques et pertinents (< 20 mots pour chaque et entre "[ ]" ). Tout √ßa sans introduction pr√©alable ni √©moji`;
        const IA_MODE_EXPRESS = "express";
        const IA_MODE_APPRENTI = "apprenti";
        const IA_MODE_EXPERIMENTAL = "experimental";

        function getTemplateById(id) {
            return templates.find(template => template.id === id) || templates[0];
        }

        function getDefaultTitle(templateId) {
            const template = getTemplateById(templateId);
            return template?.defaultTitle || template?.name || fallbackTitle;
        }

        function getTemplateSections(templateId) {
            return getTemplateById(templateId).sections;
        }

        function getTemplateSection(templateId, sectionKey) {
            return getTemplateSections(templateId).find(section => section.key === sectionKey);
        }

        function getDefaultSectionLabel(templateId, sectionKey) {
            const section = getTemplateSection(templateId, sectionKey);
            return section ? `${section.icon} ${section.label}` : sectionKey;
        }

        function getTemplateColumns(templateId) {
            return getTemplateById(templateId).columns;
        }

        function getTemplateColumn(templateId, index) {
            return getTemplateColumns(templateId)[index] || { stage: "first-col", label: `Colonne ${index + 1}` };
        }

        let templateSlides = {};

        function initializeTemplateSlides(slideList = []) {
            templateSlides = templates.reduce((acc, template) => {
                acc[template.id] = [];
                return acc;
            }, {});
            slideList.forEach(slide => {
                const templateId = slide.templateId || templates[0].id;
                if (!templateSlides[templateId]) {
                    templateSlides[templateId] = [];
                }
                templateSlides[templateId].push(slide);
            });
            templates.forEach(template => {
                if (!templateSlides[template.id] || !templateSlides[template.id].length) {
                    templateSlides[template.id] = [{ templateId: template.id }];
                }
            });
        }

        function getTemplateSlidesList(templateId) {
            if (!templateSlides[templateId]) {
                templateSlides[templateId] = [];
            }
            if (!templateSlides[templateId].length) {
                templateSlides[templateId].push({ templateId });
            }
            return templateSlides[templateId];
        }


        const slidesContainer = document.getElementById("slides");
        const tabsContainer = document.getElementById("tabs");
        const addTabBtn = document.getElementById("addTabBtn");
        const deleteTabBtn = document.getElementById("deleteTabBtn");
        const exportBtn = document.getElementById("exportPngBtn");
        const exportPptxBtn = document.getElementById("exportPptxBtn");
        const textStyleBtn = document.getElementById("textStyleBtn");
        const templateSelect = document.getElementById("templateSelect");
        const fileMenuBtn = document.getElementById("fileMenuBtn");
        const importJsonBtn = document.getElementById("importJsonBtn");
        const exportJsonBtn = document.getElementById("exportJsonBtn");
        const contextBtn = document.getElementById("contextBtn");
        const contextModal = document.getElementById("contextModal");
        const contextField = document.getElementById("contextField");
        const contextModalTabs = contextModal.querySelectorAll(".modal-tab");
        const contextModalPanels = contextModal.querySelectorAll(".modal-panel");
        const settingsMenu = document.getElementById("settingsMenu");
        const fileMenu = document.getElementById("fileMenu");
        const apiKeyInput = document.getElementById("apiKeyInput");
        const promptTemplateSelect = document.getElementById("promptTemplateSelect");
        const promptInputs = Array.from(document.querySelectorAll(".prompt-input"));
        const fontSelect = document.getElementById("fontSelect");
        const fontSizeInput = document.getElementById("fontSizeInput");
        const ratioGrid = document.getElementById("ratioGrid");
        const backgroundSelector = document.getElementById("backgroundSelector");
        const resetPromptsBtn = document.getElementById("resetPromptsBtn");
        const iaModeToggle = document.getElementById("iaModeToggle");
        const iaModeButtons = Array.from(iaModeToggle?.querySelectorAll("[data-ia-mode]") ?? []);
        const promptCustomizationArea = document.getElementById("promptCustomizationArea");

        const STORAGE_KEY = "go-roadmap-state";

        let persistTimer = null;

        function schedulePersist() {
            clearTimeout(persistTimer);
            persistTimer = setTimeout(persistState, 500);
        }

        function collectAllSlides() {
            const all = [];
            Object.entries(templateSlides).forEach(([templateId, slides]) => {
                slides.forEach(slide => {
                    all.push({ ...slide, templateId });
                });
            });
            return all;
        }

        function persistState() {
            storeCurrentSlides();
            const payload = {
                slides: collectAllSlides(),
                settings: {
                    ratioIndex: currentRatioIndex,
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize,
                    apiKey: apiKeyInput.value,
                    context: contextField.value,
                    prompts: promptLibrary,
                    promptTemplateId: activePromptTemplateId,
                    iaMode: activeIaMode,
                    defaultTemplateId: currentTemplateId
                }
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            } catch (err) {
                console.error("Impossible de sauvegarder l'√©tat :", err);
            }
        }

        function loadSavedState() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (!stored) {
                initializeTemplateSlides();
                return false;
            }
            try {
                const parsed = JSON.parse(stored);
                const settings = parsed.settings || {};
                initializeTemplateSlides(Array.isArray(parsed.slides) ? parsed.slides : []);
                applySettingsFromPayload(settings);
                return Array.isArray(parsed.slides) && parsed.slides.length;
            } catch (err) {
                console.error("Impossible de charger l'√©tat :", err);
                initializeTemplateSlides();
                setPromptFieldsForTemplate(activePromptTemplateId);
                return false;
            }
        }

        const importInput = document.createElement("input");
        importInput.type = "file";
        importInput.accept = "application/json";
        importInput.style.display = "none";
        document.body.appendChild(importInput);

        let slideCount = 0;
        let activeIndex = 0;
        let activePaletteColumn = null;
        let currentTextStyleIndex = 0;
        let currentFontSize = 12;
        let currentRatioIndex = 0;
        let currentTemplateId = templates[0].id;
        let activePromptTemplateId = templates[0].id;
        let activeIaMode = IA_MODE_EXPRESS;
        const promptLibrary = templates.reduce((acc, template) => {
            acc[template.id] = sectionKeys.reduce((inner, key) => {
                inner[key] = defaultPromptTemplate;
                return inner;
            }, {});
            return acc;
        }, {});

        function populateTemplateSelectors() {
            [templateSelect, promptTemplateSelect].forEach(select => {
                if (!select) return;
                select.innerHTML = "";
                templates.forEach(template => {
                    const option = document.createElement("option");
                    option.value = template.id;
                    option.textContent = `${template.emoji} ${template.name}`;
                    select.appendChild(option);
                });
            });
        }

        populateTemplateSelectors();
        if (templateSelect) {
            templateSelect.value = currentTemplateId;
        }
        if (promptTemplateSelect) {
            promptTemplateSelect.value = activePromptTemplateId;
        }
        setPromptFieldsForTemplate(activePromptTemplateId);
        setActiveIaMode(activeIaMode);

        function applySettingsFromPayload(settings = {}) {
            const payload = settings || {};
            if (payload.prompts) {
                Object.entries(payload.prompts).forEach(([templateId, prompts]) => {
                    if (!promptLibrary[templateId]) return;
                    sectionKeys.forEach(sectionKey => {
                        promptLibrary[templateId][sectionKey] = prompts[sectionKey] || defaultPromptTemplate;
                    });
                });
            } else if (payload.objectivePrompt || payload.meansPrompt || payload.indicatorsPrompt) {
                const templateId = templates[0].id;
                promptLibrary[templateId]["first-section"] = payload.objectivePrompt || defaultPromptTemplate;
                promptLibrary[templateId]["second-section"] = payload.meansPrompt || defaultPromptTemplate;
                promptLibrary[templateId]["third-section"] = payload.indicatorsPrompt || defaultPromptTemplate;
            }
            activePromptTemplateId = payload.promptTemplateId || activePromptTemplateId;
            currentTemplateId = payload.defaultTemplateId || currentTemplateId;
            if (templateSelect) {
                templateSelect.value = currentTemplateId;
            }
            if (promptTemplateSelect) {
                promptTemplateSelect.value = activePromptTemplateId;
            }
            apiKeyInput.value = payload.apiKey || "";
            contextField.value = payload.context || "";
            if (typeof payload.ratioIndex === "number") {
                currentRatioIndex = Math.max(0, Math.min(ratioOptions.length - 1, payload.ratioIndex));
                applyRatio(currentRatioIndex);
            }
            if (typeof payload.textStyleIndex === "number") {
                currentTextStyleIndex = payload.textStyleIndex;
            }
            if (typeof payload.fontSize === "number") {
                currentFontSize = normalizeFontSize(payload.fontSize);
            }
            setPromptFieldsForTemplate(activePromptTemplateId);
            setActiveIaMode(payload.iaMode || activeIaMode);
        }

        const fallbackTitle = "GO-Roadmap";
        const defaultSubtitle = "Produit / √©quipe / scope";
        const ratioButtons = [];

        function parseStyleIndex(value) {
            const parsed = parseInt(value, 10);
            return Number.isNaN(parsed) ? currentTextStyleIndex : parsed;
        }

        function selectColumnForPalette(column) {
            if (!column) {
                activePaletteColumn = null;
                document.querySelectorAll(".column.palette-active").forEach(el => el.classList.remove("palette-active"));
                return;
            }
            document.querySelectorAll(".column.palette-active").forEach(el => el.classList.remove("palette-active"));
            activePaletteColumn = column;
            column.classList.add("palette-active");
        }

        function updateSectionLabelsInSlide(sectionKey, sourceLabel) {
            const slide = sourceLabel.closest(".slide");
            if (!slide) return;
            const rawText = sourceLabel.textContent.trim();
            const templateId = slide.dataset.templateId || templates[0].id;
            const defaultLabel = getDefaultSectionLabel(templateId, sectionKey);
            const normalized = rawText || defaultLabel;
            slide.querySelectorAll(`.section-label[data-section="${sectionKey}"]`).forEach(label => {
                label.textContent = normalized;
            });
        }

        function bindSectionLabel(label) {
            const sectionKey = label.dataset.section;
            label.addEventListener("blur", () => {
                if (!label.textContent.trim()) {
                    const slide = label.closest(".slide");
                    const templateId = slide?.dataset.templateId || templates[0].id;
                    label.textContent = getDefaultSectionLabel(templateId, sectionKey);
                }
                updateSectionLabelsInSlide(sectionKey, label);
            });
        }

        function bindTextareaPlaceholder(textarea) {
            const example = textarea.dataset.placeholder || "";
            textarea.addEventListener("focus", () => {
                if (!textarea.value) {
                    textarea.placeholder = example;
                }
            });
            textarea.addEventListener("blur", () => {
                textarea.placeholder = "";
            });
        }

        function getPromptValue(templateId, sectionKey) {
            const templatePrompts = promptLibrary[templateId] || promptLibrary[templates[0].id];
            return templatePrompts[sectionKey] || defaultPromptTemplate;
        }

        function updatePromptLabels(templateId) {
            promptInputs.forEach(textarea => {
                const sectionKey = textarea.dataset.section;
                const sectionDef = getTemplateSection(templateId, sectionKey);
                const labelEl = textarea.closest(".prompt-row")?.querySelector(".prompt-label-text");
                if (labelEl) {
                    const sectionLabel = sectionDef ? `${sectionDef.icon} ${sectionDef.label}` : sectionKey;
                    labelEl.textContent = `Prompt - ${sectionLabel}`;
                }
            });
        }

        function setPromptFieldsForTemplate(templateId) {
            promptInputs.forEach(textarea => {
                const sectionKey = textarea.dataset.section;
                textarea.value = getPromptValue(templateId, sectionKey);
            });
            updatePromptLabels(templateId);
        }

        function updateIaModeUI() {
            iaModeButtons.forEach(button => {
                button.classList.toggle("active", button.dataset.iaMode === activeIaMode);
            });
            if (promptCustomizationArea) {
                promptCustomizationArea.classList.toggle("hidden", activeIaMode !== IA_MODE_EXPERIMENTAL);
            }
        }

        function setActiveIaMode(mode) {
            if (![IA_MODE_EXPRESS, IA_MODE_APPRENTI, IA_MODE_EXPERIMENTAL].includes(mode)) {
                return;
            }
            activeIaMode = mode;
            updateIaModeUI();
        }

        promptInputs.forEach(textarea => {
            textarea.addEventListener("input", () => {
                const sectionKey = textarea.dataset.section;
                if (!sectionKey) return;
                promptLibrary[activePromptTemplateId][sectionKey] = textarea.value;
                schedulePersist();
            });
        });

        iaModeButtons.forEach(button => {
            button.addEventListener("click", () => {
                setActiveIaMode(button.dataset.iaMode);
                schedulePersist();
            });
        });

        templateSelect?.addEventListener("change", () => {
            const selected = templateSelect.value;
            if (!selected || selected === currentTemplateId) {
                return;
            }
            storeCurrentSlides();
            currentTemplateId = selected;
            renderSlidesForTemplate(currentTemplateId);
            schedulePersist();
        });

        promptTemplateSelect?.addEventListener("change", () => {
            activePromptTemplateId = promptTemplateSelect.value;
            setPromptFieldsForTemplate(activePromptTemplateId);
            schedulePersist();
        });

        function showColumnPlaceholders(column) {
            column.querySelectorAll("textarea").forEach(textarea => {
                if (!textarea.value) {
                    textarea.placeholder = textarea.dataset.placeholder || "";
                }
            });
        }

        function clearColumnPlaceholders(column) {
            column.querySelectorAll("textarea").forEach(textarea => {
                if (!textarea.value) {
                    textarea.placeholder = "";
                }
            });
        }

        function normalizeBullets(textarea) {
            const lines = textarea.value.split("\n");
            const normalized = lines.map(line => {
                const trimmed = line.trim();
                if (!trimmed) return "";
                return trimmed.startsWith("‚Ä¢") ? trimmed : `‚Ä¢ ${trimmed}`;
            });
            textarea.value = normalized.join("\n");
        }

        function updateTextareaOverflowState(textarea) {
            if (!textarea) return;
            textarea.classList.toggle("textarea-overflow", textarea.scrollHeight > textarea.clientHeight);
        }

        function monitorTextareaOverflow(textarea) {
            updateTextareaOverflowState(textarea);
            textarea.addEventListener("input", () => updateTextareaOverflowState(textarea));
            textarea.addEventListener("keydown", event => {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    const start = textarea.selectionStart;
                    const end = textarea.selectionEnd;
                    const insert = "\n‚Ä¢ ";
                    textarea.setRangeText(insert, start, end, "end");
                    const newPos = start + insert.length;
                    textarea.setSelectionRange(newPos, newPos);
                    updateTextareaOverflowState(textarea);
                }
            });
            textarea.addEventListener("blur", () => {
                normalizeBullets(textarea);
            });
        }


        function getActiveSlideElement() {
            return slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
        }

        function applyColumnStageColor(stage, color) {
            const column = getActiveSlideElement()?.querySelector(`.column[data-stage="${stage}"]`);
            if (!column) return;
            column.style.setProperty("--stage-color", color);
            schedulePersist();
        }

        function applyBackgroundToActiveSlide(color) {
            const slide = getActiveSlideElement();
            if (!slide) return;
            applyBackgroundToSlide(slide, color);
            syncBackgroundSelector();
            document.documentElement.style.setProperty("--global-background", color);
        }

        function syncBackgroundSelector() {
            if (!backgroundSelector) return;
            const slide = getActiveSlideElement();
            if (!slide) return;
            const value = slide.dataset.bgColor ?? "transparent";
            backgroundSelector.value = value === "transparent" ? "transparent" : "#ffffff";
        }

        function normalizeFontSize(value) {
            const parsed = Number(value);
            if (Number.isNaN(parsed)) {
                return currentFontSize;
            }
            return Math.max(8, Math.min(72, parsed));
        }

        function syncFontControls() {
            if (fontSelect) {
                fontSelect.value = currentTextStyleIndex;
            }
            if (fontSizeInput) {
                fontSizeInput.value = currentFontSize;
            }
        }

        function handleFontSizeChange(value) {
            const normalized = normalizeFontSize(value);
            if (normalized === currentFontSize && Number(value) === normalized) {
                return;
            }
            currentFontSize = normalized;
            if (fontSizeInput) {
                fontSizeInput.value = normalized;
            }
            const activeSlide = getActiveSlideElement();
            if (activeSlide) {
                applyTextStyleToSlide(activeSlide, currentTextStyleIndex, currentFontSize);
            }
        }

        function initSettingsMenu() {
            fontSelect.innerHTML = "";
            textStyles.forEach((style, index) => {
                const option = document.createElement("option");
                option.value = index;
                option.textContent = style.name;
                option.style.fontFamily = style.font;
                option.style.fontSize = `${style.size}px`;
                fontSelect.appendChild(option);
            });

            ratioGrid.innerHTML = "";
            ratioButtons.length = 0;
            ratioOptions.forEach((ratio, index) => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "ratio-option";
                btn.dataset.index = index;
                btn.textContent = ratio.name;
                btn.addEventListener("click", () => {
                    applyRatio(index);
                });
                ratioButtons.push(btn);
                ratioGrid.appendChild(btn);
            });

            fontSelect.addEventListener("change", () => {
                currentTextStyleIndex = parseInt(fontSelect.value, 10);
                const activeSlide = getActiveSlideElement();
                if (activeSlide) {
                    applyTextStyleToSlide(activeSlide, currentTextStyleIndex, currentFontSize);
                }
            });
            fontSizeInput.addEventListener("change", () => handleFontSizeChange(fontSizeInput.value));
            Array.from(fontSizeInput.options).forEach(opt => {
                opt.style.fontSize = `${opt.value}px`;
            });
            backgroundSelector.addEventListener("change", () => {
                applyBackgroundToActiveSlide(backgroundSelector.value);
            });

            syncFontControls();
            syncBackgroundSelector();
            updateRatioButtons();
        }

        function toggleSettingsMenu() {
            syncFontControls();
            syncBackgroundSelector();
            toggleMenu(settingsMenu);
        }

        initSettingsMenu();

        function updateRatioButtons() {
            ratioButtons.forEach((button, index) => {
                button.classList.toggle("active", index === currentRatioIndex);
            });
        }

        function parseHexColor(value) {
            const hex = value.replace(/^#/, "");
            if (hex.length !== 6) return null;
            return {
                r: parseInt(hex.slice(0, 2), 16),
                g: parseInt(hex.slice(2, 4), 16),
                b: parseInt(hex.slice(4, 6), 16)
            };
        }

        function getBrightnessFromColor(value) {
            const parsed = parseHexColor(value);
            if (!parsed) return 1;
            return (parsed.r * 299 + parsed.g * 587 + parsed.b * 114) / 1000 / 255;
        }

        function getTextColorForBackground(value) {
            if (!value || value === "transparent") {
                return "#2f2922";
            }
            if (value.startsWith("linear-gradient")) {
                const match = value.match(/#([0-9a-fA-F]{6})/);
                if (match) {
                    value = `#${match[1]}`;
                }
            }
            const brightness = getBrightnessFromColor(value);
            return brightness < 0.6 ? "#ffffff" : "#2f2922";
        }

        function setSlideTextColor(slide, color) {
            const textColor = getTextColorForBackground(color);
            slide.style.setProperty("--slide-text-color", textColor);
        }

        function applyBackgroundToSlide(slide, color) {
            const normalized = color || "transparent";
            slide.dataset.bgColor = normalized;
            slide.style.setProperty("--slide-bg", normalized);
            setSlideTextColor(slide, normalized);
            schedulePersist();
        }

        function applyTextStyleToSlide(slide, styleIndex, size = currentFontSize) {
            const style = textStyles[styleIndex] || textStyles[0];
            const fontSize = typeof size === "number" ? size : currentFontSize;
            slide.dataset.textStyleIndex = styleIndex;
            slide.dataset.fontSize = fontSize;
            slide.style.setProperty("--slide-font-family", style.font);
            slide.style.setProperty("--slide-font-size", `${fontSize}px`);
            const labelSize = Math.max(fontSize - 2, 12);
            slide.style.setProperty("--slide-label-size", `${labelSize}px`);
            schedulePersist();
        }

        function applyRatio(index) {
            const ratio = ratioOptions[index] || ratioOptions[0];
            currentRatioIndex = index;
            document.documentElement.style.setProperty("--slide-aspect-ratio", ratio.css);
            updateRatioButtons();
            schedulePersist();
        }

        function collectSlidesFromDOM() {
            const slides = Array.from(slidesContainer.querySelectorAll(".slide"));
            return slides.map(slide => {
                const templateId = slide.dataset.templateId || templates[0].id;
                const columns = Array.from(slide.querySelectorAll(".column")).map(column => {
                    const columnTitleEl = column.querySelector(".column-title");
                    const columnTitle = columnTitleEl ? columnTitleEl.textContent.trim() : "";
                    const stageLabel = columnTitleEl ? columnTitleEl.textContent.trim() : column.dataset.stage || "";
                    const stageColor = column.style.getPropertyValue("--stage-color").trim();
                    const columnData = {
                        stage: column.dataset.stage,
                        stageLabel,
                        stageColor,
                        title: columnTitle,
                        sections: {}
                    };
                    getTemplateSections(templateId).forEach(section => {
                        const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                        const textarea = column.querySelector(`textarea[data-section="${section.key}"]`);
                        columnData.sections[section.key] = {
                            label: label ? label.textContent.trim() : getDefaultSectionLabel(templateId, section.key),
                            text: textarea ? textarea.value : ""
                        };
                    });
                    return columnData;
                });
                const titleEl = slide.querySelector(".slide-title-input");
                const fontSizeValue = parseInt(slide.dataset.fontSize, 10);
                return {
                    title: titleEl ? titleEl.value : getDefaultTitle(templateId),
                    templateId,
                    bgColor: slide.dataset.bgColor || "transparent",
                    textStyleIndex: parseStyleIndex(slide.dataset.textStyleIndex),
                    fontSize: Number.isNaN(fontSizeValue) ? currentFontSize : fontSizeValue,
                    columns
                };
            });
        }

        function createColumn(templateId, columnIndex, seed = {}) {
            const column = document.createElement("div");
            column.className = "column";
            const columnConfig = getTemplateColumn(templateId, columnIndex);
            column.dataset.stage = columnConfig.stage;
            const baseStageLabel = columnConfig.label;
            const fallbackStage = seed.stageLabel || baseStageLabel;
            const stageColor = seed.stageColor || stageColors[columnConfig.stage] || "#ffffff";
            column.style.setProperty("--stage-color", stageColor);

            const sectionsHtml = getTemplateSections(templateId)
                .map(section => `
        <div class="section">
          <div class="section-label-row">
            <span class="section-label" data-section="${section.key}" contenteditable="true">${section.icon} ${section.label}</span>
          </div>
          <div class="section-text-row">
            <div class="textarea-wrapper">
              <textarea class="editable" data-section="${section.key}" data-placeholder="${(section.examples || "").replace(/"/g, '&quot;')}"></textarea>
              <button class="field-ai-btn inside" type="button" data-field="section-text" data-section="${section.key}" title="G√©n√©rer le contenu" aria-label="G√©n√©rer le contenu">‚ú®</button>
            </div>
          </div>
        </div>
      `).join("");

            column.innerHTML = `
      <div class="column-header">
        <div class="column-header-main">
          <span class="column-title" contenteditable="true">${fallbackStage}</span>
        </div>
      </div>
      <div class="column-body">
        ${sectionsHtml}
      </div>
    `;

            const columnTitleEl = column.querySelector(".column-title");
            columnTitleEl.addEventListener("focus", () => {
                selectColumnForPalette(column);
                const selection = window.getSelection();
                if (selection) {
                    const range = document.createRange();
                    range.selectNodeContents(columnTitleEl);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });
            columnTitleEl.addEventListener("keydown", event => {
                if (event.key === "Enter") {
                    event.preventDefault();
                    columnTitleEl.blur();
                }
            });
            columnTitleEl.addEventListener("blur", () => {
                if (!columnTitleEl.textContent.trim()) {
                    columnTitleEl.textContent = fallbackStage;
                }
            });

            column.querySelectorAll(".section-label").forEach(bindSectionLabel);

            getTemplateSections(templateId).forEach(section => {
                const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                const textarea = column.querySelector(`textarea[data-section="${section.key}"]`);
                const sectionSeed = seed.sections && seed.sections[section.key];
                if (sectionSeed) {
                    label.textContent = sectionSeed.label || getDefaultSectionLabel(templateId, section.key);
                    textarea.value = sectionSeed.text || "";
                }
                monitorTextareaOverflow(textarea);
            });

            column.addEventListener("focusin", () => {
                column.classList.add("column-focused");
                showColumnPlaceholders(column);
            });
            column.addEventListener("focusout", () => {
                column.classList.remove("column-focused");
                setTimeout(() => {
                    if (!column.contains(document.activeElement)) {
                        clearColumnPlaceholders(column);
                    }
                }, 0);
            });

            column.querySelectorAll("textarea").forEach(bindTextareaPlaceholder);

            column.addEventListener("click", () => {
                selectColumnForPalette(column);
            });

            return column;
        }

        function createSlide(index, seed = {}) {
            const slide = document.createElement("div");
            slide.className = "slide";
            slide.dataset.index = index;
            const templateId = seed.templateId || templates[0].id;
            const titleValue = (seed.title || getDefaultTitle(templateId)).replace(/"/g, '&quot;');
            const subtitleValue = (seed.subtitle || defaultSubtitle).replace(/"/g, '&quot;');
            slide.dataset.templateId = templateId;
            slide.dataset.tabLabel = seed.tabLabel || `Page ${index + 1}`;
            slide.innerHTML = `
  <div class="slide-header">
    <div class="slide-title-row">
      <input class="slide-title-input editable" type="text" value="${titleValue}">
    </div>
  </div>
  <div class="slide-body">
    <div class="columns"></div>
  </div>
`;
            const columnsContainer = slide.querySelector(".columns");
            getTemplateColumns(templateId).forEach((_, columnIndex) => {
                const columnSeed = seed.columns && seed.columns[columnIndex];
                columnsContainer.appendChild(createColumn(templateId, columnIndex, columnSeed));
            });
            const templateColumns = getTemplateColumns(templateId);
            columnsContainer.querySelectorAll(".column").forEach((column, columnIndex) => {
                const columnTitle = column.querySelector(".column-title");
                if (!columnTitle.textContent.trim()) {
                    columnTitle.textContent = templateColumns[columnIndex]?.label || "";
                }
            });

            columnsContainer.addEventListener("click", event => {
                const targetColumn = event.target.closest(".column");
                if (targetColumn) {
                    selectColumnForPalette(targetColumn);
                }
            });
            const bgColor = seed.bgColor ?? "transparent";
            applyBackgroundToSlide(slide, bgColor);
            const styleIndex = typeof seed.textStyleIndex === "number" ? seed.textStyleIndex : currentTextStyleIndex;
            const fontSize = typeof seed.fontSize === "number" ? seed.fontSize : currentFontSize;
            applyTextStyleToSlide(slide, styleIndex, fontSize);
            return slide;
        }

        function renderSlidesForTemplate(templateId) {
            currentTemplateId = templateId || currentTemplateId;
            const slides = getTemplateSlidesList(currentTemplateId);
            slidesContainer.innerHTML = "";
            slideCount = 0;
            slides.forEach((slideData, index) => {
                const slide = createSlide(index, slideData);
                slidesContainer.appendChild(slide);
                slideCount++;
            });
            refreshTabs();
            setActiveTab(0);
            if (templateSelect) {
                templateSelect.value = currentTemplateId;
            }
        }

        function storeCurrentSlides() {
            templateSlides[currentTemplateId] = collectSlidesFromDOM();
        }

        function createTabButton(index) {
            const btn = document.createElement("button");
            btn.className = "tab-btn";
            btn.dataset.index = index;
            const slide = slidesContainer.querySelector(`.slide[data-index="${index}"]`);
            const label = (slide?.dataset.tabLabel || `Page ${index + 1}`).trim();
            btn.textContent = label;
            btn.addEventListener("click", () => setActiveTab(index));
            btn.addEventListener("dblclick", () => {
                const newName = prompt("Renommer l'onglet", btn.textContent);
                if (!newName) return;
                btn.textContent = newName;
                if (slide) {
                    slide.dataset.tabLabel = newName;
                }
            });
            tabsContainer.appendChild(btn);
        }

        function refreshTabs() {
            tabsContainer.innerHTML = "";
            const slides = slidesContainer.querySelectorAll(".slide");
            slides.forEach((slide, idx) => {
                slide.dataset.index = idx;
                createTabButton(idx);
            });
            slideCount = slides.length;
            updateDeleteButtonState();
        }

        function setActiveTab(index) {
            closeContextMenus();
            activeIndex = index;
            const slides = slidesContainer.querySelectorAll(".slide");
            const tabBtns = tabsContainer.querySelectorAll(".tab-btn");
            slides.forEach(s => {
                s.classList.toggle("hidden", s.dataset.index != index);
            });
            tabBtns.forEach(b => {
                b.classList.toggle("active", b.dataset.index == index);
            });
            const activeSlide = slidesContainer.querySelector(`.slide[data-index="${index}"]`);
            const firstColumn = activeSlide ? activeSlide.querySelector(".column") : null;
            if (firstColumn) {
                selectColumnForPalette(firstColumn);
            }
            if (activeSlide) {
                currentTextStyleIndex = parseStyleIndex(activeSlide.dataset.textStyleIndex);
                currentFontSize = normalizeFontSize(activeSlide.dataset.fontSize ?? currentFontSize);
                syncFontControls();
                syncBackgroundSelector();
                currentTemplateId = activeSlide.dataset.templateId || templates[0].id;
                if (templateSelect) {
                    templateSelect.value = currentTemplateId;
                }
            }
        }

        function buildColumnSeeds(slide, options = {}) {
            if (!slide) {
                return [];
            }
            const templateId = slide.dataset.templateId || templates[0].id;
            const includeText = options.includeText !== false;
            return Array.from(slide.querySelectorAll(".column")).map(column => {
                const columnTitleEl = column.querySelector(".column-title");
                const stageLabel = columnTitleEl ? columnTitleEl.textContent.trim() : column.dataset.stage || "";
                const stageColor = column.style.getPropertyValue("--stage-color").trim() || "#ffffff";
                const sections = {};
                getTemplateSections(templateId).forEach(section => {
                    const label = column.querySelector(`.section-label[data-section="${section.key}"]`);
                    const textarea = column.querySelector(`textarea[data-section="${section.key}"]`);
                    sections[section.key] = {
                        label: label ? (label.textContent.trim() || getDefaultSectionLabel(templateId, section.key)) : getDefaultSectionLabel(templateId, section.key),
                        text: textarea ? (includeText ? textarea.value : "") : ""
                    };
                });
                return { stageLabel, stageColor, sections };
            });
        }

        function getDefaultFromCurrentSlide() {
            const slide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (!slide) {
                return null;
            }
            const titleEl = slide.querySelector(".slide-title-input");
            const subtitleEl = slide.querySelector(".slide-subtitle-input");
            const bgColor = slide.dataset.bgColor || "#ffffff";
            const textStyleIndex = parseStyleIndex(slide.dataset.textStyleIndex);
            const fontSize = normalizeFontSize(slide.dataset.fontSize ?? currentFontSize);
            const columns = buildColumnSeeds(slide, { includeText: false });
            const templateId = slide.dataset.templateId || templates[0].id;
            return {
                title: titleEl?.value || getDefaultTitle(templateId),
                subtitle: subtitleEl?.value || defaultSubtitle,
                bgColor,
                textStyleIndex,
                fontSize,
                templateId,
                columns
            };
        }

        function getDefaultFromLastSlide() {
            if (slideCount === 0) {
                return {
                    title: getDefaultTitle(templates[0].id),
                    subtitle: defaultSubtitle,
                    templateId: templates[0].id,
                    bgColor: "transparent",
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize
                };
            }
            const previousSlide = slidesContainer.querySelector(`.slide[data-index="${slideCount - 1}"]`);
            if (!previousSlide) {
                return {
                    title: getDefaultTitle(templates[0].id),
                    subtitle: defaultSubtitle,
                    templateId: templates[0].id,
                    bgColor: "transparent",
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize
                };
            }
            const prevTitleEl = previousSlide.querySelector(".slide-title-input");
            const prevSubtitleEl = previousSlide.querySelector(".slide-subtitle-input");
            const prevTemplateId = previousSlide.dataset.templateId || templates[0].id;
            return {
                title: prevTitleEl ? prevTitleEl.value : getDefaultTitle(prevTemplateId),
                subtitle: prevSubtitleEl ? prevSubtitleEl.value : defaultSubtitle,
                templateId: prevTemplateId,
                bgColor: previousSlide.dataset.bgColor || "transparent",
                textStyleIndex: parseStyleIndex(previousSlide.dataset.textStyleIndex),
                fontSize: normalizeFontSize(previousSlide.dataset.fontSize ?? currentFontSize),
                columns: buildColumnSeeds(previousSlide, { includeText: false })
            };
        }

        function addTab() {
            const idx = slideCount;
            const seed = getDefaultFromCurrentSlide() || getDefaultFromLastSlide();
            const slide = createSlide(idx, seed);
            slidesContainer.appendChild(slide);
            createTabButton(idx);
            slideCount++;
            updateDeleteButtonState();
            setActiveTab(idx);
            schedulePersist();
        }

        function updateDeleteButtonState() {
            deleteTabBtn.disabled = slideCount <= 1;
        }

        addTabBtn.addEventListener("click", addTab);


        deleteTabBtn.addEventListener("click", () => {
            if (slideCount <= 1) {
                return;
            }
            const currentSlide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (currentSlide) {
                currentSlide.remove();
            }
            refreshTabs();
            if (activeIndex >= slideCount) {
                activeIndex = slideCount - 1;
            }
            setActiveTab(activeIndex);
            schedulePersist();
        });

        textStyleBtn.addEventListener("click", event => {
            event.stopPropagation();
            toggleSettingsMenu();
        });
        fileMenuBtn?.addEventListener("click", event => {
            event.stopPropagation();
            toggleMenu(fileMenu);
        });

        if (resetPromptsBtn) {
            resetPromptsBtn.addEventListener("click", () => {
                sectionKeys.forEach(sectionKey => {
                    promptLibrary[activePromptTemplateId][sectionKey] = defaultPromptTemplate;
                });
                setPromptFieldsForTemplate(activePromptTemplateId);
                schedulePersist();
            });
        }

        importJsonBtn.addEventListener("click", () => {
            importInput.value = "";
            importInput.click();
            closeContextMenus();
        });

        importInput.addEventListener("change", event => {
            const files = event.target.files;
            const file = files && files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const parsed = JSON.parse(reader.result);
                    const payload = Array.isArray(parsed) ? { slides: parsed, settings: {} } : parsed;
                    importSlidesFromData(payload.slides ?? payload, payload.settings ?? {});
                } catch (err) {
                    alert("Import JSON invalide.");
                    console.error(err);
                }
            };
            reader.readAsText(file);
        });

        exportJsonBtn.addEventListener("click", () => {
            const data = collectAllSlides();
            const payload = {
                slides: data,
                settings: {
                    ratioIndex: currentRatioIndex,
                    textStyleIndex: currentTextStyleIndex,
                    fontSize: currentFontSize,
                    apiKey: apiKeyInput.value,
                    context: contextField.value,
                    prompts: promptLibrary,
                    promptTemplateId: activePromptTemplateId,
                    iaMode: activeIaMode,
                    defaultTemplateId: currentTemplateId
                }
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "go-roadmap.json";
            link.click();
            URL.revokeObjectURL(link.href);
            closeContextMenus();
        });

        function importSlidesFromData(slidesData, settings = {}) {
            const slideList = Array.isArray(slidesData) ? slidesData : [];
            initializeTemplateSlides(slideList);
            applySettingsFromPayload(settings);
            renderSlidesForTemplate(currentTemplateId);
            schedulePersist();
        }

        function closeMenu(menu) {
            menu?.classList.remove("open");
        }

        function toggleMenu(menu) {
            if (!menu) return;
            const isOpen = menu.classList.contains("open");
            closeContextMenus();
            if (!isOpen) {
                menu.classList.add("open");
            }
        }

        function closeContextMenus() {
            [settingsMenu, fileMenu].forEach(menu => menu?.classList.remove("open"));
        }

        function withExportMode(action) {
            return (async () => {
                closeContextMenus();
                document.body.classList.add("exporting");
                try {
                    return await action();
                } finally {
                    document.body.classList.remove("exporting");
                }
            })();
        }

        function prepareSlideForExport(slide) {
            const wrapper = document.createElement("div");
            wrapper.style.position = "fixed";
            wrapper.style.top = "-9999px";
            wrapper.style.left = "-9999px";
            wrapper.style.opacity = "0";
            wrapper.style.pointerEvents = "none";
            wrapper.style.zIndex = "-1";
            const clone = slide.cloneNode(true);
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);
            clone.querySelectorAll("textarea").forEach(textarea => {
                const computed = window.getComputedStyle(textarea);
                const replacement = document.createElement("div");
                replacement.textContent = textarea.value || textarea.placeholder || "";
                replacement.style.cssText = computed.cssText;
                replacement.style.whiteSpace = "pre-wrap";
                replacement.style.wordBreak = "break-word";
                replacement.style.overflow = "visible";
                replacement.style.width = computed.width;
                replacement.style.minHeight = computed.height;
                replacement.style.boxSizing = "border-box";
                textarea.replaceWith(replacement);
            });
            clone.querySelectorAll(".column-title").forEach(input => {
                const computed = window.getComputedStyle(input);
                const replacement = document.createElement("div");
                replacement.textContent = input.value || "";
                replacement.style.cssText = computed.cssText;
                replacement.style.whiteSpace = "nowrap";
                replacement.style.overflow = "visible";
                replacement.style.width = computed.width;
                replacement.style.height = computed.height;
                replacement.style.fontSize = `calc(${computed.fontSize} + 5px)`;
                replacement.style.position = "relative";
                replacement.style.top = "10px";
                replacement.style.boxSizing = "border-box";
                input.replaceWith(replacement);
            });
            return { wrapper, clone };
        }

        exportBtn.addEventListener("click", async () => {
            closeContextMenus();
            const slide = slidesContainer.querySelector(`.slide[data-index="${activeIndex}"]`);
            if (!slide) return;
            const oldText = exportBtn.textContent;
            exportBtn.textContent = "‚è≥";
            exportBtn.disabled = true;
            try {
                await withExportMode(async () => {
                    const { wrapper, clone } = prepareSlideForExport(slide);
                    try {
                        const canvas = await html2canvas(clone, { scale: 2, backgroundColor: null, useCORS: true });
                        const link = document.createElement("a");
                        link.download = `go-roadmap-page-${activeIndex + 1}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    } finally {
                        wrapper.remove();
                    }
                });
            } catch (err) {
                alert("Export impossible. Tu peux utiliser l'impression PDF en secours.");
                console.error(err);
            } finally {
                exportBtn.textContent = oldText;
                exportBtn.disabled = false;
            }
        });

        function buildTableDataForSlide(slideData) {
            const columns = slideData.columns || [];
            if (!columns.length) {
                return [];
            }
            const formatSectionContent = (section) =>
                (section?.text || "")
                    .split(/\n+/)
                    .map(line => line.trim())
                    .filter(Boolean)
                    .join("\n");
            const formatSectionCell = (section) => {
                const label = section?.label?.trim();
                const content = formatSectionContent(section);
                const parts = [];
                if (label) {
                    parts.push({
                        text: label + (content ? "\n" : ""),
                        options: { bold: true, fontSize: 10 }
                    });
                }
                if (content) {
                    parts.push({
                        text: content,
                        options: { fontSize: 10 }
                    });
                }
                return parts.length ? parts : { text: "", options: { fontSize: 10 } };
            };
            const headerRow = columns.map(column => ({
                text: `${column.stageLabel || column.stage || ""}`.trim(),
                options: { bold: true, fontSize: 10 }
            }));
            const rows = sectionKeys.map(key =>
                columns.map(column => ({
                    text: formatSectionCell(column.sections[key]),
                    options: { fontSize: 10 }
                }))
            );
            return [headerRow, ...rows];
        }

        async function exportPptxFromSlides() {
            const ratio = ratioOptions[currentRatioIndex] || ratioOptions[0];
            const data = collectSlidesFromDOM();
            if (!data.length) return;
            const pptx = new PptxGenJS();
            const layoutName = `CUSTOM_${ratio.name.replace(/[^a-zA-Z0-9]/g, "_")}`;
            pptx.defineLayout({ name: layoutName, width: ratio.pptx.width, height: ratio.pptx.height });
            pptx.layout = layoutName;
            for (const slideData of data) {
                const pptSlide = pptx.addSlide();
                const table = buildTableDataForSlide(slideData);
                pptSlide.addTable(table, {
                    x: 0.4,
                    y: 0.4,
                    w: ratio.pptx.width - 0.8,
                    border: { type: "none" },
                    fontSize: 10,
                    rowH: 0.4,
                    valign: "top",
                    color: "363636"
                });
                pptSlide.addText(`${slideData.title}`, {
                    x: 0.4,
                    y: 0.1,
                    w: ratio.pptx.width - 0.8,
                    fontSize: 12,
                    bold: true
                });
            }
            await pptx.writeFile({ fileName: "go-roadmap.pptx" });
        }

        exportPptxBtn.addEventListener("click", async () => {
            exportPptxBtn.disabled = true;
            try {
                await withExportMode(async () => {
                    await exportPptxFromSlides();
                });
            } catch (err) {
                alert("Export PPTX impossible. Tu peux r√©essayer.");
                console.error(err);
            } finally {
                exportPptxBtn.disabled = false;
            }
            closeContextMenus();
        });

        function fillTemplate(template, data) {
            return template.replace(/\{\{(\w+)\}\}/g, (_, key) => data[key] ?? "");
        }

        function getPromptTemplateForSection(templateId, sectionKey) {
            const sectionPrompts = promptLibrary[templateId] || promptLibrary[templates[0].id];
            return sectionPrompts[sectionKey] || defaultPromptTemplate;
        }

        function getPromptTemplateForMode(section, templateId) {
            if (activeIaMode === IA_MODE_EXPRESS) {
                return defaultPromptTemplate;
            }
            if (activeIaMode === IA_MODE_APPRENTI) {
                return apprentPromptTemplate;
            }
            return getPromptTemplateForSection(templateId, section);
        }

        function buildFieldPrompt(section, templateId, contextData) {
            const template = getPromptTemplateForMode(section, templateId);
            return fillTemplate(template, contextData);
        }

        async function callOpenAI(messages) {
            const apiKey = apiKeyInput.value.trim();
            try {
                const useProxy = !apiKey;
                if (useProxy) {
                    console.warn("Appel OpenAI via le proxy tranxq.workers.dev");
                } else {
                    console.warn("Appel OpenAI officiel");
                }
                const endpoint = apiKey
                    ? "https://api.openai.com/v1/chat/completions"
                    : "https://openai.tranxq.workers.dev/v1/chat/completions";
                console.log(
                    "send request",
                    messages.map(message => ({
                        role: message.role,
                        content: message.content
                    }))
                );
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(apiKey ? { Authorization: `Bearer ${apiKey}` } : {})
                    },
                    body: JSON.stringify({
                        model: "gpt-5-nano",
                        messages,
                        temperature: 1
                    })
                });
                if (!response.ok) {
                    const body = await response.text();
                    throw new Error(body);
                }
                const payload = await response.json();
                console.debug("OpenAI response payload", payload);
                const choice = payload.choices?.[0] || {};
                const content = choice.message?.content ?? choice.text ?? "";
                return content;
            } catch (err) {
                console.error("Erreur OpenAI", err);
                alert("Impossible de contacter OpenAI (acc√®s non autoris√© ou quota exc√©d√©). Utilise ta propre cl√© Open API.");
                return null;
            }
        }

        let activeModalTab = "context";

        function switchModalTab(tabName) {
            activeModalTab = tabName;
            contextModalTabs.forEach(tab => {
                tab.classList.toggle("active", tab.dataset.tab === tabName);
            });
            contextModalPanels.forEach(panel => {
                panel.classList.toggle("hide", panel.dataset.panel !== tabName);
            });
        }

        contextModalTabs.forEach(tab => {
            tab.addEventListener("click", () => {
                switchModalTab(tab.dataset.tab);
            });
        });

        function handleSettingsSave() {
            schedulePersist();
            closeModal(contextModal);
        }
        ;

        async function handleFieldAi(button) {
            const section = button.dataset.section;
            const textarea = button.closest(".section-text-row")?.querySelector("textarea");
            if (!textarea || !section) return;
            const column = button.closest(".column");
            const slide = button.closest(".slide");
            const columnTitle = column?.querySelector(".column-title")?.textContent.trim() || "";
            const sectionLabel = column?.querySelector(`.section-label[data-section="${section}"]`)?.textContent.trim() || "";
            const templateId = slide?.dataset.templateId || templates[0].id;
            const promptContext = {
                contextField: contextField.value.trim(),
                columnTitle,
                fieldValue: textarea.value.trim(),
                sectionTitle: sectionLabel
            };
            const message = buildFieldPrompt(section, templateId, promptContext);
            const messages = [
                { role: "system", content: "Tu es un assistant produit." },
                { role: "user", content: message }
            ];
            button.textContent = "‚è≥";
            button.disabled = true;
            try {
                const aiText = await callOpenAI(messages);
                console.log("OpenAI field response", aiText);
                if (aiText == null) return;
                textarea.value = aiText.trim();
                updateTextareaOverflowState(textarea);
                schedulePersist();
            } finally {
                button.textContent = "‚ú®";
                button.disabled = false;
            }
        }

        document.addEventListener("click", event => {
            const btn = event.target.closest(".field-ai-btn");
            if (btn) {
                event.stopPropagation();
                handleFieldAi(btn);
                return;
            }
            if (!event.target.closest(".menu-trigger")) {
                closeContextMenus();
            }
        });

        window.addEventListener("beforeunload", persistState);

        function openModal(modal) {
            modal?.classList.add("open");
        }

        function closeModal(modal) {
            modal?.classList.remove("open");
        }

        document.querySelectorAll(".modal-close").forEach(btn => {
            btn.addEventListener("click", () => {
                const targetId = btn.dataset.close;
                if (targetId) {
                    closeModal(document.getElementById(targetId));
                }
            });
        });

        contextBtn.addEventListener("click", () => {
            switchModalTab("context");
            openModal(contextModal);
        });
        contextModal.addEventListener("click", event => {
            if (event.target === contextModal) {
                closeModal(contextModal);
            }
        });
        switchModalTab("context");
        loadSavedState();
        renderSlidesForTemplate(currentTemplateId);
        applyRatio(currentRatioIndex);

        const infoButton = document.getElementById("infoButton");
        const infoPopup = document.getElementById("infoPopup");
        infoButton?.addEventListener("click", event => {
            event.stopPropagation();
            infoPopup?.classList.toggle("open");
        });
        document.addEventListener("click", event => {
            if (!infoPopup?.contains(event.target) && event.target !== infoButton) {
                infoPopup?.classList.remove("open");
            }
        });

        const tourSteps = [
            {
                title: "Go-Toolkit, ton assistant r√©daction",
                description: "Go-Toolkit aide les Product Owners √† pr√©parer des supports de pr√©sentation clairs, structur√©s et pertinents",
                selector: null
            },
            {
                title: "Choix de mod√®le de documents",
                description: "Choisis parmi les trois mod√®les disponibles, navigue page par page via les onglets et utilise les ic√¥nes ‚ûï/üóëÔ∏è pour ajouter, renommer ou supprimer une page √† tout moment.",
                selectors: ["#templateSelect", "#tabs", ".tab-btn-add", ".tab-btn-delete"]
            },
            {
                title: "Structure enti√®rement personnalisable",
                description: "Chaque page propose un titre, des colonnes, des section et des champs √©ditables pour structurer ton propos.",
                selectors: [".slide-title-input", ".column-title", ".section-label"]
            },
            {
                title: "Exports",
                description: "Le bouton üìÑ permet d'exporter en Image (courant) ou en PowerPoint (texte) pour l'int√©grer dans tes livrables.",
                selector: "#fileMenuTrigger"
            },
            {
                title: "Assistant ‚ú®IA",
                description: "Avant d'utiliser l'IA, d√©cris ton contexte et remplis les √©l√©ments de ton mieux",
                selector: "#contextBtn"
            },
            {
                title: "IA sur chaque champ",
                description: "Le bouton ‚ú® te renvoit une r√©ponse claire et structur√© en 15-30 secondes √† partir des √©l√©ments renseign√©s",
                selector: ".field-ai-btn"
            },
        ];

        const tourOverlay = document.getElementById("tourOverlay");
        const tourHighlight = tourOverlay?.querySelector(".tour-highlight");
        const tourPanel = tourOverlay?.querySelector(".tour-panel");
        const tourTitle = document.getElementById("tourStepTitle");
        const tourDescription = document.getElementById("tourStepDescription");
        const tourCounter = document.getElementById("tourStepCounter");
        const tourPrevBtn = document.getElementById("tourPrevBtn");
        const tourNextBtn = document.getElementById("tourNextBtn");
        const tourCloseBtn = document.getElementById("tourCloseBtn");
        const tourSkipBtn = document.getElementById("tourSkipBtn");
        const tourReplayBtn = document.getElementById("tourReplayBtn");
        const tourStorageKey = "goToolkitTourCompleted";
        let currentTourIndex = 0;

        function getSelectorsFromStep(step) {
            if (!step) {
                return [];
            }
            if (Array.isArray(step.selectors)) {
                return step.selectors;
            }
            if (step.selector) {
                return [step.selector];
            }
            return [];
        }

        function getSelectorsBoundingRect(selectors) {
            if (!selectors?.length) {
                return null;
            }
            let unionRect = null;
            selectors.forEach(selector => {
                const target = document.querySelector(selector);
                if (!target) {
                    return;
                }
                const rect = target.getBoundingClientRect();
                if (!unionRect) {
                    unionRect = {
                        top: rect.top,
                        left: rect.left,
                        right: rect.right,
                        bottom: rect.bottom,
                        width: rect.width,
                        height: rect.height
                    };
                } else {
                    unionRect.top = Math.min(unionRect.top, rect.top);
                    unionRect.left = Math.min(unionRect.left, rect.left);
                    unionRect.right = Math.max(unionRect.right, rect.right);
                    unionRect.bottom = Math.max(unionRect.bottom, rect.bottom);
                    unionRect.width = unionRect.right - unionRect.left;
                    unionRect.height = unionRect.bottom - unionRect.top;
                }
            });
            return unionRect;
        }

        function positionTourPanel(selectors) {
            if (!tourPanel) return;
            const spacing = 14;
            const defaultStyles = {
                top: "auto",
                bottom: "28px",
                left: "50%",
                right: "auto",
                transform: "translateX(-50%)"
            };
            Object.assign(tourPanel.style, defaultStyles);
            const rect = getSelectorsBoundingRect(selectors);
            if (!rect) return;
            const panelRect = tourPanel.getBoundingClientRect();
            let top = rect.bottom + spacing;
            if (top + panelRect.height > window.innerHeight - spacing) {
                top = rect.top - panelRect.height - spacing;
            }
            let left = rect.left + rect.width / 2 - panelRect.width / 2;
            left = Math.max(spacing, Math.min(left, window.innerWidth - panelRect.width - spacing));
            tourPanel.style.top = `${Math.max(spacing, top)}px`;
            tourPanel.style.left = `${left}px`;
            tourPanel.style.bottom = "auto";
            tourPanel.style.right = "auto";
            tourPanel.style.transform = "none";
        }

        function updateHighlight(selectors) {
            if (!tourHighlight) return;
            const rect = getSelectorsBoundingRect(selectors);
            if (!rect) {
                tourHighlight.classList.add("hidden");
                tourOverlay?.classList.add("dimmed");
                return;
            }
            tourOverlay?.classList.remove("dimmed");
            tourHighlight.classList.remove("hidden");
            const offset = 10;
            tourHighlight.style.width = `${rect.width + offset * 2}px`;
            tourHighlight.style.height = `${rect.height + offset * 2}px`;
            tourHighlight.style.transform = "translate(0, 0)";
            tourHighlight.style.left = `${rect.left - offset}px`;
            tourHighlight.style.top = `${rect.top - offset}px`;
        }

        function handleTourModal(step) {
            if (!contextModal) return;
            if (step?.openContextModal) {
                openModal(contextModal);
            } else {
                closeModal(contextModal);
            }
        }

        function renderTourStep() {
            if (!tourOverlay || !tourSteps.length) return;
            const step = tourSteps[currentTourIndex];
            tourTitle.textContent = step.title;
            tourDescription.textContent = step.description;
            tourCounter.textContent = `√âtape ${currentTourIndex + 1} / ${tourSteps.length}`;
            tourPrevBtn.disabled = currentTourIndex === 0;
            tourNextBtn.textContent = currentTourIndex === tourSteps.length - 1 ? "Termin√©" : "Suivant";
            const selectors = getSelectorsFromStep(step);
            updateHighlight(selectors);
            positionTourPanel(selectors);
            handleTourModal(step);
        }

        function openTour(startIndex = 0) {
            if (!tourOverlay) return;
            currentTourIndex = startIndex;
            tourOverlay.classList.add("visible");
            tourOverlay.setAttribute("aria-hidden", "false");
            renderTourStep();
        }

        function closeTour(markSeen = false) {
            if (markSeen && window.localStorage) {
                window.localStorage.setItem(tourStorageKey, "1");
            }
            if (!tourOverlay) return;
            tourOverlay.classList.remove("visible");
            tourOverlay.setAttribute("aria-hidden", "true");
            tourOverlay.classList.remove("dimmed");
            if (tourHighlight) {
                tourHighlight.classList.add("hidden");
            }
        }

        if (tourPrevBtn) {
            tourPrevBtn.addEventListener("click", () => {
                if (currentTourIndex === 0) return;
                currentTourIndex = Math.max(0, currentTourIndex - 1);
                renderTourStep();
            });
        }

        tourNextBtn?.addEventListener("click", () => {
            if (currentTourIndex >= tourSteps.length - 1) {
                closeTour(true);
                return;
            }
            currentTourIndex = Math.min(tourSteps.length - 1, currentTourIndex + 1);
            renderTourStep();
        });

        tourCloseBtn?.addEventListener("click", () => closeTour(true));
        tourSkipBtn?.addEventListener("click", () => closeTour(true));
        tourReplayBtn?.addEventListener("click", () => {
            if (window.localStorage) {
                window.localStorage.removeItem(tourStorageKey);
            }
            openTour(0);
        });

        window.addEventListener("resize", () => {
            if (!tourOverlay?.classList.contains("visible")) return;
            renderTourStep();
        });

        const tourSeen = window.localStorage?.getItem(tourStorageKey);
        if (!tourSeen) {
            setTimeout(() => openTour(0), 200);
        }
    </script>

</body>

</html>