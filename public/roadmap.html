<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Goal Digger | Go-Toolkit</title>

    <!-- Vis Timeline -->
    <link rel="stylesheet" href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css"
        type="text/css" />
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js"></script>

    <style>
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --surface-soft: #f7f7f7;
            --border: #e5e7eb;
            --border-light: var(--border);
            --border-strong: #d1d5db;
            --timeline-background: #ffffff;

            --primary: #2a7a57;
            --primary-soft: rgba(42, 122, 87, 0.17);
            --primary-strong: #1f4f3d;

            --text: #111827;
            --muted: rgba(57, 76, 89, .85);

            --radius-lg: 16px;
            --radius-md: 999px;
            --radius-sm: 10px;

            --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
            --app-font: "Inter", system-ui;
            --global-font-size: 14px;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            height: 100vh;
            background: #f7f7f7;
            color: var(--text);
            font-family: var(--app-font, "Inter");
            overflow: hidden;
        }

        .vis-item .vis-item-content {
            white-space: normal !important;
            word-break: break-word;
            overflow-wrap: anywhere;
            padding: 2px 0px;
        }

        .type-milestone .vis-item-content {
            padding: 6px 15px;
        }

        .vis-item.type-milestone .vis-item-content {
            margin-left: -20px;
        }


        .app {
            width: 100%;
            max-width: none;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
            min-height: 100vh;
            height: 100vh;
            padding: 12px;
        }

        .app-main {
            display: flex;
            flex: 1 1 auto;
            gap: 12px;
            align-items: stretch;
            min-height: 0;
            position: relative;
        }

        .app::after {
            content: "";
            position: absolute;
            bottom: 16px;
            right: 16px;
            width: 120px;
            height: 120px;
            background: url("logo.gif") no-repeat center/contain;
            opacity: 0.25;
            pointer-events: none;
            z-index: -1;
        }




        .app-header {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 2px;
            flex-wrap: wrap;
            width: 100%;
            margin: 4px 0 auto;
            padding: 0;
            border-radius: 0;
            border: none;
            box-shadow: none;
        }

        .app-home-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #ffffff;
            font-size: 16px;
            color: var(--primary-strong);
            text-decoration: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .app-home-link:hover,
        .app-home-link:focus-visible {
            border-color: var(--primary);
            outline: none;
        }

        .tabs {
            flex: 0 1 auto;
            min-width: 0;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tabs-wrapper {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 40px;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        .ia-header-actions {
            width: 100%;
            padding: 5px 0px;
        }

        .tab {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 4px 12px;
            font-size: 12px;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .context-menu.file-menu {
            padding: 0;
            margin: 0;
        }

        .context-menu.file-menu .menu-panel .menu-panel-btn {
            margin-right: 10px;
            border: none;
        }

        .tab.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .tab-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .tab-btn-add,
        .tab-btn-delete {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #fff;
            padding: 4px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        h1 {
            margin: 0 0 4px;
            font-size: 19px;
        }

        .subtitle {
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--muted);
        }

        /* Panneau gauche : OpenAI + JSON */
        label {
            font-size: 12px;
            color: var(--muted);
            display: block;
            margin-bottom: 3px;
        }

        textarea {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 11px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
            resize: none;
            min-height: 80px;
            scrollbar-width: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
            scrollbar-width: thin;
        }

        textarea::-webkit-scrollbar {
            width: 0;
        }

        textarea:focus::-webkit-scrollbar {
            width: 6px;
        }

        textarea::-webkit-scrollbar-thumb {
            background: rgba(42, 122, 87, 0.35);
            border-radius: 10px;
        }

        select,
        .input-small {
            width: 100%;
            border-radius: 999px;
            border: 1px solid var(--border-strong);
            padding: 4px 8px;
            font-size: 11px;
            background: var(--surface-soft);
        }

        select:focus,
        .input-small:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            white-space: nowrap;
            background: var(--primary);
            color: #fff;
        }

        .white-btn {
            border-color: rgba(15, 23, 42, 0.2);
            background: #fff;
            color: #0f172a;
            margin-right: 6px;
        }

        .white-btn:hover,
        .white-btn:focus-visible {
            border-color: #2a7a57;
            background: #fff;
            color: #2a7a57;
            box-shadow: none;
        }

        .nav-switch {
            position: relative;
            display: inline-flex;
            align-items: center;
            margin-right: 6px;
        }

        .nav-switch-btn {
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: #fff;
            color: #0f172a;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .nav-switch-btn:hover,
        .nav-switch-btn:focus-visible {
            color: #2a7a57;
            border-color: #2a7a57;
        }

        .nav-switch-menu {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 180px;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 6px;
            display: none;
            z-index: 50;
        }

        .nav-switch-menu.open {
            display: block;
        }

        .nav-switch-link {
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
            border: none;
            background: transparent;
            border-radius: 10px;
            padding: 8px 12px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
            color: #1f2a56;
        }

        .nav-switch-link:hover,
        .nav-switch-link:focus-visible {
            background: rgba(42, 122, 87, 0.08);
        }

        .btn-ghost {
            background: var(--surface-soft);
            color: var(--text);
            border-color: var(--border);
        }

        .btn:hover {
            box-shadow: 0 6px 18px rgba(42, 122, 87, 0.32);
        }

        .btn-ghost:hover {
            background: #e5edff;
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .btn[disabled] {
            opacity: 0.45;
            cursor: default;
            box-shadow: none;
        }

        .hint {
            font-size: 11px;
            color: var(--muted);
        }

        .hint code {
            font-size: 10px;
            background: var(--surface-soft);
            border-radius: 6px;
            padding: 2px 4px;
        }

        /* Timeline + toolbar */
        .timeline-card {
            --vis-item-padding-vertical: 2px;
            --vis-item-padding-horizontal: 4px;
            --vis-group-label-padding-vertical: 4px;
            --vis-group-label-padding-horizontal: 10px;
            --vis-row-padding-vertical: 4px;
            background: var(--timeline-background);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1 1 auto;
            min-height: 0;
            height: 100%;
            width: 100%;
            max-width: none;
            min-width: 0;
            font-size: var(--global-font-size, 14px);
            aspect-ratio: auto;
        }

        .timeline-card[data-spacing="dense"] {
            --vis-item-padding-vertical: 4px;
            --vis-item-padding-horizontal: 6px;
            --vis-group-label-padding-vertical: 2px;
            --vis-group-label-padding-horizontal: 8px;
            --vis-row-padding-vertical: 4px;
        }

        .timeline-card[data-spacing="normal"] {
            --vis-item-padding-vertical: 6px;
            --vis-item-padding-horizontal: 10px;
            --vis-group-label-padding-vertical: 4px;
            --vis-group-label-padding-horizontal: 10px;
            --vis-row-padding-vertical: 6px;
        }

        .timeline-card[data-spacing="comfortable"] {
            --vis-item-padding-vertical: 10px;
            --vis-item-padding-horizontal: 16px;
            --vis-group-label-padding-vertical: 6px;
            --vis-group-label-padding-horizontal: 12px;
            --vis-row-padding-vertical: 10px;
        }

        .timeline-card[data-ratio="full"],
        .timeline-card:not([data-ratio]) {
            flex: 1 1 auto;
            aspect-ratio: auto;
            width: 100%;
            margin-inline: 0;
            max-width: none;
        }

        .timeline-card[data-ratio="16:9"],
        .timeline-card[data-ratio="4:3"],
        .timeline-card[data-ratio="a4"] {
            flex: 0 0 auto;
            aspect-ratio: auto;
            width: auto;
            max-width: 100%;
            margin-inline: auto;
        }

        .timeline-card[data-ratio="16:9"] {
            aspect-ratio: 16 / 9;
        }

        .timeline-card[data-ratio="4:3"] {
            aspect-ratio: 4 / 3;
        }

        .timeline-card[data-ratio="a4"] {
            aspect-ratio: 297 / 210;
        }

        /* Make timeline card corners rounded */
        .timeline-card {
            border-radius: 8px;
            overflow: hidden;
        }

        .gutenberg-card {
            display: none;
            flex: 0 0 350px;
            width: 350px;
            background: var(--surface);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 8px 8px 10px;
            box-shadow: var(--shadow-soft);
            gap: 8px;
            height: 100%;
            min-height: 0;
            overflow-y: auto;
            transition: transform 0.18s ease, opacity 0.18s ease;
            font-size: 11px;
            font-family: monospace;
        }

        .gutenberg-card.open {
            display: flex;
            flex-direction: column;
        }

        .gutenberg-card .modal-header {
            padding: 0 0 4px;
        }

        .gutenberg-card .gutenberg-title {
            font-size: 15px;
            font-weight: 700;
            margin: 0;
            padding: 0;
            line-height: 1;
        }

        .gutenberg-card .ia-actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1 1 auto;
            min-height: 0;
        }

        .gutenberg-card .ia-header-actions {
            padding: 0;
        }

        .gutenberg-card .ia-prompt-fields {
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }

        .gutenberg-card .ia-prompt-field {
            height: 100%;
            min-height: 0;
        }

        .gutenberg-card .gutenberg-recette {
            /* reduced height: half of previous 250px */
            flex: 0 0 200px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .gutenberg-recette-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .btn-generate {
            border-radius: 6px;
            border: none;
            background: #2a7a57;
            color: #ffffff;
            padding: 6px 10px;
        }

        .btn.btn-generate.primary {
            background: #2a7a57;
            color: #ffffff;
            border: none;
        }

        /* Increase the label font size for Récit and Script by 2px */
        .gutenberg-card label[for="promptCreate"],
        .gutenberg-card label[for="promptModify"] {
            font-size: 14px;
        }

        .gutenberg-card .gutenberg-script {
            flex: 1 1 auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .gutenberg-card .gutenberg-actions {
            margin-top: -4px;
        }

        .timeline-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            flex: 1;
            min-height: 0;
        }

        .timeline-empty-state {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 24px;
            gap: 12px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 12px;
            border: 1px dashed var(--border-strong);
            color: var(--text);
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1;
        }

        .timeline-empty-state.visible {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .timeline-empty-text {
            margin: 0;
            font-size: 14px;
            color: var(--text);
        }

        .timeline-empty-link {
            font-weight: 600;
            color: var(--primary);
            text-decoration: none;
            border-bottom: 1px solid transparent;
        }

        .timeline-empty-link:hover,
        .timeline-empty-link:focus-visible {
            text-decoration: underline;
            border-bottom-color: rgba(42, 122, 87, 0.6);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        #timeline {
            position: relative;
            z-index: 0;
            background: var(--timeline-background);
            border-radius: 12px;
            height: 100%;
            padding: 6px;
        }

        .edit-tooltip {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 50%;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            background: rgba(15, 23, 42, 0.92);
            color: #fff;
            opacity: 0;
            transform: translate(-50%, -120%);
            white-space: nowrap;
            transition: opacity 0.1s ease;
            z-index: 3;
        }

        .edit-tooltip.visible {
            opacity: 1;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .header-buttons .btn {
            background: #ffffff;
            border-color: rgba(15, 23, 42, 0.08);
            color: #0f172a;
            padding: 0 16px;
            min-height: 36px;
            border-radius: 999px;
            font-size: 14px;
        }

        .header-actions .btn,
        .header-actions .info-button {
            background: #ffffff;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.08);
            padding: 0 10px;
            min-height: 32px;
            color: #0f172a;
            font-size: 12px;
            line-height: 32px;
        }

        .header-actions .btn:hover,
        .header-actions .info-button:hover,
        .header-actions .btn:focus-visible,
        .header-actions .info-button:focus-visible {
            box-shadow: 0 6px 18px rgba(42, 122, 87, 0.32);
        }

        .info-button {
            border-radius: 999px;
            border: 1px solid #ebe0d1;
            background: #fff;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
        }

        .menu-header {
            font-size: 14px;
            font-weight: 700;
        }

        .context-menu.share-menu {
            right: 0;
            left: auto;
            min-width: 260px;
        }

        .context-menu.share-menu .menu-panel {
            padding: 12px;
            gap: 8px;
        }

        .context-menu.share-menu button {
            border-radius: 10px;
        }

        .context-menu.share-menu button:hover,
        .context-menu.share-menu button:focus {
            border-radius: 10px;
        }

        .share-link-field {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #d0c3ad;
            padding: 8px;
            font-size: 13px;
            font-family: inherit;
            background: #fbf8f2;
        }

        .share-link-line {
            display: flex;
        }

        .share-menu-status {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .share-menu-status.error {
            color: #b00020;
        }

        .share-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
            gap: 6px;
        }

        .share-actions .menu-panel-btn {
            width: 100%;
        }

        .share-actions .menu-panel-btn.primary {
            border: none;
            background: var(--primary);
            color: #fff;
        }

        #fileMenu .menu-panel {
            padding: 0;
            gap: 0;
        }

        .info-popup {
            position: absolute;
            top: 56px;
            right: 12px;
            width: 280px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: none;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            z-index: 60;
        }

        .info-popup.open {
            display: flex;
        }

        .info-popup img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            align-self: center;
        }

        .info-popup button {
            border-radius: 8px;
            border: 1px solid rgba(15, 23, 42, 0.15);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            min-width: 110px;
        }

        .info-popup button.secondary {
            background: #fff;
            border: 1px solid rgba(15, 23, 42, 0.15);
            color: var(--text);
        }

        .info-popup button.update-btn {
            background: #2a7a57;
            border-color: #2a7a57;
            color: #fff;
        }

        .info-actions {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tour-overlay {
            position: fixed;
            inset: 0;
            background: transparent;
            display: none;
            z-index: 120;
            pointer-events: auto;
        }

        .tour-overlay.visible {
            display: block;
        }

        .tour-overlay.dimmed {
            background: rgba(15, 15, 15, 0.65);
        }

        .tour-highlight {
            position: absolute;
            border: 2px solid #2a7a57;
            border-radius: 12px;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(15, 15, 15, 0.65);
            transition: all 0.25s ease;
            pointer-events: none;
        }

        .tour-highlight.hidden {
            opacity: 0;
        }

        .tour-panel {
            position: absolute;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%);
            max-width: 460px;
            width: calc(100% - 40px);
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.35);
            color: #1f1f1f;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tour-panel h4 {
            margin: 0;
            font-size: 18px;
        }

        .tour-panel p {
            margin: 0;
            line-height: 1.4;
        }

        .tour-step-counter {
            font-size: 11px;
            color: #918b7f;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .tour-step-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .tour-panel button {
            border-radius: 8px;
            border: 1px solid var(--border);
            background: #fff;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 13px;
        }

        .tour-panel button.primary {
            border: none;
            background: #2a7a57;
            color: #fff;
        }

        .tour-panel button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tour-skip {
            position: absolute;
            top: 12px;
            right: 12px;
            border: none;
            background: rgba(255, 255, 255, 0.12);
            color: #fff;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
        }

        .menu-panel-btn {
            border-radius: 0;
            background: transparent;
            text-align: left;
            padding: 8px 12px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            border: none;
            transition: background 0.2s ease;
        }

        .menu-panel-btn:hover {
            background: rgba(42, 122, 87, 0.08);
        }

        .header-actions {
            display: flex;
            flex-direction: row;
            gap: 8px;
            max-width: 800px;
            width: 100%;
            justify-content: flex-end;
            align-items: flex-start;
        }

        .tabs-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            flex-wrap: wrap;
        }

        .header-actions .header-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }

        .ia-key-row label {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
            color: var(--muted);
        }

        .ia-key-row input {
            width: 100%;
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 10px 12px;
            font-size: 13px;
            background: var(--surface-soft);
            color: var(--text);
            font-family: inherit;
        }

        .header-actions .header-row label,
        .header-actions .header-row textarea,
        .header-actions .header-row select,
        .header-actions .header-row button {
            width: 100%;
        }

        .ia-prompt-fields {
            width: 100%;
            position: relative;
        }

        .ia-prompt-field {
            display: block;
            width: 100%;
            max-height: none;
        }

        .ia-actions-footer {
            display: flex;
            justify-content: flex-end;
            margin-top: 8px;
            gap: 8px;
        }

        .ia-template-footer {
            justify-content: flex-start;
        }

        .header-actions textarea {
            max-height: 30px;
            font-size: 14px;
        }

        .header-actions button {
            align-self: flex-end;
            background: #fff;
            border: 1px solid rgba(15, 23, 42, 0.2);
            color: #0f172a;
            box-shadow: none;
        }

        .menu-trigger {
            position: relative;
            display: inline-flex;
        }

        .context-menu {
            position: absolute;
            top: calc(100% + 6px);
            right: 0;
            background: var(--surface);
            border: 1px solid rgba(15, 23, 42, 0.1);
            border-radius: 16px;
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.2);
            display: none;
            min-width: 220px;
            z-index: 40;
        }

        .context-menu.open {
            display: block;
        }

        .menu-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }

        .context-menu label,
        .context-menu button {
            font-size: 13px;
            color: var(--text);
        }

        .toast {
            position: fixed;
            bottom: 18px;
            right: 18px;
            background: rgba(15, 23, 42, 0.92);
            color: #fff;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 13px;
            box-shadow: 0 8px 18px rgba(15, 23, 42, 0.3);
            pointer-events: none;
            opacity: 0;
            transform: translateY(12px);
            transition: opacity 0.25s ease, transform 0.25s ease;
            z-index: 90;
        }

        .toast.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
            z-index: 60;
        }

        .modal-overlay.open {
            display: flex;
        }

        .filter-modal {
            background: var(--surface);
            border-radius: 18px;
            padding: 16px 18px 20px;
            width: min(800px, 100%);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.25);
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: relative;
        }

        .filter-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 0px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .filter-modal h3 {
            margin: 0;
            font-size: 15px;
        }

        /* Promptzilla card grid */
        .promptzilla-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 8px 0 0 0;
        }

        .promptzilla-card {
            background: var(--surface-soft);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid var(--border-strong);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 84px;
        }

        .promptzilla-card:hover {
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }

        .promptzilla-card.selected {
            border: 2px solid #2a7a57;
            box-shadow: 0 10px 30px rgba(42, 122, 87, 0.12);
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            color: var(--muted);
        }

        .color-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
            z-index: 90;
            opacity: 0;
            pointer-events: none;
            transition: opacity 140ms ease;
        }

        .color-modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .color-modal {
            background: var(--surface);
            border-radius: 18px;
            width: min(520px, 100%);
            max-height: min(90vh, 600px);
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 18px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.3);
        }

        .color-modal .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.3);
        }

        .color-modal h3 {
            margin: 0;
            font-size: 15px;
        }

        .color-modal .modal-close {
            font-size: 20px;
            color: var(--muted);
        }

        .color-modal-body {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .color-types {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 320px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .color-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .color-row-label {
            flex: 1;
        }

        .color-row-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .color-row-label-input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 13px;
            background: transparent;
            color: inherit;
            transition: border-color 120ms ease;
            cursor: pointer;
        }

        .color-row-label-input:focus {
            outline: none;
            border-color: var(--muted);
            cursor: text;
        }

        .color-row-label-input:not(:read-only) {
            cursor: text;
        }

        .color-row-label-input:disabled {
            opacity: 0.65;
            cursor: not-allowed;
        }



        .color-row-controls input[type="color"] {
            width: 38px;
            height: 38px;
            border: none;
            padding: 0;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
        }

        .color-row-controls input[type="text"] {
            width: 90px;
            border-radius: 10px;
            border: 1px solid var(--border-strong);
            padding: 6px 8px;
            font-size: 12px;
            text-transform: lowercase;
        }

        .color-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 8px;
        }

        .type-selector {
            border-radius: 0px;
            border-left: 1px solid rgba(15, 23, 42, 0.15);
            background: transparent;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            font-size: 11px;
        }

        .type-selector-icon {
            font-size: 12px;
            line-height: 1;
        }

        .type-selector select {
            border: none;
            background: transparent;
            font-size: 12px;
            padding: 0;
            min-width: 120px;
            font-weight: 600;
            font-family: inherit;
            color: var(--text);
            cursor: pointer;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            text-transform: capitalize;
        }

        .type-selector select:disabled {
            opacity: 0.6;
        }

        .type-selector.disabled .type-selector-icon {
            color: rgba(15, 23, 42, 0.45);
        }

        .toolbar .item-actions {
            margin-left: auto;
        }

        .btn-group {
            display: inline-flex;
            border-radius: 999px;
            border: 1px solid var(--border);
            background: var(--surface-soft);
            overflow: hidden;
        }

        .header-buttons .type-filter-panel {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            min-width: 220px;
        }

        .type-filter-panel {
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .type-filter-option {
            position: relative;
            display: inline-flex;
            align-items: center;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            transition: border-color 0.2s ease;
            overflow: hidden;
            background: #ffffff;
        }

        .type-filter-option input {
            position: absolute;
            inset: 0;
            opacity: 0;
            margin: 0;
            cursor: pointer;
        }

        .type-filter-option .type-filter-label {
            font-size: 12px;
            white-space: nowrap;
            text-transform: capitalize;
            letter-spacing: 0.02em;
        }

        .type-filter-option.active {
            transform: none;
            box-shadow: none;
        }

        .btn-small {
            border: none;
            background: transparent;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: background 120ms ease, color 120ms ease;
        }

        .btn-small:hover {
            background: var(--primary-soft);
        }

        .btn-small-active {
            background: var(--primary-soft);
            color: var(--primary-strong);
        }

        .btn-small:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* vis.js styling */
        .vis-labelset .vis-label {
            font-size: var(--global-font-size);
            color: var(--muted);
            font-weight: 600;
        }


        .vis-item {
            border-radius: var(--radius-sm);
            border-width: 1px;
            font-size: var(--global-font-size);
            line-height: 1.1;
            padding-block: var(--vis-item-padding-vertical, 4px);
            padding-inline: var(--vis-item-padding-horizontal, 8px);
            cursor: pointer;
            background: #e5e7eb;
            border-color: #d1d5db;
            color: var(--text);
            transition:
                box-shadow 120ms ease,
                transform 80ms ease,
                background 120ms ease,
                border-color 120ms ease,
                color 120ms ease;
            white-space: normal;
            word-break: break-word;
            max-height: 50px;
            overflow: hidden;
        }

        #timeline .vis-labelset .vis-label {
            padding-block: var(--vis-group-label-padding-vertical, 4px);
            padding-inline: var(--vis-group-label-padding-horizontal, 10px);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #timeline .vis-body .vis-row {
            padding-block: var(--vis-row-padding-vertical, 6px);
            border-bottom: 1px solid rgba(15, 23, 42, 0.04);
        }

        #timeline .vis-body .vis-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }


        .vis-item:hover {
            background: #dbeafe;
            border-color: var(--primary);
        }

        .vis-item.vis-selected {
            border-width: 2px;
            border-style: solid;
            background: rgba(37, 99, 235, 0.14);
            border-color: var(--primary-strong);
            color: #111827;
        }

        .vis-item.milestone-class {
            background: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        .vis-drag-center {
            border-color: var(--primary-strong) !important;
        }

        .type-milestone {
            background: transparent;
            border: none;
            padding: 0;
            overflow: visible;
            min-width: 0;
        }

        .type-milestone .diamond {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            background: #fed7aa;
            border: 1px solid var(--milestone);
            transform: rotate(45deg);
            flex-shrink: 0;
        }

        .vis-item.vis-dot {
            border: none;
            background: transparent;
        }

        .vis-item.vis-dot::before {
            content: "";
            position: absolute;
            width: 10px;
            height: 10px;
            top: 50%;
            left: 50%;
            transform: translate(calc(-50% + 6px), -50%) rotate(45deg);
            border-radius: 0;
            background: var(--milestone-selected-background, rgba(37, 99, 235, 0.14));
            box-shadow: 0 0 0 1px transparent;

        }

        .vis-item.vis-dot {
            background: transparent;
            border: none;
            color: transparent;
            box-shadow: none;
            width: 0;
            height: 0;
            padding: 0;
            margin: 0;
        }

        .vis-item .vis-item-content {
            padding: 2px 2px 2px 4px;
        }

        .type-milestone .vis-item-content {
            padding-left: 18px;
            /* pull the box left to cover the dot */
        }



        .vis-item.type-milestone.vis-selected,
        .vis-item.milestone-class.vis-selected {
            border-width: 2px;
            background: transparent;
            border-color: var(--primary-strong);
            border-style: solid;
            border-radius: 4px;
        }

        #timeline.vis-timeline,
        #timeline.vis-timeline .vis-panel {
            border: var(--border-light) !important;
            box-shadow: none;
        }

        #timeline .vis-timeline {
            border: none !important;
            box-shadow: none !important;
        }

        /* Remove / soften group borders */
        .vis-major,
        .vis-panel {
            border: var(--border-light) !important;
            /* ou alors une ligne super douce : */
            /* border-bottom: 1px solid rgba(0,0,0,0.06) !important; */
        }

        /* Option : rendre la ligne de séparation ultra discrète */
        .vis-group-level-0 {
            border: var(--border-light) !important;
        }

        .vis-group:not(:last-child) {
            border-bottom: 1px dotted var(--border-light) !important;
        }


        .vis-time-axis .vis-text {
            font-size: var(--global-font-size);
            color: var(--muted);
            font-weight: 600;
            overflow: visible;
        }

        #timeline .vis-time-axis .vis-grid.vis-vertical {
            border-left: 1px dotted var(--border-light) !important;
        }

        #timeline .vis-time-axis .vis-grid.vis-major {
            border-left: 1px dotted var(--border-light) !important;
        }

        .vis-panel.vis-center,
        .vis-panel.vis-left {
            border-color: var(--border-light);
        }

        @media (max-width: 900px) {
            .app {
                grid-template-columns: 1fr;
            }

            .app-main {
                position: relative;
            }

            .gutenberg-card {
                display: flex;
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: min(360px, 90vw);
                max-width: 100%;
                flex: 0 0 auto;
                box-shadow: var(--shadow-soft);
                transform: translateX(110%);
                opacity: 0;
                pointer-events: none;
                visibility: hidden;
                z-index: 90;
            }

            .gutenberg-card.open {
                transform: translateX(0);
                opacity: 1;
                pointer-events: auto;
                visibility: visible;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="app-header">
            <div class="tabs-actions">
                <a class="app-home-link" href="index.html" title="Revenir à l'accueil">☍</a>
                <div class="nav-switch">
                    <button id="navSwitcherBtn" class="nav-switch-btn" type="button" aria-haspopup="true"
                        aria-expanded="false">⟴ Goal Digger ▾</button>
                    <div id="navSwitcherMenu" class="nav-switch-menu" role="menu">
                        <a class="nav-switch-link" href="robert.html" role="menuitem"> ¶ Petit Robert</a>
                        <a class="nav-switch-link" href="cardinal.html" role="menuitem">✶Le Cardinal</a>
                    </div>
                </div>

                <div class="tabs-wrapper">
                    <div id="viewTabs" class="tabs"></div>
                    <div class="tab-actions">
                        <button class="tab-btn-add" id="addViewBtn" type="button"
                            aria-label="Ajouter une vue">+</button>
                        <button class="tab-btn-delete" id="deleteViewBtn" type="button"
                            aria-label="Supprimer la vue active">×</button>
                    </div>
                </div>

                <!-- Promptzilla modal (6 choices) -->
                <div class="modal-overlay" id="promptzillaOverlay" role="dialog" aria-modal="true"
                    aria-labelledby="promptzillaTitle">
                    <div class="filter-modal promptzilla-modal" style="width: min(900px, 96vw);">
                        <div class="modal-header">
                            <h3 id="promptzillaTitle">⛶ Promptzilla</h3>
                            <button class="modal-close" id="promptzillaClose" type="button"
                                aria-label="Fermer Promptzilla">×</button>
                        </div>
                        <div class="promptzilla-grid" id="promptzillaList"
                            style="display:grid; grid-template-columns: repeat(3,1fr); gap:12px;">
                            <!-- cards rendered by JS -->
                        </div>
                        <div class="modal-footer" style="display:flex; justify-content:flex-end; gap:8px;">
                            <button id="promptzillaValidateBtn" class="btn">Valider</button>
                        </div>
                    </div>
                </div>

                <div class="header-actions">
                    <button class="btn" id="openPromptzillaBtn" aria-label="Ouvrir Promptzilla">⛶ Promptzilla</button>
                    <button class="btn" id="openContextModal" aria-label="Ouvrir Gutenberg">⸙ Gutenberg</button>
                    <button class="btn" id="openIaModal" aria-label="Ouvrir Soulgorithm">⌘ Soulgorithm</button>

                    <div class="menu-trigger">
                        <button class="btn" id="optionsBtn" aria-label="Hublot">◯ Hublot</button>
                        <div class="context-menu" id="optionsMenu">
                            <div class="menu-panel">
                                <label>
                                    Taille (px)
                                    <select id="fontSizeInput">
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                        <option value="12">12</option>
                                        <option value="13">13</option>
                                        <option value="14">14</option>
                                    </select>
                                </label>
                                <label>
                                    Fond
                                    <select id="backgroundSelector">
                                        <option value="#ffffff">Blanc</option>
                                        <option value="transparent" selected>Transparent</option>
                                    </select>
                                </label>
                                <label>
                                    Largeur
                                    <select id="widthSelect">
                                        <option value="full">Plein écran</option>
                                        <option value="16:9">16/9</option>
                                        <option value="4:3">4/3</option>
                                        <option value="a4">A4</option>
                                    </select>
                                </label>
                                <label>
                                    Espacement
                                    <select id="spacingSelect">
                                        <option value="dense">Compact</option>
                                        <option value="normal">Normal</option>
                                        <option value="comfortable">Confortable</option>
                                    </select>
                                </label>
                                <label>
                                    Quadrillage
                                    <select id="borderLightSelect">
                                        <option value="blanc">Blanc</option>
                                        <option value="clair">Clair</option>
                                        <option value="sombre">Sombre</option>
                                    </select>
                                </label>
                                <label>
                                    Afficher les durées
                                    <select id="itemDurationSelect">
                                        <option value="none">Masquer</option>
                                        <option value="days">Afficher (jours)</option>
                                        <option value="weeks">Afficher (semaines)</option>
                                    </select>
                                </label>
                                <label>
                                    Afficher les week-ends
                                    <select id="weekendVisibilitySelect">
                                        <option value="show">Oui</option>
                                        <option value="hide">Non</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="menu-trigger">
                        <button class="btn" id="fileMenuBtn" aria-label="Canal">⥂ Canal</button>
                        <div class="context-menu file-menu" id="fileMenu">
                            <div class="menu-panel" style="transform: translateX(10px);">
                                <button id="importJsonBtn" type="button" class="menu-panel-btn">⤷ Ouvrir
                                    Capsule</button>
                                <button id="exportJsonBtn" type="button" class="menu-panel-btn">⭳ Télécharger
                                    Capsule</button>
                                <button id="exportTextBtn" type="button" class="menu-panel-btn">¶ Texte</button>
                                <button id="exportImageBtn" type="button" class="menu-panel-btn">◩ Image</button>
                                <button id="exportExcelBtn" type="button" class="menu-panel-btn">▥ Excel</button>
                                <button id="aboutTimelineBtn" type="button" class="menu-panel-btn">⎉ Vaisseau</button>
                            </div>
                        </div>
                    </div>

                    <div class="menu-trigger">
                        <button id="shareBtn" class="info-button" type="button" aria-label="Partager"
                            title="Lien de la capsule">⧉ Capsule</button>
                        <div class="context-menu share-menu" id="shareMenu">
                            <div class="menu-panel">
                                <div class="menu-header">Lien de la capsule</div>
                                <div class="share-link-line">
                                    <input id="shareLinkField" class="share-link-field" type="text" readonly
                                        placeholder="Appuie sur Créer pour générer un lien privé.">
                                </div>
                                <div class="share-actions">
                                    <button id="shareUpdateBtn" type="button" class="menu-panel-btn">🔄️
                                        Actualiser</button>
                                    <button id="shareCreateBtn" type="button" class="menu-panel-btn primary">☍
                                        Créer</button>
                                </div>
                                <p class="share-menu-status" id="shareMenuStatus"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-main">
            <!-- TIMELINE + TOOLBAR -->
            <div class="timeline-card" data-spacing="dense" data-ratio="full">


                <div class="toolbar">
                    <div class="btn-group">
                        <button class="btn-small" id="btn-today">Aujourd'hui</button>
                    </div>

                    <div class="btn-group">
                        <button class="btn-small" id="btn-zoom-in">+</button>
                        <button class="btn-small" id="btn-fit">Auto</button>

                        <button class="btn-small" id="btn-zoom-out">−</button>
                    </div>

                    <div class="btn-group">
                        <button class="btn-small" id="btn-scale-day">Jour</button>

                        <button class="btn-small btn-small-active" id="btn-scale-week">Semaine</button>
                        <button class="btn-small" id="btn-scale-month">Mois</button>
                    </div>
                    <div class="btn-group item-actions">
                        <button class="btn-small" id="btn-rename-selected" aria-label="Renommer l’élément sélectionné">
                            ✎
                        </button>
                        <button class="btn-small" id="btn-delete-selected" aria-label="Supprimer l’élément sélectionné">
                            ×
                        </button>
                        <div class="type-selector" aria-label="Type d’action" role="group">
                            <span class="type-selector-icon" aria-hidden="true">#</span>
                            <select id="itemTypeSelect" aria-label="Changer le type d’action">
                                <option value="">Type d'action</option>
                            </select>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn-small" id="btn-add-milestone" aria-label="Ajouter un jalon">
                            + Repère
                        </button>
                        <button class="btn-small" id="btn-add-item" aria-label="Ajouter un élément">
                            + Action
                        </button>
                        <button class="btn-small" id="btn-add-type" aria-label="Ajouter un type">
                            + Type
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn-small" id="openColorPaletteBtn" aria-label="Gérer les types">⚙
                            Réglages</button>
                    </div>
                </div>
                <div class="timeline-header">
                    <div class="header-text">
                        <h1>Page 1</h1>
                    </div>
                    <div class="header-buttons">
                        <div class="type-filter-panel" id="typeFilterPanel" role="group" aria-label="Filtrer par type">
                        </div>
                    </div>
                </div>
                <div class="timeline-wrapper">
                    <div id="timeline"></div>
                    <div class="timeline-empty-state" id="timelineEmptyState" role="status" aria-live="polite">
                        <p class="timeline-empty-text">
                            Cette page est vide.
                        </p>
                        <a href="#openContextModal" role="button" class="timeline-empty-link" id="timelineEmptyAction">
                            ⌘ Renseigner le contexte
                        </a>
                    </div>
                </div>
            </div>

            <div class="gutenberg-card" id="contextModalOverlay" role="complementary"
                aria-labelledby="contextModalTitle" aria-hidden="true">

                <div class="ia-actions">
                    <div class="header-row ia-header-actions gutenberg-recette">
                        <div class="gutenberg-recette-header">
                            <label for="promptCreate">Récit</label>
                            <button class="btn btn-generate primary" id="btn-call">
                                <span>⌘ Générer</span>
                            </button>
                        </div>
                        <div class="ia-prompt-fields">
                            <textarea id="promptCreate" class="ia-prompt-field" rows="10"
                                placeholder="Décris ici ta vision idéale dans 3 à 24 mois : les attendus, les changements, les impacts concrets."></textarea>
                        </div>
                    </div>
                    <div class="header-row ia-header-actions gutenberg-script">
                        <label for="promptModify"
                            style="margin-top:0;display:block;font-size:13px;color:var(--muted)">Script</label>
                        <div class="ia-prompt-fields">
                            <textarea id="promptModify" class="ia-prompt-field" rows="20"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="iaModalOverlay" role="dialog" aria-modal="true" aria-labelledby="iaModalTitle">
            <div class="filter-modal">
                <div class="modal-header">
                    <h3 id="iaModalTitle">⌘ Promptzilla</h3>
                    <button class="modal-close" id="iaModalClose" type="button" aria-label="Fermer l'IA">×</button>
                </div>
                <div class="ia-actions">
                    <div class="header-row  ia-header-actions">
                        <label for="templateModeSelect">Narration</label>
                        <select id="templateModeSelect">
                            <option value="create">⌘ Libre</option>
                            <option value="modify">⌗ Structuré</option>
                        </select>
                    </div>
                    <div class="header-row ia-header-actions">
                        <label for="iaTemplateEditor">Prompt système</label>
                        <textarea id="iaTemplateEditor" rows="18"></textarea>
                    </div>
                    <div class="header-row ia-header-actions ia-key-row">
                        <label>
                            <a href="https://platform.openai.com/settings/organization/api-keys" target="_blank"
                                rel="noreferrer">OpenAI API key</a>
                            <input type="password" id="iaApiKeyInput" autocomplete="off" placeholder="sk-...">
                        </label>
                        <label>
                            <span>Vitesse</span>
                            <select id="reasoningEffortSelect"
                                style="border: 1px solid #d0c3ad; font-size: 13px; font-family: inherit; color: inherit;">
                                <option value="minimal">Éclair</option>
                                <option value="low" selected>Rapide</option>
                                <option value="medium">Fluide</option>
                                <option value="high">Turbo</option>
                            </select>
                        </label>
                    </div>
                    <div class="ia-actions-footer ia-template-footer">
                        <button class="btn white-btn" type="button" id="resetTemplatesBtn">↺ Réinitialiser</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="color-modal-overlay" id="colorModalOverlay" role="dialog" aria-modal="true"
            aria-labelledby="colorModalTitle">
            <div class="color-modal">
                <div class="modal-header">
                    <h3 id="colorModalTitle">Type</h3>
                    <button class="modal-close" id="colorModalClose" type="button"
                        aria-label="Fermer la palette">×</button>
                </div>
                <div class="color-modal-body">
                    <div class="color-types" id="colorTypeList"></div>
                </div>
                <div class="color-actions">
                    <button class="btn white-btn" type="button" id="randomizeColorsBtn">🌈 Random</button>
                    <button class="btn" type="button" id="saveColorPreferencesBtn">Valider</button>
                </div>
            </div>
        </div>

        <div id="timelineInfoPopup" class="info-popup" role="dialog" aria-live="polite">
            <img src="logo.gif" alt="Logo Go-Toolkit">
            <strong>Module Goal Digger</strong>
            <span>Version 2025.12.05</span>
            <span>Développé par Quang TRAN.</span>
            <span>Usage réservé à Savane Consulting.</span>
            <div class="info-actions">
                <button id="timelineUpdateBtn" type="button" class="update-btn">Mettre à jour</button>
                <button id="timelineTourReplayBtn" type="button" class="secondary">Tour guidé</button>
            </div>
        </div>

        <div id="timelineTourOverlay" class="tour-overlay" aria-hidden="true">
            <div class="tour-highlight hidden" aria-hidden="true"></div>
            <div class="tour-panel">
                <span class="tour-step-counter" id="timelineTourStepCounter"></span>
                <h4 id="timelineTourStepTitle"></h4>
                <p id="timelineTourStepDescription"></p>
                <div class="tour-step-footer">
                    <button id="timelineTourPrevBtn" type="button">Précédent</button>
                    <button id="timelineTourNextBtn" type="button" class="primary">Suivant</button>
                    <button id="timelineTourCloseBtn" type="button">Fermer</button>
                </div>
            </div>
            <button id="timelineTourSkipBtn" class="tour-skip" type="button">×</button>
        </div>

        <div id="copyToast" class="toast" aria-live="polite" aria-atomic="true"></div>

        <input type="file" id="importJsonInput" accept="application/json" style="display:none">
        <script>
            window.GO_TOOLKIT_SHARE_API_URL =
                window.GO_TOOLKIT_SHARE_API_URL || "https://share.gotoolkit.workers.dev/";
        </script>
        <script src="js/share-worker-client.js"></script>
        <script src="js/share-history.js"></script>
        <script src="js/openai-client.js"></script>
        <script>
            // ============================================================
            // 1. Schema JSON · planning-v1 (doc développeur)
            // ============================================================
            /*
                OpenAI doit renvoyer un objet de forme :
    
                {
                  "timeline": {          // optionnel
                    "start": "2025-01-01",
                    "end":   "2025-03-31"
                  },
                  "groups": [
                    { "id": "milestones", "label": "Jalons PI" },
                    { "id": "team-alpha", "label": "Team Alpha – Core Engine" },
                    ...
                  ],
                  "items": [
                    // jalon ponctuel
                    {
                      "id": "ms-1",
                      "groupId": "milestones",
                      "label": "System Demo 1",
                      "kind": "milestone",
                      "date": "2025-01-15"
                    },
                    // tâche avec début / fin
                    {
                      "id": "it-1",
                      "groupId": "team-alpha",
                      "label": "Feature X",
                      "kind": "feature",   // "feature" | "enabler" | "bug" | "other"
                      "start": "2025-01-05",
                      "end": "2025-02-02"
                    }
                  ]
                }
    
                → Ce fichier se charge de mapper ce JSON vers vis-timeline,
                  et permet aussi de réexporter le planning dans ce format.
            */

            // ============================================================
            // 2. Setup vis-timeline (groups + items)
            // ============================================================
            var DataSet = vis.DataSet;
            var Timeline = vis.Timeline;
            if (window.moment && typeof moment.locale === "function") {
                moment.locale("fr");
            }

            var container = document.getElementById("timeline");
            var timelineCard = document.querySelector(".timeline-card");
            var timelineWrapper = document.querySelector(".timeline-wrapper");
            var itemDurationSelect = document.getElementById("itemDurationSelect");
            var weekendVisibilitySelect = document.getElementById("weekendVisibilitySelect");
            var editTooltip = document.createElement("div");
            editTooltip.className = "edit-tooltip";
            if (timelineWrapper) {
                timelineWrapper.appendChild(editTooltip);
            }
            var lastPointerPosition = { x: null, y: null };
            if (timelineWrapper) {
                timelineWrapper.addEventListener("mousemove", function (event) {
                    lastPointerPosition.x = event.clientX;
                    lastPointerPosition.y = event.clientY;
                    if (editTooltip.classList.contains("visible")) {
                        positionEditTooltip(event.clientX, event.clientY);
                    }
                });
            }

            var groups = new DataSet();
            var items = new DataSet();
            function handleDataMutation() {
                persistCurrentPlanning();
                updateEmptyViewMessage();
            }
            items.on("add", handleDataMutation);
            items.on("update", handleDataMutation);
            items.on("remove", handleDataMutation);
            groups.on("add", handleDataMutation);
            groups.on("update", handleDataMutation);
            groups.on("remove", handleDataMutation);
            var itemsView = new vis.DataView(items, {
                filter: function (item) {
                    return matchesFilters(item, filterState);
                }
            });

            var now = new Date();
            var oneDay = 24 * 60 * 60 * 1000;
            var oneWeek = 7 * oneDay;
            var snapMode = "week";
            var currentScaleMode = "week";
            var typeDefinitions = {};
            var filterState = { kinds: {} };
            var typeFilterPanel = document.getElementById("typeFilterPanel");
            var itemTypeSelect = document.getElementById("itemTypeSelect");
            var btnAddType = document.getElementById("btn-add-type");
            var typeSelectorControl = document.querySelector(".type-selector");
            var timeline = null;
            var emptyStateElement = document.getElementById("timelineEmptyState");
            var emptyStateAction = document.getElementById("timelineEmptyAction");
            var emptyStateTextEl = document.querySelector(".timeline-empty-text");
            var defaultEmptyText = emptyStateTextEl ? emptyStateTextEl.textContent.trim() : "";
            var defaultEmptyLinkText = emptyStateAction ? emptyStateAction.textContent.trim() : "";
            var OPENAI_PROXY_URL = "https://openai.gotoolkit.workers.dev/v1/responses";
            var OPENAI_MODEL = "gpt-5-nano";
            var OPENAI_TEMPERATURE = 1;
            var LOCAL_STORAGE_KEY = "timeline-planning-state";
            var typeStyleElement = document.createElement("style");
            typeStyleElement.id = "timeline-type-styles";
            document.head.appendChild(typeStyleElement);
            var persistenceLocked = false;
            var persistedTimelineBrief = "";
            var contextUiReady = false;
            var lastTimelineGenerationAt = 0;
            var AUTO_CONTEXT_SUPPRESSION_MS = 15000;
            var shouldOpenContextOnFirstLoad = false;
            var DEFAULT_CONTEXT_STATE = {
                prompts: {
                    create: "",
                    modify: null
                }
            };
            var customSystemTemplates = {
                create: "",
                modify: ""
            };
            var allowedBackgroundValues = ["transparent", "#ffffff"];
            function deepClone(value) {
                if (value === undefined || value === null) return value;
                return JSON.parse(JSON.stringify(value));
            }
            function matchesFilters(item, state) {
                if (!item || !state) return true;
                var kind = sanitizeTypeId(item.kind || item.type || "");
                if (!kind) return true;
                return state.kinds[kind] !== false;
            }
            function ensureKindFilter(kind) {
                if (!kind) return;
                if (!Object.prototype.hasOwnProperty.call(filterState.kinds, kind)) {
                    filterState.kinds[kind] = true;
                }
            }
            var DEMO_STATE = {
                views: [],
                displayPreferences: null
            };
            function sanitizeTypeId(raw) {
                var id = (raw || "").toLowerCase().trim();
                if (!id) return "feature";
                return id.replace(/[^a-z0-9_-]/g, "-");
            }

            function hslToHex(h, s, l) {
                var hue = ((h % 360) + 360) % 360;
                var sat = Math.max(0, Math.min(100, s)) / 100;
                var light = Math.max(0, Math.min(100, l)) / 100;
                var c = (1 - Math.abs(2 * light - 1)) * sat;
                var x = c * (1 - Math.abs(((hue / 60) % 2) - 1));
                var m = light - c / 2;
                var r = 0;
                var g = 0;
                var b = 0;
                if (hue < 60) {
                    r = c;
                    g = x;
                } else if (hue < 120) {
                    r = x;
                    g = c;
                } else if (hue < 180) {
                    g = c;
                    b = x;
                } else if (hue < 240) {
                    g = x;
                    b = c;
                } else if (hue < 300) {
                    r = x;
                    b = c;
                } else {
                    r = c;
                    b = x;
                }
                var red = Math.round((r + m) * 255);
                var green = Math.round((g + m) * 255);
                var blue = Math.round((b + m) * 255);
                var toHex = function (value) {
                    var str = value.toString(16);
                    return str.length === 1 ? "0" + str : str;
                };
                return "#" + toHex(red) + toHex(green) + toHex(blue);
            }

            function clampColorValue(value) {
                if (typeof value !== "number" || isNaN(value)) {
                    return 0;
                }
                return Math.max(0, Math.min(255, Math.round(value)));
            }

            function parseRgbColor(value) {
                if (!value || typeof value !== "string") {
                    return null;
                }
                var input = value.trim().toLowerCase();
                if (!input || input === "transparent") {
                    return null;
                }
                var hexMatch = input.match(/^#([a-f0-9]{3}|[a-f0-9]{6})$/i);
                if (hexMatch) {
                    var hex = hexMatch[1];
                    if (hex.length === 3) {
                        return {
                            r: clampColorValue(parseInt(hex[0] + hex[0], 16)),
                            g: clampColorValue(parseInt(hex[1] + hex[1], 16)),
                            b: clampColorValue(parseInt(hex[2] + hex[2], 16)),
                            a: 1
                        };
                    }
                    return {
                        r: clampColorValue(parseInt(hex.slice(0, 2), 16)),
                        g: clampColorValue(parseInt(hex.slice(2, 4), 16)),
                        b: clampColorValue(parseInt(hex.slice(4, 6), 16)),
                        a: 1
                    };
                }
                var rgbMatch = input.match(/^rgba?\(([^)]+)\)$/);
                if (rgbMatch) {
                    var parts = rgbMatch[1].split(",").map(function (part) {
                        return part.trim();
                    });
                    if (parts.length < 3) {
                        return null;
                    }
                    var r = parseInt(parts[0], 10);
                    var g = parseInt(parts[1], 10);
                    var b = parseInt(parts[2], 10);
                    var alpha = parts.length === 4 ? parseFloat(parts[3]) : 1;
                    return {
                        r: clampColorValue(r),
                        g: clampColorValue(g),
                        b: clampColorValue(b),
                        a: Math.max(0, Math.min(1, isNaN(alpha) ? 1 : alpha))
                    };
                }
                return null;
            }

            function rgbaToCss(components) {
                if (!components) return null;
                if (components.a === undefined || components.a === null || components.a >= 1) {
                    return "rgb(" + components.r + ", " + components.g + ", " + components.b + ")";
                }
                return (
                    "rgba(" +
                    components.r +
                    ", " +
                    components.g +
                    ", " +
                    components.b +
                    ", " +
                    components.a +
                    ")"
                );
            }

            function getContrastingTextColor(value) {
                var parsed = parseRgbColor(value);
                if (!parsed) return null;
                var alpha = parsed.a === undefined || parsed.a === null ? 1 : parsed.a;
                if (alpha <= 0) {
                    return null;
                }
                if (alpha < 1) {
                    return "#0f172a";
                }
                var luminance = (parsed.r * 299 + parsed.g * 587 + parsed.b * 114) / 1000;
                return luminance >= 180 ? "#0f172a" : "#ffffff";
            }

            function getDarkerColor(source, amount) {
                var parsed = parseRgbColor(source);
                if (!parsed) return source;
                var factor = Math.max(0, Math.min(1, amount || 0));
                var darkened = {
                    r: clampColorValue(parsed.r * (1 - factor)),
                    g: clampColorValue(parsed.g * (1 - factor)),
                    b: clampColorValue(parsed.b * (1 - factor)),
                    a: parsed.a
                };
                return rgbaToCss(darkened) || source;
            }

            function updateTypeShades(def) {
                if (!def) return;
                var accentBase = def.background && def.background !== "transparent"
                    ? def.background
                    : def.color && def.color !== "transparent"
                        ? def.color
                        : def.border || "#0f172a";
                var borderSource = accentBase;
                var textSource = def.color && def.color !== "transparent" ? def.color : accentBase;
                def.darkBorder = getDarkerColor(borderSource, 0.28);
                def.darkText = getDarkerColor(textSource, 0.45);
                var contrastSource = accentBase;
                var contrastColor = getContrastingTextColor(contrastSource);
                def.contrastTextColor = contrastColor || def.darkText || def.color || "#0f172a";
            }

            function getRainbowColor() {
                var hue = Math.random() * 360;
                var saturation = 65 + Math.random() * 15;
                var lightness = 76 + Math.random() * 6;
                return hslToHex(hue, saturation, lightness);
            }

            function generateRainbowPalette(count) {
                var palette = [];
                var size = Math.max(1, count || 1);
                var baseHue = Math.random() * 360;
                var step = 360 / size;
                for (var i = 0; i < size; i++) {
                    var hue = (baseHue + i * step) % 360;
                    var saturation = 65 + Math.random() * 15;
                    var lightness = 76 + Math.random() * 6;
                    palette.push(hslToHex(hue, saturation, lightness));
                }
                return palette;
            }

            function normalizeHexColor(value) {
                if (!value || typeof value !== "string") return null;
                var trimmed = value.trim().toLowerCase();
                if (trimmed === "transparent") return "transparent";
                if (trimmed[0] !== "#") trimmed = "#" + trimmed;
                if (/^#([a-f0-9]{6})$/.test(trimmed)) {
                    return trimmed;
                }
                var shortMatch = trimmed.match(/^#([a-f0-9]{3})$/);
                if (shortMatch) {
                    return (
                        "#" +
                        shortMatch[1]
                            .split("")
                            .map(function (char) { return char + char; })
                            .join("")
                    );
                }
                return null;
            }

            function setPreviewColor(preview, color) {
                if (!preview) return;
                if (color === "transparent") {
                    preview.style.backgroundImage =
                        "repeating-linear-gradient(45deg, rgba(15, 23, 42, 0.08) 0 6px, transparent 6px 12px)";
                    preview.style.backgroundColor = "transparent";
                } else {
                    preview.style.backgroundImage = "none";
                    preview.style.backgroundColor = color;
                }
            }

            function rebuildTypeStyles() {
                var rules = Object.keys(typeDefinitions).map(function (key) {
                    var def = typeDefinitions[key];
                    var background = def.background;
                    if (key === "milestone") {
                        background = "transparent";
                    }
                    var effectiveBorder = def.darkBorder || def.border;
                    var effectiveColor = def.contrastTextColor || def.darkText || def.color;
                    var ruleLines = [
                        ".vis-item.type-" + def.id + " {",
                        "  background: " + background + ";",
                        // "  border-color: " + effectiveBorder + ";"
                    ];
                    if (key !== "milestone") {
                        ruleLines.push("  color: " + effectiveColor + ";");
                    }
                    ruleLines.push("}");
                    return ruleLines.join("\n");
                });
                var milestoneDef = typeDefinitions["milestone"];
                if (milestoneDef) {
                    var highlightBackground = milestoneDef.background || "var(--primary-color)";
                    var highlightBorder = milestoneDef.border || "var(--primary-color)";
                    var milestoneRule = [
                        ":root {",
                        "  --milestone-selected-background: " + highlightBackground + ";",
                        "  --milestone-selected-border: " + highlightBorder + ";",
                        "}"
                    ].join("\n");
                    rules.push(milestoneRule);
                    rules.push([
                        ".vis-item.type-milestone .vis-item-content {",
                        "  color: var(--text);",
                        "}"
                    ].join("\n"));
                }
                typeStyleElement.textContent = rules.join("\n");
            }

            function ensureTypeDefinition(def) {
                var base = def || {};
                var id = sanitizeTypeId(base.id || base.name || base.kind);
                var colors = def && def.colors ? def.colors : {};
                var existing = typeDefinitions[id] || {};
                var background =
                    colors.background || base.background || existing.background || getRainbowColor();
                var border = colors.border || base.border || existing.border || "var(--primary-color)";
                var textColor = colors.text || base.color || existing.color || "#111827";
                var label = base.label || base.name || existing.label || id;
                var entry = {
                    id: id,
                    label: label,
                    background: background,
                    border: border,
                    color: textColor
                };
                updateTypeShades(entry);
                typeDefinitions[id] = entry;
                ensureKindFilter(id);
                rebuildTypeStyles();
                return id;
            }

            function applyTypeDefinitions(defs) {
                if (!Array.isArray(defs)) return;
                defs.forEach(function (def) {
                    ensureTypeDefinition({
                        id: def.id,
                        label: def.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    });
                });
            }

            function snapshotTypeDefinitions() {
                return Object.keys(typeDefinitions)
                    .map(function (key) {
                        var def = typeDefinitions[key];
                        if (!def) return null;
                        return {
                            id: def.id,
                            label: def.label,
                            background: def.background,
                            border: def.border,
                            color: def.color
                        };
                    })
                    .filter(Boolean);
            }

            function buildTimelineStatePayload() {
                return {
                    views: views.map(function (view) {
                        return {
                            name: view.name,
                            title: view.title,
                            planning: view.planning,
                            context: normalizeContextState(view.context)
                        };
                    }),
                    displayPreferences: Object.assign({}, displayPreferences),
                    types: snapshotTypeDefinitions(),
                    templates: {
                        create: customSystemTemplates.create,
                        modify: customSystemTemplates.modify
                    },
                    brief: getTimelineBrief()
                };
            }

            function getTimelineBrief() {
                var context = getActiveViewContext();
                if (context && context.prompts) {
                    var prompt = context.prompts.create || context.prompts.modify;
                    if (typeof prompt === "string") {
                        return prompt;
                    }
                }
                if (typeof txtPromptCreate !== "undefined" && txtPromptCreate && typeof txtPromptCreate.value === "string") {
                    return txtPromptCreate.value;
                }
                return persistedTimelineBrief || "";
            }

            function persistTimelineState() {
                try {
                    var payload = buildTimelineStatePayload();
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(payload));
                    if (currentShareToken) {
                        writeShareDraft(currentShareToken, payload, new Date().toISOString());
                    }
                } catch (err) {
                    console.warn("Impossible de sauvegarder le planning", err);
                }
            }

            function loadPersistedTimelineState() {
                try {
                    var raw = localStorage.getItem(LOCAL_STORAGE_KEY);
                    if (!raw) return null;
                    var parsed = JSON.parse(raw);
                    if (parsed && typeof parsed.brief === "string") {
                        persistedTimelineBrief = parsed.brief;
                    } else {
                        persistedTimelineBrief = "";
                    }
                    return parsed;
                } catch (err) {
                    console.warn("Impossible de lire le planning sauvegardé", err);
                    persistedTimelineBrief = "";
                    return null;
                }
            }

            var views = [];
            var activeViewIndex = 0;
            var displayPreferences = {
                font: "Inter",
                fontSize: 14,
                background: "transparent",
                ratio: "full",
                itemDurationMode: "days",
                spacing: "dense",
                hideWeekends: true
                , borderLightMode: DEFAULT_BORDER_LIGHT_MODE
            };
            var colorModalState = {
                types: {},
                labels: {},
                timeline: displayPreferences.background || "#ffffff"
            };

            function cloneDefaultContext() {
                return deepClone(DEFAULT_CONTEXT_STATE);
            }

            function normalizeContextState(context) {
                var base = context && typeof context === "object"
                    ? deepClone(context)
                    : cloneDefaultContext();
                if (!base.prompts || typeof base.prompts !== "object") {
                    base.prompts = { create: "", modify: null };
                }
                base.prompts.create = typeof base.prompts.create === "string" ? base.prompts.create : "";
                base.prompts.modify = typeof base.prompts.modify === "string" ? base.prompts.modify : null;
                return base;
            }

            function ensureViewContext(view) {
                if (!view) return cloneDefaultContext();
                view.context = normalizeContextState(view.context);
                return view.context;
            }

            function getActiveViewContext() {
                var view = views[activeViewIndex];
                if (!view) return cloneDefaultContext();
                return ensureViewContext(view);
            }
            function padTwoDigits(value) {
                return value < 10 ? "0" + value : "" + value;
            }

            function formatHiddenWeekDate(date) {
                return (
                    date.getFullYear() +
                    "-" +
                    padTwoDigits(date.getMonth() + 1) +
                    "-" +
                    padTwoDigits(date.getDate()) +
                    " " +
                    padTwoDigits(date.getHours()) +
                    ":" +
                    padTwoDigits(date.getMinutes()) +
                    ":" +
                    padTwoDigits(date.getSeconds())
                );
            }

            function buildWeekendHiddenDates() {
                if (!displayPreferences.hideWeekends) {
                    return [];
                }
                var saturday = new Date();
                var day = saturday.getDay();
                var offsetToSaturday = (6 - day + 7) % 7;
                saturday.setDate(saturday.getDate() + offsetToSaturday);
                saturday.setHours(0, 0, 0, 0);
                var monday = new Date(saturday);
                monday.setDate(monday.getDate() + 2);
                return [
                    {
                        start: formatHiddenWeekDate(saturday),
                        end: formatHiddenWeekDate(monday),
                        repeat: "weekly"
                    }
                ];
            }
            var persistedState = loadPersistedTimelineState();
            shouldOpenContextOnFirstLoad = !persistedState;
            if (persistedState) {
                if (Array.isArray(persistedState.views) && persistedState.views.length) {
                    views = persistedState.views.map(function (view, index) {
                        return {
                            name: view.name || view.title || ("Page " + (index + 1)),
                            title: view.title || view.name || ("Page " + (index + 1)),
                            planning: view.planning || null,
                            context: normalizeContextState(view.context)
                        };
                    });
                } else if (persistedState.groups) {
                    var defaultLabel = persistedState.label || persistedState.name || "Page 1";
                    views = [{
                        name: defaultLabel,
                        title: defaultLabel,
                        planning: persistedState,
                        context: cloneDefaultContext()
                    }];
                }
                if (persistedState.displayPreferences) {
                    Object.assign(displayPreferences, persistedState.displayPreferences);
                }
                if (Array.isArray(persistedState.types)) {
                    applyTypeDefinitions(persistedState.types);
                }
                if (persistedState.templates) {
                    if (typeof persistedState.templates.create === "string") {
                        customSystemTemplates.create = persistedState.templates.create;
                    }
                    if (typeof persistedState.templates.modify === "string") {
                        customSystemTemplates.modify = persistedState.templates.modify;
                    }
                }
            } else {
                if (Array.isArray(DEMO_STATE.views) && DEMO_STATE.views.length) {
                    views = deepClone(DEMO_STATE.views);
                }
                if (DEMO_STATE.displayPreferences) {
                    var demoPrefs = deepClone(DEMO_STATE.displayPreferences);
                    demoPrefs.background = "#ffffff";
                    Object.assign(displayPreferences, demoPrefs);
                }
            }
            if (!views.length) {
                views = [{ name: "Page 1", title: "Page 1", planning: null, context: cloneDefaultContext() }];
            }
            views.forEach(ensureViewFilterState);
            views.forEach(ensureViewContext);
            if (persistedTimelineBrief && views.length) {
                var firstContext = ensureViewContext(views[0]);
                if (!firstContext.prompts.create) {
                    firstContext.prompts.create = persistedTimelineBrief;
                }
            }

            function persistCurrentPlanning() {
                if (persistenceLocked) return;
                if (!views[activeViewIndex]) return;
                views[activeViewIndex].planning = exportPlanningToJson();
                persistTimelineState();
            }

            function updateEmptyViewMessage() {
                if (!emptyStateElement || !items || typeof items.get !== "function") return;
                var isEmpty = items.get().length === 0;
                emptyStateElement.classList.toggle("visible", isEmpty);
                emptyStateElement.setAttribute("aria-hidden", isEmpty ? "false" : "true");
            }

            function setEmptyStateLoading(isLoading, counter) {
                if (!emptyStateTextEl) return;
                if (isLoading) {
                    var label = "⏳ Attente" + (typeof counter === "number" ? " " + counter + "s" : "");
                    emptyStateTextEl.textContent = label;
                    if (emptyStateAction) {
                        emptyStateAction.style.display = "none";
                    }
                } else {
                    emptyStateTextEl.textContent = defaultEmptyText;
                    if (emptyStateAction) {
                        emptyStateAction.textContent = defaultEmptyLinkText;
                        emptyStateAction.style.display = "";
                    }
                }
            }

            function syncContextUIForActiveView() {
                syncContextFieldsFromState({ refreshModify: true, skipPersist: true });
            }

            function maybeAutoOpenContextModal() {
                if (!contextUiReady) return;
                if (!contextModalOverlay) return;
                if (contextModalOverlay.classList.contains("open")) return;
                if (hasTimelineData()) return;
                if (lastTimelineGenerationAt && Date.now() - lastTimelineGenerationAt < AUTO_CONTEXT_SUPPRESSION_MS) return;
                openContextModal();
            }

            function getActiveTypeIds() {
                return Object.keys(filterState.kinds).filter(function (key) {
                    return !!filterState.kinds[key];
                });
            }

            function setKindEnabled(kind, enabled) {
                filterState.kinds[kind] = enabled;
                refreshTypeFilterUI(getVisibleViewTypeIds());
                updateTimelineFilter();
            }

            function refreshTypeFilterUI(typeIds) {
                if (!typeFilterPanel) return;
                typeFilterPanel.innerHTML = "";
                var usage = {};
                if (items && typeof items.get === "function") {
                    items.get().forEach(function (item) {
                        var kind = sanitizeTypeId(item.kind || item.type || "");
                        if (!kind) return;
                        usage[kind] = (usage[kind] || 0) + 1;
                    });
                }
                var orderedIds = getOrderedTypeIds(typeIds).filter(function (key) {
                    return usage[key] > 0;
                });

                if (!orderedIds.length) {
                    typeFilterPanel.style.display = "none";
                    return;
                }
                typeFilterPanel.style.display = "";

                orderedIds.forEach(function (key) {
                    var def = typeDefinitions[key];
                    if (!def) return;
                    ensureKindFilter(key);
                    var isActive = filterState.kinds[key] !== false;
                    var option = document.createElement("label");
                    option.className = "type-filter-option" + (isActive ? " active" : "");
                    var checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.checked = isActive;
                    checkbox.dataset.kind = key;
                    var baseColor = def.background && def.background !== "transparent"
                        ? def.background
                        : "rgba(15, 23, 42, 0.08)";
                    var backgroundColor = isActive ? baseColor : "#ffffff";
                    var typeBorderColor = def.darkBorder || def.border || "#fff";
                    var typeTextColor = def.contrastTextColor || def.darkText || def.color || "#0f172a";
                    var borderColor = isActive ? typeBorderColor : "rgba(15, 23, 42, 0.15)";
                    var textColor = isActive ? typeTextColor : "var(--text)";
                    option.style.background = backgroundColor;
                    option.style.borderColor = borderColor;
                    option.style.color = textColor;
                    var labelText = document.createElement("span");
                    labelText.className = "type-filter-label";
                    labelText.textContent = def.label || key;

                    checkbox.addEventListener("change", function () {
                        var enabled = checkbox.checked;
                        setKindEnabled(key, enabled);
                    });

                    option.appendChild(checkbox);
                    option.appendChild(labelText);
                    typeFilterPanel.appendChild(option);
                });
            }

            function updateTimelineFilter() {
                if (itemsView && typeof itemsView.refresh === "function") {
                    itemsView.refresh();
                }
                if (timeline && typeof timeline.redraw === "function") {
                    timeline.redraw();
                }
            }

            function normalizeToDay(value) {
                if (!value) return null;
                var clone = new Date(value);
                clone.setHours(0, 0, 0, 0);
                return clone;
            }

            function countDaysBetween(startDate, endDate, excludeWeekends) {
                var start = normalizeToDay(startDate);
                var end = normalizeToDay(endDate);
                if (!start || !end) return 0;
                if (start > end) {
                    var swap = start;
                    start = end;
                    end = swap;
                }
                var count = 0;
                var cursor = new Date(start);
                while (cursor <= end) {
                    var day = cursor.getDay();
                    if (!excludeWeekends || (day !== 0 && day !== 6)) {
                        count++;
                    }
                    cursor.setDate(cursor.getDate() + 1);
                }
                return count;
            }

            function getItemDurationInDays(item) {
                if (!item) return null;
                var start = toDate(item.start || item.date);
                if (!start) return null;
                var end = toDate(item.end || item.start || item.date) || start;
                var excludeWeekends = !!displayPreferences.hideWeekends;
                var totalDays = countDaysBetween(start, end, excludeWeekends);
                return totalDays || 1;
            }

            function formatItemDurationSuffix(item) {
                var days = getItemDurationInDays(item);
                if (!days) return null;
                var mode = displayPreferences.itemDurationMode || "none";
                if (mode === "weeks") {
                    var weeks = Math.max(1, Math.ceil(days / 7));
                    return "- " + weeks + " sem.";
                }
                return "- " + days + " j";
            }

            function appendDurationToContent(content, item) {
                var mode = displayPreferences.itemDurationMode || "none";
                if (mode === "none") return content || "";
                var suffix = formatItemDurationSuffix(item);
                if (!suffix) return content || "";
                var trimmed = (content || "").trim();
                return trimmed ? trimmed + " " + suffix : suffix;
            }

            function formatTooltipDate(value) {
                var date = toDate(value);
                if (!date) return "";
                var day = date.getDate();
                var month = date.getMonth() + 1;
                var paddedDay = day < 10 ? "0" + day : day;
                var paddedMonth = month < 10 ? "0" + month : month;
                return paddedDay + "/" + paddedMonth;
            }

            function buildTooltipText(item) {
                var startDate = formatTooltipDate(item.start || item.date);
                var endDate = formatTooltipDate(item.end || item.start || item.date);
                if (!startDate || !endDate) return null;
                var label = (item.content || item.label || "").trim();
                var days = getItemDurationInDays(item);
                var durationText = days ? " (" + days + " jours)" : "";
                var prefix = label ? label + " — " : "";
                return prefix + startDate + " → " + endDate + durationText;
            }

            function positionEditTooltip(clientX, clientY) {
                if (!timelineWrapper) return;
                var rect = timelineWrapper.getBoundingClientRect();
                var left = clientX - rect.left;
                var top = clientY - rect.top;
                left = Math.max(8, Math.min(rect.width - 8, left));
                top = Math.max(8, top - 20);
                editTooltip.style.left = left + "px";
                editTooltip.style.top = top + "px";
            }

            function positionEditTooltipAtRect(rect) {
                if (!timelineWrapper || !rect) return;
                var wrapperRect = timelineWrapper.getBoundingClientRect();
                var left = rect.left - wrapperRect.left + rect.width / 2;
                var top = rect.top - wrapperRect.top;
                left = Math.max(8, Math.min(wrapperRect.width - 8, left));
                top = Math.max(8, top - 20);
                editTooltip.style.left = left + "px";
                editTooltip.style.top = top + "px";
            }

            function getTimelineItemRect(itemId) {
                if (!timelineWrapper || !itemId) return null;
                var element = timelineWrapper.querySelector('.vis-item[data-id="' + itemId + '"]');
                return element ? element.getBoundingClientRect() : null;
            }

            function showEditTooltip(text, rect) {
                if (!editTooltip || !text) return;
                editTooltip.textContent = text;
                editTooltip.classList.add("visible");
                if (rect) {
                    positionEditTooltipAtRect(rect);
                } else if (lastPointerPosition.x !== null && lastPointerPosition.y !== null) {
                    positionEditTooltip(lastPointerPosition.x, lastPointerPosition.y);
                } else if (timelineWrapper) {
                    var wrapperRect = timelineWrapper.getBoundingClientRect();
                    editTooltip.style.left = wrapperRect.width / 2 + "px";
                    editTooltip.style.top = "10px";
                }
            }

            function hideEditTooltip() {
                if (!editTooltip) return;
                editTooltip.classList.remove("visible");
            }

            function normalizeItemAfterResize(item) {
                if (!item) return item;
                var previous = items.get(item.id) || {};
                var startDate = item.start ? new Date(item.start) : null;
                var endDate = item.end ? new Date(item.end) : null;
                var hasValidEnd = endDate && !isNaN(endDate.getTime());
                var hasValidStart = startDate && !isNaN(startDate.getTime());
                var durationMs = hasValidStart && hasValidEnd ? endDate.getTime() - startDate.getTime() : 0;
                var isMilestone = (previous.kind || item.kind) === "milestone";
                var epsilon = 5 * 60 * 1000; // 5 minutes to avoid jitter around the threshold
                var atOrBelowOneDay = hasValidStart && hasValidEnd && durationMs < (oneDay - epsilon);

                // Constrain non-milestone items resized to a single day into milestones.
                if (!isMilestone && atOrBelowOneDay) {
                    var milestoneDate = hasValidStart ? startDate : (previous.start ? new Date(previous.start) : new Date());
                    item.kind = "milestone";
                    item.type = "point";
                    item.className = "type-milestone milestone-class";
                    item.date = milestoneDate;
                    delete item.end;
                    delete item.start;
                    item.start = milestoneDate;
                    return item;
                }

                // Allow milestones stretched beyond one day to become regular items.
                var beyondOneDay = hasValidStart && hasValidEnd && durationMs > (oneDay + epsilon);
                if (isMilestone && beyondOneDay) {
                    var nextKind = getFirstNonMilestoneTypeId();
                    ensureTypeDefinition({ id: nextKind });
                    item.kind = nextKind;
                    item.type = undefined;
                    item.className = "type-" + nextKind;
                    item.end = endDate && endDate > startDate
                        ? endDate
                        : new Date(startDate.getTime() + oneDay);
                    return item;
                }

                return item;
            }

            var options = {
                stack: true,
                orientation: "top",
                groupHeightMode: "spacing",
                editable: {
                    add: true,
                    updateTime: true,
                    updateGroup: true,
                    remove: false
                },
                selectable: true,
                multiselect: false,
                margin: { item: 8, axis: 10 },
                locale: "fr",
                snap: function (date) {
                    var d = new Date(date);
                    if (snapMode === "day") {
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    if (snapMode === "month") {
                        d.setDate(1);
                        d.setHours(0, 0, 0, 0);
                        return d;
                    }
                    var day = d.getDay();
                    var diff = (day + 6) % 7;
                    d.setDate(d.getDate() - diff);
                    d.setHours(0, 0, 0, 0);
                    return d;
                },
                template: function (item) {
                    if (item.kind === "milestone") {
                        var text = (item.content || "").trim() || "Jalon";
                        return (
                            '<div class="ms-pill">' +
                            '<span class="diamond"></span>' +
                            "<span>" + text + "</span>" +
                            "</div>"
                        );
                    }
                    return appendDurationToContent(item.content || "", item);
                },
                timeAxis: {
                    scale: "week",
                    step: 1
                },
                hiddenDates: buildWeekendHiddenDates(),
                onMoving: function (item, callback) {
                    if (typeof callback === "function") {
                        callback(item);
                    }
                    var tooltipText = buildTooltipText(item);
                    if (tooltipText) {
                        showEditTooltip(tooltipText);
                    } else {
                        hideEditTooltip();
                    }
                },
                onMove: function (item, callback) {
                    item = normalizeItemAfterResize(item);
                    if (typeof callback === "function") {
                        callback(item);
                    }
                    hideEditTooltip();
                }
            };

            timeline = new Timeline(container, itemsView, groups, options);
            window.addEventListener("resize", function () {
                if (!timeline) return;
                var currentRange = timeline.getWindow();
            });

            var contextModalOverlay = document.getElementById("contextModalOverlay");
            var contextModalButton = document.getElementById("openContextModal");
            var iaModalOverlay = document.getElementById("iaModalOverlay");
            var iaModalButton = document.getElementById("openIaModal");
            var iaModalClose = document.getElementById("iaModalClose");

            function openContextModal(options) {
                ensureModifyPrompt({ refreshModify: true });
                if (contextModalOverlay) {
                    contextModalOverlay.classList.add("open");
                    contextModalOverlay.setAttribute("aria-hidden", "false");
                }
            }

            function closeContextModal() {
                if (contextModalOverlay) {
                    contextModalOverlay.classList.remove("open");
                    contextModalOverlay.setAttribute("aria-hidden", "true");
                }
            }

            function toggleContextModal(options) {
                if (!contextModalOverlay) return;
                if (contextModalOverlay.classList.contains("open")) {
                    closeContextModal();
                } else {
                    openContextModal(options);
                }
            }

            function openIaModal() {
                var defaultTemplateMode = "create";
                if (templateModeSelect) {
                    templateModeSelect.value = defaultTemplateMode;
                    syncTemplateEditor(defaultTemplateMode);
                }
                if (iaModalOverlay) iaModalOverlay.classList.add("open");
            }

            function closeIaModal() {
                if (iaModalOverlay) iaModalOverlay.classList.remove("open");
            }

            if (contextModalButton) {
                contextModalButton.addEventListener("click", function () {
                    toggleContextModal();
                });
            }
            if (iaModalButton) {
                iaModalButton.addEventListener("click", openIaModal);
            }
            if (iaModalClose) {
                iaModalClose.addEventListener("click", closeIaModal);
            }
            if (iaModalOverlay) {
                iaModalOverlay.addEventListener("click", function (event) {
                    if (event.target === iaModalOverlay) {
                        closeIaModal();
                    }
                });
            }
            if (emptyStateAction) {
                emptyStateAction.addEventListener("click", function (event) {
                    event.preventDefault();
                    openContextModal();
                    if (contextModalButton) {
                        contextModalButton.focus();
                    }
                });
            }

            /* Roadmap Promptzilla: 6 templates + selection/validate flow */
            var roadmapPromptzillaOverlay = document.getElementById("promptzillaOverlay");
            var roadmapPromptzillaList = document.getElementById("promptzillaList");
            var roadmapPromptzillaClose = document.getElementById("promptzillaClose");
            var roadmapPromptzillaValidate = document.getElementById("promptzillaValidateBtn");
            var openPromptzillaBtn = document.getElementById("openPromptzillaBtn");
            var selectedPromptzillaId = null;

            var ROADMAP_PROMPTZILLA = [

                {
                    "id": "product",
                    "title": "🎯 Roadmap Produit",
                    "text": "Génère une roadmap produit sur 6 mois avec 4 jalons majeurs (MVP, beta, release, amélioration), 3 acteurs (PO, UX, Dev), 3 domaines (fonctionnel, UX, data) et une timeline mensuelle. Inclure risques, dépendances et livrables clés",
                    "script": "Page : 🎯 Roadmap Produit\n\nÉléments :\n\nCadrage & définition MVP (PO, UX)\nDate: 2026-01-01 → 2026-01-31\nGroupe: MVP\nType: fonctionnel\n\nImplémentation MVP cœur de valeur (PO, Dev)\nDate: 2026-02-01 → 2026-02-29\nGroupe: MVP\nType: data\n\nGo/No-Go MVP et ouverture beta privée\nDate: 2026-03-01\nGroupe: Beta\nType: milestone\n\nItérations UX & analytics sur beta (UX, Dev)\nDate: 2026-03-02 → 2026-04-15\nGroupe: Beta\nType: UX\n\nRelease publique + communication produit\nDate: 2026-04-16 → 2026-05-15\nGroupe: Release\nType: fonctionnel\n\nAméliorations data & optimisation parcours\nDate: 2026-05-16 → 2026-06-30\nGroupe: Amélioration continue\nType: data\n\nRisque: dépendance forte à une équipe back\nDate: 2026-01-01 → 2026-06-30\nGroupe: Risques & dépendances\nType: risque\n\nLivrable clé: backlog roadmap 6 mois verrouillé\nDate: 2026-01-15\nGroupe: Livrables\nType: livrable"
                },
                {
                    "id": "tech",
                    "title": "🛠️ Roadmap Technique",
                    "text": "Crée une roadmap technique annuelle en 4 phases (audit, refonte, migration, optimisation), positionne les jalons trimestriels, les responsabilités (Tech Lead, Infra, SecOps) et les types d’initiatives (perf, sécurité, scalabilité) sur 1 an",
                    "script": "Page : 🛠️ Roadmap Technique\n\nÉléments :\n\nAudit architecture & dette technique (Tech Lead)\nDate: 2026-01-01 → 2026-03-31\nGroupe: Audit\nType: scalabilité\n\nJalon T1: restitution audit & priorisation\nDate: 2026-03-31\nGroupe: Jalons trimestriels\nType: milestone\n\nRefonte modules critiques (Tech Lead, Infra)\nDate: 2026-04-01 → 2026-06-30\nGroupe: Refonte\nType: perf\n\nJalon T2: validation perf & coût infra\nDate: 2026-06-30\nGroupe: Jalons trimestriels\nType: milestone\n\nMigration vers nouvelle stack/plateforme (Infra)\nDate: 2026-07-01 → 2026-09-30\nGroupe: Migration\nType: scalabilité\n\nJalon T3: bascule production contrôlée\nDate: 2026-09-30\nGroupe: Jalons trimestriels\nType: milestone\n\nDurcissement sécurité & observabilité (SecOps)\nDate: 2026-10-01 → 2026-12-15\nGroupe: Optimisation\nType: sécurité\n\nJalon T4: revue annuelle risques & SLA\nDate: 2026-12-15\nGroupe: Jalons trimestriels\nType: milestone"
                },
                {
                    "id": "sprint",
                    "title": "⚡Calendrier de sprints",
                    "text": "Propose une planification sur 4 sprints de 2 semaines avec objectifs, stories clés, critères de réussite, dépendances internes et rôles (Dev, QA, UX). Ajoute jalons de revue et rituels agiles.",
                    "script": "Page : ⚡Calendrier de sprints\n\nÉléments :\n\nSprint 1: cadrage fonctionnel & skeleton UI\nDate: 2026-01-05 → 2026-01-18\nGroupe: Sprint 1\nType: dev\n\nRevue & rétro Sprint 1 (PO, Dev, QA, UX)\nDate: 2026-01-19\nGroupe: Jalons de revue\nType: milestone\n\nSprint 2: flux principaux + premiers tests QA\nDate: 2026-01-20 → 2026-02-02\nGroupe: Sprint 2\nType: QA\n\nRevue & démo utilisateurs internes\nDate: 2026-02-03\nGroupe: Jalons de revue\nType: milestone\n\nSprint 3: optimisation UX & intégration data\nDate: 2026-02-04 → 2026-02-17\nGroupe: Sprint 3\nType: UX\n\nSprint 4: hardening, corrections & préparation release\nDate: 2026-02-18 → 2026-03-03\nGroupe: Sprint 4\nType: dev\n\nDépendance: disponibilité environnement de test commun\nDate: 2026-01-05 → 2026-03-03\nGroupe: Dépendances\nType: dépendance\n\nRituels agiles: dailies & planning poker\nDate: 2026-01-05 → 2026-03-03\nGroupe: Rituels\nType: rituel"
                },
                {
                    "id": "strategy",
                    "title": "💼 Vision stratégique",
                    "text": "Génère une vision stratégique en 3 horizons (H1/H2/H3) sur 24 mois, avec thèmes structurants, jalons annuels, domaines (produit, tech, business), impacts attendus et types d’investissements",
                    "script": "Page : 💼 Vision stratégique\n\nÉléments :\n\nH1: poser les fondations produit & tech\nDate: 2026-01-01 → 2026-06-30\nGroupe: H1\nType: produit\n\nH2: accélération croissance & scalabilité\nDate: 2026-07-01 → 2027-06-30\nGroupe: H2\nType: business\n\nH3: diversification offres & écosystème\nDate: 2027-07-01 → 2027-12-31\nGroupe: H3\nType: tech\n\nJalon annuel: revue stratégique année 1\nDate: 2026-12-15\nGroupe: Jalons annuels\nType: milestone\n\nJalon annuel: revue stratégique année 2\nDate: 2027-12-15\nGroupe: Jalons annuels\nType: milestone\n\nInvestissements: équipe produit/UX & discovery\nDate: 2026-01-01 → 2026-12-31\nGroupe: Investissements H1/H2\nType: investissement\n\nInvestissements: plateforme data & partenariats\nDate: 2027-01-01 → 2027-12-31\nGroupe: Investissements H2/H3\nType: investissement"
                },
                {
                    "id": "research",
                    "title": "🔎 Plan de recherche",
                    "text": "Construis un plan de recherche en phase discovery sur 6 mois : recherche utilisateur, cadrage problème, prototypage, test d’hypothèses, restitution. Mentionne acteurs (PO, UX, clients), jalons et décisions Go/No-Go.",
                    "script": "Page : 🔎 Plan de recherche\n\nÉléments :\n\nEntretiens exploratoires utilisateurs (PO, UX)\nDate: 2026-01-01 → 2026-02-15\nGroupe: Recherche utilisateur\nType: discovery\n\nCadrage problème & mapping opportunités\nDate: 2026-02-16 → 2026-03-15\nGroupe: Cadrage problème\nType: atelier\n\nPrototypage low-fi & scénarios clé\nDate: 2026-03-16 → 2026-04-15\nGroupe: Prototypage\nType: UX\n\nTests d’hypothèses avec clients pilotes\nDate: 2026-04-16 → 2026-05-31\nGroupe: Tests\nType: expérimentation\n\nRestitution & décision Go/No-Go\nDate: 2026-06-15\nGroupe: Décisions\nType: milestone\n\nJalon intermédiaire: partage insights mi-parcours\nDate: 2026-03-31\nGroupe: Jalons\nType: milestone"
                },
                {
                    "id": "project",
                    "title": "🧩 Projet d'intégration'",
                    "text": "Génére un projet d’intégration sur 4 mois avec phases (design, dev API, tests, déploiement), jalons critiques, interactions partenaires, risques liés aux environnements et validations métiers.",
                    "script": "Page : 🧩 Projet de réalisation\n\nÉléments :\n\nDesign détaillé & contrats d’interface\nDate: 2026-01-01 → 2026-01-31\nGroupe: Design\nType: fonctionnel\n\nDéveloppement API & intégrations partenaires\nDate: 2026-02-01 → 2026-03-15\nGroupe: Dev API\nType: tech\n\nJalon critique: environnement d’intégration stable\nDate: 2026-02-15\nGroupe: Jalons critiques\nType: milestone\n\nCampagne de tests end-to-end & non régression\nDate: 2026-03-16 → 2026-04-05\nGroupe: Tests\nType: QA\n\nDéploiement progressif & validation métier\nDate: 2026-04-06 → 2026-04-30\nGroupe: Déploiement\nType: métier\n\nRisque: instabilité environnements partenaires\nDate: 2026-02-01 → 2026-04-30\nGroupe: Risques\nType: risque"
                }
            ];



            function renderRoadmapPromptzilla() {
                if (!roadmapPromptzillaList) return;
                roadmapPromptzillaList.innerHTML = "";
                ROADMAP_PROMPTZILLA.forEach(function (tpl) {
                    var card = document.createElement("div");
                    card.className = "promptzilla-card";
                    card.setAttribute("role", "button");
                    card.dataset.id = tpl.id;
                    card.innerHTML = `<strong style="font-size:13px">${tpl.title}</strong><div style="font-size:12px;color:var(--muted);white-space:pre-wrap;word-break:break-word;margin-top:6px">${tpl.text}</div>`;
                    card.addEventListener("click", function () {
                        selectedPromptzillaId = tpl.id;
                        // update visuals
                        Array.from(roadmapPromptzillaList.children).forEach(function (c) { c.classList.remove("selected"); });
                        card.classList.add("selected");
                        // focus validate
                        if (roadmapPromptzillaValidate) roadmapPromptzillaValidate.focus();
                    });
                    roadmapPromptzillaList.appendChild(card);
                });
            }

            function openRoadmapPromptzilla() {
                if (!roadmapPromptzillaOverlay) return;
                renderRoadmapPromptzilla();
                selectedPromptzillaId = null;
                roadmapPromptzillaOverlay.classList.add("open");
            }

            function closeRoadmapPromptzilla() {
                if (!roadmapPromptzillaOverlay) return;
                roadmapPromptzillaOverlay.classList.remove("open");
            }

            if (openPromptzillaBtn) {
                openPromptzillaBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    openRoadmapPromptzilla();
                });
            }
            if (roadmapPromptzillaClose) roadmapPromptzillaClose.addEventListener("click", closeRoadmapPromptzilla);
            if (roadmapPromptzillaOverlay) {
                roadmapPromptzillaOverlay.addEventListener("click", function (ev) {
                    if (ev.target === roadmapPromptzillaOverlay) closeRoadmapPromptzilla();
                });
            }
            if (roadmapPromptzillaValidate) {
                roadmapPromptzillaValidate.addEventListener("click", function () {
                    if (!selectedPromptzillaId) return;
                    var tpl = ROADMAP_PROMPTZILLA.find(function (t) { return t.id === selectedPromptzillaId; });
                    if (tpl) {
                        var visionField = document.getElementById("promptCreate");
                        var scriptField = document.getElementById("promptModify");
                        if (visionField) {
                            visionField.value = tpl.text;
                        }
                        if (scriptField) {
                            scriptField.value = tpl.script || "";
                        }
                        // Persist into active view context so opening the Gutenberg modal won't overwrite values
                        if (typeof persistActiveContext === "function") {
                            persistActiveContext(function (ctx) {
                                ctx.prompts = ctx.prompts || {};
                                ctx.prompts.create = tpl.text || "";
                                ctx.prompts.modify = tpl.script || "";
                                ctx.mode = "create";
                            });
                        }
                        closeRoadmapPromptzilla();
                        // open Gutenberg/context modal in 'create' mode to avoid refresh-overwrite of modify
                        if (typeof openContextModal === "function") {
                            openContextModal({ mode: "create" });
                            // focus the vision textarea
                            setTimeout(function () {
                                var v = document.getElementById("promptCreate");
                                if (v) v.focus();
                            }, 200);
                        }
                    }
                });
            }

            var CREATE_SYSTEM_TEMPLATE = `Tu es un assistant product owner qui va générer une feuille de route produit à partir des instructions suivantes {{(contenu du id="prompt") }}
Réponds toujours avec un JSON qui contient :
- \`page\` : le titre de la page courante (utilisé pour le header).
- \`types\` : un tableau d’objets \`{ id, label}\` pour décrire des natures d'actions différentes entre 3 et 6 dont un type spécifique aux milestones.
- \`timeline\` : \`{ start, end }\` au format ISO (YYYY-MM-DD).
- \`groups\` : chaque groupe d'actions avec { id, label } entre 3 et 6 (ex : par équipe, thème, stream produit, enjeu, objectif.).
- \`items\` : chaque action ou livrable ou résultat avec { id, groupId, label, kind, start?, end?, date? }.
- Les livrables ou résultats sont convertis en \`kind: "milestone"\` avec juste la date de début.
- Décomposer en plusieurs actions, ceux qui ont plus de 21 jours
- Sors uniquement le JSON, sans explication ni texte additionnel. Utiliser des intitulés courtes.`;

            var MODIFY_SYSTEM_TEMPLATE = `Tu es un assistant product owner qui va générer une feuille de route produit à partir des instructions suivantes {{(contenu du id="prompt") }}
Réponds toujours avec un JSON qui contient :
- \`page\` : le titre de la page courante (utilisé pour le header).
- \`types\` : un tableau d’objets \`{ id, label}\` pour décrire des natures d'actions différentes entre 3 et 6 dont un type spécifique aux milestones.
- \`timeline\` : \`{ start, end }\` au format ISO (YYYY-MM-DD).
- \`groups\` : chaque groupe d'actions avec { id, label } entre 3 et 6 (ex : par équipe, thème, stream produit, enjeu, objectif.).
- \`items\` : chaque action ou livrable ou résultat avec { id, groupId, label, kind, start?, end?, date? }.
- Les livrables ou résultats sont convertis en \`kind: "milestone"\` avec juste la date de début.
- Décomposer en plusieurs actions, ceux qui ont plus de 21 jours
- Sors uniquement le JSON, sans explication ni texte additionnel. Utiliser des intitulés courtes.`;

            customSystemTemplates.create = customSystemTemplates.create || CREATE_SYSTEM_TEMPLATE;
            customSystemTemplates.modify = customSystemTemplates.modify || MODIFY_SYSTEM_TEMPLATE;

            var optionsBtn = document.getElementById("optionsBtn");
            var optionsMenu = document.getElementById("optionsMenu");
            var fontSizeInput = document.getElementById("fontSizeInput");
            var backgroundSelector = document.getElementById("backgroundSelector");
            var widthSelect = document.getElementById("widthSelect");
            var spacingSelect = document.getElementById("spacingSelect");
            var borderLightSelect = document.getElementById("borderLightSelect");
            var fileMenuBtn = document.getElementById("fileMenuBtn");
            var fileMenu = document.getElementById("fileMenu");
            var importJsonBtn = document.getElementById("importJsonBtn");
            var exportJsonBtn = document.getElementById("exportJsonBtn");
            var exportTextBtn = document.getElementById("exportTextBtn");
            var exportImageBtn = document.getElementById("exportImageBtn");
            var exportExcelBtn = document.getElementById("exportExcelBtn");
            var aboutTimelineBtn = document.getElementById("aboutTimelineBtn");
            var importJsonInput = document.getElementById("importJsonInput");
            var headerTitleElement = document.querySelector(".header-text h1");
            var infoPopup = document.getElementById("timelineInfoPopup");
            var timelineUpdateBtn = document.getElementById("timelineUpdateBtn");
            var copyToast = document.getElementById("copyToast");
            var copyToastTimer = null;
            var shareMenu = document.getElementById("shareMenu");
            var shareBtn = document.getElementById("shareBtn");
            var shareLinkField = document.getElementById("shareLinkField");
            var shareMenuStatus = document.getElementById("shareMenuStatus");
            var shareCreateBtn = document.getElementById("shareCreateBtn");
            var shareUpdateBtn = document.getElementById("shareUpdateBtn");
            var shareHistory = window.goToolkitShareHistory;
            var FIRESTORE_COLLECTION = "timelines";
            var SHARE_QUERY_PARAM = "share";
            var SHARE_WORKER_UNAVAILABLE_MESSAGE =
                "Le partage privé nécessite le worker Cloudflare lié à Go-Toolkit (go-toolkit-share).";
            var shareWorkerService = window.goToolkitShareWorker;
            var shareWorkerAvailable = Boolean(shareWorkerService && shareWorkerService.isReady);
            var currentShareToken = null;
            var shareLoadedFromRemote = false;
            var shareStatusMessage = "";
            var shareStatusType = "";
            var shareRequestInProgress = false;
            var shareLastUpdatedAt = null;

            function getShareDraftKey(token) {
                return LOCAL_STORAGE_KEY + "-share-" + token;
            }

            function readShareDraft(token) {
                if (!token || typeof window === "undefined" || !window.localStorage) return null;
                try {
                    var raw = localStorage.getItem(getShareDraftKey(token));
                    if (!raw) return null;
                    var parsed = JSON.parse(raw);
                    if (!parsed || typeof parsed !== "object") return null;
                    return parsed;
                } catch (err) {
                    console.warn("Impossible de lire le cache local de la capsule", err);
                    return null;
                }
            }

            function writeShareDraft(token, payload, updatedAt) {
                if (!token || typeof window === "undefined" || !window.localStorage) return;
                try {
                    var value = {
                        payload: payload,
                        updatedAt: updatedAt || new Date().toISOString()
                    };
                    localStorage.setItem(getShareDraftKey(token), JSON.stringify(value));
                } catch (err) {
                    console.warn("Impossible de sauvegarder le cache local de la capsule", err);
                }
            }

            function getRoadmapSharePreview() {
                var firstView = Array.isArray(views) && views.length ? views[0] : null;
                var title = (firstView && (firstView.title || firstView.name)) || "Planning";
                var desc = getTimelineBrief()
                    .split(/\r?\n/)
                    .map(function (line) { return line.trim(); })
                    .filter(Boolean)
                    .slice(0, 2)
                    .join(" · ");
                return {
                    title: title,
                    description: desc || "Complète le contexte pour l'afficher ici."
                };
            }

            function persistRoadmapShareRecord(token, updatedAt) {
                if (!shareHistory || !token) {
                    return;
                }
                try {
                    var preview = getRoadmapSharePreview();
                    shareHistory.upsertRecord("roadmap", {
                        token: token,
                        updatedAt: updatedAt || new Date().toISOString(),
                        title: preview.title,
                        description: preview.description
                    });
                } catch (err) {
                    console.warn("Impossible d'archiver le lien Go-Roadmap", err);
                }
            }
            var navSwitcherBtn = document.getElementById("navSwitcherBtn");
            var navSwitcherMenu = document.getElementById("navSwitcherMenu");
            var colorModalOverlay = document.getElementById("colorModalOverlay");
            var colorModalClose = document.getElementById("colorModalClose");
            var openColorPaletteBtn = document.getElementById("openColorPaletteBtn");
            var colorTypeList = document.getElementById("colorTypeList");
            var saveColorPreferencesBtn = document.getElementById("saveColorPreferencesBtn");
            var randomizeColorsBtn = document.getElementById("randomizeColorsBtn");
            var fontSizeChoices = [9, 10, 11, 12, 13, 14, 15, 16];
            var borderLightModes = {
                blanc: "#ffffff",
                clair: "var(--border)",
                sombre: "var(--border-strong)"
            };
            var DEFAULT_BORDER_LIGHT_MODE = "clair";

            function renderFontSizeOptions() {
                if (!fontSizeInput) return;
                fontSizeInput.innerHTML = "";
                fontSizeChoices.forEach(function (size) {
                    var option = document.createElement("option");
                    option.value = size;
                    option.textContent = size + " px";
                    option.style.fontSize = size + "px";
                    fontSizeInput.appendChild(option);
                });
                if (displayPreferences.fontSize) {
                    fontSizeInput.value = displayPreferences.fontSize;
                }
            }

            function closeContextMenus() {
                if (optionsMenu) optionsMenu.classList.remove("open");
                if (fileMenu) fileMenu.classList.remove("open");
                if (shareMenu) shareMenu.classList.remove("open");
            }

            if (optionsBtn && optionsMenu) {
                optionsBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    syncFontControls();
                    optionsMenu.classList.toggle("open");
                });
            }

            if (fileMenuBtn && fileMenu) {
                fileMenuBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    fileMenu.classList.toggle("open");
                });
            }

            if (shareBtn && shareMenu) {
                shareBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    shareMenu.classList.toggle("open");
                    updateShareMenuUI();
                });
            }

            document.addEventListener("click", function (event) {
                if (optionsMenu && !optionsMenu.contains(event.target) && optionsBtn !== event.target) {
                    optionsMenu.classList.remove("open");
                }
                if (fileMenu && !fileMenu.contains(event.target) && fileMenuBtn !== event.target) {
                    fileMenu.classList.remove("open");
                }
                if (shareMenu && !shareMenu.contains(event.target) && shareBtn !== event.target) {
                    shareMenu.classList.remove("open");
                }
            });

            function getOrderedTypeIds(typeIds) {
                var ids = Array.isArray(typeIds) ? typeIds : Object.keys(typeDefinitions);
                var unique = {};
                ids.forEach(function (id) {
                    if (id && typeDefinitions[id]) {
                        unique[id] = true;
                    }
                });
                var result = Object.keys(unique);
                return result.sort(function (a, b) {
                    var labelA = (typeDefinitions[a] && typeDefinitions[a].label) || a;
                    var labelB = (typeDefinitions[b] && typeDefinitions[b].label) || b;
                    return labelA.localeCompare(labelB);
                });
            }

            function getVisibleViewTypeIds() {
                var seen = {};
                Object.keys(typeDefinitions || {}).forEach(function (id) {
                    if (id) seen[id] = true;
                });
                if (items && typeof items.get === "function") {
                    items.get().forEach(function (item) {
                        var kind = sanitizeTypeId(item.kind || item.type || "");
                        if (kind) {
                            seen[kind] = true;
                        }
                    });
                }
                if (!seen["milestone"]) {
                    seen["milestone"] = true;
                }
                return Object.keys(seen);
            }

            function getFirstNonMilestoneTypeId() {
                var ordered = getOrderedTypeIds(Object.keys(typeDefinitions));
                for (var i = 0; i < ordered.length; i++) {
                    if (ordered[i] !== "milestone") {
                        return ordered[i];
                    }
                }
                return "feature";
            }

            function getFocusedItemKind() {
                if (!selectedItemId) return "";
                var focused = items.get(selectedItemId);
                if (!focused) return "";
                return sanitizeTypeId(focused.kind || focused.type || "");
            }

            function syncTypeSelectorDisabledState() {
                if (!typeSelectorControl || !itemTypeSelect) return;
                typeSelectorControl.classList.toggle("disabled", itemTypeSelect.disabled);
            }

            function renderTypeSwitcherOptions() {
                if (!itemTypeSelect) return;
                var focusedKind = getFocusedItemKind();
                var typeIds = getVisibleViewTypeIds();
                if (focusedKind && typeIds.indexOf(focusedKind) === -1) {
                    typeIds.push(focusedKind);
                }
                typeIds.forEach(function (typeId) {
                    if (!typeDefinitions[typeId]) {
                        ensureTypeDefinition({ id: typeId });
                    }
                });
                var orderedIds = getOrderedTypeIds(typeIds);
                itemTypeSelect.innerHTML = "";

                if (!orderedIds.length) {
                    var emptyOption = document.createElement("option");
                    emptyOption.value = "";
                    emptyOption.textContent = "Pas de type défini";
                    emptyOption.disabled = true;
                    emptyOption.selected = true;
                    itemTypeSelect.appendChild(emptyOption);
                    itemTypeSelect.disabled = true;
                    syncTypeSelectorDisabledState();
                    return;
                }

                if (!selectedItemId) {
                    var placeholder = document.createElement("option");
                    placeholder.value = "";
                    placeholder.textContent = "-";
                    placeholder.disabled = true;
                    placeholder.selected = true;
                    itemTypeSelect.appendChild(placeholder);
                }

                orderedIds.forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    var option = document.createElement("option");
                    option.value = def.id;
                    option.textContent = def.label || def.id;
                    itemTypeSelect.appendChild(option);
                });

                if (selectedItemId) {
                    var targetValue =
                        focusedKind && orderedIds.indexOf(focusedKind) !== -1
                            ? focusedKind
                            : orderedIds[0];
                    itemTypeSelect.value = targetValue;
                    itemTypeSelect.disabled = false;
                } else {
                    itemTypeSelect.disabled = true;
                }
                syncTypeSelectorDisabledState();
            }

            function applyTypeToSelectedItem(kindId) {
                if (!selectedItemId) return;
                var desiredKind = sanitizeTypeId(kindId);
                if (!desiredKind) return;
                var current = items.get(selectedItemId);
                if (!current) return;
                var currentKind = sanitizeTypeId(current.kind || current.type || "");
                if (currentKind === desiredKind) return;

                ensureTypeDefinition({ id: desiredKind });
                ensureKindFilter(desiredKind);

                var updatePayload = {
                    id: selectedItemId,
                    kind: desiredKind,
                    className:
                        desiredKind === "milestone"
                            ? "type-milestone milestone-class"
                            : "type-" + desiredKind,
                    type: desiredKind === "milestone" ? "point" : null
                };

                if (desiredKind === "milestone") {
                    updatePayload.end = null;
                    if (!current.start) {
                        updatePayload.start = getTimelineCenter();
                    }
                } else {
                    if (!current.start) {
                        updatePayload.start = getTimelineCenter();
                    }
                    if (!current.end) {
                        updatePayload.end = computeDefaultEnd(current.start || updatePayload.start);
                    }
                }

                items.update(updatePayload);
                refreshTypeFilterUI(getVisibleViewTypeIds());
                renderTypeSwitcherOptions();
                updateTimelineFilter();
            }

            function ensureViewFilterState(view) {
                if (!view) return null;
                if (!view.filterState) {
                    view.filterState = { kinds: {} };
                }
                return view.filterState;
            }

            function syncFiltersForActiveView(typeIds) {
                var view = views[activeViewIndex];
                if (!view) return;
                var state = ensureViewFilterState(view);
                if (state) {
                    filterState = state;
                }
                refreshTypeFilterUI(typeIds || getVisibleViewTypeIds());
                renderTypeSwitcherOptions();
            }

            function captureColorPreferencesState() {
                colorModalState.types = {};
                colorModalState.labels = {};
                var typeIds = getVisibleViewTypeIds();
                colorModalState.typeIds = typeIds;
                typeIds.forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    colorModalState.types[typeId] = def.background || getRainbowColor();
                    colorModalState.labels[typeId] = def.label || typeId;
                });
                colorModalState.timeline = displayPreferences.background || "#ffffff";
            }

            function updateTypeColorValue(typeId, normalized, preview, picker, hexInput) {
                if (!normalized) return;
                colorModalState.types[typeId] = normalized;
                setPreviewColor(preview, normalized);
                if (picker) {
                    picker.value = normalized === "transparent" ? "#ffffff" : normalized;
                }
                if (hexInput) {
                    hexInput.value = normalized;
                }
            }

            function renderColorModalContent() {
                if (!colorTypeList) return;
                colorTypeList.innerHTML = "";
                var targetTypeIds = Array.isArray(colorModalState.typeIds) && colorModalState.typeIds.length
                    ? colorModalState.typeIds
                    : getVisibleViewTypeIds();
                var typeIds = getOrderedTypeIds(targetTypeIds);
                typeIds.forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    var colorValue = colorModalState.types[typeId] || def.background || "#ffffff";
                    colorModalState.types[typeId] = colorValue;
                    var row = document.createElement("div");
                    row.className = "color-row";
                    var labelValue = colorModalState.labels[typeId] || def.label || typeId;
                    colorModalState.labels[typeId] = labelValue;
                    var labelWrapper = document.createElement("div");
                    labelWrapper.className = "color-row-label";
                    var labelInput = document.createElement("input");
                    labelInput.type = "text";
                    labelInput.className = "color-row-label-input";
                    labelInput.value = labelValue;
                    labelInput.placeholder = typeId;
                    labelInput.setAttribute("aria-label", "Nom du type " + (def.label || typeId));
                    labelInput.readOnly = true;
                    labelInput.addEventListener("dblclick", function (event) {
                        if (labelInput.disabled) return;
                        event.stopPropagation();
                        labelInput.readOnly = false;
                        labelInput.focus();
                        if (labelInput.select) {
                            labelInput.select();
                        }
                    });
                    labelInput.addEventListener("blur", function () {
                        labelInput.readOnly = true;
                    });
                    if (typeId === "milestone") {
                        labelInput.disabled = true;
                        labelInput.title = "Nom du jalon non modifiable";
                    }
                    labelInput.addEventListener("input", function () {
                        colorModalState.labels[typeId] = labelInput.value;
                    });
                    labelWrapper.appendChild(labelInput);
                    var controls = document.createElement("div");
                    controls.className = "color-row-controls";
                    var preview = document.createElement("span");
                    preview.className = "color-preview";
                    setPreviewColor(preview, colorValue);
                    var colorPicker = document.createElement("input");
                    colorPicker.type = "color";
                    colorPicker.value = colorValue === "transparent" ? "#ffffff" : colorValue;
                    var hexInput = document.createElement("input");
                    hexInput.type = "text";
                    hexInput.placeholder = "#ffffff";
                    hexInput.value = colorValue;
                    hexInput.addEventListener("input", function () {
                        var normalized = normalizeHexColor(hexInput.value);
                        if (!normalized) return;
                        updateTypeColorValue(typeId, normalized, preview, colorPicker, hexInput);
                    });
                    colorPicker.addEventListener("input", function () {
                        var normalized = normalizeHexColor(colorPicker.value);
                        if (!normalized) return;
                        updateTypeColorValue(typeId, normalized, preview, colorPicker, hexInput);
                    });
                    if (typeId !== "milestone") {
                        var deleteBtn = document.createElement("button");
                        deleteBtn.type = "button";
                        deleteBtn.className = "btn-small danger";
                        deleteBtn.textContent = "❌";
                        deleteBtn.addEventListener("click", function () {
                            removeTypeFromColorModal(typeId);
                        });
                        controls.appendChild(deleteBtn);
                    }
                    controls.appendChild(preview);
                    controls.appendChild(colorPicker);
                    controls.appendChild(hexInput);
                    row.appendChild(labelWrapper);
                    row.appendChild(controls);
                    colorTypeList.appendChild(row);
                });
            }

            function removeTypeFromColorModal(typeId) {
                if (typeId === "milestone") return;
                var typedItems = [];
                if (items && typeof items.get === "function") {
                    typedItems = items.get().filter(function (it) {
                        var kind = sanitizeTypeId(it.kind || it.type || "");
                        return kind === typeId;
                    });
                }

                var names = typedItems.map(function (it) {
                    return (it.content || it.label || it.id || "").toString().trim() || it.id;
                });
                var listPreview = names.slice(0, 8).map(function (n) { return " - " + n; }).join("\n");
                var extra = names.length > 8 ? "\n... (" + (names.length - 8) + " de plus)" : "";
                var message = typedItems.length
                    ? "Supprimer le type \"" + typeId + "\" et " + typedItems.length + " élément(s) ?\n" + listPreview + extra
                    : "Supprimer le type \"" + typeId + "\" ? (aucun élément associé)";

                if (!confirm(message)) return;

                if (typedItems.length && items && typeof items.remove === "function") {
                    var idsToRemove = typedItems.map(function (it) { return it.id; });
                    items.remove(idsToRemove);
                    if (selectedItemId && idsToRemove.indexOf(selectedItemId) !== -1) {
                        selectedItemId = null;
                        updateSelectionButtons();
                        renderTypeSwitcherOptions();
                    }
                }

                delete typeDefinitions[typeId];
                delete colorModalState.types[typeId];
                delete colorModalState.labels[typeId];
                views.forEach(function (view) {
                    if (!view.filterState || !view.filterState.kinds) return;
                    delete view.filterState.kinds[typeId];
                });
                if (filterState && filterState.kinds) {
                    delete filterState.kinds[typeId];
                }
                rebuildTypeStyles();
                syncFiltersForActiveView(getVisibleViewTypeIds());
                renderColorModalContent();
                updateTimelineFilter();
                updateEmptyViewMessage();
                persistTimelineState();
            }

            function openColorModal() {
                captureColorPreferencesState();
                renderColorModalContent();
                if (colorModalOverlay) {
                    colorModalOverlay.classList.add("open");
                }
            }

            function closeColorModal() {
                if (colorModalOverlay) {
                    colorModalOverlay.classList.remove("open");
                }
            }

            function applyColorModalChanges() {
                var renameCandidates = [];
                Object.keys(colorModalState.types).forEach(function (typeId) {
                    var def = typeDefinitions[typeId];
                    if (!def) return;
                    var background = colorModalState.types[typeId];
                    if (background) {
                        def.background = background;
                        updateTypeShades(def);
                    }
                    if (typeId === "milestone") return;
                    var updatedLabel = colorModalState.labels[typeId];
                    if (typeof updatedLabel !== "string") return;
                    var normalizedLabel = updatedLabel.trim();
                    if (!normalizedLabel) return;
                    colorModalState.labels[typeId] = normalizedLabel;
                    var candidateId = sanitizeTypeId(normalizedLabel);
                    if (!candidateId) return;
                    if (candidateId === typeId) {
                        def.label = normalizedLabel;
                        return;
                    }
                    renameCandidates.push({
                        from: typeId,
                        label: normalizedLabel,
                        baseId: candidateId
                    });
                });

                var finalIdMap = {};
                if (renameCandidates.length) {
                    var lockedIds = Object.keys(typeDefinitions).filter(function (id) {
                        return renameCandidates.every(function (task) {
                            return task.from !== id;
                        });
                    });
                    var reserved = {};
                    lockedIds.forEach(function (id) {
                        reserved[id] = true;
                    });
                    reserved["milestone"] = true;
                    renameCandidates.forEach(function (task) {
                        var baseId = task.baseId || task.from;
                        var candidate = baseId;
                        var counter = 1;
                        while (reserved[candidate]) {
                            candidate = baseId + "-" + counter;
                            counter++;
                            if (counter > 100) {
                                candidate = task.from;
                                break;
                            }
                        }
                        finalIdMap[task.from] = candidate || task.from;
                        reserved[finalIdMap[task.from]] = true;
                    });
                }

                renameCandidates.forEach(function (task) {
                    var def = typeDefinitions[task.from];
                    if (!def) return;
                    var desiredId = finalIdMap[task.from];
                    if (!desiredId || desiredId === task.from) {
                        def.label = task.label;
                        return;
                    }
                    var preserved = {
                        id: desiredId,
                        label: task.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    };
                    delete typeDefinitions[task.from];
                    typeDefinitions[desiredId] = preserved;
                    updateTypeShades(preserved);
                    if (Array.isArray(colorModalState.typeIds)) {
                        colorModalState.typeIds = colorModalState.typeIds.map(function (id) {
                            return id === task.from ? desiredId : id;
                        });
                    }
                    var storedColor = colorModalState.types[task.from];
                    if (typeof storedColor !== "undefined") {
                        colorModalState.types[desiredId] = storedColor;
                        delete colorModalState.types[task.from];
                    }
                    colorModalState.labels[desiredId] = task.label;
                    delete colorModalState.labels[task.from];
                    views.forEach(function (view) {
                        if (!view.filterState || !view.filterState.kinds) return;
                        if (Object.prototype.hasOwnProperty.call(view.filterState.kinds, task.from)) {
                            view.filterState.kinds[desiredId] = view.filterState.kinds[task.from];
                            delete view.filterState.kinds[task.from];
                        }
                    });
                    if (filterState && filterState.kinds && Object.prototype.hasOwnProperty.call(filterState.kinds, task.from)) {
                        filterState.kinds[desiredId] = filterState.kinds[task.from];
                        delete filterState.kinds[task.from];
                    }
                    var updates = [];
                    items.get().forEach(function (item) {
                        var currentKind = sanitizeTypeId(item.kind || item.type || "");
                        if (!currentKind || currentKind !== task.from) return;
                        updates.push({
                            id: item.id,
                            kind: desiredId,
                            className:
                                desiredId === "milestone"
                                    ? "type-milestone milestone-class"
                                    : "type-" + desiredId
                        });
                    });
                    if (updates.length) {
                        items.update(updates);
                    }
                });

                rebuildTypeStyles();
                syncFiltersForActiveView(getVisibleViewTypeIds());
                if (colorModalState.timeline) {
                    applyBackground(colorModalState.timeline);
                }
                persistCurrentPlanning();
                closeColorModal();
            }

            if (openColorPaletteBtn) {
                openColorPaletteBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    closeContextMenus();
                    openColorModal();
                });
            }
            if (colorModalClose) {
                colorModalClose.addEventListener("click", closeColorModal);
            }
            if (colorModalOverlay) {
                colorModalOverlay.addEventListener("click", function (event) {
                    if (event.target === colorModalOverlay) {
                        closeColorModal();
                    }
                });
            }
            if (randomizeColorsBtn) {
                randomizeColorsBtn.addEventListener("click", function () {
                    var typeIds = colorModalState.typeIds || getVisibleViewTypeIds();
                    if (!typeIds.length) return;
                    var palette = generateRainbowPalette(typeIds.length);
                    typeIds.forEach(function (typeId, index) {
                        colorModalState.types[typeId] = palette[index % palette.length];
                    });
                    renderColorModalContent();
                });
            }
            if (saveColorPreferencesBtn) {
                saveColorPreferencesBtn.addEventListener("click", applyColorModalChanges);
            }

            function downloadJson(filename, payload) {
                var blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
                var url = URL.createObjectURL(blob);
                var anchor = document.createElement("a");
                anchor.href = url;
                anchor.download = filename;
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
                setTimeout(function () {
                    URL.revokeObjectURL(url);
                }, 1000);
            }

            function getExportFilename(ext) {
                try {
                    var rawTitle = (document.title || "export").toString().trim();
                    var safe = rawTitle.replace(/[^a-z0-9\-_.]/gi, "_").replace(/_+/g, "_");
                    var ts = new Date().toISOString().replace(/[:.]/g, "-");
                    return safe + "_" + ts + "." + ext;
                } catch (e) {
                    return "export_" + Date.now() + "." + ext;
                }
            }

            function gatherExportState() {
                persistCurrentPlanning();
                return buildTimelineStatePayload();
            }

            function exportTimelineState() {
                var payload = gatherExportState();
                downloadJson(getExportFilename('json'), payload);
            }

            async function exportTimelineImage() {
                if (!timelineCard || !exportImageBtn) return;
                closeContextMenus();
                var initialLabel = exportImageBtn.textContent;
                exportImageBtn.disabled = true;
                exportImageBtn.textContent = "⏳";
                try {
                    var canvas = await html2canvas(timelineCard, { scale: 2, backgroundColor: null, useCORS: true });
                    var link = document.createElement("a");
                    link.href = canvas.toDataURL("image/png");
                    link.download = getExportFilename('png');
                    link.click();
                } catch (err) {
                    console.error("Export image impossible", err);
                    alert("Export image impossible. Réessaie.");
                } finally {
                    exportImageBtn.textContent = initialLabel;
                    exportImageBtn.disabled = false;
                }
            }

            function buildExcelRows(planning) {
                if (!planning || !Array.isArray(planning.items)) return [];
                var groupMap = {};
                (planning.groups || []).forEach(function (group) {
                    if (group && group.id) {
                        groupMap[group.id] = group.label || "";
                    }
                });
                return planning.items.map(function (item) {
                    return {
                        Ligne: groupMap[item.groupId] || item.groupId || "",
                        Activité: item.label || "",
                        Type: item.kind || "",
                        Début: item.start || "",
                        Fin: item.end || "",
                        Date: item.date || ""
                    };
                });
            }

            function computeDaySpan(start, end) {
                if (!start || !end) {
                    return null;
                }
                var startDate = new Date(start);
                var endDate = new Date(end);
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    return null;
                }
                var msPerDay = 1000 * 60 * 60 * 24;
                var diff = Math.round((endDate - startDate) / msPerDay);
                if (diff < 0) {
                    return null;
                }
                return diff + 1; // include both endpoints
            }

            function exportTimelineExcel() {
                if (!exportExcelBtn) return;
                closeContextMenus();
                exportExcelBtn.disabled = true;
                var initialLabel = exportExcelBtn.textContent;
                exportExcelBtn.textContent = "⏳";
                try {
                    persistCurrentPlanning();
                    var currentView = views[activeViewIndex];
                    var planning = (currentView && currentView.planning) || exportPlanningToJson();
                    var rows = buildExcelRows(planning);
                    if (!rows.length) {
                        alert("Aucun élément à exporter.");
                        return;
                    }
                    var worksheet = XLSX.utils.json_to_sheet(rows, {
                        header: ["Ligne", "Activité", "Type", "Début", "Fin", "Date"]
                    });
                    var workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Planning");
                    XLSX.writeFile(workbook, getExportFilename('xlsx'));
                } catch (err) {
                    console.error("Export Excel failed", err);
                    alert("Export Excel impossible. Réessaie.");
                } finally {
                    exportExcelBtn.textContent = initialLabel;
                    exportExcelBtn.disabled = false;
                }
            }

            function buildTextExport(planning, viewTitle) {
                var lines = [];
                if (viewTitle) {
                    lines.push("Page : " + viewTitle);
                }
                if (planning && planning.timeline) {
                    var start = planning.timeline.start || "";
                    var end = planning.timeline.end || "";
                    var rangeParts = [];
                    if (start) rangeParts.push(start);
                    if (end) rangeParts.push(end);
                    if (rangeParts.length) {
                        lines.push("Période : " + rangeParts.join(" → "));
                    }
                }
                var groupMap = {};
                (planning && Array.isArray(planning.groups) ? planning.groups : []).forEach(function (group) {
                    if (group && group.id) {
                        var label = group.label || group.name || group.id;
                        groupMap[group.id] = label.trim() || group.id;
                    }
                });
                var groupLabels = Object.keys(groupMap).map(function (id) {
                    return groupMap[id];
                }).filter(Boolean);
                if (groupLabels.length) {
                    lines.push("Groupes : " + groupLabels.join(", "));
                }
                var items = planning && Array.isArray(planning.items) ? planning.items : [];
                if (items.length) {
                    lines.push("");
                    lines.push("Éléments :");
                    items.forEach(function (item, index) {
                        if (index) {
                            lines.push("");
                        }
                        var label = item.label || "Sans titre";
                        lines.push(label);
                        if (item.kind === "milestone") {
                            if (item.date) {
                                lines.push("Date: " + item.date);
                            }
                        } else {
                            if (item.start || item.end) {
                                var span = (item.start || "") + (item.start && item.end ? " → " : "") + (item.end || "");
                                if (span) {
                                    var days = computeDaySpan(item.start, item.end);
                                    lines.push("Date: " + span + (days ? " (" + days + " jours)" : ""));
                                }
                            }
                        }
                        var groupLabel = groupMap[item.groupId] || item.groupId;
                        if (groupLabel) {
                            lines.push("Groupe: " + groupLabel);
                        }
                        if (item.kind) {
                            lines.push("Type: " + item.kind);
                        }
                    });
                } else {
                    lines.push("");
                    lines.push("Aucun élément à exporter pour l’instant.");
                }
                return lines.join("\n");
            }

            function copyTextToClipboard(text) {
                if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
                    return navigator.clipboard.writeText(text);
                }
                return new Promise(function (resolve, reject) {
                    var textarea = document.createElement("textarea");
                    textarea.value = text;
                    textarea.setAttribute("readonly", "");
                    textarea.style.position = "absolute";
                    textarea.style.left = "-9999px";
                    document.body.appendChild(textarea);
                    textarea.select();
                    textarea.setSelectionRange(0, textarea.value.length);
                    var success = document.execCommand("copy");
                    document.body.removeChild(textarea);
                    if (success) {
                        resolve();
                    } else {
                        reject(new Error("Fallback copy failed"));
                    }
                });
            }

            function showCopyToast(message) {
                if (!copyToast) return;
                copyToast.textContent = message;
                copyToast.classList.add("visible");
                if (copyToastTimer) {
                    clearTimeout(copyToastTimer);
                }
                copyToastTimer = setTimeout(function () {
                    copyToast.classList.remove("visible");
                    copyToastTimer = null;
                }, 2200);
            }

            async function exportTimelineText() {
                if (!exportTextBtn) return;
                closeContextMenus();
                exportTextBtn.disabled = true;
                try {
                    persistCurrentPlanning();
                    var currentView = views[activeViewIndex];
                    var planning = (currentView && currentView.planning) || exportPlanningToJson();
                    var text = buildTextExport(planning, currentView && currentView.title);
                    await copyTextToClipboard(text);
                    showCopyToast("Texte copié dans le presse-papier");
                } catch (err) {
                    console.error("Copie texte impossible", err);
                    alert("Impossible de copier le texte. Réessaie.");
                } finally {
                    exportTextBtn.disabled = false;
                }
            }

            function applyImportedState(state, options) {
                if (!state) return false;
                options = options || {};
                var importedViews = [];
                if (Array.isArray(state.views) && state.views.length) {
                    importedViews = state.views.map(function (view, index) {
                        var label = view.name || view.title || ("Page " + (index + 1));
                        return {
                            name: label,
                            title: view.title || view.name || label,
                            planning: view.planning || null,
                            context: normalizeContextState(view.context)
                        };
                    });
                } else if (state.groups) {
                    var label = state.label || state.name || "Page 1";
                    importedViews = [{ name: label, title: label, planning: state, context: cloneDefaultContext() }];
                }
                if (!importedViews.length) {
                    if (options.alertOnEmpty !== false) {
                        alert("Aucune vue valide à importer.");
                    }
                    return false;
                }
                views = importedViews;
                if (Array.isArray(state.types)) {
                    applyTypeDefinitions(state.types);
                }
                if (state.displayPreferences) {
                    Object.assign(displayPreferences, state.displayPreferences);
                }
                if (typeof state.brief === "string") {
                    persistedTimelineBrief = state.brief;
                    if (importedViews.length) {
                        var migratedContext = ensureViewContext(importedViews[0]);
                        if (!migratedContext.prompts.create) {
                            migratedContext.prompts.create = state.brief;
                        }
                    }
                    syncContextFieldsFromState({ refreshModify: true, skipPersist: true });
                }
                if (state.templates) {
                    if (typeof state.templates.create === "string") {
                        customSystemTemplates.create = state.templates.create;
                    }
                    if (typeof state.templates.modify === "string") {
                        customSystemTemplates.modify = state.templates.modify;
                    }
                }
                importedViews.forEach(ensureViewContext);
                syncTemplateEditor(templateModeSelect ? templateModeSelect.value : "create");
                renderFontSizeOptions();
                applyDisplayPreferences();
                syncFontControls();
                renderViewTabs();
                activateView(0, true);
                persistTimelineState();
                return true;
            }

            function initShareWorkerService() {
                shareWorkerAvailable = Boolean(window.goToolkitShareWorker && window.goToolkitShareWorker.isReady);
            }

            function setShareStatus(message, type) {
                shareStatusMessage = message || "";
                shareStatusType = type || "";
            }

            function formatRelativeTime(isoString) {
                if (!isoString) return "";
                var value = new Date(isoString).getTime();
                if (Number.isNaN(value)) return "";
                var deltaSeconds = Math.max(0, Math.floor((Date.now() - value) / 1000));
                if (deltaSeconds < 60) {
                    return "Mis à jour à l'instant";
                }
                var deltaMinutes = Math.floor(deltaSeconds / 60);
                if (deltaMinutes < 60) {
                    return "Mis à jour il y a " + deltaMinutes + " minute" + (deltaMinutes > 1 ? "s" : "");
                }
                var deltaHours = Math.floor(deltaMinutes / 60);
                if (deltaHours < 24) {
                    return "Mis à jour il y a " + deltaHours + " heure" + (deltaHours > 1 ? "s" : "");
                }
                var deltaDays = Math.floor(deltaHours / 24);
                return "Mis à jour il y a " + deltaDays + " jour" + (deltaDays > 1 ? "s" : "");
            }

            function formatFullDate(isoString) {
                var value = new Date(isoString);
                if (Number.isNaN(value.getTime())) return "";
                var formatter = new Intl.DateTimeFormat("fr-FR", {
                    day: "2-digit",
                    month: "short",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit"
                });
                return formatter.format(value);
            }

            function getShareTokenFromUrl() {
                var params = new URLSearchParams(window.location.search);
                var value = params.get(SHARE_QUERY_PARAM);
                return value ? value.trim() : null;
            }

            function buildShareUrl(token) {
                if (!token) {
                    return "";
                }
                var url = new URL(window.location.href);
                url.searchParams.set(SHARE_QUERY_PARAM, token);
                return url.toString();
            }

            function updateUrlWithShareToken(token) {
                var url = new URL(window.location.href);
                if (token) {
                    url.searchParams.set(SHARE_QUERY_PARAM, token);
                } else {
                    url.searchParams.delete(SHARE_QUERY_PARAM);
                }
                history.replaceState(null, "", url.toString());
            }

            function createShareToken() {
                if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
                    return crypto.randomUUID();
                }
                var bytes = new Uint8Array(16);
                if (typeof crypto !== "undefined" && typeof crypto.getRandomValues === "function") {
                    crypto.getRandomValues(bytes);
                } else {
                    for (var i = 0; i < bytes.length; i++) {
                        bytes[i] = Math.floor(Math.random() * 256);
                    }
                }
                return Array.from(bytes)
                    .map(function (byte) {
                        return byte.toString(16).padStart(2, "0");
                    })
                    .join("");
            }

            async function fetchSharePayload(token) {
                if (!shareWorkerAvailable || !shareWorkerService) {
                    throw new Error(SHARE_WORKER_UNAVAILABLE_MESSAGE);
                }
                return shareWorkerService.fetchSharePayload(FIRESTORE_COLLECTION, token);
            }

            async function tryLoadSharedStateFromUrl() {
                var token = getShareTokenFromUrl();
                if (!token) {
                    return false;
                }
                if (!shareWorkerAvailable) {
                    setShareStatus(SHARE_WORKER_UNAVAILABLE_MESSAGE, "error");
                    return false;
                }

                var localDraft = readShareDraft(token);
                var remoteResult = null;
                try {
                    remoteResult = await fetchSharePayload(token);
                } catch (err) {
                    console.error("Erreur de chargement distant du lien partagé :", err);
                }

                var remotePayload = remoteResult && remoteResult.payload;
                var remoteUpdatedAt = remoteResult && remoteResult.meta && remoteResult.meta.updatedAt;
                var localPayload = localDraft && localDraft.payload;
                var localUpdatedAt = localDraft && localDraft.updatedAt;

                var remoteDate = remoteUpdatedAt ? new Date(remoteUpdatedAt).getTime() : 0;
                var localDate = localUpdatedAt ? new Date(localUpdatedAt).getTime() : 0;
                var payloadsMatch = remotePayload && localPayload
                    ? JSON.stringify(remotePayload) === JSON.stringify(localPayload)
                    : false;
                var timestampsEqual = remoteUpdatedAt && localUpdatedAt && remoteDate === localDate;

                var chosenPayload = null;
                var chosenUpdatedAt = null;

                if (remotePayload && localPayload && (payloadsMatch || timestampsEqual)) {
                    chosenPayload = localPayload;
                    chosenUpdatedAt = localUpdatedAt || remoteUpdatedAt;
                } else if (localPayload && localDate > remoteDate) {
                    chosenPayload = localPayload;
                    chosenUpdatedAt = localUpdatedAt;
                } else if (remotePayload && remoteDate > localDate && localPayload) {
                    var confirmed = window.confirm(
                        "Mettre à jour avec les modifications du " + formatFullDate(remoteUpdatedAt) + " ?"
                    );
                    if (confirmed) {
                        chosenPayload = remotePayload;
                        chosenUpdatedAt = remoteUpdatedAt;
                    } else {
                        chosenPayload = localPayload;
                        chosenUpdatedAt = localUpdatedAt || remoteUpdatedAt || new Date().toISOString();
                    }
                } else if (remotePayload) {
                    chosenPayload = remotePayload;
                    chosenUpdatedAt = remoteUpdatedAt || new Date().toISOString();
                } else if (localPayload) {
                    chosenPayload = localPayload;
                    chosenUpdatedAt = localUpdatedAt || new Date().toISOString();
                }

                if (!chosenPayload) {
                    setShareStatus("Lien de la capsule introuvable.", "error");
                    return false;
                }

                var imported = applyImportedState(chosenPayload, { alertOnEmpty: false });
                if (!imported) {
                    setShareStatus("Lien de la capsule introuvable.", "error");
                    return false;
                }
                currentShareToken = token;
                shareLoadedFromRemote = true;
                shareLastUpdatedAt = chosenUpdatedAt || new Date().toISOString();
                setShareStatus(formatRelativeTime(shareLastUpdatedAt));
                persistRoadmapShareRecord(token, shareLastUpdatedAt);
                writeShareDraft(token, chosenPayload, shareLastUpdatedAt);
                updateShareMenuUI();
                return true;
            }

            async function saveSharePayload(token, payload) {
                if (!shareWorkerAvailable || !shareWorkerService) {
                    throw new Error(SHARE_WORKER_UNAVAILABLE_MESSAGE);
                }
                var meta = await shareWorkerService.saveSharePayload(FIRESTORE_COLLECTION, token, payload);
                return (meta && meta.updatedAt) || new Date().toISOString();
            }

            function getShareDefaultStatusText() {
                if (!shareWorkerAvailable) {
                    return SHARE_WORKER_UNAVAILABLE_MESSAGE;
                }
                if (shareLastUpdatedAt) {
                    return formatRelativeTime(shareLastUpdatedAt);
                }
                if (shareLoadedFromRemote && currentShareToken) {
                    return "Ce lien charge la version enregistrée via le worker Cloudflare.";
                }
                if (currentShareToken) {
                    return "Un lien privé existe déjà pour cette session.";
                }
                return "Seules les personnes disposant du lien peuvent y accéder.";
            }

            function updateShareMenuUI() {
                if (shareLinkField) {
                    var hasToken = Boolean(currentShareToken);
                    shareLinkField.value = hasToken ? buildShareUrl(currentShareToken) : "";
                    shareLinkField.placeholder = hasToken ? "" : "Appuie sur Créer pour générer un lien privé.";
                }
                if (shareUpdateBtn) {
                    var hasToken = Boolean(currentShareToken);
                    shareUpdateBtn.hidden = !hasToken;
                    shareUpdateBtn.disabled = shareRequestInProgress || !hasToken || !shareWorkerAvailable;
                }
                if (shareCreateBtn) {
                    shareCreateBtn.disabled = shareRequestInProgress || !shareWorkerAvailable;
                    if (!currentShareToken) {
                        shareCreateBtn.classList.add("primary");
                    } else {
                        shareCreateBtn.classList.remove("primary");
                    }
                }
                if (shareMenuStatus) {
                    var text = shareStatusMessage || getShareDefaultStatusText();
                    shareMenuStatus.textContent = text;
                    var isError =
                        (shareStatusType === "error" && Boolean(text)) ||
                        (!shareWorkerAvailable && !shareStatusMessage);
                    shareMenuStatus.classList.toggle("error", isError);
                }
                if (shareUpdateBtn) {
                    if (currentShareToken) {
                        shareUpdateBtn.classList.add("primary");
                    } else {
                        shareUpdateBtn.classList.remove("primary");
                    }
                }
            }

            async function copyCurrentShareLinkToClipboard() {
                if (!currentShareToken) return false;
                var link = buildShareUrl(currentShareToken);
                if (!link) return false;
                try {
                    await copyTextToClipboard(link);
                    showCopyToast("Lien privé copié");
                    return true;
                } catch (err) {
                    console.error("Copie du lien privé impossible", err);
                    return false;
                }
            }

            async function handleShareCreateClick() {
                if (!shareWorkerAvailable) {
                    setShareStatus(SHARE_WORKER_UNAVAILABLE_MESSAGE, "error");
                    updateShareMenuUI();
                    return;
                }
                if (shareRequestInProgress) return;
                shareRequestInProgress = true;
                updateShareMenuUI();
                try {
                    persistCurrentPlanning();
                    var token = createShareToken();
                    var payload = buildTimelineStatePayload();
                    var updatedAt = await saveSharePayload(token, payload);
                    currentShareToken = token;
                    shareLoadedFromRemote = true;
                    shareLastUpdatedAt = updatedAt;
                    updateUrlWithShareToken(token);
                    setShareStatus(formatRelativeTime(updatedAt));
                    updateShareMenuUI();
                    persistRoadmapShareRecord(token, updatedAt);
                    writeShareDraft(token, payload, updatedAt);
                    await copyCurrentShareLinkToClipboard();
                } catch (err) {
                    console.error("Erreur lors de la création du lien partagé :", err);
                    setShareStatus("Impossible de créer le lien partagé.", "error");
                    updateShareMenuUI();
                } finally {
                    shareRequestInProgress = false;
                    updateShareMenuUI();
                }
            }

            async function handleShareUpdateClick() {
                if (!shareWorkerAvailable) {
                    setShareStatus(SHARE_WORKER_UNAVAILABLE_MESSAGE, "error");
                    updateShareMenuUI();
                    return;
                }
                if (!currentShareToken) {
                    setShareStatus("Pas de lien privé à mettre à jour.", "error");
                    updateShareMenuUI();
                    return;
                }
                if (shareRequestInProgress) return;
                shareRequestInProgress = true;
                updateShareMenuUI();
                try {
                    persistCurrentPlanning();
                    var payload = buildTimelineStatePayload();
                    var updatedAt = await saveSharePayload(currentShareToken, payload);
                    shareLoadedFromRemote = true;
                    shareLastUpdatedAt = updatedAt;
                    setShareStatus(formatRelativeTime(updatedAt));
                    updateShareMenuUI();
                    persistRoadmapShareRecord(currentShareToken, updatedAt);
                    writeShareDraft(currentShareToken, payload, updatedAt);
                    await copyCurrentShareLinkToClipboard();
                } catch (err) {
                    console.error("Erreur lors de la mise à jour du lien partagé :", err);
                    setShareStatus("Impossible de mettre à jour le lien partagé.", "error");
                    updateShareMenuUI();
                } finally {
                    shareRequestInProgress = false;
                    updateShareMenuUI();
                }
            }

            function triggerImportJson() {
                if (!importJsonInput) return;
                importJsonInput.value = "";
                importJsonInput.click();
            }

            if (importJsonInput) {
                importJsonInput.addEventListener("change", function (event) {
                    var file = event.target.files && event.target.files[0];
                    if (!file) return;
                    var reader = new FileReader();
                    reader.onload = function () {
                        try {
                            var payload = JSON.parse(reader.result);
                            applyImportedState(payload);
                        } catch (err) {
                            alert("Fichier JSON invalide.");
                        }
                    };
                    reader.readAsText(file);
                    importJsonInput.value = "";
                });
            }

            if (importJsonBtn) {
                importJsonBtn.addEventListener("click", function () {
                    triggerImportJson();
                    closeContextMenus();
                });
            }
            if (exportJsonBtn) {
                exportJsonBtn.addEventListener("click", function () {
                    exportTimelineState();
                    closeContextMenus();
                });
            }
            if (exportImageBtn) {
                exportImageBtn.addEventListener("click", exportTimelineImage);
            }
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener("click", exportTimelineExcel);
            }
            if (exportTextBtn) {
                exportTextBtn.addEventListener("click", exportTimelineText);
            }
            if (shareCreateBtn) {
                shareCreateBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    handleShareCreateClick();
                });
            }
            if (shareUpdateBtn) {
                shareUpdateBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    handleShareUpdateClick();
                });
            }
            if (shareLinkField) {
                shareLinkField.addEventListener("focus", function () {
                    this.select();
                });
                shareLinkField.addEventListener("click", function () {
                    this.select();
                });
            }

            function closeTimelineInfoPopup() {
                if (!infoPopup) return;
                infoPopup.classList.remove("open");
            }

            function toggleTimelineInfoPopup(event) {
                if (!infoPopup) return;
                event.stopPropagation();
                closeContextMenus();
                infoPopup.classList.toggle("open");
            }

            function clearTimelineStorageAndReload() {
                try {
                    localStorage.clear();
                } catch (err) {
                    console.warn("Impossible de vider localStorage", err);
                }
                try {
                    sessionStorage.clear();
                } catch (err) {
                    console.warn("Impossible de vider sessionStorage", err);
                }
                try {
                    if (window.sessionStorage) {
                        window.sessionStorage.setItem(timelineTourSkipFlag, "1");
                    }
                } catch (err) {
                    console.warn("Impossible de préparer l'indicateur de mise à jour", err);
                }
                var cookies = (document.cookie || "").split(";");
                cookies.forEach(function (cookie) {
                    var eqPos = cookie.indexOf("=");
                    var name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
                    name = name.trim();
                    if (!name) return;
                    document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
                });
                var reload = function () {
                    window.location.reload();
                };
                if (window.caches && typeof window.caches.keys === "function") {
                    window.caches
                        .keys()
                        .then(function (keys) {
                            return Promise.all(
                                keys.map(function (key) {
                                    return window.caches.delete(key);
                                })
                            );
                        })
                        .catch(function () { })
                        .finally(reload);
                } else {
                    reload();
                }
            }

            function promptTimelineUpdate() {
                var warning =
                    "La mise à jour effacera les données locales (cache, cookies, préférences). Continuer ?";
                if (!confirm(warning)) return;
                closeTimelineInfoPopup();
                clearTimelineStorageAndReload();
            }

            function hideTimelineAbout() {
                closeTimelineInfoPopup();
            }

            if (aboutTimelineBtn) {
                aboutTimelineBtn.addEventListener("click", toggleTimelineInfoPopup);
            }

            if (timelineUpdateBtn) {
                timelineUpdateBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    promptTimelineUpdate();
                });
            }

            document.addEventListener("click", function (event) {
                if (!infoPopup || infoPopup.contains(event.target) || event.target === aboutTimelineBtn) {
                    return;
                }
                closeTimelineInfoPopup();
            });
            if (navSwitcherBtn && navSwitcherMenu) {
                navSwitcherBtn.addEventListener("click", function (event) {
                    event.stopPropagation();
                    var isOpen = navSwitcherMenu.classList.toggle("open");
                    navSwitcherBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
                });
                navSwitcherMenu.addEventListener("click", function (event) {
                    event.stopPropagation();
                });
                document.addEventListener("click", function (event) {
                    if (!navSwitcherMenu.contains(event.target) && event.target !== navSwitcherBtn) {
                        navSwitcherMenu.classList.remove("open");
                        navSwitcherBtn.setAttribute("aria-expanded", "false");
                    }
                });
            }

            function applyFont(font) {
                document.documentElement.style.setProperty("--app-font", font);
                document.body.style.fontFamily = font;
                if (timelineCard) {
                    timelineCard.style.fontFamily = font;
                }
                if (container) {
                    container.style.fontFamily = font;
                }
                displayPreferences.font = font;
            }

            function updateFontSize(size) {
                var normalized = parseInt(size, 10);
                if (isNaN(normalized)) {
                    normalized = 14;
                }
                var value = normalized + "px";
                document.documentElement.style.setProperty("--global-font-size", value);
                document.body.style.fontSize = value;
                if (timelineCard) timelineCard.style.fontSize = value;
                if (container) container.style.fontSize = value;
                displayPreferences.fontSize = normalized;
            }

            function syncFontControls() {
                var computed = getComputedStyle(document.documentElement);
                if (fontSizeInput) {
                    var rawSize = computed.getPropertyValue("--global-font-size").trim();
                    var calculated = parseInt(rawSize, 10);
                    if (isNaN(calculated)) {
                        calculated = parseInt(window.getComputedStyle(document.body).fontSize, 10);
                    }
                    if (!isNaN(calculated)) {
                        fontSizeInput.value = calculated;
                    }
                }
            }

            function applyBackground(value) {
                var normalized = (typeof value === "string" ? value.trim() : "") || "#ffffff";
                var bodyValue = normalized === "transparent" ? "#f7f7f7" : normalized;
                var cardValue = normalized === "transparent" ? "rgba(255, 255, 255, 0.6)" : normalized;
                document.body.style.background = bodyValue;
                document.documentElement.style.setProperty("--timeline-background", cardValue);
                if (timelineCard) {
                    timelineCard.style.background = cardValue;
                }
                displayPreferences.background = normalized;
                if (backgroundSelector) {
                    var selectorValue = allowedBackgroundValues.indexOf(normalized) >= 0
                        ? normalized
                        : allowedBackgroundValues[0];
                    backgroundSelector.value = selectorValue;
                }
            }

            function updateTimelineAspect(ratio) {
                if (!timelineCard || !ratio) return;
                timelineCard.dataset.ratio = ratio;
            }

            function applySpacingMode(mode, shouldPersist) {
                if (!timelineCard) return;
                var normalized = typeof mode === "string" ? mode.trim().toLowerCase() : "";
                if (!normalized) normalized = "dense";
                var allowed = ["dense", "normal", "comfortable"];
                if (allowed.indexOf(normalized) === -1) {
                    normalized = "dense";
                }
                timelineCard.dataset.spacing = normalized;
                displayPreferences.spacing = normalized;
                if (spacingSelect) {
                    spacingSelect.value = normalized;
                }
                if (shouldPersist) {
                    persistTimelineState();
                }
            }

            function applyBorderLightMode(mode, shouldPersist) {
                var normalized = typeof mode === "string" ? mode.trim() : "";
                if (!normalized || !borderLightModes.hasOwnProperty(normalized)) {
                    normalized = DEFAULT_BORDER_LIGHT_MODE;
                }
                document.documentElement.style.setProperty("--border-light", borderLightModes[normalized]);
                displayPreferences.borderLightMode = normalized;
                if (borderLightSelect) {
                    borderLightSelect.value = normalized;
                }
                if (shouldPersist) {
                    persistTimelineState();
                }
            }

            function applyRatio(ratio, shouldPersist) {
                if (!timelineCard) return;
                var normalized = typeof ratio === "string" ? ratio.trim() : "";
                var allowed = ["full", "16:9", "4:3", "a4"];
                if (!normalized || allowed.indexOf(normalized) === -1) {
                    normalized = "full";
                }
                displayPreferences.ratio = normalized;
                updateTimelineAspect(normalized);
                if (widthSelect) {
                    widthSelect.value = normalized;
                }
                if (shouldPersist) {
                    persistTimelineState();
                }
            }

            function applyDisplayPreferences() {
                if (displayPreferences.font) {
                    applyFont(displayPreferences.font);
                }
                if (fontSizeInput && displayPreferences.fontSize) {
                    fontSizeInput.value = displayPreferences.fontSize;
                    updateFontSize(displayPreferences.fontSize);
                }
                var backgroundValue = displayPreferences.background || "#ffffff";
                applyBackground(backgroundValue);
                applyRatio(displayPreferences.ratio || "full");
                applySpacingMode(displayPreferences.spacing || "dense");
                applyBorderLightMode(displayPreferences.borderLightMode || DEFAULT_BORDER_LIGHT_MODE);
                applyWeekendVisibilityPreference(false);
            }

            function applyWeekendVisibilityPreference(shouldPersist) {
                if (weekendVisibilitySelect) {
                    weekendVisibilitySelect.value = displayPreferences.hideWeekends ? "hide" : "show";
                }
                if (timeline) {
                    timeline.setOptions({
                        hiddenDates: buildWeekendHiddenDates()
                    });
                }
                if (shouldPersist) {
                    persistTimelineState();
                }
            }

            function hideEmptyGroups() {
                document.querySelectorAll("#timeline .vis-group").forEach((group) => {
                    const hasItem = Boolean(group.querySelector(".vis-item"));
                    group.style.display = hasItem ? "" : "none";
                });
            }
            timeline.on("change", hideEmptyGroups);
            timeline.on("rangechanged", hideEmptyGroups);
            hideEmptyGroups(); // call once after initial render


            function setItemDurationMode(mode, shouldPersist) {
                var normalized = typeof mode === "string" ? mode : "none";
                var allowed = ["none", "days", "weeks"];
                if (allowed.indexOf(normalized) === -1) {
                    normalized = "none";
                }
                displayPreferences.itemDurationMode = normalized;
                if (itemDurationSelect) {
                    itemDurationSelect.value = normalized;
                }
                if (shouldPersist) {
                    persistTimelineState();
                }
                if (timeline && typeof timeline.redraw === "function") {
                    timeline.redraw();
                }
            }

            renderFontSizeOptions();

            if (fontSizeInput) fontSizeInput.addEventListener("change", function () {
                updateFontSize(this.value);
            });
            applyDisplayPreferences();
            syncFontControls();
            if (backgroundSelector) {
                backgroundSelector.addEventListener("change", function () {
                    applyBackground(this.value);
                });
            }
            if (itemDurationSelect) {
                itemDurationSelect.addEventListener("change", function () {
                    setItemDurationMode(this.value, true);
                });
            }
            if (widthSelect) {
                widthSelect.addEventListener("change", function () {
                    applyRatio(this.value, true);
                });
            }
            if (spacingSelect) {
                spacingSelect.addEventListener("change", function () {
                    applySpacingMode(this.value, true);
                });
            }
            if (borderLightSelect) {
                borderLightSelect.addEventListener("change", function () {
                    applyBorderLightMode(this.value, true);
                });
            }
            if (weekendVisibilitySelect) {
                weekendVisibilitySelect.addEventListener("change", function () {
                    displayPreferences.hideWeekends = this.value === "hide";
                    applyWeekendVisibilityPreference(true);
                });
            }
            setItemDurationMode(displayPreferences.itemDurationMode || "none", false);

            var viewTabs = document.getElementById("viewTabs");
            var addViewBtn = document.getElementById("addViewBtn");
            var deleteViewBtn = document.getElementById("deleteViewBtn");

            function ensureViewName(index) {
                var view = views[index];
                if (!view) return "Page " + (index + 1);
                return view.name || view.title || ("Page " + (index + 1));
            }

            function refreshHeaderText() {
                if (!headerTitleElement) return;
                var currentView = views[activeViewIndex];
                headerTitleElement.textContent =
                    (currentView && (currentView.title || currentView.name)) || "Outil de planning · OpenAI ready";
            }

            function resetTimelineForEmptyView() {
                persistenceLocked = true;
                groups.clear();
                items.clear();
                persistenceLocked = false;
                timeline.setWindow(
                    new Date(now.getTime() - 2 * oneWeek),
                    new Date(now.getTime() + 6 * oneWeek),
                    { animation: false }
                );
                syncFiltersForActiveView(getVisibleViewTypeIds());
                updateTimelineFilter();
                persistCurrentPlanning();
                updateEmptyViewMessage();
            }

            function activateView(index, skipSave) {
                if (index < 0 || index >= views.length) return;
                if (!skipSave) {
                    persistCurrentPlanning();
                }
                activeViewIndex = index;
                var view = views[index];
                ensureViewFilterState(view);
                if (view && view.filterState) {
                    filterState = view.filterState;
                }
                if (view && view.planning) {
                    applyPlanningFromJson(view.planning);
                } else {
                    resetTimelineForEmptyView();
                }
                ensureViewContext(view);
                refreshHeaderText();
                renderViewTabs();
                updateEmptyViewMessage();
                syncContextUIForActiveView();
            }

            if (headerTitleElement) {
                headerTitleElement.addEventListener("dblclick", function () {
                    var currentLabel = (headerTitleElement.textContent || "").trim();
                    var label = window.prompt("Nom de la vue", currentLabel);
                    if (label === null) return;
                    label = label.trim();
                    if (!label) return;
                    var view = views[activeViewIndex];
                    if (!view) return;
                    view.title = label;
                    refreshHeaderText();
                    persistTimelineState();
                    renderViewTabs();
                });
            }

            function renderViewTabs() {
                if (!viewTabs) return;
                viewTabs.innerHTML = "";
                views.forEach(function (view, index) {
                    var btn = document.createElement("button");
                    btn.type = "button";
                    btn.className = "tab" + (index === activeViewIndex ? " active" : "");
                    btn.textContent = ensureViewName(index);
                    btn.dataset.index = index;
                    btn.addEventListener("click", function () {
                        activateView(Number(this.dataset.index));
                    });
                    btn.addEventListener("dblclick", function () {
                        var idx = Number(this.dataset.index);
                        var currentName = ensureViewName(idx);
                        var newName = window.prompt("Nom de l'onglet", currentName);
                        if (newName === null) return;
                        newName = newName.trim();
                        if (!newName) return;
                        var targetView = views[idx];
                        if (!targetView) return;
                        targetView.name = newName;
                        this.textContent = newName;
                        persistTimelineState();
                    });
                    viewTabs.appendChild(btn);
                });
                if (viewTabs.children.length > 0) {
                    var last = viewTabs.children[viewTabs.children.length - 1];
                    last.scrollIntoView({ behavior: "smooth", inline: "end" });
                }
            }

            function addView() {
                persistCurrentPlanning();
                var label = "Page " + (views.length + 1);
                var newView = { name: label, title: label, planning: null, context: cloneDefaultContext() };
                ensureViewFilterState(newView);
                views.push(newView);
                persistTimelineState();
                activateView(views.length - 1, true);
                openContextModal({ mode: "create" });
            }

            function deleteView() {
                if (views.length <= 1) return;
                views.splice(activeViewIndex, 1);
                if (activeViewIndex >= views.length) {
                    activeViewIndex = views.length - 1;
                }
                persistTimelineState();
                activateView(activeViewIndex, true);
            }

            addViewBtn && addViewBtn.addEventListener("click", addView);
            deleteViewBtn && deleteViewBtn.addEventListener("click", deleteView);

            renderViewTabs();
            activateView(activeViewIndex, true);
            // ============================================================
            // 3. Inline labeling via prompt (double-clic)
            // ============================================================
            var renameGuard = false;
            function editItemLabel(itemId) {
                if (renameGuard) return;
                renameGuard = true;
                setTimeout(function () {
                    renameGuard = false;
                }, 300);
                var it = items.get(itemId);
                if (!it) return;
                var current = (it.content || "").trim();
                var label = window.prompt("Saisis un libellé ou vide pour supprimer", current);
                if (label === null) return;
                label = label.trim();
                if (!label) {
                    items.remove(itemId);
                    return;
                }
                items.update({ id: itemId, content: label });
            }

            function editGroupLabel(groupId) {
                if (!groupId) return;
                var group = groups.get(groupId);
                if (!group) return;
                var current = (group.content || group.label || group.id || "").trim();
                var label = window.prompt("Nom du groupe. Vider pour supprimer", current);
                if (label === null) return;
                label = label.trim();
                if (!label) {
                    if (!confirm("Supprimer ce groupe et tous les éléments associés ?")) {
                        return;
                    }
                    var relatedItems = items.get({
                        filter: function (item) {
                            return item.group === groupId;
                        }
                    });
                    relatedItems.forEach(function (item) {
                        items.remove(item.id);
                    });
                    groups.remove(groupId);
                    return;
                }
                groups.update({ id: groupId, content: label, label: label });
            }

            // Double-clic : éditer un groupe ou un élément
            timeline.on("doubleClick", function (props) {
                if (props.what === "group-label" && props.group) {
                    editGroupLabel(props.group);
                    return;
                }
                if (props.item) {
                    editItemLabel(props.item);
                }
            });

            // Ajout natif vis → on force notre logique + label prompt
            options.onAdd = function (item, callback) {
                callback(null);
                var start = item.start || item.end || new Date();
                var groupId = item.group || "team-alpha";
                var id, newItem;

                if (groupId === "milestones") {
                    id = "ms-" + Date.now();
                    newItem = {
                        id: id,
                        group: "milestones",
                        content: "",
                        start: start,
                        type: "point",
                        kind: "milestone",
                        className: "type-milestone milestone-class"
                    };
                } else {
                    id = "it-" + Date.now();
                    newItem = {
                        id: id,
                        group: groupId,
                        content: "",
                        start: start,
                        end: new Date(start.getTime() + oneWeek),
                        kind: "feature",
                        className: "type-feature"
                    };
                }
                items.add(newItem);
                setTimeout(function () { editItemLabel(id); }, 30);
            };

            timeline.setOptions(options);
            updateTimelineFilter();

            // ============================================================
            // 4. Sélection et suppression simple
            // ============================================================
            var selectedItemId = null;
            var btnAddMilestone = document.getElementById("btn-add-milestone");
            var btnRenameSelected = document.getElementById("btn-rename-selected");
            var btnAddItem = document.getElementById("btn-add-item");
            var btnDeleteSelected = document.getElementById("btn-delete-selected");

            function getDefaultGroupId() {
                if (!groups || typeof groups.get !== "function") {
                    return null;
                }
                var currentGroups = groups.get();
                if (currentGroups && currentGroups.length) {
                    return currentGroups[0].id;
                }
                var fallbackId = "team-alpha";
                if (typeof groups.add === "function") {
                    groups.add({
                        id: fallbackId,
                        content: "Team Alpha"
                    });
                }
                return fallbackId;
            }

            function getTimelineCenter() {
                if (!timeline || typeof timeline.getWindow !== "function") {
                    return new Date();
                }
                var windowBounds = timeline.getWindow();
                if (!windowBounds) {
                    return new Date();
                }
                var start = windowBounds.start ? new Date(windowBounds.start) : new Date();
                var end = windowBounds.end ? new Date(windowBounds.end) : new Date(start.getTime() + oneWeek);
                var mid = (start.getTime() + end.getTime()) / 2;
                return new Date(mid);
            }

            function getGroupForNewItem(isMilestone) {
                if (!groups || typeof groups.get !== "function") {
                    return null;
                }
                if (isMilestone) {
                    var milestoneGroup = groups.get("milestones");
                    if (milestoneGroup) {
                        return "milestones";
                    }
                }
                if (selectedItemId) {
                    var selectedItem = items.get(selectedItemId);
                    if (selectedItem && selectedItem.group) {
                        return selectedItem.group;
                    }
                }
                return getDefaultGroupId();
            }

            function computeDefaultEnd(start) {
                if (!start) return new Date();
                var end = new Date(start);
                if (currentScaleMode === "day") {
                    end.setDate(end.getDate() + 10);
                    return end;
                }
                if (currentScaleMode === "month") {
                    end.setMonth(end.getMonth() + 2);
                    return end;
                }
                end.setDate(end.getDate() + 14);
                return end;
            }

            function createTimelineItem(kind) {
                if (!items) return;
                var isMilestone = kind === "milestone";
                var groupId = getGroupForNewItem(isMilestone);
                if (!groupId) return;
                var baseStart = getTimelineCenter();
                var newItemId = (isMilestone ? "ms-" : "it-") + Date.now();
                var newItem = {
                    id: newItemId,
                    group: groupId,
                    content: "",
                    start: baseStart,
                    kind: isMilestone ? "milestone" : "feature",
                    className: isMilestone ? "type-milestone milestone-class" : "type-feature"
                };
                if (isMilestone) {
                    newItem.type = "point";
                } else {
                    newItem.end = computeDefaultEnd(baseStart);
                }
                items.add(newItem);
                if (timeline && typeof timeline.setSelection === "function") {
                    timeline.setSelection(newItemId);
                }
                selectedItemId = newItemId;
                updateSelectionButtons();
                setTimeout(function () {
                    editItemLabel(newItemId);
                }, 30);
            }

            timeline.on("select", function (props) {
                var selectedId = (props.items && props.items.length) ? props.items[0] : null;
                selectedItemId = selectedId;
                if (selectedId) {
                    var selectedItem = items.get(selectedId);
                    var tooltipText = buildTooltipText(selectedItem);
                    if (tooltipText) {
                        var rect = getTimelineItemRect(selectedId);
                        showEditTooltip(tooltipText, rect);
                    } else {
                        hideEditTooltip();
                    }
                } else {
                    hideEditTooltip();
                }
                updateSelectionButtons();
                renderTypeSwitcherOptions();
            });

            timeline.on("itemover", function (props) {
                if (props.item !== selectedItemId) return;
                var item = items.get(props.item);
                var tooltipText = buildTooltipText(item);
                if (tooltipText) {
                    var rect = getTimelineItemRect(props.item);
                    showEditTooltip(tooltipText, rect);
                }
            });

            timeline.on("itemout", function (props) {
                if (props.item === selectedItemId) {
                    hideEditTooltip();
                }
            });

            if (btnAddMilestone) {
                btnAddMilestone.addEventListener("click", function () {
                    createTimelineItem("milestone");
                });
            }
            if (btnAddType) {
                btnAddType.addEventListener("click", function () {
                    var label = window.prompt("Nom du nouveau type");
                    if (label === null) return;
                    label = (label || "").trim();
                    if (!label) return;
                    var id = sanitizeTypeId(label);
                    if (!id) return;
                    ensureTypeDefinition({ id: id, label: label });
                    ensureKindFilter(id);
                    rebuildTypeStyles();
                    syncFiltersForActiveView(getVisibleViewTypeIds());
                    renderColorModalContent();
                    persistTimelineState();
                });
            }
            if (btnRenameSelected) {
                btnRenameSelected.addEventListener("click", function () {
                    if (!selectedItemId) return;
                    editItemLabel(selectedItemId);
                });
            }
            if (btnAddItem) {
                btnAddItem.addEventListener("click", function () {
                    createTimelineItem("feature");
                });
            }

            if (itemTypeSelect) {
                itemTypeSelect.addEventListener("change", function () {
                    applyTypeToSelectedItem(itemTypeSelect.value);
                });
            }

            function updateSelectionButtons() {
                var hasSelection = !!selectedItemId;
                if (btnDeleteSelected) {
                    btnDeleteSelected.disabled = !hasSelection;
                }
                if (btnRenameSelected) {
                    btnRenameSelected.disabled = !hasSelection;
                }
            }

            updateSelectionButtons();
            renderTypeSwitcherOptions();

            if (btnDeleteSelected) {
                btnDeleteSelected.addEventListener("click", function () {
                    deleteSelectedItemWithConfirmation();
                });
            }

            document.addEventListener("keydown", function (event) {
                if (!selectedItemId) return;
                var tag = (event.target && event.target.tagName) ? event.target.tagName.toLowerCase() : "";
                if (tag === "input" || tag === "textarea" || (event.target && event.target.isContentEditable)) {
                    return;
                }
                if (event.key === "Delete" || event.key === "Backspace") {
                    event.preventDefault();
                    deleteSelectedItemWithConfirmation();
                }
            });

            function deleteSelectedItemWithConfirmation() {
                if (!selectedItemId) return;
                var it = items.get(selectedItemId);
                var label = (it && it.content) ? it.content : selectedItemId;
                if (confirm("Supprimer « " + label + " » ?")) {
                    items.remove(selectedItemId);
                    selectedItemId = null;
                    updateSelectionButtons();
                    renderTypeSwitcherOptions();
                }
            }

            // ============================================================
            // 5. Fonctions JSON <-> vis-timeline
            // ============================================================
            function isoToDate(str) {
                if (!str) return null;
                var value = typeof str === "string" ? str.trim() : (str + "");
                if (!value) return null;
                // Parse plain YYYY-MM-DD as local midnight to avoid timezone shifts
                var dateOnlyMatch = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (dateOnlyMatch) {
                    var y = parseInt(dateOnlyMatch[1], 10);
                    var m = parseInt(dateOnlyMatch[2], 10) - 1;
                    var d = parseInt(dateOnlyMatch[3], 10);
                    var localDate = new Date(y, m, d, 0, 0, 0, 0);
                    return isNaN(localDate.getTime()) ? null : localDate;
                }
                var d2 = new Date(value);
                return isNaN(d2.getTime()) ? null : d2;
            }

            function toDate(iso) {
                var d = isoToDate(iso);
                if (d) return d;
                var fallback = new Date(iso);
                return isNaN(fallback.getTime()) ? new Date() : fallback;
            }

            function daysBetween(start, end) {
                if (!start || !end) return 0;
                return Math.round((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));
            }

            function dateToIso(d) {
                if (!d) return null;
                return new Date(d).toISOString().slice(0, 10);
            }

            function applyPlanningFromJson(planning) {
                if (!planning) return;

                persistenceLocked = true;
                try {
                    applyTypeDefinitions(planning.types);
                    // groups
                    if (Array.isArray(planning.groups)) {
                        groups.clear();
                        planning.groups.forEach(function (g, idx) {
                            groups.add({
                                id: g.id,
                                content: g.label || g.id || ("Group " + (idx + 1))
                            });
                        });
                    }

                    // items
                    if (Array.isArray(planning.items)) {
                        items.clear();
                        planning.items.forEach(function (it) {
                            var kind = sanitizeTypeId(it.type || it.kind || "feature");
                            var base = {
                                id: it.id || ("it-" + Date.now() + Math.random()),
                                group: it.groupId,
                                content: it.label || "",
                                kind: kind
                            };
                            ensureTypeDefinition({ id: kind });

                            if (base.kind === "milestone") {
                                base.start = isoToDate(it.date || it.start);
                                base.type = "point";
                                base.className = "type-milestone milestone-class";
                            } else {
                                base.start = isoToDate(it.start);
                                var inclusiveEnd = isoToDate(it.end);
                                if (inclusiveEnd) {
                                    inclusiveEnd = new Date(inclusiveEnd.getTime() + oneDay);
                                }
                                base.end = inclusiveEnd || new Date(base.start.getTime() + oneDay);
                                if (base.end < base.start) {
                                    base.end = new Date(base.start.getTime() + oneDay);
                                }
                                base.className = "type-" + base.kind;
                            }
                            items.add(base);
                        });
                    }

                    // timeline range
                    var rangeStart = planning.timeline && planning.timeline.start
                        ? isoToDate(planning.timeline.start)
                        : null;
                    var rangeEnd = planning.timeline && planning.timeline.end
                        ? isoToDate(planning.timeline.end)
                        : null;

                    if (rangeStart && rangeEnd) {
                        timeline.setWindow(rangeStart, rangeEnd, { animation: false });
                    } else {
                        timeline.fit({ animation: false });
                    }
                    syncFiltersForActiveView(getVisibleViewTypeIds());
                    updateTimelineFilter();
                } finally {
                    persistenceLocked = false;
                }
                persistCurrentPlanning();
                updateEmptyViewMessage();
            }

            function exportPlanningToJson() {
                var g = groups.get();
                var it = items.get();

                var minStart = null;
                var maxEnd = null;

                var outGroups = g.map(function (gr) {
                    return {
                        id: gr.id,
                        label: gr.content
                    };
                });

                var outItems = it.map(function (item) {
                    if (item.kind === "milestone") {
                        if (item.start) {
                            var ds = new Date(item.start);
                            if (!minStart || ds < minStart) minStart = ds;
                            if (!maxEnd || ds > maxEnd) maxEnd = ds;
                        }
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: "milestone",
                            date: dateToIso(item.start)
                        };
                    } else {
                        var ds2 = item.start ? new Date(item.start) : null;
                        var de2 = item.end ? new Date(item.end) : null;
                        if (ds2) {
                            if (!minStart || ds2 < minStart) minStart = ds2;
                        }

                        var inclusiveEndForExport = null;
                        if (de2) {
                            inclusiveEndForExport = new Date(de2.getTime() - oneDay);
                            if (ds2 && inclusiveEndForExport < ds2) {
                                inclusiveEndForExport = ds2;
                            }
                            if (!maxEnd || inclusiveEndForExport > maxEnd) {
                                maxEnd = inclusiveEndForExport;
                            }
                        } else if (ds2) {
                            if (!maxEnd || ds2 > maxEnd) maxEnd = ds2;
                        }

                        var kind = item.kind || "feature";
                        return {
                            id: item.id,
                            groupId: item.group,
                            label: item.content || "",
                            kind: kind,
                            start: dateToIso(item.start),
                            end: dateToIso(inclusiveEndForExport || ds2)
                        };
                    }
                });

                var typeEntries = Object.keys(typeDefinitions).map(function (key) {
                    var def = typeDefinitions[key];
                    if (!def) return null;
                    return {
                        id: def.id,
                        label: def.label,
                        background: def.background,
                        border: def.border,
                        color: def.color
                    };
                }).filter(Boolean);

                var planning = {
                    timeline: {
                        start: dateToIso(minStart) || dateToIso(new Date()),
                        end: dateToIso(maxEnd) || dateToIso(new Date())
                    },
                    groups: outGroups,
                    items: outItems
                };

                if (typeEntries.length) {
                    planning.types = typeEntries;
                }

                return planning;
            }

            // ============================================================
            // 6. Toolbar timeline
            // ============================================================
            document.getElementById("btn-today").addEventListener("click", function () {
                var range = 4 * oneWeek;
                var center = new Date();
                timeline.setWindow(
                    new Date(center.getTime() - range / 2),
                    new Date(center.getTime() + range / 2),
                    { animation: true }
                );
            });

            document.getElementById("btn-fit").addEventListener("click", function () {
                timeline.fit({ animation: true });
            });

            document.getElementById("btn-zoom-in").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() + interval * 0.25);
                var newEnd = new Date(r.end.getTime() - interval * 0.25);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            document.getElementById("btn-zoom-out").addEventListener("click", function () {
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                var newStart = new Date(r.start.getTime() - interval * 0.5);
                var newEnd = new Date(r.end.getTime() + interval * 0.5);
                timeline.setWindow(newStart, newEnd, { animation: true });
            });

            function zoomTimelineByFactor(factor) {
                if (!timeline || typeof timeline.getWindow !== "function") return;
                var r = timeline.getWindow();
                var interval = r.end - r.start;
                if (interval <= 0) return;
                var newInterval = interval * factor;
                var center = (r.start.getTime() + r.end.getTime()) / 2;
                var newStart = new Date(center - newInterval / 2);
                var newEnd = new Date(center + newInterval / 2);
                timeline.setWindow(newStart, newEnd, { animation: false });
            }

            var btnWeek = document.getElementById("btn-scale-week");
            var btnDay = document.getElementById("btn-scale-day");
            var btnMonth = document.getElementById("btn-scale-month");

            function setScale(mode) {
                var normalized = (mode === "day" || mode === "month") ? mode : "week";
                currentScaleMode = normalized;
                snapMode = normalized;

                btnWeek.classList.toggle("btn-small-active", normalized === "week");
                btnDay.classList.toggle("btn-small-active", normalized === "day");
                btnMonth.classList.toggle("btn-small-active", normalized === "month");

                var timeAxis = (normalized === "day")
                    ? { scale: "day", step: 1 }
                    : (normalized === "month")
                        ? { scale: "month", step: 1 }
                        : { scale: "week", step: 1 };

                timeline.setOptions({
                    timeAxis: timeAxis,
                    snap: options.snap
                });
            }

            btnWeek.addEventListener("click", function () { setScale("week"); });
            btnDay.addEventListener("click", function () { setScale("day"); });
            btnMonth.addEventListener("click", function () { setScale("month"); });

            // Global wheel zoom (Ctrl/Meta + wheel anywhere) targeting the timeline
            window.addEventListener("wheel", function (event) {
                if (!(event.ctrlKey || event.metaKey)) return; // avoid hijacking normal scroll
                if (!timeline) return;
                event.preventDefault();
                event.stopPropagation();
                var zoomFactor = event.deltaY < 0 ? 0.8 : 1.25;
                zoomTimelineByFactor(zoomFactor);
            }, { passive: false, capture: true });

            function detectScaleFromRange(start, end) {
                if (!start || !end) return null;
                var diff = end.getTime() - start.getTime();
                if (diff <= 0) return null;
                var days = diff / oneDay;

                var viewportWidth = container ? container.clientWidth : 0;
                var pixelsPerDay = viewportWidth > 0 && days > 0 ? viewportWidth / days : 0;

                // Prefer a finer scale when there is enough pixel budget per day.
                if (pixelsPerDay >= 18) return "day";
                if (pixelsPerDay >= 4) return "week";

                if (days <= 7) return "day";
                if (days <= 14) return "week";
                return "month";
            }

            timeline.on("rangechanged", function (props) {
                var autoMode = detectScaleFromRange(props.start, props.end);
                if (autoMode && autoMode !== currentScaleMode) {
                    setScale(autoMode);
                }
            });

            // ============================================================
            // 7. Panneau OpenAI
            // ============================================================
            var txtPromptCreate = document.getElementById("promptCreate");
            var txtPromptModify = document.getElementById("promptModify");
            var btnCall = document.getElementById("btn-call");
            var templateModeSelect = document.getElementById("templateModeSelect");
            var iaTemplateEditor = document.getElementById("iaTemplateEditor");
            var resetTemplatesBtn = document.getElementById("resetTemplatesBtn");

            function ensureModifyPrompt(options) {
                var context = getActiveViewContext();
                context.prompts = context.prompts || {};
                var shouldRefresh = options && options.refreshModify;
                var hasExisting = typeof context.prompts.modify === "string";
                if ((shouldRefresh && !hasExisting) || context.prompts.modify === undefined || context.prompts.modify === null) {
                    context.prompts.modify = getModifyPromptContent();
                }
                if (txtPromptModify) {
                    txtPromptModify.value = context.prompts.modify || "";
                }
                if (!options || !options.skipPersist) {
                    persistTimelineState();
                }
            }

            function syncContextFieldsFromState(options) {
                var context = getActiveViewContext();
                if (txtPromptCreate) {
                    // Preserve existing textarea content if context has no prompt saved.
                    var existing = (txtPromptCreate.value || "").toString();
                    if (context.prompts && typeof context.prompts.create === "string" && context.prompts.create.trim() !== "") {
                        txtPromptCreate.value = context.prompts.create;
                    } else if (existing.trim() !== "") {
                        // If the textarea already contains meaningful text (from HTML), copy it into context for the active view.
                        context.prompts = context.prompts || {};
                        context.prompts.create = existing;
                    } else {
                        txtPromptCreate.value = "";
                    }
                }
                ensureModifyPrompt({
                    refreshModify: options && options.refreshModify,
                    skipPersist: true
                });
                if (!options || !options.skipPersist) {
                    persistTimelineState();
                }
            }

            function persistActiveContext(updateFn) {
                var context = getActiveViewContext();
                if (typeof updateFn === "function") {
                    updateFn(context);
                }
                persistedTimelineBrief = context.prompts.create || context.prompts.modify || "";
                persistTimelineState();
            }

            syncContextFieldsFromState({ skipPersist: true, refreshModify: true });
            contextUiReady = true;

            (function ensureGutenbergDefaultVisibility() {
                var el = document.getElementById("contextModalOverlay");
                if (!el) return;
                var isDrawer = false;
                try {
                    isDrawer = window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
                } catch (e) {
                    isDrawer = (window.innerWidth || 0) <= 900;
                }
                if (isDrawer) {
                    el.classList.remove("open");
                    el.setAttribute("aria-hidden", "true");
                } else {
                    el.classList.add("open");
                    el.setAttribute("aria-hidden", "false");
                }
            })();

            if (shouldOpenContextOnFirstLoad && !hasTimelineData()) {
                // Do not auto-open Gutenberg at first load — open Promptzilla instead
                if (typeof openRoadmapPromptzilla === "function") {
                    openRoadmapPromptzilla();
                } else if (typeof openContextModal === "function") {
                    // fallback
                    openContextModal({ mode: "create" });
                }
            }

            if (txtPromptCreate) {
                txtPromptCreate.addEventListener("input", function () {
                    persistActiveContext(function (ctx) {
                        ctx.prompts.create = txtPromptCreate.value || "";
                    });
                });
            }
            if (txtPromptModify) {
                txtPromptModify.addEventListener("input", function () {
                    persistActiveContext(function (ctx) {
                        ctx.prompts.modify = txtPromptModify.value || "";
                    });
                });
            }

            function getSystemTemplateForMode(mode) {
                return mode === "modify"
                    ? (customSystemTemplates.modify || MODIFY_SYSTEM_TEMPLATE)
                    : (customSystemTemplates.create || CREATE_SYSTEM_TEMPLATE);
            }

            function resetSystemTemplates() {
                customSystemTemplates.create = CREATE_SYSTEM_TEMPLATE;
                customSystemTemplates.modify = MODIFY_SYSTEM_TEMPLATE;
                syncTemplateEditor(templateModeSelect ? templateModeSelect.value : "create");
                persistTimelineState();
            }

            function persistTemplateChange(mode, value) {
                var target = mode === "modify" ? "modify" : "create";
                customSystemTemplates[target] = value || getSystemTemplateForMode(target);
                persistTimelineState();
            }

            function syncTemplateEditor(mode) {
                var normalized = mode === "modify" ? "modify" : "create";
                if (templateModeSelect) {
                    templateModeSelect.value = normalized;
                }
                if (iaTemplateEditor) {
                    iaTemplateEditor.value = getSystemTemplateForMode(normalized);
                }
            }

            if (templateModeSelect) {
                templateModeSelect.addEventListener("change", function () {
                    syncTemplateEditor(this.value);
                });
            }

            if (iaTemplateEditor) {
                iaTemplateEditor.addEventListener("input", function () {
                    var mode = templateModeSelect ? templateModeSelect.value : "create";
                    persistTemplateChange(mode, iaTemplateEditor.value || "");
                });
            }

            if (resetTemplatesBtn) {
                resetTemplatesBtn.addEventListener("click", function () {
                    resetSystemTemplates();
                });
            }

            var IA_API_KEY_STORAGE_KEY = "go-toolkit-api-key";
            var iaApiKeyInput = document.getElementById("iaApiKeyInput");
            var reasoningEffortSelect = document.getElementById("reasoningEffortSelect");
            var REASONING_EFFORT_KEY = "plan-reasoning-effort";
            var REASONING_EFFORTS = ["minimal", "low", "medium", "high"];

            function readSharedTimelineApiKey() {
                if (typeof window === "undefined" || !window.localStorage) {
                    return "";
                }
                try {
                    return localStorage.getItem(IA_API_KEY_STORAGE_KEY) || "";
                } catch (err) {
                    console.warn("Impossible de lire la clé OpenAI stockée localement", err);
                    return "";
                }
            }

            function persistSharedTimelineApiKey(value) {
                if (typeof window === "undefined" || !window.localStorage) {
                    return;
                }
                try {
                    if (value) {
                        localStorage.setItem(IA_API_KEY_STORAGE_KEY, value);
                    } else {
                        localStorage.removeItem(IA_API_KEY_STORAGE_KEY);
                    }
                } catch (err) {
                    console.warn("Impossible de sauvegarder la clé OpenAI localement", err);
                }
            }

            var storedApiKey = readSharedTimelineApiKey();
            if (iaApiKeyInput && storedApiKey) {
                iaApiKeyInput.value = storedApiKey;
            }

            (function initializeReasoningEffort() {
                if (!reasoningEffortSelect) return;
                var stored = localStorage.getItem(REASONING_EFFORT_KEY) || "low";
                if (REASONING_EFFORTS.indexOf(stored) === -1) {
                    stored = "low";
                }
                reasoningEffortSelect.value = stored;
                reasoningEffortSelect.addEventListener("change", function () {
                    var value = reasoningEffortSelect.value;
                    if (REASONING_EFFORTS.indexOf(value) !== -1) {
                        localStorage.setItem(REASONING_EFFORT_KEY, value);
                    }
                });
            })();

            if (iaApiKeyInput) {
                iaApiKeyInput.addEventListener("input", function () {
                    persistSharedTimelineApiKey(iaApiKeyInput.value.trim());
                });
            }
            var waitingTimerId = null;
            var waitingCounter = 60;
            var iaModalButtonDefaultLabel = iaModalButton
                ? iaModalButton.textContent.trim()
                : "⌘";
            var EMPTY_MODIFY_PROMPT_TEXT = (function () {
                if (Array.isArray(ROADMAP_PROMPTZILLA) && ROADMAP_PROMPTZILLA.length) {
                    var first = ROADMAP_PROMPTZILLA[0];
                    if (first && typeof first.script === "string" && first.script.trim() !== "") {
                        return first.script;
                    }
                }
                return (
                    "Page : Planning 2026\n" +
                    "\n" +
                    "Éléments :\n" +
                    "\n" +
                    "Action 1 \n" +
                    "Date: 2026-01-01 → 2027-01-01\n" +
                    "Groupe: Phase 1\n" +
                    "Type:  Catégorie 1\n" +
                    "\n" +
                    "\n" +
                    "Repère 1 \n" +
                    "Date: 2025-03-22\n" +
                    "Groupe: Phase 2\n" +
                    "Type: milestone\n" +
                    "\n" +
                    "Action 2\n" +
                    "Date: 2026-03-01 → 2026-07-01 \n" +
                    "Groupe: Groupe 2\n" +
                    "Type:  Catégorie 2"
                );
            })();

            function hasTimelineData() {
                if (!items || typeof items.get !== "function") {
                    return false;
                }
                return items.get().length > 0;
            }

            function getModifyPromptContent() {
                if (!items || typeof items.get !== "function" || !hasTimelineData()) {
                    return EMPTY_MODIFY_PROMPT_TEXT;
                }
                persistCurrentPlanning();
                var currentView = views[activeViewIndex];
                var planning = exportPlanningToJson();
                var title =
                    currentView && (currentView.title || currentView.name)
                        ? currentView.title || currentView.name
                        : "";
                return buildTextExport(planning, title);
            }

            function determineGenerationMode() {
                var scriptText = (txtPromptModify && txtPromptModify.value ? txtPromptModify.value.trim() : "");
                return scriptText ? "modify" : "create";
            }

            function updateIaButtonLabel(isLoading, counter) {
                if (!iaModalButton) return;
                if (isLoading) {
                    var displayCounter = typeof counter === "number" ? counter : waitingCounter;
                    iaModalButton.textContent = "⏳ Attente " + displayCounter + "s";
                } else {
                    iaModalButton.textContent = iaModalButtonDefaultLabel;
                }
            }

            function stopWaitingTimer() {
                if (waitingTimerId) {
                    clearInterval(waitingTimerId);
                    waitingTimerId = null;
                }
                updateIaButtonLabel(false);
                setEmptyStateLoading(false);
            }

            function startWaitingTimer() {
                stopWaitingTimer();
                waitingCounter = 30;
                updateIaButtonLabel(true, waitingCounter);
                setEmptyStateLoading(true, waitingCounter);
                waitingTimerId = setInterval(function () {
                    waitingCounter--;
                    if (waitingCounter < 0) {
                        waitingCounter = 30;
                    }
                    updateIaButtonLabel(true, waitingCounter);
                    setEmptyStateLoading(true, waitingCounter);
                }, 1000);
            }

            function fillPromptTemplate(template, instructions, planningJson) {
                var text = template.replace("{{(contenu du id=\"prompt\") }}", instructions || "");
                var placeholder = "{{(contenu au format JSON du planning existant)}}";
                if (template.indexOf(placeholder) >= 0) {
                    var planningContent =
                        planningJson && planningJson.trim() ? planningJson : "(aucun planning existant)";
                    text = text.replace(placeholder, planningContent);
                }
                return text;
            }

            async function callOpenAI(messages) {
                try {
                    if (!window.GoToolkitOpenAI) {
                        throw new Error("Client OpenAI indisponible");
                    }
                    var apiKey = "";
                    if (iaApiKeyInput && iaApiKeyInput.value) {
                        apiKey = iaApiKeyInput.value.trim();
                    }
                    if (!apiKey) {
                        apiKey = readSharedTimelineApiKey();
                    }
                    var useProxy = !apiKey;
                    var endpoint = useProxy ? OPENAI_PROXY_URL : "https://api.openai.com/v1/responses";
                    console.log(
                        "OpenAI request content",
                        messages.map(function (m) {
                            return "[" + m.role + "] " + (m.content || "");
                        })
                    );
                    var messageText = await GoToolkitOpenAI.chatCompletion({
                        endpoint: endpoint,
                        apiKey: useProxy ? "" : apiKey,
                        payload: {
                            model: OPENAI_MODEL,
                            temperature: OPENAI_TEMPERATURE,
                            messages: messages,
                            reasoning: {
                                effort: (function () {
                                    var value = reasoningEffortSelect ? reasoningEffortSelect.value : "low";
                                    return REASONING_EFFORTS.indexOf(value) !== -1 ? value : "low";
                                })()
                            },
                            stream: true
                        }
                    });
                    console.log("OpenAI received text", messageText);
                    return messageText;
                } catch (err) {
                    console.error("Erreur OpenAI", err);
                    alert("Impossible de contacter OpenAI. Vérifie que le proxy est accessible.");
                    return null;
                }
            }

            btnCall.addEventListener("click", async function () {
                var mode = determineGenerationMode();
                if (mode === "modify") {
                    ensureModifyPrompt({ refreshModify: true });
                }
                var promptField = mode === "modify" ? txtPromptModify : txtPromptCreate;
                var promptText = (promptField && promptField.value ? promptField.value.trim() : "");

                if (!promptText && mode === "modify" && txtPromptCreate && txtPromptCreate.value.trim()) {
                    mode = "create";
                    promptField = txtPromptCreate;
                    promptText = txtPromptCreate.value.trim();
                }

                if (!promptText) {
                    alert("Ajoute un prompt avant d'appeler OpenAI 🙂");
                    promptField && promptField.focus();
                    return;
                }

                var currentPlanning = null;
                var planningJson = "";
                if (mode === "modify") {
                    if (hasTimelineData()) {
                        currentPlanning = exportPlanningToJson();
                        planningJson = JSON.stringify(currentPlanning, null, 2);
                    }
                }

                var systemContent = fillPromptTemplate(
                    getSystemTemplateForMode(mode),
                    promptText,
                    planningJson
                );

                var payload = {
                    schema: "planning-v1",
                    mode: mode,
                    prompt: promptText,
                    planning: currentPlanning
                };

                var messages = [
                    { role: "system", content: systemContent },
                    { role: "user", content: JSON.stringify(payload, null, 2) }
                ];

                lastTimelineGenerationAt = Date.now();
                startWaitingTimer();
                btnCall.disabled = true;
                closeIaModal();
                try {
                    var aiResponse = await callOpenAI(messages);
                    if (!aiResponse) return;
                    var normalized = aiResponse.trim();
                    console.log("OpenAI response body", normalized);
                    var planning;
                    try {
                        planning = JSON.parse(normalized);
                    } catch (err) {
                        console.error("JSON OpenAI invalide", err);
                        alert("Réponse OpenAI invalide : JSON attendu.");
                        return;
                    }
                    if (planning && typeof planning.page === "string") {
                        var pageTitle = planning.page.trim();
                        if (pageTitle) {
                            var currentView = views[activeViewIndex];
                            if (currentView) {
                                currentView.title = pageTitle;
                                refreshHeaderText();
                                persistTimelineState();
                            }
                        }
                    }
                    applyPlanningFromJson(planning);
                } finally {
                    btnCall.disabled = false;
                    stopWaitingTimer();
                }
            });

            var timelineTourSteps = [
                {
                    title: "Go-Roadmap, ton copilote planning",
                    description: "Go-Roadmap aide les consultants à générer des plannings de projet clairs et rapides pour cadrer leurs prochaines étapes.",
                    selectors: ["#timeline"]
                },
                {
                    title: "Démarre par le Contexte 💬",
                    description: "Clique sur 💬, choisis Magique ou Guidé, saisis ton contexte puis lance \"⌘ Créer le planning\".",
                    selectors: ["#openContextModal"]
                },
                {
                    title: "Affiche, zoome, navigue",
                    description: "Le planning apparaît, tu peux zoomer, te déplacer dans le temps et jongler avec les boutons de la barre d’outils.",
                    selectors: [
                        ".toolbar .btn-group:nth-of-type(1)",
                        ".toolbar .btn-group:nth-of-type(2)",
                        ".toolbar .btn-group:nth-of-type(3)"
                    ]
                },
                {
                    title: "Modifie librement le contenu",
                    description: "Ajoute, renomme, déplace, ajuste les durées ou supprime n’importe quel élément directement dans la timeline.",
                    selectors: [".toolbar .item-actions"]
                },
                {
                    title: "Exporte ta timeline",
                    description: "Le menu 📄 permet de télécharger la vue courante en texte, image ou Excel et le bouton ⧉ Capsule génère un lien privé pour la partager rapidement.",
                    selectors: ["#fileMenuBtn"]
                }
            ];
            var timelineTourOverlay = document.getElementById("timelineTourOverlay");
            var timelineTourHighlight = timelineTourOverlay && timelineTourOverlay.querySelector(".tour-highlight");
            var timelineTourPanel = timelineTourOverlay && timelineTourOverlay.querySelector(".tour-panel");
            var timelineTourTitle = document.getElementById("timelineTourStepTitle");
            var timelineTourDescription = document.getElementById("timelineTourStepDescription");
            var timelineTourCounter = document.getElementById("timelineTourStepCounter");
            var timelineTourPrevBtn = document.getElementById("timelineTourPrevBtn");
            var timelineTourNextBtn = document.getElementById("timelineTourNextBtn");
            var timelineTourCloseBtn = document.getElementById("timelineTourCloseBtn");
            var timelineTourSkipBtn = document.getElementById("timelineTourSkipBtn");
            var timelineTourReplayBtn = document.getElementById("timelineTourReplayBtn");
            var timelineTourStorageKey = "goTimelineTourSeen";
            var timelineTourSkipFlag = "goTimelineTourSkipAfterUpdate";
            var timelineCurrentTourIndex = 0;

            function getSelectorsFromStep(step) {
                if (!step) return [];
                if (Array.isArray(step.selectors)) return step.selectors;
                if (step.selector) return [step.selector];
                return [];
            }

            function getSelectorsBoundingRect(selectors) {
                if (!selectors || !selectors.length) {
                    return null;
                }
                let unionRect = null;
                selectors.forEach(function (selector) {
                    var target = document.querySelector(selector);
                    if (!target) return;
                    var rect = target.getBoundingClientRect();
                    if (!unionRect) {
                        unionRect = {
                            top: rect.top,
                            left: rect.left,
                            right: rect.right,
                            bottom: rect.bottom
                        };
                    } else {
                        unionRect.top = Math.min(unionRect.top, rect.top);
                        unionRect.left = Math.min(unionRect.left, rect.left);
                        unionRect.right = Math.max(unionRect.right, rect.right);
                        unionRect.bottom = Math.max(unionRect.bottom, rect.bottom);
                    }
                });
                if (!unionRect) return null;
                unionRect.width = unionRect.right - unionRect.left;
                unionRect.height = unionRect.bottom - unionRect.top;
                return unionRect;
            }

            function positionTourPanel(selectors) {
                if (!timelineTourPanel) return;
                var spacing = 14;
                var defaults = {
                    top: "auto",
                    bottom: "28px",
                    left: "50%",
                    right: "auto",
                    transform: "translateX(-50%)"
                };
                Object.assign(timelineTourPanel.style, defaults);
                var rect = getSelectorsBoundingRect(selectors);
                if (!rect) return;
                var panelRect = timelineTourPanel.getBoundingClientRect();
                var top = rect.bottom + spacing;
                if (top + panelRect.height > window.innerHeight - spacing) {
                    top = rect.top - panelRect.height - spacing;
                }
                var left = rect.left + rect.width / 2 - panelRect.width / 2;
                left = Math.max(spacing, Math.min(left, window.innerWidth - panelRect.width - spacing));
                timelineTourPanel.style.top = Math.max(spacing, top) + "px";
                timelineTourPanel.style.left = left + "px";
                timelineTourPanel.style.bottom = "auto";
                timelineTourPanel.style.right = "auto";
                timelineTourPanel.style.transform = "none";
            }

            function updateHighlight(selectors) {
                if (!timelineTourHighlight || !timelineTourOverlay) return;
                var rect = getSelectorsBoundingRect(selectors);
                if (!rect) {
                    timelineTourHighlight.classList.add("hidden");
                    timelineTourOverlay.classList.add("dimmed");
                    return;
                }
                timelineTourOverlay.classList.remove("dimmed");
                timelineTourHighlight.classList.remove("hidden");
                var offset = 10;
                timelineTourHighlight.style.width = rect.width + offset * 2 + "px";
                timelineTourHighlight.style.height = rect.height + offset * 2 + "px";
                timelineTourHighlight.style.left = rect.left - offset + "px";
                timelineTourHighlight.style.top = rect.top - offset + "px";
            }

            function renderTimelineTourStep() {
                if (!timelineTourOverlay || !timelineTourSteps.length) return;
                var step = timelineTourSteps[timelineCurrentTourIndex];
                if (!step) return;
                timelineTourTitle.textContent = step.title;
                timelineTourDescription.textContent = step.description;
                timelineTourCounter.textContent = "Étape " + (timelineCurrentTourIndex + 1) + " / " + timelineTourSteps.length;
                timelineTourPrevBtn.disabled = timelineCurrentTourIndex === 0;
                timelineTourNextBtn.textContent = timelineCurrentTourIndex === timelineTourSteps.length - 1 ? "Terminé" : "Suivant";
                var selectors = getSelectorsFromStep(step);
                updateHighlight(selectors);
                positionTourPanel(selectors);
            }

            function openTimelineTour(startIndex) {
                hideTimelineAbout();
                if (!timelineTourOverlay) return;
                timelineCurrentTourIndex = typeof startIndex === "number" ? startIndex : 0;
                timelineTourOverlay.classList.add("visible");
                timelineTourOverlay.setAttribute("aria-hidden", "false");
                renderTimelineTourStep();
            }

            function closeTimelineTour(markSeen) {
                if (markSeen && window.localStorage) {
                    window.localStorage.setItem(timelineTourStorageKey, "1");
                }
                if (!timelineTourOverlay) return;
                timelineTourOverlay.classList.remove("visible");
                timelineTourOverlay.setAttribute("aria-hidden", "true");
                timelineTourOverlay.classList.remove("dimmed");
                if (timelineTourHighlight) {
                    timelineTourHighlight.classList.add("hidden");
                }
            }

            if (timelineTourPrevBtn) {
                timelineTourPrevBtn.addEventListener("click", function () {
                    if (timelineCurrentTourIndex === 0) return;
                    timelineCurrentTourIndex--;
                    renderTimelineTourStep();
                });
            }
            if (timelineTourNextBtn) {
                timelineTourNextBtn.addEventListener("click", function () {
                    if (timelineCurrentTourIndex >= timelineTourSteps.length - 1) {
                        closeTimelineTour(true);
                        return;
                    }
                    timelineCurrentTourIndex++;
                    renderTimelineTourStep();
                });
            }
            if (timelineTourCloseBtn) {
                timelineTourCloseBtn.addEventListener("click", function () {
                    closeTimelineTour(true);
                });
            }
            if (timelineTourSkipBtn) {
                timelineTourSkipBtn.addEventListener("click", function () {
                    closeTimelineTour(true);
                });
            }
            if (timelineTourReplayBtn) {
                timelineTourReplayBtn.addEventListener("click", function () {
                    if (window.localStorage) {
                        window.localStorage.removeItem(timelineTourStorageKey);
                    }
                    openTimelineTour(0);
                });
            }

            window.addEventListener("resize", function () {
                if (!timelineTourOverlay || !timelineTourOverlay.classList.contains("visible")) return;
                renderTimelineTourStep();
            });

            var timelineTourSeen = window.localStorage && window.localStorage.getItem(timelineTourStorageKey);
            var timelineTourSkipAfterUpdateValue =
                window.sessionStorage && window.sessionStorage.getItem(timelineTourSkipFlag);
            if (timelineTourSkipAfterUpdateValue && window.sessionStorage) {
                window.sessionStorage.removeItem(timelineTourSkipFlag);
            }
            if (!timelineTourSeen && !timelineTourSkipAfterUpdateValue) {
                setTimeout(function () {
                    openTimelineTour(0);
                }, 200);
            }

            initShareWorkerService();
            updateShareMenuUI();
            tryLoadSharedStateFromUrl();

            setScale("week");
            if (txtPromptCreate) {
                txtPromptCreate.focus();
            }


        </script>
</body>

</html>